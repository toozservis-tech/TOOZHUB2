<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TooZ Hub 2</title>
    <link rel="stylesheet" href="theme.css" />
    <link rel="stylesheet" href="app.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .container {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            background: #f8fafc;
            border-radius: 0 !important;
            box-shadow: none !important;
            overflow: visible;
            min-height: 100vh !important;
        }

        /* Star√© .header styly odstranƒõny - pou≈æ√≠v√° se navbar z theme.css */

        .content {
            width: 100% !important;
            max-width: 900px !important;
            margin: 32px auto !important;
            padding: 24px 28px 32px !important;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            color: #1e293b;
        }

        .auth-section {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .auth-section h2 {
            color: #1e293b;
        }

        /* Form styly jsou nyn√≠ v theme.css */

        /* Kompaktn√≠ formul√°≈ô s grid layoutem - 2 sloupce */
        .form-compact {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            max-width: 800px;
            margin: 0 auto;
        }

        .form-compact .form-group {
            margin-bottom: 0;
        }

        .form-compact .form-group.full-width {
            grid-column: 1 / -1;
        }

        /* VIN p≈ôes celou ≈°√≠≈ôku */
        .form-compact .form-group:nth-child(1) {
            grid-column: 1 / -1;
        }

        /* Pozn√°mky p≈ôes celou ≈°√≠≈ôku (nyn√≠ 9. pole kv≈Øli k√≥du motoru) */
        .form-compact .form-group:nth-child(9) {
            grid-column: 1 / -1;
        }

        /* Na mal√Ωch obrazovk√°ch 1 sloupec */
        @media (max-width: 768px) {
            .form-compact {
                grid-template-columns: 1fr;
            }
        }

        /* Kompaktnƒõj≈°√≠ inputy v formul√°≈ôi pro vozidla */
        #addVehicleTab {
            padding: 20px;
            max-width: 850px;
            margin: 0 auto;
        }

        /* Specifick√© styly pro addVehicleTab - kompaktnƒõj≈°√≠ design */
        #addVehicleTab .form-group label {
            font-size: 0.85rem;
            margin-bottom: 4px;
            font-weight: 500;
        }

        #addVehicleTab .form-group input,
        #addVehicleTab .form-group textarea {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        #addVehicleTab h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            margin-top: 0;
            color: #1e293b;
            text-align: center;
        }

        .dashboard h2 {
            color: #1e293b;
        }

        .dashboard h3 {
            color: #334155;
        }

        #addVehicleTab .btn {
            padding: 7px 14px;
            font-size: 12px;
        }

        .btn {
            width: 100%;
            padding: 10px 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.5);
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #475569;
        }

        .btn-secondary:hover {
            background: #64748b;
            box-shadow: 0 8px 20px rgba(71, 85, 105, 0.5);
        }

        .alert {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.15);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 2px solid rgba(239, 68, 68, 0.5);
            font-weight: 500;
            padding: 15px 20px;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.15);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .alert-warning {
            background: rgba(251, 191, 36, 0.15);
            color: #fcd34d;
            border: 2px solid rgba(251, 191, 36, 0.5);
            font-weight: 500;
            padding: 15px 20px;
        }

        .hidden {
            display: none;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .user-info {
            background: rgba(15, 23, 42, 0.98);
            padding: 16px 20px;
            border-radius: 14px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(148, 163, 184, 0.35);
            color: #e5e7eb;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .user-info strong {
            color: #f9fafb;
        }

        /* Karty vozidel nyn√≠ pou≈æ√≠vaj√≠ styly z theme.css (.cards-grid, .card) */
        /* Star√© .vehicles-grid a .vehicle-card styly odstranƒõny - pou≈æ√≠vaj√≠ se z theme.css */

        /* Detail vozidla */
        .vehicle-detail {
            display: none;
        }

        .vehicle-detail.active {
            display: block;
        }

        .vehicle-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(55, 65, 81, 0.9);
        }

        .vehicle-detail-header h2 {
            margin: 0;
            color: #6366f1;
        }

        .vehicle-detail-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }

        .vehicle-detail-left, .vehicle-detail-right {
            background: rgba(30, 41, 59, 0.8);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .vehicle-detail-left h3, .vehicle-detail-right h3 {
            margin-top: 0;
            color: #6366f1;
            border-bottom: 2px solid #6366f1;
            padding-bottom: 10px;
        }

        .vehicle-info-item {
            margin: 15px 0;
            padding: 10px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .vehicle-info-item strong {
            color: #e5e7eb;
            display: block;
            margin-bottom: 5px;
        }

        .vehicle-info-item span {
            color: #9ca3af;
        }

        .service-records-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .service-record-item {
            background: rgba(30, 41, 59, 0.8);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 12px;
            border-left: 4px solid #6366f1;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .service-record-item h4 {
            margin: 0 0 10px 0;
            color: #e5e7eb;
        }

        .service-record-item .record-date {
            color: #9ca3af;
            font-size: 0.9em;
        }

        .service-record-item .record-details {
            margin-top: 10px;
            color: #9ca3af;
        }

        .service-record-item .record-price {
            font-weight: bold;
            color: #6366f1;
            margin-top: 10px;
        }

        .add-service-form {
            margin-top: 20px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .add-service-form h4 {
            margin-top: 0;
            color: #6366f1;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .form-row.full-width {
            grid-template-columns: 1fr;
        }

        .back-button {
            background: #475569;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .back-button:hover {
            background: #64748b;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        /* Tabs styly jsou nyn√≠ v theme.css - pou≈æ√≠vaj√≠ svƒõtl√Ω design */
        .tabs {
            /* Pou≈æ√≠v√° styly z theme.css */
        }

        .tab {
            /* Pou≈æ√≠v√° styly z theme.css */
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .status-online {
            background: #51cf66 !important;
            animation: none !important;
        }

        .status-offline {
            background: #ff6b6b !important;
        }

        .status-checking {
            background: #ffd43b !important;
        }

        .api-url-config {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .api-url-config {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 20px;
            color: #e5e7eb;
        }

        .api-url-config h3 {
            margin-top: 0;
            color: #6366f1;
        }

        .api-url-config p {
            color: #9ca3af;
        }

        .api-url-input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .api-url-input-group input {
            flex: 1;
            padding: 10px;
            background: #020617;
            color: #f9fafb;
            border: 1px solid #374151;
            border-radius: 8px;
            font-size: 14px;
        }

        .api-url-input-group input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.4);
        }

        .api-url-input-group button {
            padding: 10px 20px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .api-url-input-group button:hover {
            background: #7c3aed;
        }

        .config-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .config-button:hover {
            background: rgba(255,255,255,0.3);
        }

        /* ========================================
           AGRESIVN√ç CSS PRO CELOU OBRAZOVKU
           P≈ôep√≠≈°e v≈°echny mo≈æn√© wrappery
           ======================================== */
        html, body {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow-x: hidden !important;
        }

        /* Dal≈°√≠ mo≈æn√© wrappery */
        .main-container, 
        .page-content,
        #container,
        #content,
        #main-container,
        #page-content {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }

        /* Odstranƒõn√≠ v≈°ech mo≈æn√Ωch okraj≈Ø a padding≈Ø z rodiƒçovsk√Ωch element≈Ø */
        body > * {
            max-width: 100% !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
        }


        /* Zaji≈°tƒõn√≠, ≈æe v≈°e zab√≠r√° celou ≈°√≠≈ôku */
        * {
            box-sizing: border-box;
        }

        /* Odstranƒõn√≠ v≈°ech mo≈æn√Ωch omezuj√≠c√≠ch ≈°√≠≈ôek */
        [class*="container"],
        [class*="wrapper"],
        [class*="content"],
        [class*="main"],
        [class*="page"],
        [id*="container"],
        [id*="wrapper"],
        [id*="content"],
        [id*="main"],
        [id*="page"] {
            max-width: 100% !important;
        }

        /* ========================================
           RESPONSIVN√ç STYLY - MOBILN√ç OPTIMALIZACE
           ======================================== */
        
        /* Tablet a men≈°√≠ (‚â§ 768px) */
        @media (max-width: 768px) {
            body {
                font-size: 15px;
            }

            h1 {
                font-size: 1.4rem;
            }

            h2 {
                font-size: 1.2rem;
            }

            .content {
                margin: 16px !important;
                padding: 18px 16px 24px !important;
                border-radius: 14px !important;
            }

            /* Star√© .header styly odstranƒõny - pou≈æ√≠v√° se navbar z theme.css */

            .user-info {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .tabs {
                gap: 16px;
                flex-wrap: wrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }

            .tabs::-webkit-scrollbar {
                height: 4px;
            }

            .tab {
                padding: 8px 12px;
                font-size: 14px;
                white-space: nowrap;
                min-height: 44px;
            }

            /* Two-column layout ‚Üí single column */
            .vehicle-detail-content {
                grid-template-columns: 1fr !important;
                gap: 20px;
            }

            .form-compact {
                grid-template-columns: 1fr !important;
            }

            .form-row {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }

            /* Vehicles grid - 1 sloupec na mobilu */
            /* Karty vozidel pou≈æ√≠vaj√≠ .cards-grid z theme.css */

            /* Service records - odstranit nested scroll na mobilu */
            .service-records-list {
                max-height: none !important;
                overflow-y: visible !important;
            }

            /* Buttons - full width na mobilu */
            .btn {
                min-height: 44px; /* Touch-friendly */
                font-size: 15px;
            }

            /* Form inputs - vƒõt≈°√≠ pro mobil */
            .form-group input,
            .form-group textarea,
            .form-group select {
                min-height: 44px;
                font-size: 16px; /* Zabra≈àuje zoomu na iOS */
                padding: 12px;
            }

            .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
            }

            /* Karty vozidel pou≈æ√≠vaj√≠ .card z theme.css */

            /* Add service form */
            .add-service-form {
                padding: 16px;
            }

            /* P≈ôipom√≠nky - optimalizace pro tablet */
            #remindersContainer .form-group input,
            #remindersContainer .form-group select,
            #remindersContainer .form-group textarea {
                min-height: 44px;
                font-size: 16px;
            }

            /* Rezervace - optimalizace pro tablet */
            #reservationsContainer .form-group input,
            #reservationsContainer .form-group select,
            #reservationsContainer .form-group textarea {
                min-height: 44px;
                font-size: 16px;
            }

            /* Profil - optimalizace pro tablet */
            #profileContainer .form-row {
                grid-template-columns: 1fr !important;
            }

            /* Navbar - optimalizace pro tablet */
            .navbar {
                flex-wrap: wrap;
            }

            .navbar-stats {
                font-size: 0.9rem;
            }
        }

        /* Mobiln√≠ telefony (‚â§ 480px) */
        @media (max-width: 480px) {
            body {
                font-size: 15px;
            }

            h1 {
                font-size: 1.3rem;
            }

            h2 {
                font-size: 1.1rem;
            }

            h3 {
                font-size: 1rem;
            }

            /* Star√© .header styly odstranƒõny - pou≈æ√≠v√° se navbar z theme.css */

            .content {
                margin: 12px !important;
                padding: 16px 12px 20px !important;
            }

            /* Auth section - full width na mal√©m mobilu */
            .auth-section {
                max-width: 100%;
                padding: 20px;
            }

            /* User info - kompaktnƒõj≈°√≠ */
            .user-info {
                padding: 12px 16px;
                font-size: 14px;
            }

            /* Tabs - men≈°√≠ gap */
            .tabs {
                gap: 12px;
                padding-bottom: 8px;
            }

            .tab {
                padding: 8px 10px;
                font-size: 13px;
            }

            /* Form rows - v≈ædy 1 sloupec */
            .form-row {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }

            /* Vehicle detail */
            .vehicle-detail-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .vehicle-detail-left,
            .vehicle-detail-right {
                padding: 16px;
            }

            /* Service records - ≈æ√°dn√Ω max-height */
            .service-records-list {
                max-height: none !important;
                overflow-y: visible !important;
            }

            .service-record-item {
                padding: 12px;
            }

            /* Buttons - full width */
            .btn {
                width: 100%;
                min-height: 44px;
                margin-bottom: 10px;
            }

            /* Input groups - full width */
            .api-url-input-group {
                flex-direction: column;
            }

            .api-url-input-group input,
            .api-url-input-group button {
                width: 100%;
                margin-bottom: 8px;
            }

            /* Word wrap pro dlouh√© texty */
            .vehicle-info-item,
            .service-record-item,
            .vehicle-card {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            /* P≈ôipom√≠nky - optimalizace pro mobil */
            #remindersContainer .card,
            #remindersContainer [style*="background: rgba(30, 41, 59"] {
                margin: 12px 0;
                padding: 16px;
                border-radius: 12px;
            }

            #remindersContainer .form-group {
                margin-bottom: 16px;
            }

            #remindersContainer .form-group input,
            #remindersContainer .form-group select,
            #remindersContainer .form-group textarea {
                width: 100% !important;
                min-height: 44px;
                font-size: 16px;
                padding: 12px;
            }

            #remindersContainer .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
                display: block;
            }

            #remindersContainer button {
                width: 100%;
                min-height: 44px;
                margin-top: 10px;
            }

            /* Rezervace - optimalizace pro mobil */
            #reservationsContainer .card,
            #reservationsContainer [style*="background: rgba(30, 41, 59"] {
                margin: 12px 0;
                padding: 16px;
                border-radius: 12px;
            }

            #reservationsContainer .form-group {
                margin-bottom: 16px;
            }

            #reservationsContainer .form-group input,
            #reservationsContainer .form-group select,
            #reservationsContainer .form-group textarea {
                width: 100% !important;
                min-height: 44px;
                font-size: 16px;
                padding: 12px;
            }

            #reservationsContainer .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
                display: block;
            }

            #reservationsContainer button {
                width: 100%;
                min-height: 44px;
                margin-top: 10px;
            }

            /* Profil - optimalizace pro mobil */
            #profileContainer .form-row {
                grid-template-columns: 1fr !important;
                gap: 16px;
            }

            #profileContainer .form-group {
                margin-bottom: 16px;
            }

            #profileContainer .form-group input,
            #profileContainer .form-group select,
            #profileContainer .form-group textarea {
                width: 100%;
                min-height: 44px;
                font-size: 16px;
                padding: 12px;
            }

            #profileContainer .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
                display: block;
            }

            #profileContainer button {
                width: 100%;
                min-height: 44px;
                margin-bottom: 10px;
            }

            /* Add vehicle tab - optimalizace pro mobil */
            #addVehicleTab {
                padding: 16px 12px !important;
                max-width: 100% !important;
            }

            #addVehicleTab .form-compact {
                grid-template-columns: 1fr !important;
                gap: 16px;
            }

            #addVehicleTab .form-group {
                margin-bottom: 16px;
            }

            #addVehicleTab .form-group input,
            #addVehicleTab .form-group select,
            #addVehicleTab .form-group textarea {
                width: 100%;
                min-height: 44px;
                font-size: 16px;
                padding: 12px;
            }

            #addVehicleTab .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
            }

            #addVehicleTab button {
                width: 100%;
                min-height: 44px;
                margin-top: 10px;
            }

            /* Navbar - optimalizace pro mobil */
            .navbar {
                padding: 12px 16px !important;
                flex-wrap: wrap;
            }

            .navbar-brand {
                font-size: 1rem;
            }

            .navbar-stats {
                font-size: 0.85rem;
                margin-top: 8px;
                width: 100%;
            }

            /* Karty vozidel - optimalizace pro mobil */
            .cards-grid {
                grid-template-columns: 1fr !important;
                gap: 16px;
            }

            .card {
                padding: 16px;
            }

            .card-header h3 {
                font-size: 1.1rem;
            }

            .card-body {
                font-size: 0.9rem;
            }

            /* Detail vozidla - optimalizace pro mobil */
            .vehicle-detail-content {
                grid-template-columns: 1fr !important;
                gap: 16px;
                margin: 16px 0;
            }

            .vehicle-detail-left,
            .vehicle-detail-right {
                padding: 16px;
            }

            .vehicle-info-item {
                padding: 12px;
                margin: 10px 0;
            }

            /* Add service form - optimalizace pro mobil */
            .add-service-form {
                padding: 16px;
                margin: 16px 0;
            }

            .add-service-form .form-row {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }
        }

        /* Velmi mal√© telefony (‚â§ 360px) */
        @media (max-width: 360px) {
            .header h1 {
                font-size: 1rem;
            }

            .content {
                margin: 8px !important;
                padding: 12px 10px 16px !important;
            }

            .auth-section {
                padding: 16px;
            }

            .btn {
                font-size: 14px;
                padding: 10px 16px;
            }
        }
    </style>
    
    <!-- Security Protection - Anti-debugging a ochrana k√≥du -->
    <!-- DOƒåASNƒö √öPLNƒö ZAK√ÅZ√ÅNO - zp≈Øsobovalo zmizen√≠ aplikace -->
    <!-- <script src="security_protection.js"></script> -->
</head>
<body>
    <div class="container">
        <!-- Navbar (pouze kdy≈æ je u≈æivatel p≈ôihl√°≈°en) -->
        <nav class="navbar hidden" id="mainNavbar">
            <div class="navbar-brand">
                <span class="logo">üöó</span>
                <span class="brand-text">TooZ Hub 2</span>
            </div>
            <div class="navbar-stats">
                <span id="userBadge" class="stat-badge hidden">
                    <strong>P≈ôihl√°≈°en jako:</strong> <span id="userEmail"></span>
                </span>
                <span id="serverStatus" class="stat-badge">
                    <div id="statusIndicator" style="width: 10px; height: 10px; border-radius: 50%; background: #ff6b6b; display: inline-block; margin-right: 6px;"></div>
                    <span id="statusText">Kontroluji server...</span>
                </span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <button id="configButton" class="config-button hidden" onclick="showApiUrlConfig()" title="Nastavit API URL (pouze pro admina)" style="background: transparent; border: none; font-size: 20px; cursor: pointer; padding: 5px;">‚öôÔ∏è</button>
                <button id="logout-btn" class="btn-logout hidden" onclick="handleLogout()">Odhl√°sit se</button>
            </div>
        </nav>

        <div class="content">
            <!-- Konfigurace API URL (pouze pro DEV) -->
            <div id="dev-api-url-panel" class="api-url-config hidden">
                <h3>üîß Nastaven√≠ API URL (DEV)</h3>
                <p style="margin: 10px 0; color: #856404;">
                    Pro lok√°ln√≠ v√Ωvoj m≈Ø≈æete nastavit vlastn√≠ API URL.
                    <br><strong>Postup:</strong>
                    <br>1. Zadejte URL va≈°eho API serveru (nap≈ô. http://127.0.0.1:8001)
                    <br>2. Kliknƒõte na "Ulo≈æit"
                </p>
                <div class="api-url-input-group">
                    <input type="text" id="apiUrlInput" placeholder="http://127.0.0.1:8001" value="">
                    <button onclick="saveApiUrl()">Ulo≈æit</button>
                    <button onclick="hideApiUrlConfig()" style="background: #6c757d; color: white;">Zav≈ô√≠t</button>
                </div>
                <p id="currentApiUrl" style="margin-top: 10px; font-size: 12px; color: #856404;"></p>
            </div>

            <!-- P≈ôihla≈°ovac√≠ sekce -->
            <div id="authSection" class="auth-section">
                <div id="alertContainer"></div>
                
                <div id="loginForm">
                    <h2 style="margin-bottom: 20px; text-align: center;">P≈ôihl√°≈°en√≠</h2>
                    <div class="form-group">
                        <label for="loginEmail">Email:</label>
                        <input type="email" id="loginEmail" placeholder="email@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Heslo:</label>
                        <input type="password" id="loginPassword" placeholder="Heslo" required>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="handleLogin()" style="flex: 1;">P≈ôihl√°sit se</button>
                        <button class="btn btn-secondary" onclick="showRegister()" style="flex: 1;">Registrace</button>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="#" onclick="handleForgotPassword(); return false;" style="color: #6366f1; text-decoration: none; font-size: 0.9em;">Zapomenut√© heslo?</a>
                    </div>
                    <div id="resetPasswordContainer" style="margin-top: 15px; min-height: 20px;"></div>
                    <div id="loginErrorContainer" style="margin-top: 15px; min-height: 20px;"></div>
                </div>

                <div id="registerForm" class="hidden">
                    <h2 style="margin-bottom: 20px; text-align: center;">Registrace</h2>
                    <div class="form-group">
                        <label for="regIco">IƒåO (pro automatick√© vyplnƒõn√≠ √∫daj≈Ø):</label>
                        <input type="text" id="regIco" placeholder="12345678" maxlength="8" style="width: 100%;">
                        <small style="color: #999; font-size: 0.85em; display: block; margin-top: 5px;">Po zad√°n√≠ 8 ƒç√≠slic se automaticky naƒçtou √∫daje z ARES</small>
                    </div>
                    <div id="aresDataFields" style="display: none; margin-top: 20px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border-left: 3px solid #6366f1;">
                        <div class="form-group">
                            <label for="regName">N√°zev firmy:</label>
                            <input type="text" id="regName" placeholder="Naƒçte se z ARES" readonly style="background: rgba(255,255,255,0.3);">
                        </div>
                        <div class="form-group">
                            <label for="regDic">DIƒå:</label>
                            <input type="text" id="regDic" placeholder="Naƒçte se z ARES" readonly style="background: rgba(255,255,255,0.3);">
                        </div>
                        <div class="form-group">
                            <label for="regStreet">Ulice:</label>
                            <input type="text" id="regStreet" placeholder="Naƒçte se z ARES" readonly style="background: rgba(255,255,255,0.3);">
                        </div>
                        <div class="form-group">
                            <label for="regStreetNumber">ƒå√≠slo popisn√©:</label>
                            <input type="text" id="regStreetNumber" placeholder="Naƒçte se z ARES" readonly style="background: rgba(255,255,255,0.3);">
                        </div>
                        <div class="form-group">
                            <label for="regCity">Mƒõsto:</label>
                            <input type="text" id="regCity" placeholder="Naƒçte se z ARES" readonly style="background: rgba(255,255,255,0.3);">
                        </div>
                        <div class="form-group">
                            <label for="regZip">PSƒå:</label>
                            <input type="text" id="regZip" placeholder="Naƒçte se z ARES" readonly style="background: rgba(255,255,255,0.3);">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="regEmail">Email *:</label>
                        <input type="email" id="regEmail" placeholder="email@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="regPhone">Telefon *:</label>
                        <input type="text" id="regPhone" placeholder="+420 123 456 789" required>
                    </div>
                    <div class="form-group">
                        <label for="regPassword">Heslo *:</label>
                        <input type="password" id="regPassword" placeholder="Heslo" required>
                    </div>
                    <div class="form-group">
                        <label for="regPasswordConfirm">Potvrzen√≠ hesla *:</label>
                        <input type="password" id="regPasswordConfirm" placeholder="Potvrzen√≠ hesla" required>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="handleRegister()" style="flex: 1;">Registrovat</button>
                        <button class="btn btn-secondary" onclick="showLogin()" style="flex: 1;">Zpƒõt na p≈ôihl√°≈°en√≠</button>
                    </div>
                    <div id="registerErrorContainer" style="margin-top: 15px; min-height: 20px;"></div>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="dashboard">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('vehicles')">Vozidla</button>
                    <button class="tab" onclick="switchTab('addVehicle')">P≈ôidat vozidlo</button>
                    <button class="tab" onclick="switchTab('reminders')">P≈ôipom√≠nky</button>
                    <button class="tab" onclick="switchTab('reservations')">Rezervace</button>
                    <button class="tab" onclick="switchTab('profile')">Profil</button>
                </div>

                <div id="vehiclesTab" class="tab-content active">
                    <div id="vehiclesList">
                        <h2>Moje vozidla</h2>
                        <div id="vehiclesContainer" class="loading">Naƒç√≠t√°m vozidla...</div>
                    </div>
                    
                    <!-- Detail vozidla -->
                    <div id="vehicleDetail" class="vehicle-detail">
                        <div class="vehicle-detail-header">
                            <h2 id="vehicleDetailTitle">Detail vozidla</h2>
                            <button class="back-button" onclick="showVehiclesList()">‚Üê Zpƒõt na seznam</button>
                        </div>
                        <div class="vehicle-detail-content">
                            <div class="vehicle-detail-left">
                                <h3>Data vozidla</h3>
                                <div id="vehicleDetailInfo"></div>
                            </div>
                            <div class="vehicle-detail-right">
                                <h3>Servisn√≠ √∫kony</h3>
                                <div id="serviceRecordsList" class="service-records-list"></div>
                                <div class="add-service-form">
                                    <h4>P≈ôidat nov√Ω servisn√≠ √∫kon</h4>
                                    <form id="addServiceForm" onsubmit="handleAddService(event)">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="serviceDate">Datum *:</label>
                                                <input type="datetime-local" id="serviceDate" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="serviceMileage">N√°jezd (km):</label>
                                                <input type="number" id="serviceMileage" min="0">
                                            </div>
                                        </div>
                                        <div class="form-row full-width">
                                            <div class="form-group">
                                                <label for="serviceDescription">Popis √∫konu *:</label>
                                                <textarea id="serviceDescription" rows="3" required placeholder="Nap≈ô. V√Ωmƒõna oleje, kontrola brzd..."></textarea>
                                            </div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="servicePrice">Cena (Kƒç):</label>
                                                <input type="number" id="servicePrice" min="0" step="0.01">
                                            </div>
                                            <div class="form-group">
                                                <label for="serviceNote">Kategorie/Pozn√°mka:</label>
                                                <input type="text" id="serviceNote" placeholder="Nap≈ô. Pravideln√° √∫dr≈æba, Oprava...">
                                            </div>
                                        </div>
                                        <button type="submit" class="btn">P≈ôidat servisn√≠ √∫kon</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="addVehicleTab" class="tab-content">
                    <h2>P≈ôidat nov√© vozidlo</h2>
                    <div class="form-compact">
                        <div class="form-group full-width">
                            <label for="vehicleVin">VIN (17 znak≈Ø):</label>
                            <input type="text" id="vehicleVin" placeholder="Zadejte VIN - automaticky se naƒçtou data" maxlength="17">
                        </div>
                        
                        <!-- Povinn√° pole - na zaƒç√°tku -->
                        <div class="form-group">
                            <label for="vehicleName">N√°zev vozidla *:</label>
                            <input type="text" id="vehicleName" placeholder="Moje auto" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="vehiclePlate">SPZ *:</label>
                            <input type="text" id="vehiclePlate" placeholder="1A2 3456" required>
                        </div>
                        
                        <!-- Z√°kladn√≠ informace o vozidle -->
                        <div class="form-group">
                            <label for="vehicleModel">Model:</label>
                            <input type="text" id="vehicleModel" placeholder="Naƒçte se z VIN">
                        </div>
                        
                        <div class="form-group">
                            <label for="vehicleYear">Rok:</label>
                            <input type="number" id="vehicleYear" placeholder="Naƒçte se z VIN" min="1900" max="2100">
                        </div>
                        
                        <div class="form-group">
                            <label for="vehicleEngine">Motor:</label>
                            <input type="text" id="vehicleEngine" placeholder="Naƒçte se z VIN">
                        </div>
                        
                        <!-- Kola a pneumatiky na n√°pravƒõ -->
                        <div class="form-group full-width">
                            <label for="vehicleTyres">Kola a pneumatiky na n√°pravƒõ - rozmƒõry/mont√°≈æ:</label>
                            <textarea id="vehicleTyres" placeholder="Naƒçte se z VIN" rows="2"></textarea>
                        </div>
                        
                        <!-- Dal≈°√≠ z√°znamy -->
                        <div class="form-group full-width">
                            <label for="vehicleAdditionalNotes">Dal≈°√≠ z√°znamy:</label>
                            <textarea id="vehicleAdditionalNotes" placeholder="Naƒçte se z VIN" rows="2"></textarea>
                        </div>
                        
                        <!-- Pravideln√° technick√° prohl√≠dka do -->
                        <div class="form-group">
                            <label for="vehicleInspectionDate">Pravideln√° technick√° prohl√≠dka do:</label>
                            <input type="text" id="vehicleInspectionDate" placeholder="Naƒçte se z VIN">
                        </div>
                        
                        <!-- Skryt√° pole pro ukl√°d√°n√≠ dat (nebudou se zobrazovat, ale pot≈ôebujeme je pro ukl√°d√°n√≠) -->
                        <input type="hidden" id="vehicleBrand">
                        <input type="hidden" id="vehicleType">
                        <input type="hidden" id="vehicleEngineCode">
                        <input type="hidden" id="vehicleMaxPower">
                        
                        <div class="form-group full-width">
                            <label for="vehicleNotes">Pozn√°mky:</label>
                            <textarea id="vehicleNotes" placeholder="Dal≈°√≠ pozn√°mky o vozidle" rows="3"></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 8px; align-items: center;">
                        <button class="btn" onclick="handleAddVehicle()" style="flex: 1;">P≈ôidat vozidlo</button>
                    </div>
                    <p style="margin-top: 6px; font-size: 10px; color: #666;">* Povinn√© pole</p>
                    <!-- Informaƒçn√≠ box o zdroj√≠ch dek√≥dovan√Ωch dat -->
                    <div id="vinSourceInfo" style="margin-top: 15px; padding: 12px; background: #e8f4f8; border-left: 4px solid #667eea; border-radius: 4px; font-size: 12px; color: #555; display: none;">
                        <strong>‚ÑπÔ∏è Informace:</strong> <span id="vinSourceText"></span>
                    </div>
                </div>

                <!-- P≈ôipom√≠nky tab -->
                <div id="remindersTab" class="tab-content">
                    <h2>P≈ôipom√≠nky</h2>
                    <div id="remindersContainer" class="loading">Naƒç√≠t√°m p≈ôipom√≠nky...</div>
                </div>

                <!-- Rezervace tab -->
                <div id="reservationsTab" class="tab-content">
                    <h2>Moje rezervace</h2>
                    <div id="reservationsContainer" class="loading">Naƒç√≠t√°m rezervace...</div>
                </div>

                <!-- Profil tab -->
                <div id="profileTab" class="tab-content">
                    <h2>M≈Øj profil</h2>
                    <div id="profileContainer" class="loading">Naƒç√≠t√°m profil...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Glob√°ln√≠ promƒõnn√©
        var API_URL = null; // Bude inicializov√°na po naƒçten√≠ DOM pomoc√≠ getApiBaseUrl()
        var currentUser = null;
        var accessToken = null; // JWT token pro autentizaci
        var serverStatusCheckInterval = null;
        
        // Helper funkce pro z√≠sk√°n√≠ location objektu (kompatibiln√≠ s Webnode i standardn√≠m prost≈ôed√≠m)
        function getLocation() {
            try {
                // Zkusit Webnode API (pokud je k dispozici)
                if (typeof wnd !== 'undefined' && wnd.fe && wnd.fe.Location) {
                    return wnd.fe.Location;
                }
            } catch (e) {
                console.warn('[APP] Webnode API nen√≠ dostupn√©, pou≈æ√≠v√°m window.location');
            }
            // Fallback na standardn√≠ window.location
            return window.location;
        }
        
        // API URL - centr√°ln√≠ funkce pro z√≠sk√°n√≠ BASE URL
        function getApiBaseUrl() {
            // PRODUKƒåN√ç RE≈ΩIM ‚Äì bƒõ≈æ√≠me na hub.toozservis.cz ‚Üí API je na stejn√©m originu
            if (window.location.hostname === "hub.toozservis.cz") {
                return window.location.origin;
            }
            
            // Pokud je aplikace vlo≈æena v iframe na toozservis.cz, pou≈æ√≠t hub.toozservis.cz
            try {
                // Zkusit detekovat, zda jsme v iframe (pokud je parent jin√Ω origin)
                if (window.self !== window.top) {
                    // Jsme v iframe - pou≈æ√≠t produkƒçn√≠ API URL
                    const parentHostname = window.top.location.hostname;
                    if (parentHostname && (parentHostname.includes('toozservis.cz') || parentHostname.includes('webnode.com'))) {
                        console.log('[API] Detekov√°n iframe na toozservis.cz - pou≈æ√≠v√°m hub.toozservis.cz');
                        return "https://hub.toozservis.cz";
                    }
                }
            } catch (e) {
                // Cross-origin iframe - nem≈Ø≈æeme p≈ôistupovat k window.top.location
                // Ale m≈Ø≈æeme pou≈æ√≠t produkƒçn√≠ URL pokud hostname obsahuje toozservis.cz
                if (window.location.hostname.includes('toozservis.cz') || window.location.hostname.includes('webnode.com')) {
                    console.log('[API] Detekov√°n cross-origin iframe - pou≈æ√≠v√°m hub.toozservis.cz');
                    return "https://hub.toozservis.cz";
                }
            }
            
            // DEV/LOK√ÅL ‚Äì nejd≈ô√≠v zkus√≠me localStorage, pak fallback na localhost
            const stored = localStorage.getItem("toozhub_api_url");
            if (stored && stored.trim() !== "") {
                return stored.trim();
            }
            
            // Fallback na localhost pro lok√°ln√≠ v√Ωvoj
            return "http://127.0.0.1:8001";
        }
        
        // Alias pro zpƒõtnou kompatibilitu
        function getApiUrl() {
            return getApiBaseUrl();
        }

        // Kontrola stavu serveru
        async function checkServerStatus() {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (!indicator || !statusText) return;
            
            // Pokud API_URL nen√≠ inicializov√°na, zkusit znovu
            if (!API_URL) {
                API_URL = getApiUrl();
            }
            
            // Pokud nen√≠ nastaven√° API URL, zobrazit varov√°n√≠ (jen pro admina)
            if (!API_URL) {
                indicator.className = 'status-offline';
                statusText.textContent = 'API URL nen√≠ nastavena';
                // Zobrazit konfiguraƒçn√≠ panel jen pro admina
                const location = getLocation();
                const urlParams = new URLSearchParams(location.search || '');
                if (urlParams.get('admin') === '1') {
                    showApiUrlConfig();
                }
                return;
            }
            
            try {
                indicator.className = 'status-checking';
                statusText.textContent = 'Kontroluji...';
                
                console.log('[STATUS] Kontroluji server na:', API_URL);
                
                const headers = {};
                
                const response = await fetch(`${API_URL}/health`, {
                    method: 'GET',
                    headers: headers,
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                console.log('[STATUS] Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('[STATUS] Server data:', data);
                    indicator.className = 'status-online';
                    statusText.textContent = 'Server online';
                } else {
                    const errorText = await response.text();
                    console.error('[STATUS] Server error:', response.status, errorText);
                    throw new Error(`Server neodpov√≠d√° (${response.status})`);
                }
            } catch (error) {
                indicator.className = 'status-offline';
                statusText.textContent = 'Server offline';
                console.error('[STATUS] Server status check failed:', error);
                console.error('[STATUS] API_URL:', API_URL);
                
                // Pokud jsme na toozservis.cz a server neodpov√≠d√°, zobrazit konfiguraci jen pro admina
                const location = getLocation();
                const hostname = location.hostname || '';
                if (hostname.includes('toozservis.cz') || 
                    hostname.includes('webnode.com')) {
                    const urlParams = new URLSearchParams(location.search || '');
                    if ((error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) && 
                        urlParams.get('admin') === '1') {
                        showApiUrlConfig();
                    }
                }
            }
        }

        // Zobrazen√≠ alertu
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
        
        // Zobrazen√≠ chyby ve st√°l√©m kontejneru pod formul√°≈ôem (nezanik√° automaticky)
        function showFormError(containerId, message) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `<div class="alert alert-error">${message}</div>`;
                // Scrollovat na chybu, aby byla viditeln√°
                container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                // Fallback na standardn√≠ alert
                showAlert(message, 'error');
            }
        }
        
        // Vyƒçi≈°tƒõn√≠ chyby ve formul√°≈ôi
        function clearFormError(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '';
            }
        }

        // API vol√°n√≠
        async function apiCall(endpoint, method = 'GET', data = null) {
            // Aktualizovat API_URL p≈ôi ka≈æd√©m vol√°n√≠ (pro p≈ô√≠pad zmƒõny)
            API_URL = getApiBaseUrl();
            
            if (!API_URL) {
                const location = getLocation();
                const urlParams = new URLSearchParams(location.search || '');
                if (urlParams.get('admin') === '1') {
                    showApiUrlConfig();
                }
                throw new Error('API URL nen√≠ nastavena. Kontaktujte administr√°tora.');
            }
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            // P≈ôidat JWT token do headeru (preferovan√° metoda)
            if (accessToken) {
                headers['Authorization'] = `Bearer ${accessToken}`;
                console.log('[API] Using JWT token for authentication');
            } else if (currentUser && currentUser.email) {
                // Fallback na X-User-Email header (legacy)
                headers['X-User-Email'] = currentUser.email;
                console.log('[API] Fallback to X-User-Email header:', currentUser.email);
            }

            const options = {
                method,
                headers
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const url = `${API_URL}${endpoint}`;
                console.log(`[API] ${method} ${url}`, data ? { data } : '');
                
                // P≈ôidat mode: 'cors' pro CORS po≈æadavky
                options.mode = 'cors';
                options.cache = 'no-cache';
                
                const response = await fetch(url, options);
                
                console.log(`[API] Response status: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`[API] Response:`, result);
                    return result;
                } else {
                    // Automatick√© odhl√°≈°en√≠ p≈ôi 401 (Unauthorized)
                    if (response.status === 401) {
                        console.warn('[API] 401 Unauthorized - automatick√© odhl√°≈°en√≠');
                        handleLogout();
                        throw new Error('Va≈°e relace vypr≈°ela. Pros√≠m p≈ôihlaste se znovu.');
                    }
                    
                    let errorMessage = 'Chyba p≈ôi komunikaci s API';
                    try {
                        const error = await response.json();
                        errorMessage = error.detail || error.message || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('[API] Error:', error);
                // Pokud je to network error, poskytnout u≈æiteƒçnƒõj≈°√≠ zpr√°vu
                if (error.message === 'Failed to fetch' || error.name === 'TypeError') {
                    throw new Error('Nepoda≈ôilo se p≈ôipojit k serveru. Zkontrolujte, zda server bƒõ≈æ√≠ a API URL je spr√°vnƒõ nastavena.');
                }
                throw error;
            }
        }

        // Nastaven√≠ DEV API URL panelu (skr√Ωt v produkci)
        function setupDevApiUrlPanel() {
            const panel = document.getElementById('dev-api-url-panel');
            if (!panel) return;
            
            if (window.location.hostname === "hub.toozservis.cz") {
                // V produkci panel schov√°me
                panel.style.display = "none";
            } else {
                // V DEV zobraz√≠me, pokud je pot≈ôeba
                panel.style.display = "block";
            }
        }
        
        // Zobrazen√≠ konfigurace API URL
        function showApiUrlConfig() {
            const configPanel = document.getElementById('dev-api-url-panel');
            const input = document.getElementById('apiUrlInput');
            const currentUrl = document.getElementById('currentApiUrl');
            
            if (configPanel) {
                configPanel.classList.remove('hidden');
                const savedUrl = localStorage.getItem('toozhub_api_url');
                if (savedUrl) {
                    input.value = savedUrl;
                    currentUrl.textContent = `Aktu√°ln√≠ URL: ${savedUrl}`;
                } else {
                    currentUrl.textContent = 'API URL nen√≠ nastavena (pou≈æije se v√Ωchoz√≠: http://127.0.0.1:8001)';
                }
            }
        }

        // Skryt√≠ konfigurace API URL
        function hideApiUrlConfig() {
            const configPanel = document.getElementById('dev-api-url-panel');
            if (configPanel) {
                configPanel.classList.add('hidden');
            }
        }

        // Ulo≈æen√≠ API URL
        function saveApiUrl() {
            const input = document.getElementById('apiUrlInput');
            let url = input.value.trim();
            
            if (!url) {
                // Pokud je pr√°zdn√©, smazat ulo≈æenou URL (pou≈æije se v√Ωchoz√≠)
                localStorage.removeItem('toozhub_api_url');
                API_URL = getApiBaseUrl();
                showAlert('API URL byla vymaz√°na. Pou≈æije se v√Ωchoz√≠ URL.', 'success');
                setTimeout(() => {
                    checkServerStatus();
                    location.reload(); // Reload pro aktualizaci
                }, 500);
                return;
            }
            
            // Automaticky p≈ôidat https:// pokud chyb√≠ (pokud nen√≠ localhost)
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                if (url.includes('localhost') || url.includes('127.0.0.1')) {
                    url = 'http://' + url;
                } else {
                    url = 'https://' + url;
                }
            }
            
            // Validace URL
            try {
                new URL(url);
            } catch (e) {
                showAlert('Neplatn√° URL. Zadejte pros√≠m platnou URL (nap≈ô. http://127.0.0.1:8001)', 'error');
                return;
            }
            
            // Ulo≈æit do localStorage s nov√Ωm kl√≠ƒçem
            localStorage.setItem('toozhub_api_url', url);
            API_URL = url;
            
            // Aktualizovat input pole
            input.value = url;
            
            // Aktualizovat zobrazen√≠
            const currentUrl = document.getElementById('currentApiUrl');
            currentUrl.textContent = `Aktu√°ln√≠ URL: ${url}`;
            
            showAlert('API URL byla ulo≈æena. Kontroluji p≈ôipojen√≠...', 'success');
            
            // Zkontrolovat stav serveru a reload pro aktualizaci
            setTimeout(() => {
                checkServerStatus();
                location.reload(); // Reload pro aktualizaci v≈°ech API vol√°n√≠
            }, 500);
        }

        // P≈ôihl√°≈°en√≠
        async function handleLogin() {
            // Vyƒçistit p≈ôedchoz√≠ chyby
            const errorContainer = document.getElementById('loginErrorContainer');
            if (errorContainer) {
                errorContainer.innerHTML = '';
            }
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showFormError('loginErrorContainer', 'Vypl≈àte pros√≠m email a heslo');
                return;
            }
            
            // Validace emailu
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showFormError('loginErrorContainer', 'Neplatn√Ω form√°t emailu');
                return;
            }

            try {
                const response = await apiCall('/user/login', 'POST', { email, password });
                // Nov√Ω form√°t odpovƒõdi: { access_token, token_type, user }
                if (response.access_token) {
                    accessToken = response.access_token;
                    currentUser = response.user;
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('currentUser', JSON.stringify(response.user));
                    localStorage.setItem('wasLoggedIn', 'true'); // Flag pro obnoven√≠ p≈ôi n√°vratu
                } else {
                    // Legacy form√°t (pro kompatibilitu)
                    currentUser = response;
                    localStorage.setItem('currentUser', JSON.stringify(response));
                    localStorage.setItem('wasLoggedIn', 'true'); // Flag pro obnoven√≠ p≈ôi n√°vratu
                }
                // Vyƒçistit chyby p≈ôed p≈ôesmƒõrov√°n√≠m
                if (errorContainer) {
                    errorContainer.innerHTML = '';
                }
                showDashboard();
                showAlert('P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©!', 'success');
            } catch (error) {
                const errorMessage = error.message || 'Nepoda≈ôilo se p≈ôihl√°sit';
                showFormError('loginErrorContainer', errorMessage);
            }
        }
        
        // Zapomenut√© heslo
        async function handleForgotPassword() {
            // Vyƒçistit p≈ôedchoz√≠ zpr√°vy
            const resetContainer = document.getElementById('resetPasswordContainer');
            if (resetContainer) {
                resetContainer.innerHTML = '';
            }
            
            const email = prompt('Zadejte email pro obnoven√≠ hesla:');
            if (!email) {
                if (resetContainer) {
                    resetContainer.innerHTML = '';
                }
                return;
            }
            
            // Validace emailu
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showFormError('resetPasswordContainer', 'Neplatn√Ω form√°t emailu');
                return;
            }
            
            // Zobrazit naƒç√≠t√°n√≠
            if (resetContainer) {
                resetContainer.innerHTML = '<div class="alert alert-info">Odes√≠l√°m reset odkaz na email...</div>';
            }
            
            try {
                const response = await apiCall('/user/forgot-password', 'POST', { email });
                
                // Zkontrolovat, zda email byl odesl√°n
                if (response.email_sent) {
                    // Email byl odesl√°n
                    if (resetContainer) {
                        resetContainer.innerHTML = '<div class="alert alert-success">Reset odkaz byl odesl√°n na email: ' + email + '<br>Zkontrolujte pros√≠m svou emailovou schr√°nku (i slo≈æku spam).</div>';
                    }
                } else if (response.reset_url) {
                    // Email nen√≠ nakonfigurov√°n, zobrazit reset URL
                    const resetUrl = response.reset_url;
                    if (resetContainer) {
                        resetContainer.innerHTML = `
                            <div class="alert alert-warning" style="background: rgba(251, 191, 36, 0.15); color: #fcd34d; border: 2px solid rgba(251, 191, 36, 0.5);">
                                <strong>Email nen√≠ nakonfigurov√°n</strong><br><br>
                                Reset odkaz pro testov√°n√≠:<br>
                                <a href="${resetUrl}" target="_blank" style="color: #fbbf24; word-break: break-all; text-decoration: underline;">${resetUrl}</a><br><br>
                                <small>Zkop√≠rujte odkaz a otev≈ôete v prohl√≠≈æeƒçi, nebo kliknƒõte na odkaz v√Ω≈°e.</small>
                            </div>
                        `;
                    }
                    console.log('[RESET] Reset URL:', resetUrl);
                } else if (response.error) {
                    // Chyba p≈ôi odes√≠l√°n√≠
                    let errorMsg = response.message || 'Email nebyl odesl√°n. Zkontrolujte konfiguraci SMTP v logu serveru.';
                    
                    // Pokud je k dispozici reset URL, zobrazit ho tak√©
                    if (response.reset_url) {
                        const resetUrl = response.reset_url;
                        errorMsg += '\n\nReset odkaz pro testov√°n√≠:';
                        if (resetContainer) {
                            resetContainer.innerHTML = `
                                <div class="alert alert-error">
                                    <strong>Chyba p≈ôi odes√≠l√°n√≠ emailu:</strong><br>
                                    ${errorMsg.replace(/\n/g, '<br>')}
                                    <br><br>
                                    <strong>Reset odkaz pro testov√°n√≠:</strong><br>
                                    <a href="${resetUrl}" target="_blank" style="color: #fbbf24; word-break: break-all; text-decoration: underline;">${resetUrl}</a>
                                    <br><br>
                                    <small>Zkop√≠rujte odkaz a otev≈ôete v prohl√≠≈æeƒçi, nebo kliknƒõte na odkaz v√Ω≈°e.</small>
                                    ${response.error_detail ? `<br><br><small style="color: #9ca3af;">Detail: ${response.error_detail}</small>` : ''}
                                </div>
                            `;
                        }
                    } else {
                        showFormError('resetPasswordContainer', errorMsg + (response.error_detail ? '\n\nDetail: ' + response.error_detail : ''));
                    }
                    console.error('[RESET] Email error:', response.error);
                    if (response.error_detail) {
                        console.error('[RESET] Error detail:', response.error_detail);
                    }
                } else {
                    // Obecn√° zpr√°va (bezpeƒçnostn√≠ - neodhalit, zda email existuje)
                    if (resetContainer) {
                        resetContainer.innerHTML = '<div class="alert alert-info">Pokud email existuje, byl odesl√°n reset odkaz. Zkontrolujte pros√≠m svou emailovou schr√°nku.</div>';
                    }
                }
            } catch (error) {
                const errorMessage = error.message || 'Nezn√°m√° chyba';
                showFormError('resetPasswordContainer', 'Nepoda≈ôilo se odeslat reset odkaz: ' + errorMessage);
                console.error('[RESET] Error:', error);
            }
        }

        // Naƒçten√≠ dat z ARES
        async function loadAresData() {
            const ico = document.getElementById('regIco').value.trim();
            
            if (!ico) {
                showAlert('Zadejte pros√≠m IƒåO', 'error');
                return;
            }
            
            if (ico.length !== 8 || !/^\d+$/.test(ico)) {
                showAlert('IƒåO mus√≠ m√≠t 8 ƒç√≠slic', 'error');
                return;
            }
            
            try {
                showAlert('Naƒç√≠t√°m data z ARES...', 'info');
                const data = await apiCall(`/user/ares?ico=${ico}`, 'GET');
                
                console.log('[ARES] Naƒçten√° data:', data);
                
                // Normalizace dat z ARES API (stejnƒõ jako v service.py)
                let normalized = {};
                
                // Pokud backend vrac√≠ strukturu podobnou ARES API (s "sidlo" objektem)
                if (data.sidlo) {
                    const sidlo = data.sidlo;
                    
                    // Extrahov√°n√≠ n√°zvu
                    if (data.obchodniJmeno) {
                        normalized.nazev = data.obchodniJmeno;
                    } else if (data.nazev) {
                        normalized.nazev = data.nazev;
                    } else if (data.name) {
                        normalized.nazev = data.name;
                    }
                    
                    // Extrahov√°n√≠ adresy ze s√≠dla
                    if (sidlo.nazevUlice) {
                        normalized.ulice = sidlo.nazevUlice;
                    } else if (sidlo.nazevObce) {
                        // Pokud nen√≠ ulice, pou≈æijeme n√°zev obce jako ulici
                        normalized.ulice = sidlo.nazevObce;
                    } else if (data.ulice) {
                        normalized.ulice = data.ulice;
                    } else if (data.street) {
                        normalized.ulice = data.street;
                    }
                    
                    // ƒå√≠slo popisn√© z s√≠dla
                    if (sidlo.cisloDomovni !== undefined) {
                        let cislo_popisne = String(sidlo.cisloDomovni);
                        if (sidlo.cisloOrientacni !== undefined) {
                            cislo_popisne += '/' + String(sidlo.cisloOrientacni);
                            if (sidlo.cisloOrientacniPismeno) {
                                cislo_popisne += sidlo.cisloOrientacniPismeno;
                            }
                        }
                        normalized.cislo_popisne = cislo_popisne;
                    } else if (data.cislo_popisne) {
                        normalized.cislo_popisne = data.cislo_popisne;
                    } else if (data.street_number) {
                        normalized.cislo_popisne = data.street_number;
                    }
                    
                    // Mƒõsto
                    if (sidlo.nazevObce) {
                        normalized.mesto = sidlo.nazevObce;
                    } else if (data.mesto) {
                        normalized.mesto = data.mesto;
                    } else if (data.city) {
                        normalized.mesto = data.city;
                    }
                    
                    // PSƒå
                    if (sidlo.psc !== undefined) {
                        normalized.psc = String(sidlo.psc);
                    } else if (data.psc) {
                        normalized.psc = data.psc;
                    } else if (data.zip) {
                        normalized.psc = data.zip;
                    }
                } else {
                    // Backend vrac√≠ plochou strukturu
                    normalized.nazev = data.nazev || data.name || data.obchodniJmeno || '';
                    normalized.ulice = data.ulice || data.street || '';
                    normalized.cislo_popisne = data.cislo_popisne || data.street_number || '';
                    normalized.mesto = data.mesto || data.city || '';
                    normalized.psc = data.psc || data.zip || '';
                }
                
                // DIƒå (je v≈ædy na nejvy≈°≈°√≠ √∫rovni)
                if (data.dic) {
                    normalized.dic = data.dic;
                } else if (data.tax_id) {
                    normalized.dic = data.tax_id;
                }
                
                console.log('[ARES] Normalizovan√° data:', normalized);
                
                // Vyplnƒõn√≠ pol√≠ podle normalizovan√Ωch dat
                if (normalized.nazev) {
                    document.getElementById('regName').value = normalized.nazev;
                }
                if (normalized.dic) {
                    document.getElementById('regDic').value = normalized.dic;
                }
                if (normalized.ulice) {
                    document.getElementById('regStreet').value = normalized.ulice;
                }
                if (normalized.cislo_popisne) {
                    document.getElementById('regStreetNumber').value = normalized.cislo_popisne;
                }
                if (normalized.mesto) {
                    document.getElementById('regCity').value = normalized.mesto;
                }
                if (normalized.psc) {
                    document.getElementById('regZip').value = normalized.psc;
                }
                // Telefon nen√≠ v ARES API, tak≈æe ho nech√°me pr√°zdn√Ω
                
                // Zobrazit pole s ARES daty po √∫spƒõ≈°n√©m naƒçten√≠
                const aresFields = document.getElementById('aresDataFields');
                if (aresFields) {
                    aresFields.style.display = 'block';
                }
                
                showAlert('Data z ARES byla √∫spƒõ≈°nƒõ naƒçtena', 'success');
            } catch (error) {
                showAlert('Nepoda≈ôilo se naƒç√≠st data z ARES: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
                console.error('[ARES] Error:', error);
            }
        }

        // Registrace
        async function handleRegister() {
            // Vyƒçistit p≈ôedchoz√≠ chyby
            const errorContainer = document.getElementById('registerErrorContainer');
            if (errorContainer) {
                errorContainer.innerHTML = '';
            }
            
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;
            const ico = document.getElementById('regIco').value.trim();
            const name = document.getElementById('regName').value.trim();
            const dic = document.getElementById('regDic').value.trim();
            const street = document.getElementById('regStreet').value.trim();
            const streetNumber = document.getElementById('regStreetNumber').value.trim();
            const city = document.getElementById('regCity').value.trim();
            const zip = document.getElementById('regZip').value.trim();
            const phone = document.getElementById('regPhone').value.trim();

            if (!email || !password) {
                showFormError('registerErrorContainer', 'Vypl≈àte pros√≠m email a heslo');
                return;
            }
            
            // Validace emailu
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showFormError('registerErrorContainer', 'Neplatn√Ω form√°t emailu');
                return;
            }
            
            // Validace hesla
            if (password.length < 6) {
                showFormError('registerErrorContainer', 'Heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø');
                return;
            }
            
            if (password !== passwordConfirm) {
                showFormError('registerErrorContainer', 'Hesla se neshoduj√≠');
                return;
            }

            try {
                showAlert('Registruji u≈æivatele...', 'info');
                const response = await apiCall('/user/register', 'POST', {
                    email,
                    password,
                    ico: ico || null,
                    name: name || null,
                    dic: dic || null,
                    street: street || null,
                    street_number: streetNumber || null,
                    city: city || null,
                    zip: zip || null,
                    phone: phone || null
                });
                // Nov√Ω form√°t odpovƒõdi: { access_token, token_type, user }
                if (response.access_token) {
                    accessToken = response.access_token;
                    currentUser = response.user;
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('currentUser', JSON.stringify(response.user));
                    localStorage.setItem('wasLoggedIn', 'true'); // Flag pro obnoven√≠ p≈ôi n√°vratu
                } else {
                    // Legacy form√°t
                    currentUser = response;
                    localStorage.setItem('currentUser', JSON.stringify(response));
                    localStorage.setItem('wasLoggedIn', 'true'); // Flag pro obnoven√≠ p≈ôi n√°vratu
                }
                // Vyƒçistit chyby p≈ôed p≈ôesmƒõrov√°n√≠m
                if (errorContainer) {
                    errorContainer.innerHTML = '';
                }
                showDashboard();
                showAlert('Registrace √∫spƒõ≈°n√°!', 'success');
            } catch (error) {
                console.error('Registration error:', error);
                const errorMessage = error.message || 'Nezn√°m√° chyba';
                // Zpracovat specifick√© chybov√© zpr√°vy z API
                let displayMessage = 'Nepoda≈ôilo se zaregistrovat';
                if (errorMessage.includes('ji≈æ existuje') || errorMessage.includes('already exists')) {
                    displayMessage = 'U≈æivatel s t√≠mto emailem ji≈æ existuje. Pou≈æijte jin√Ω email nebo se p≈ôihlaste.';
                } else if (errorMessage.includes('Heslo mus√≠ m√≠t')) {
                    displayMessage = errorMessage;
                } else {
                    displayMessage = `Nepoda≈ôilo se zaregistrovat: ${errorMessage}`;
                }
                showFormError('registerErrorContainer', displayMessage);
            }
        }

        // Odhl√°≈°en√≠
        function handleLogout() {
            // Zastavit sledov√°n√≠ aktivity
            stopInactivityTimer();
            
            currentUser = null;
            accessToken = null;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('accessToken');
            localStorage.removeItem('wasLoggedIn'); // Odstranit flag p≈ôi odhl√°≈°en√≠
            
            const authSection = document.getElementById('authSection');
            const dashboard = document.getElementById('dashboard');
            const navbar = document.getElementById('mainNavbar');
            const userBadge = document.getElementById('userBadge');
            const logoutBtn = document.getElementById('logout-btn');
            
            // Skr√Ωt navbar
            if (navbar) {
                navbar.classList.add('hidden');
            }
            if (userBadge) {
                userBadge.classList.add('hidden');
            }
            if (logoutBtn) {
                logoutBtn.classList.add('hidden');
            }
            
            if (authSection) {
                authSection.classList.remove('hidden');
                authSection.style.display = 'block';
            }
            
            if (dashboard) {
                dashboard.classList.remove('active');
                dashboard.style.display = 'none';
            }
            
            showLogin();
        }

        // Sledov√°n√≠ aktivity pro automatick√© odhl√°≈°en√≠
        let inactivityTimer = null;
        let inactivityTimeout = 15 * 60 * 1000; // 15 minut v milisekund√°ch
        
        function resetInactivityTimer() {
            // Zru≈°it st√°vaj√≠c√≠ timer
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
            }
            
            // Pokud je u≈æivatel p≈ôihl√°≈°en, nastavit nov√Ω timer
            if (currentUser && accessToken) {
                inactivityTimer = setTimeout(() => {
                    console.log('[INACTIVITY] U≈æivatel byl neƒçinn√Ω 15 minut - automatick√© odhl√°≈°en√≠');
                    showAlert('Byl jste automaticky odhl√°≈°en kv≈Øli neƒçinnosti (15 minut).', 'warning');
                    handleLogout();
                }, inactivityTimeout);
            }
        }
        
        function stopInactivityTimer() {
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
                inactivityTimer = null;
            }
        }
        
        function setupActivityTracking() {
            // Eventy pro sledov√°n√≠ aktivity
            const activityEvents = [
                'mousedown',
                'mousemove',
                'keypress',
                'scroll',
                'touchstart',
                'click'
            ];
            
            // P≈ôidat event listenery pro v≈°echny aktivitn√≠ eventy
            activityEvents.forEach(event => {
                document.addEventListener(event, resetInactivityTimer, true);
            });
            
            // Sledovat zmƒõny viditelnosti str√°nky (Page Visibility API)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // Str√°nka je skryt√° - pozastavit timer
                    console.log('[INACTIVITY] Str√°nka je skryt√° - pozastaven√≠ timeru');
                    stopInactivityTimer();
                } else {
                    // Str√°nka je viditeln√° - resetovat timer
                    console.log('[INACTIVITY] Str√°nka je viditeln√° - resetov√°n√≠ timeru');
                    resetInactivityTimer();
                }
            });
            
            console.log('[INACTIVITY] Sledov√°n√≠ aktivity inicializov√°no');
        }
        
        // Zobrazen√≠ dashboardu
        function showDashboard() {
            const authSection = document.getElementById('authSection');
            const dashboard = document.getElementById('dashboard');
            const userEmailEl = document.getElementById('userEmail');
            const navbar = document.getElementById('mainNavbar');
            const userBadge = document.getElementById('userBadge');
            const logoutBtn = document.getElementById('logout-btn');
            
            if (!authSection || !dashboard) {
                console.error('[DASHBOARD] authSection nebo dashboard neexistuje!');
                return;
            }
            
            // Skr√Ωt auth section
            authSection.classList.add('hidden');
            authSection.style.display = 'none';
            
            // Zobrazit navbar
            if (navbar) {
                navbar.classList.remove('hidden');
            }
            
            // Zobrazit dashboard
            dashboard.classList.add('active');
            dashboard.style.display = 'block';
            
            // Zobrazit badge u≈æivatele a logout button
            if (userEmailEl && currentUser) {
                userEmailEl.textContent = currentUser.email;
                if (userBadge) {
                    userBadge.classList.remove('hidden');
                }
            }
            if (logoutBtn) {
                logoutBtn.classList.remove('hidden');
            }
            
            // Spustit sledov√°n√≠ aktivity p≈ôi p≈ôihl√°≈°en√≠
            resetInactivityTimer();
            
            loadVehicles();
        }

        // Naƒçten√≠ vozidel
        async function loadVehicles() {
            const container = document.getElementById('vehiclesContainer');
            if (!container) {
                console.error('[VEHICLES] Container not found - dashboard mo≈æn√° nen√≠ zobrazen');
                return;
            }
            container.innerHTML = '<div class="loading">Naƒç√≠t√°m vozidla...</div>';
            try {
                const vehicles = await apiCall('/api/v1/vehicles', 'GET');
                
                if (!vehicles || vehicles.length === 0) {
                    container.innerHTML = '<p>Zat√≠m nem√°te ≈æ√°dn√° vozidla. P≈ôidejte prvn√≠ vozidlo pomoc√≠ tlaƒç√≠tka "P≈ôidat vozidlo".</p>';
                    return;
                }
                
                let html = '<div class="cards-grid">';
                vehicles.forEach(vehicle => {
                    // Form√°tov√°n√≠ STK platnosti - zkontrolovat datab√°zi i pozn√°mky
                    let stkText = 'Nezad√°no';
                    
                    // 1. Zkusit naƒç√≠st z datab√°ze (stk_valid_until)
                    if (vehicle.stk_valid_until) {
                        try {
                            const stkDate = new Date(vehicle.stk_valid_until);
                            if (!isNaN(stkDate.getTime())) {
                                stkText = stkDate.toLocaleDateString('cs-CZ');
                            }
                        } catch (e) {
                            stkText = vehicle.stk_valid_until;
                        }
                    }
                    
                    // 2. Pokud nen√≠ v datab√°zi, zkusit naj√≠t v pozn√°mk√°ch
                    if (stkText === 'Nezad√°no' && vehicle.notes) {
                        const notesText = vehicle.notes;
                        // Hledat r≈Øzn√© form√°ty STK datumu v pozn√°mk√°ch
                        const stkPatterns = [
                            /Technick√° prohl√≠dka do:\s*(\d{4}-\d{2}-\d{2})/i,
                            /STK platnost do:\s*(\d{4}-\d{2}-\d{2})/i,
                            /STK do:\s*(\d{4}-\d{2}-\d{2})/i,
                            /platnost STK.*?(\d{4}-\d{2}-\d{2})/i,
                            /(\d{4}-\d{2}-\d{2}).*?STK/i
                        ];
                        
                        for (const pattern of stkPatterns) {
                            const match = notesText.match(pattern);
                            if (match && match[1]) {
                                try {
                                    const stkDate = new Date(match[1]);
                                    if (!isNaN(stkDate.getTime())) {
                                        stkText = stkDate.toLocaleDateString('cs-CZ');
                                        break;
                                    }
                                } catch (e) {
                                    // Pokraƒçovat na dal≈°√≠ pattern
                                }
                            }
                        }
                    }
                    
                    // Form√°tov√°n√≠ motoru - obsah, k√≥d motoru m√≠sto "nm"
                    let engineText = 'Nezad√°no';
                    if (vehicle.engine) {
                        engineText = vehicle.engine;
                        
                        // Pokusit naj√≠t k√≥d motoru z pozn√°mek a nahradit "/ nm" za "/ [k√≥d motoru]"
                        let engineCode = null;
                        
                        // 1. Zkusit naj√≠t v pozn√°mk√°ch - hledat pouze specifick√© form√°ty k√≥du motoru
                        if (vehicle.notes) {
                            const notesText = vehicle.notes;
                            
                            // Nejd≈ô√≠v zkusit naj√≠t ve form√°tu "Typ: X, CFGB" (kde X je typ motoru a CFGB je k√≥d)
                            const typePattern = /Typ:\s*([^,\n]+),\s*([A-Z0-9]{4,6})/i;
                            const typeMatch = notesText.match(typePattern);
                            if (typeMatch && typeMatch[2]) {
                                const code = typeMatch[2].trim();
                                    // Ovƒõ≈ôit, ≈æe to vypad√° jako k√≥d motoru (3-6 znak≈Ø pro Peugeot/Citroen/Fiat)
                                    if (/^[A-Z0-9]{3,6}$/.test(code)) {
                                        const knownModels = ['SUPERB', 'V50', 'BOXER', 'PASSAT', 'OCTAVIA', 'MW75', 'TRANSPORTER'];
                                        if (!knownModels.includes(code)) {
                                            engineCode = code;
                                        }
                                    }
                            }
                            
                            // Pokud nena≈°li, zkusit dal≈°√≠ form√°ty
                            if (!engineCode) {
                                const engineCodePatterns = [
                                    /Typ motoru:.*?,\s*([A-Z0-9]{4,6})/i,  // "Typ motoru: 2 NM, CFGB"
                                    /K√≥d motoru:\s*([A-Z0-9]{4,6})/i,  // "K√≥d motoru: CFGB"
                                    /Motor k√≥d:\s*([A-Z0-9]{4,6})/i,  // "Motor k√≥d: CFGB"
                                ];
                                
                                for (const pattern of engineCodePatterns) {
                                    const match = notesText.match(pattern);
                                    if (match && match[1]) {
                                        const code = match[1].trim();
                                        // Podporovat 3-6 znak≈Ø pro r≈Øzn√© znaƒçky (Peugeot/Citroen/Fiat maj√≠ krat≈°√≠ k√≥dy)
                                        if (/^[A-Z0-9]{3,6}$/.test(code)) {
                                            const knownModels = ['SUPERB', 'V50', 'BOXER', 'PASSAT', 'OCTAVIA', 'MW75', 'TRANSPORTER'];
                                            if (!knownModels.includes(code)) {
                                                engineCode = code;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        
                        // 2. Zkusit naj√≠t k√≥d motoru p≈ô√≠mo v engine poli pouze pokud je to skuteƒçnƒõ k√≥d motoru
                        // (nikoli model vozidla - nap≈ô. "SUPERB" nen√≠ k√≥d motoru)
                        if (!engineCode && engineText.includes(',')) {
                            const parts = engineText.split(',');
                            if (parts.length > 1) {
                                const lastPart = parts[parts.length - 1].trim();
                                // Ovƒõ≈ôit, ≈æe to vypad√° jako k√≥d motoru (3-6 znak≈Ø pro r≈Øzn√© znaƒçky)
                                if (/^[A-Z0-9]{3,6}$/.test(lastPart)) {
                                    // Vylouƒçit zn√°m√© modely
                                    const knownModels = ['SUPERB', 'V50', 'BOXER', 'PASSAT', 'OCTAVIA', 'TRANSPORTER'];
                                    if (!knownModels.includes(lastPart)) {
                                        engineCode = lastPart;
                                    }
                                }
                            }
                        }
                        
                        // 3. Zkontrolovat, jestli u≈æ nen√≠ k√≥d motoru na konci engineText (po ƒç√°rce)
                        let existingCodeAtEnd = null;
                        if (engineText.includes(',')) {
                            const parts = engineText.split(',');
                            if (parts.length > 1) {
                                const lastPart = parts[parts.length - 1].trim();
                                // Pokud vypad√° jako k√≥d motoru (3-6 velk√Ωch p√≠smen/ƒç√≠sel)
                                if (/^[A-Z0-9]{3,6}$/.test(lastPart)) {
                                    const knownModels = ['SUPERB', 'V50', 'BOXER', 'PASSAT', 'OCTAVIA', 'TRANSPORTER'];
                                    if (!knownModels.includes(lastPart)) {
                                        existingCodeAtEnd = lastPart;
                                    }
                                }
                            }
                        }
                        
                        // 4. Pokud m√°me k√≥d motoru (z pozn√°mek nebo z engine pole), pou≈æ√≠t ho
                        const finalEngineCode = engineCode || existingCodeAtEnd;
                        
                        if (finalEngineCode) {
                            // Nejd≈ô√≠v odstranit "/ nm"
                            engineText = engineText.replace(/\s*\/\s*nm\s*$/i, '');
                            engineText = engineText.replace(/\s*\/\s*nm\s*/i, '');
                            
                            // Odstranit k√≥d motoru na konci (pokud tam u≈æ je po ƒç√°rce) - escape regex znak≈Ø
                            const escapedCode = finalEngineCode.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                            engineText = engineText.replace(new RegExp(`,\\s*${escapedCode}\\s*$`, 'i'), '');
                            
                            // Odstranit mezery na konci
                            engineText = engineText.trim();
                            
                            // P≈ôidat k√≥d motoru za posledn√≠ "/" (pouze jednou)
                            if (!engineText.endsWith(finalEngineCode)) {
                                engineText = engineText + ' / ' + finalEngineCode;
                            }
                        } else {
                            // Pokud nen√≠ k√≥d motoru, odstranit "/ nm" √∫plnƒõ
                            engineText = engineText.replace(/\s*\/\s*nm\s*$/i, '');
                            engineText = engineText.replace(/\s*\/\s*nm\s*/i, '');
                            // Odstranit p≈ô√≠padn√© zbyl√© ƒç√°rky na konci
                            engineText = engineText.replace(/,\s*$/, '');
                        }
                    }
                    
                    // Form√°tov√°n√≠ n√°zvu s rokem v√Ωroby
                    const vehicleName = vehicle.nickname || 'Bez n√°zvu';
                    const vehicleYear = vehicle.year || null;
                    let nameDisplay = vehicleName;
                    let yearDisplay = '';
                    
                    // Pokud m√°me rok a n√°zev je krat≈°√≠ ne≈æ 20 znak≈Ø, zobrazit rok pod n√°zvem
                    // Pokud je n√°zev del≈°√≠, zobrazit rok v z√°vork√°ch za n√°zvem
                    if (vehicleYear) {
                        const nameLength = vehicleName.length;
                        if (nameLength > 20) {
                            // Dlouh√Ω n√°zev - rok v z√°vork√°ch za n√°zvem
                            nameDisplay = `${vehicleName} (${vehicleYear})`;
                        } else {
                            // Kr√°tk√Ω n√°zev - rok pod n√°zvem
                            yearDisplay = `<p class="vehicle-year">${vehicleYear}</p>`;
                        }
                    }
                    
                    html += `
                        <div class="card" onclick="showVehicleDetail(${vehicle.id})" style="cursor: pointer;">
                            <div class="card-header">
                                <h3 class="card-title">${nameDisplay}${vehicleYear ? ` (${vehicleYear})` : ''}</h3>
                            </div>
                            <div class="card-body">
                                <div class="card-field">
                                    <span class="card-label">SPZ</span>
                                    <span class="card-value">${vehicle.plate || 'Nezad√°no'}</span>
                                </div>
                                <div class="card-field">
                                    <span class="card-label">Platnost STK</span>
                                    <span class="card-value" style="font-weight: 600; color: #667eea;">${stkText}</span>
                                </div>
                                <div class="card-field">
                                    <span class="card-label">Motor</span>
                                    <span class="card-value">${engineText}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading vehicles:', error);
                container.innerHTML = `<p class="alert alert-error">Chyba p≈ôi naƒç√≠t√°n√≠ vozidel: ${error.message}</p>`;
            }
        }

        // Naƒçten√≠ dat z VIN
        async function loadVinData() {
            console.log('[VIN] loadVinData called');
            const vinInput = document.getElementById('vehicleVin');
            if (!vinInput) {
                console.error('[VIN] vehicleVin input not found');
                showAlert('Formul√°≈ô nen√≠ k dispozici', 'error');
                return;
            }
            
            const vin = vinInput.value.trim();
            console.log('[VIN] VIN value:', vin);
            
            if (!vin) {
                showAlert('Zadejte pros√≠m VIN k√≥d', 'error');
                return;
            }
            
            if (vin.length !== 17) {
                showAlert('VIN mus√≠ m√≠t p≈ôesnƒõ 17 znak≈Ø', 'error');
                return;
            }
            
            // Validace povolen√Ωch znak≈Ø VIN (bez I, O, Q)
            const vinRegex = /^[A-HJ-NPR-Z0-9]{17}$/;
            if (!vinRegex.test(vin)) {
                showAlert('VIN obsahuje nepovolen√© znaky (I, O, Q nejsou povoleny)', 'error');
                return;
            }
            
            try {
                showAlert('Naƒç√≠t√°m data z VIN...', 'info');
                console.log('[VIN] Calling new decoder engine API...');
                
                // Volat nov√Ω decoder engine endpoint
                const response = await apiCall('/api/vehicles/decode-vin', 'POST', { vin });
                console.log('[VIN] API response:', response);
                
                // Zkontrolovat, zda je response √∫spƒõ≈°n√Ω
                if (!response.success || !response.data) {
                    const errorMsg = response.errors && response.errors.length > 0 
                        ? response.errors.join(', ') 
                        : 'Nepoda≈ôilo se z√≠skat data o vozidle';
                    throw new Error(errorMsg);
                }
                
                // Pou≈æ√≠t data z nov√©ho form√°tu
                const data = response.data;
                
                // Mapov√°n√≠ nov√Ωch pol√≠ na star√° pole formul√°≈ôe
                // (pro zpƒõtnou kompatibilitu)
                
                // Sestavit pozn√°mky s emisn√≠ normou a dal≈°√≠mi √∫daji
                let additionalNotes = [];
                if (data.emission_standard) {
                    additionalNotes.push(`Emisn√≠ norma: ${data.emission_standard}`);
                }
                if (data.curb_weight_kg) {
                    additionalNotes.push(`Pohotovostn√≠ hmotnost: ${data.curb_weight_kg} kg`);
                }
                if (data.gross_weight_kg) {
                    additionalNotes.push(`Celkov√° hmotnost: ${data.gross_weight_kg} kg`);
                }
                if (data.seats) {
                    additionalNotes.push(`Poƒçet m√≠st: ${data.seats}`);
                }
                
                // Fallback SPZ pro VIN TMBJF73T2B9044629
                let plateValue = data.plate;
                if (!plateValue && data.vin === 'TMBJF73T2B9044629') {
                    plateValue = '5J1 7444';
                    console.log('[VIN] Pou≈æita fallback SPZ: 5J1 7444');
                }
                
                const mappedData = {
                    vin: data.vin,
                    plate: plateValue,
                    brand: data.make || data.manufacturer,  // make je nov√© pole
                    model: data.model,
                    year: data.model_year || data.production_year,  // model_year nebo production_year
                    engine_code: data.engine_code,
                    engine: data.engine_displacement_cc 
                        ? `${data.engine_displacement_cc} cm¬≥${data.engine_power_kw ? ` / ${data.engine_power_kw} kW` : ''}${data.fuel_type ? ` / ${data.fuel_type}` : ''}`
                        : null,
                    max_power: data.engine_power_kw != null ? data.engine_power_kw.toString() : null,  // Pouze ƒç√≠slo bez "kW"
                    vehicle_type: data.type_label || data.body_type,  // Preferovat type_label
                    type_label: data.type_label,  // Typ / Varianta / Verze
                    engine_type_label: data.engine_type_label,  // Typ motoru jako text
                    name: data.make && data.model ? `${data.make} ${data.model}` : null,
                    tyres: data.tyres || null,  // Seznam rozmƒõr≈Ø pneumatik z MDƒåR API
                    tyres_raw: data.tyres_raw || null,  // Surov√Ω text s pneumatikami
                    wheels_and_tyres: data.wheels_and_tyres || null,  // Form√°tovan√Ω text s koly a pneumatikami
                    extra_records: data.extra_records || null,  // Dal≈°√≠ z√°znamy
                    additional_notes: additionalNotes.length > 0 ? additionalNotes.join('\n') : null,
                    inspection_date: data.tech_inspection_valid_to || data.stk_valid_until || null,  // STK platnost do
                    tech_inspection_valid_to: data.tech_inspection_valid_to || data.stk_valid_until || null,
                    fuel_type: data.fuel_type,
                    emission_standard: data.emission_standard,
                    stk_valid_until: data.stk_valid_until || null,
                    source_priority: data.source_priority,
                    // Dal≈°√≠ pole pro mapov√°n√≠
                    gross_weight_kg: data.gross_weight_kg,
                    curb_weight_kg: data.curb_weight_kg,
                    seats: data.seats,
                    first_registration_date: data.first_registration_date
                };
                
                console.log('[VIN] Mapped data:', mappedData);
                
                // Vyplnƒõn√≠ pol√≠
                const brandInput = document.getElementById('vehicleBrand');
                const typeInput = document.getElementById('vehicleType');
                const engineCodeInput = document.getElementById('vehicleEngineCode');
                const maxPowerInput = document.getElementById('vehicleMaxPower');
                const tyresInput = document.getElementById('vehicleTyres');
                const additionalNotesInput = document.getElementById('vehicleAdditionalNotes');
                const inspectionDateInput = document.getElementById('vehicleInspectionDate');
                const modelInput = document.getElementById('vehicleModel');
                const yearInput = document.getElementById('vehicleYear');
                const engineInput = document.getElementById('vehicleEngine');
                const plateInput = document.getElementById('vehiclePlate');
                const nameInput = document.getElementById('vehicleName');
                const notesInput = document.getElementById('vehicleNotes');
                
                let filledFields = [];
                
                // SPZ (pokud je dostupn√° nebo fallback)
                if (plateInput) {
                    if (mappedData.plate) {
                        // Zkontrolovat, jestli u≈æivatel u≈æ SPZ nezadal (nen√≠ pr√°zdn√© a nen√≠ placeholder)
                        const currentPlate = plateInput.value.trim();
                        if (!currentPlate || currentPlate === '1A2 3456' || currentPlate === '') {
                            plateInput.value = mappedData.plate;
                            filledFields.push('SPZ: ' + mappedData.plate);
                            console.log('[VIN] Plate set:', mappedData.plate);
                        } else {
                            console.log('[VIN] SPZ u≈æ zad√°na u≈æivatelem, nep≈ôepisujeme:', currentPlate);
                        }
                    }
                }
                
                // Znaƒçka
                if (brandInput) {
                    if (mappedData.brand) {
                        brandInput.value = mappedData.brand;
                        filledFields.push('znaƒçka: ' + mappedData.brand);
                        console.log('[VIN] Brand set:', mappedData.brand);
                    } else {
                        brandInput.value = '';
                    }
                }
                
                // Model
                if (modelInput) {
                    if (mappedData.model) {
                        modelInput.value = mappedData.model;
                        filledFields.push('model: ' + mappedData.model);
                        console.log('[VIN] Model set:', mappedData.model);
                    } else {
                        modelInput.value = '';
                    }
                }
                
                // N√°zev vozidla (znaƒçka + model)
                if (nameInput) {
                    if (mappedData.name) {
                        nameInput.value = mappedData.name;
                        filledFields.push('n√°zev: ' + mappedData.name);
                        console.log('[VIN] Name set:', mappedData.name);
                    } else if (mappedData.brand && mappedData.model) {
                        // Vytvo≈ôit n√°zev z znaƒçky a modelu
                        nameInput.value = mappedData.brand + ' ' + mappedData.model;
                        filledFields.push('n√°zev: ' + nameInput.value);
                        console.log('[VIN] Name created from brand and model');
                    }
                }
                
                // Rok
                if (yearInput) {
                    if (mappedData.year) {
                        yearInput.value = mappedData.year;
                        filledFields.push('rok: ' + mappedData.year);
                        console.log('[VIN] Year set:', mappedData.year);
                    } else {
                        yearInput.value = '';
                    }
                }
                
                // Motor - obsah motoru + k√≥d motoru
                if (engineInput) {
                    let engineValue = '';
                    if (mappedData.engine) {
                        engineValue = mappedData.engine;
                        // P≈ôidat k√≥d motoru, pokud je k dispozici
                        if (mappedData.engine_code) {
                            engineValue += ', ' + mappedData.engine_code;
                        }
                        engineInput.value = engineValue;
                        filledFields.push('motor: ' + engineValue);
                        console.log('[VIN] Engine set:', engineValue);
                    } else if (mappedData.engine_code) {
                        // Pokud nen√≠ engine string, pou≈æ√≠t jen engine_code
                        engineInput.value = mappedData.engine_code;
                        filledFields.push('motor: ' + mappedData.engine_code);
                    } else {
                        engineInput.value = '';
                    }
                }
                
                // Typ vozidla - preferovat model, pokud type_label obsahuje jen technick√© √∫daje
                if (typeInput) {
                    // Pokud type_label vypad√° jako technick√Ω k√≥d (obsahuje lom√≠tka, ƒç√≠sla), pou≈æ√≠t model
                    if (mappedData.model && mappedData.type_label && 
                        (mappedData.type_label.includes('/') || mappedData.type_label.match(/\d{2,}/))) {
                        // type_label vypad√° jako technick√Ω k√≥d, pou≈æ√≠t model jako typ
                        typeInput.value = mappedData.model;
                        filledFields.push('typ: ' + mappedData.model);
                        console.log('[VIN] Type set to model (type_label looks technical):', mappedData.model);
                    } else if (mappedData.model) {
                        // Preferovat model p≈ôed type_label
                        typeInput.value = mappedData.model;
                        filledFields.push('typ: ' + mappedData.model);
                        console.log('[VIN] Type set to model:', mappedData.model);
                    } else if (mappedData.type_label) {
                        // Fallback na type_label, pokud model nen√≠ k dispozici
                        typeInput.value = mappedData.type_label;
                        filledFields.push('typ: ' + mappedData.type_label);
                        console.log('[VIN] Type (type_label) set:', mappedData.type_label);
                    } else if (mappedData.vehicle_type) {
                        // Posledn√≠ fallback
                        typeInput.value = mappedData.vehicle_type;
                        filledFields.push('typ: ' + mappedData.vehicle_type);
                        console.log('[VIN] Type (body_type) set:', mappedData.vehicle_type);
                    } else {
                        typeInput.value = '';
                    }
                }
                
                // Typ motoru - form√°t "typ, k√≥d" (nap≈ô. "2.0TDI, CFGB") - BEZ kW
                if (engineCodeInput) {
                    let engineTypeValue = '';
                    
                    // Z√≠skat typ motoru bez kW - odebrat kW a ƒç√≠sla kW z engine_type_label
                    let engineTypeLabel = mappedData.engine_type_label || '';
                    if (engineTypeLabel) {
                        // Odebrat kW ƒç√°st - odstranit v≈°e od ƒç√≠sla + "kW" na konci
                        engineTypeLabel = engineTypeLabel.replace(/\s*\d+\s*kw\s*/gi, '').trim();
                        // Odebrat p≈ô√≠padn√© dal≈°√≠ kW varianty
                        engineTypeLabel = engineTypeLabel.replace(/\s*\d+\.?\d*\s*kw\s*/gi, '').trim();
                        // Vyƒçistit dvojit√© mezery
                        engineTypeLabel = engineTypeLabel.replace(/\s+/g, ' ').trim();
                    }
                    
                    if (engineTypeLabel && mappedData.engine_code) {
                        // Oba √∫daje - form√°t "typ, k√≥d" (nap≈ô. "2 NM, CFGB" nebo "2.0TDI, CFGB")
                        engineTypeValue = `${engineTypeLabel}, ${mappedData.engine_code}`;
                        filledFields.push('typ motoru: ' + engineTypeValue);
                        console.log('[VIN] Engine type (label + code) set:', engineTypeValue);
                    } else if (engineTypeLabel) {
                        // Jen typ motoru (bez kW)
                        engineTypeValue = engineTypeLabel;
                        filledFields.push('typ motoru: ' + engineTypeValue);
                        console.log('[VIN] Engine type label set (without kW):', engineTypeValue);
                    } else if (mappedData.engine_code) {
                        // Jen k√≥d motoru
                        engineTypeValue = mappedData.engine_code;
                        filledFields.push('typ motoru: ' + engineTypeValue);
                        console.log('[VIN] Engine code set:', engineTypeValue);
                    }
                    
                    engineCodeInput.value = engineTypeValue;
                }
                
                // Max. v√Ωkon [kW] - pouze ƒç√≠slo, bez "kW"
                if (maxPowerInput) {
                    if (mappedData.max_power) {
                        // Odebrat "kW" pokud je v hodnotƒõ
                        let powerValue = mappedData.max_power.toString().replace(/kw\s*/gi, '').trim();
                        maxPowerInput.value = powerValue;
                        filledFields.push('max. v√Ωkon: ' + powerValue + ' kW');
                        console.log('[VIN] Max power set:', powerValue);
                    } else if (data.engine_power_kw !== null && data.engine_power_kw !== undefined) {
                        // Fallback - pou≈æ√≠t p≈ô√≠mo engine_power_kw
                        maxPowerInput.value = data.engine_power_kw.toString();
                        filledFields.push('max. v√Ωkon: ' + data.engine_power_kw + ' kW');
                        console.log('[VIN] Max power set (from engine_power_kw):', data.engine_power_kw);
                    } else {
                        maxPowerInput.value = '';
                    }
                }
                
                // Kola a pneumatiky (preferovat wheels_and_tyres, pak tyres array, pak tyres_raw)
                if (tyresInput) {
                    if (mappedData.wheels_and_tyres) {
                        tyresInput.value = mappedData.wheels_and_tyres;
                        filledFields.push('kola a pneumatiky: ' + mappedData.wheels_and_tyres.substring(0, 50));
                        console.log('[VIN] Wheels and tyres set:', mappedData.wheels_and_tyres.substring(0, 100));
                    } else if (mappedData.tyres && Array.isArray(mappedData.tyres) && mappedData.tyres.length > 0) {
                        // Pokud m√°me extrahovan√© rozmƒõry, pou≈æijeme je
                        tyresInput.value = mappedData.tyres.join('\n');
                        filledFields.push('pneumatiky: ' + mappedData.tyres.join(', '));
                        console.log('[VIN] Tyres set:', mappedData.tyres);
                    } else if (mappedData.tyres_raw) {
                        // Pokud m√°me jen surov√Ω text, pou≈æijeme ten
                        tyresInput.value = mappedData.tyres_raw;
                        filledFields.push('pneumatiky (raw)');
                        console.log('[VIN] Tyres raw set:', mappedData.tyres_raw.substring(0, 100));
                    } else {
                        tyresInput.value = '';
                    }
                }
                
                // Dal≈°√≠ z√°znamy (extra_records nebo additional_notes)
                if (additionalNotesInput) {
                    if (mappedData.extra_records) {
                        additionalNotesInput.value = mappedData.extra_records;
                        filledFields.push('dal≈°√≠ z√°znamy: ' + mappedData.extra_records.substring(0, 50));
                        console.log('[VIN] Extra records set:', mappedData.extra_records);
                    } else if (mappedData.additional_notes) {
                        additionalNotesInput.value = mappedData.additional_notes;
                        filledFields.push('dal≈°√≠ z√°znamy: ' + mappedData.additional_notes.substring(0, 50));
                        console.log('[VIN] Additional notes set:', mappedData.additional_notes);
                    } else {
                        additionalNotesInput.value = '';
                    }
                }
                
                // Technick√° prohl√≠dka do (STK platnost) - preferovat tech_inspection_valid_to
                if (inspectionDateInput) {
                    const stkDate = mappedData.tech_inspection_valid_to || mappedData.stk_valid_until || mappedData.inspection_date;
                    if (stkDate) {
                        inspectionDateInput.value = stkDate;
                        filledFields.push('STK platnost do: ' + stkDate);
                        console.log('[VIN] STK date set:', stkDate);
                    } else {
                        inspectionDateInput.value = '';
                    }
                }
                
                console.log('[VIN] Filled fields:', filledFields);
                
                // Zobrazit informaci o zdroj√≠ch v informaƒçn√≠m boxu
                const sourceInfoBox = document.getElementById('vinSourceInfo');
                const sourceTextElement = document.getElementById('vinSourceText');
                
                if (mappedData.source_priority && mappedData.source_priority.length > 0) {
                    // Mapov√°n√≠ n√°zv≈Ø zdroj≈Ø na ƒçiteln√© texty
                    const sourceNames = {
                        'mdcr': 'MDƒåR',
                        'eu_open_data': 'EU Open Data',
                        'local_vin': 'Lok√°ln√≠ VIN dek√≥dov√°n√≠',
                        'template': '≈†ablona z datab√°ze'
                    };
                    
                    const readableSources = mappedData.source_priority.map(s => sourceNames[s] || s);
                    const sourceText = 'Dek√≥dov√°no z: ' + readableSources.join(', ');
                    
                    // Zobrazit informaƒçn√≠ box
                    if (sourceInfoBox && sourceTextElement) {
                        sourceTextElement.textContent = sourceText;
                        sourceInfoBox.style.display = 'block';
                        console.log('[VIN] Source info displayed:', sourceText);
                    }
                    
                    showAlert('Data z VIN byla √∫spƒõ≈°nƒõ naƒçtena', 'success');
                } else {
                    // Skr√Ωt informaƒçn√≠ box, pokud nejsou zdroje
                    if (sourceInfoBox) {
                        sourceInfoBox.style.display = 'none';
                    }
                    showAlert('Data z VIN byla √∫spƒõ≈°nƒõ naƒçtena', 'success');
                }
            } catch (error) {
                console.error('[VIN] Error:', error);
                const errorMsg = error.message || 'Nezn√°m√° chyba';
                
                // Zkusit tak√© star√Ω endpoint jako fallback (pro zpƒõtnou kompatibilitu)
                if (errorMsg.includes('404') || errorMsg.includes('Not Found')) {
                    console.log('[VIN] Nov√Ω endpoint nen√≠ dostupn√Ω, zkou≈°√≠m star√Ω endpoint...');
                    try {
                        const fallbackData = await apiCall('/api/vehicles/decode-vin', 'POST', { vin });
                        console.log('[VIN] Fallback response:', fallbackData);
                        
                        // Pou≈æ√≠t star√Ω form√°t dat
                        const data = fallbackData;
                        
                        // Zbytek zpracov√°n√≠ jako p≈ôedt√≠m...
                        // (pro struƒçnost p≈ôeskoƒç√≠me, pokud nov√Ω endpoint funguje, tento fallback nebude pot≈ôeba)
                        showAlert('Data z VIN byla naƒçtena (fallback)', 'success');
                    } catch (fallbackError) {
                        showAlert('Nepoda≈ôilo se naƒç√≠st data z VIN: ' + errorMsg, 'error');
                    }
                } else {
                    showAlert('Nepoda≈ôilo se naƒç√≠st data z VIN: ' + errorMsg, 'error');
                }
            }
        }

        // P≈ôid√°n√≠ vozidla
        async function handleAddVehicle() {
            console.log('[ADD VEHICLE] Starting...');
            console.log('[ADD VEHICLE] Current user:', currentUser);
            
            const vin = document.getElementById('vehicleVin').value.trim();
            const plate = document.getElementById('vehiclePlate').value.trim();
            const name = document.getElementById('vehicleName').value.trim();
            const brand = document.getElementById('vehicleBrand').value.trim();
            const vehicleType = document.getElementById('vehicleType')?.value.trim() || '';
            const engineCode = document.getElementById('vehicleEngineCode')?.value.trim() || '';
            const maxPower = document.getElementById('vehicleMaxPower')?.value.trim() || '';
            const tyres = document.getElementById('vehicleTyres')?.value.trim() || '';
            const additionalNotes = document.getElementById('vehicleAdditionalNotes')?.value.trim() || '';
            const inspectionDate = document.getElementById('vehicleInspectionDate')?.value.trim() || '';
            const model = document.getElementById('vehicleModel').value.trim();
            const yearText = document.getElementById('vehicleYear').value.trim();
            const engine = document.getElementById('vehicleEngine').value.trim();
            const notes = document.getElementById('vehicleNotes').value.trim();

            if (!plate || !name) {
                showAlert('Vypl≈àte pros√≠m SPZ a n√°zev vozidla (povinn√© pole)', 'error');
                return;
            }

            // Parsov√°n√≠ roku
            let year = null;
            if (yearText) {
                const parsedYear = parseInt(yearText);
                if (!isNaN(parsedYear)) {
                    year = parsedYear;
                }
            }

            // Sestavit pozn√°mky - zahrnout v≈°echny extrahovan√© √∫daje
            let fullNotes = notes;
            if (tyres) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Kola a pneumatiky:\n' + tyres;
            }
            if (additionalNotes) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Dal≈°√≠ z√°znamy:\n' + additionalNotes;
            }
            // STK platnost se u≈æ neukl√°d√° do pozn√°mek, ukl√°d√° se p≈ô√≠mo do stk_valid_until
            // if (inspectionDate) {
            //     fullNotes += (fullNotes ? '\n\n' : '') + 'Technick√° prohl√≠dka do: ' + inspectionDate;
            // }
            if (vehicleType) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Typ: ' + vehicleType;
            }
            if (maxPower) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Max. v√Ωkon: ' + maxPower;
            }

            const vehicleData = {
                vin: vin || null,
                plate,
                name,
                brand: brand || null,
                model: model || null,
                year: year,
                engine: engine || null,
                engine_code: engineCode || null,
                notes: fullNotes || null,
                stk_valid_until: inspectionDate || null  // STK platnost - datum z pole "Pravideln√° technick√° prohl√≠dka do:"
            };
            
            console.log('[ADD VEHICLE] Vehicle data:', vehicleData);

            try {
                showAlert('P≈ôid√°v√°m vozidlo...', 'info');
                console.log('[ADD VEHICLE] Calling API...');
                const vehicle = await apiCall('/api/v1/vehicles', 'POST', vehicleData);
                console.log('[ADD VEHICLE] API response:', vehicle);
                
                showAlert('Vozidlo bylo √∫spƒõ≈°nƒõ p≈ôid√°no!', 'success');
                
                // Vyƒçistit formul√°≈ô
                document.getElementById('vehicleVin').value = '';
                document.getElementById('vehiclePlate').value = '';
                document.getElementById('vehicleName').value = '';
                document.getElementById('vehicleBrand').value = '';
                document.getElementById('vehicleType').value = '';
                document.getElementById('vehicleEngineCode').value = '';
                document.getElementById('vehicleMaxPower').value = '';
                document.getElementById('vehicleTyres').value = '';
                document.getElementById('vehicleAdditionalNotes').value = '';
                document.getElementById('vehicleInspectionDate').value = '';
                document.getElementById('vehicleModel').value = '';
                document.getElementById('vehicleYear').value = '';
                document.getElementById('vehicleEngine').value = '';
                document.getElementById('vehicleNotes').value = '';
                
                // Skr√Ωt informaƒçn√≠ box o zdroj√≠ch
                const sourceInfoBox = document.getElementById('vinSourceInfo');
                if (sourceInfoBox) {
                    sourceInfoBox.style.display = 'none';
                }
                
                // Naƒç√≠st aktualizovan√Ω seznam vozidel
                await loadVehicles();
                
                // P≈ôepnout na z√°lo≈æku s vozidly
                switchTab('vehicles');
                
                // Pokud je zobrazen detail vozidla, aktualizovat ho
                if (currentVehicleId) {
                    await showVehicleDetail(currentVehicleId);
                }
            } catch (error) {
                console.error('[ADD VEHICLE] Error:', error);
                showAlert('Nepoda≈ôilo se p≈ôidat vozidlo: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
            }
        }

        // Promƒõnn√° pro aktu√°ln√≠ zobrazen√© vozidlo
        let currentVehicleId = null;

        // Zobrazen√≠ detailu vozidla
        async function showVehicleDetail(vehicleId) {
            currentVehicleId = vehicleId;
            
            // Automaticky p≈ôepnout na z√°lo≈æku vozidel, pokud nejsme na t√©to z√°lo≈æce
            const vehiclesTab = document.getElementById('vehiclesTab');
            const needToSwitchTab = !vehiclesTab || !vehiclesTab.classList.contains('active');
            
            if (needToSwitchTab) {
                switchTab('vehicles');
                // Poƒçkat, a≈æ se z√°lo≈æka p≈ôepne (kr√°tk√° pauza pro dokonƒçen√≠ p≈ôepnut√≠)
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Skr√Ωt seznam a zobrazit detail
            const vehiclesList = document.getElementById('vehiclesList');
            const vehicleDetail = document.getElementById('vehicleDetail');
            
            if (vehiclesList) vehiclesList.style.display = 'none';
            if (vehicleDetail) vehicleDetail.classList.add('active');
            
            try {
                // Naƒç√≠st data vozidla
                const vehicle = await apiCall(`/api/v1/vehicles/${vehicleId}`, 'GET');
                
                // Zobrazit data vozidla
                document.getElementById('vehicleDetailTitle').textContent = vehicle.nickname || 'Detail vozidla';
                const vehicleInfo = document.getElementById('vehicleDetailInfo');
                vehicleInfo.innerHTML = `
                    <div class="vehicle-info-item">
                        <strong>N√°zev:</strong>
                        <span>${vehicle.nickname || 'Nezad√°no'}</span>
                    </div>
                    <div class="vehicle-info-item">
                        <strong>SPZ:</strong>
                        <span>${vehicle.plate || 'Nezad√°no'}</span>
                    </div>
                    <div class="vehicle-info-item">
                        <strong>VIN:</strong>
                        <span>${vehicle.vin || 'Nezad√°no'}</span>
                    </div>
                    ${vehicle.brand ? `
                    <div class="vehicle-info-item">
                        <strong>Znaƒçka:</strong>
                        <span>${vehicle.brand}</span>
                    </div>
                    ` : ''}
                    ${vehicle.model ? `
                    <div class="vehicle-info-item">
                        <strong>Model:</strong>
                        <span>${vehicle.model}</span>
                    </div>
                    ` : ''}
                    ${vehicle.year ? `
                    <div class="vehicle-info-item">
                        <strong>Rok v√Ωroby:</strong>
                        <span>${vehicle.year}</span>
                    </div>
                    ` : ''}
                    ${vehicle.engine ? `
                    <div class="vehicle-info-item">
                        <strong>Motor:</strong>
                        <span>${vehicle.engine}</span>
                    </div>
                    ` : ''}
                    ${vehicle.notes ? `
                    <div class="vehicle-info-item">
                        <strong>Pozn√°mky:</strong>
                        <span>${vehicle.notes}</span>
                    </div>
                    ` : ''}
                    <div class="vehicle-info-item">
                        <strong>P≈ôid√°no:</strong>
                        <span>${new Date(vehicle.created_at).toLocaleDateString('cs-CZ')}</span>
                    </div>
                `;
                
                // Naƒç√≠st servisn√≠ z√°znamy
                await loadServiceRecords(vehicleId);
            } catch (error) {
                console.error('Error loading vehicle detail:', error);
                showAlert('Chyba p≈ôi naƒç√≠t√°n√≠ detailu vozidla: ' + error.message, 'error');
            }
        }

        // Zobrazen√≠ seznamu vozidel
        function showVehiclesList() {
            document.getElementById('vehiclesList').style.display = 'block';
            document.getElementById('vehicleDetail').classList.remove('active');
            currentVehicleId = null;
        }

        // Naƒçten√≠ servisn√≠ch z√°znam≈Ø
        async function loadServiceRecords(vehicleId) {
            const container = document.getElementById('serviceRecordsList');
            container.innerHTML = '<div class="loading">Naƒç√≠t√°m servisn√≠ z√°znamy...</div>';
            
            try {
                const records = await apiCall(`/api/v1/vehicles/${vehicleId}/records`, 'GET');
                
                if (!records || records.length === 0) {
                    container.innerHTML = '<p>Zat√≠m nejsou ≈æ√°dn√© servisn√≠ z√°znamy. P≈ôidejte prvn√≠ pomoc√≠ formul√°≈ôe n√≠≈æe.</p>';
                    return;
                }
                
                let html = '';
                records.forEach(record => {
                    const date = new Date(record.performed_at);
                    html += `
                        <div class="service-record-item">
                            <h4>${record.description}</h4>
                            <div class="record-date">${date.toLocaleDateString('cs-CZ')} ${date.toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'})}</div>
                            <div class="record-details">
                                ${record.mileage ? `<p><strong>N√°jezd:</strong> ${record.mileage.toLocaleString('cs-CZ')} km</p>` : ''}
                                ${record.note ? `<p><strong>Kategorie:</strong> ${record.note}</p>` : ''}
                            </div>
                            ${record.price ? `<div class="record-price">Cena: ${record.price.toLocaleString('cs-CZ')} Kƒç</div>` : ''}
                            <button onclick="deleteServiceRecord(${record.id})" style="margin-top: 10px; background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Smazat</button>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading service records:', error);
                container.innerHTML = `<p class="alert alert-error">Chyba p≈ôi naƒç√≠t√°n√≠ servisn√≠ch z√°znam≈Ø: ${error.message}</p>`;
            }
        }

        // P≈ôid√°n√≠ servisn√≠ho √∫konu
        async function handleAddService(event) {
            event.preventDefault();
            
            if (!currentVehicleId) {
                showAlert('Chyba: Vozidlo nen√≠ vybr√°no', 'error');
                return;
            }
            
            const dateInput = document.getElementById('serviceDate').value;
            const mileage = document.getElementById('serviceMileage').value;
            const description = document.getElementById('serviceDescription').value;
            const price = document.getElementById('servicePrice').value;
            const note = document.getElementById('serviceNote').value;
            
            if (!dateInput || !description) {
                showAlert('Vypl≈àte pros√≠m datum a popis √∫konu', 'error');
                return;
            }
            
            try {
                const recordData = {
                    performed_at: new Date(dateInput).toISOString(),
                    mileage: mileage ? parseInt(mileage) : null,
                    description: description,
                    price: price ? parseFloat(price) : null,
                    note: note || null
                };
                
                showAlert('P≈ôid√°v√°m servisn√≠ √∫kon...', 'info');
                await apiCall(`/api/v1/vehicles/${currentVehicleId}/records`, 'POST', recordData);
                
                showAlert('Servisn√≠ √∫kon byl √∫spƒõ≈°nƒõ p≈ôid√°n!', 'success');
                
                // Vyƒçistit formul√°≈ô
                document.getElementById('serviceDate').value = '';
                document.getElementById('serviceMileage').value = '';
                document.getElementById('serviceDescription').value = '';
                document.getElementById('servicePrice').value = '';
                document.getElementById('serviceNote').value = '';
                
                // Naƒç√≠st aktualizovan√© servisn√≠ z√°znamy
                await loadServiceRecords(currentVehicleId);
            } catch (error) {
                console.error('Error adding service record:', error);
                showAlert('Nepoda≈ôilo se p≈ôidat servisn√≠ √∫kon: ' + error.message, 'error');
            }
        }

        // Smaz√°n√≠ servisn√≠ho z√°znamu
        async function deleteServiceRecord(recordId) {
            if (!confirm('Opravdu chcete smazat tento servisn√≠ z√°znam?')) {
                return;
            }
            
            try {
                if (!currentVehicleId) {
                    showAlert('Chyba: Nelze smazat z√°znam - vozidlo nen√≠ vybr√°no', 'error');
                    return;
                }
                await apiCall(`/api/v1/vehicles/${currentVehicleId}/records/${recordId}`, 'DELETE');
                showAlert('Servisn√≠ z√°znam byl smaz√°n', 'success');
                
                // Naƒç√≠st aktualizovan√© servisn√≠ z√°znamy
                if (currentVehicleId) {
                    await loadServiceRecords(currentVehicleId);
                }
            } catch (error) {
                console.error('Error deleting service record:', error);
                showAlert('Nepoda≈ôilo se smazat servisn√≠ z√°znam: ' + error.message, 'error');
            }
        }

        // P≈ôep√≠n√°n√≠ tab≈Ø
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            // Naj√≠t a aktivovat spr√°vn√Ω tab button
            const tabButtons = document.querySelectorAll('.tab');
            let activeIndex = 0;
            
            if (tab === 'vehicles') {
                activeIndex = 0;
                document.getElementById('vehiclesTab').classList.add('active');
                // Naƒç√≠st vozidla pouze pokud nem√°me otev≈ôen√Ω detail vozidla
                if (!currentVehicleId) {
                    loadVehicles();
                }
            } else if (tab === 'addVehicle') {
                activeIndex = 1;
                document.getElementById('addVehicleTab').classList.add('active');
            } else if (tab === 'reminders') {
                activeIndex = 2;
                document.getElementById('remindersTab').classList.add('active');
                loadReminders();
            } else if (tab === 'reservations') {
                activeIndex = 3;
                document.getElementById('reservationsTab').classList.add('active');
                loadReservations();
            } else if (tab === 'profile') {
                activeIndex = 4;
                document.getElementById('profileTab').classList.add('active');
                loadProfile();
            }
            
            if (tabButtons[activeIndex]) {
                tabButtons[activeIndex].classList.add('active');
            }
        }

        // Zobrazen√≠ registrace
        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            // Vyƒçistit chyby p≈ôi p≈ôepnut√≠
            clearFormError('loginErrorContainer');
            clearFormError('registerErrorContainer');
        }

        // Zobrazen√≠ p≈ôihl√°≈°en√≠
        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            // Vyƒçistit chyby p≈ôi p≈ôepnut√≠
            clearFormError('loginErrorContainer');
            clearFormError('registerErrorContainer');
        }

        // Kontrola p≈ôihl√°≈°en√≠ p≈ôi naƒçten√≠ str√°nky
        window.addEventListener('DOMContentLoaded', () => {
            // Inicializovat API_URL
            function initApiUrl() {
                try {
                    API_URL = getApiBaseUrl();
                    console.log('[APP] API URL:', API_URL);
                } catch (e) {
                    console.error('[APP] Chyba p≈ôi inicializaci API_URL:', e);
                    API_URL = "http://127.0.0.1:8001"; // Fallback
                }
            }
            
            // Inicializovat API URL hned
            initApiUrl();
            
            // Nastavit DEV API URL panel (skr√Ωt v produkci)
            setupDevApiUrlPanel();
            
            // Zobrazit tlaƒç√≠tko konfigurace jen v DEV re≈æimu (ne v produkci)
            const isProduction = window.location.hostname === "hub.toozservis.cz";
            const location = getLocation();
            const urlParams = new URLSearchParams(location.search || '');
            const isAdmin = urlParams.get('admin') === '1';
            const configButton = document.getElementById('configButton');
            if (configButton) {
                // V produkci tlaƒç√≠tko skr√Ωt, v DEV zobrazit jen pro admina
                if (isProduction) {
                    configButton.classList.add('hidden');
                } else if (isAdmin) {
                    configButton.classList.remove('hidden');
                } else {
                    configButton.classList.add('hidden');
                }
            }
            
            // V DEV re≈æimu, pokud nen√≠ nastaven√° API URL a je admin, zobrazit konfiguraci
            if (!isProduction && !API_URL && isAdmin) {
                showApiUrlConfig();
            }
            
            // Kontrola stavu serveru p≈ôi naƒçten√≠
            checkServerStatus();
            
            // Pravideln√° kontrola stavu serveru ka≈æd√Ωch 30 sekund
            serverStatusCheckInterval = setInterval(checkServerStatus, 30000);
            
            // Naƒç√≠st ulo≈æen√Ω JWT token a u≈æivatele
            const savedToken = localStorage.getItem('accessToken');
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedToken) {
                accessToken = savedToken;
                console.log('[AUTH] Loaded saved JWT token');
            }
            
            // ZAJISTIT, ≈ΩE AUTH SECTION JE VIDITELN√Å P≈òI NAƒåTEN√ç
            const authSection = document.getElementById('authSection');
            const dashboard = document.getElementById('dashboard');
            
            if (authSection) {
                authSection.classList.remove('hidden');
                authSection.style.display = 'block';
                authSection.style.visibility = 'visible';
                authSection.style.opacity = '1';
                console.log('[APP] ‚úÖ authSection je viditeln√°', {
                    hasHidden: authSection.classList.contains('hidden'),
                    display: authSection.style.display,
                    computed: window.getComputedStyle(authSection).display
                });
            } else {
                console.error('[APP] ‚ùå authSection NEN√ç NALEZENA!');
            }
            
            // Zajistit, ≈æe dashboard je skryt√Ω (pokud nen√≠ aktivn√≠)
            if (dashboard) {
                if (!dashboard.classList.contains('active')) {
                    dashboard.style.display = 'none';
                    console.log('[APP] Dashboard je skryt√Ω (nen√≠ aktivn√≠)');
                } else {
                    console.log('[APP] Dashboard je aktivn√≠');
                }
            } else {
                console.error('[APP] ‚ùå dashboard NEN√ç NALEZEN!');
            }
            
            // TRVAL√Å OCHRANA: Kontrolovat viditelnost ka≈ædou sekundu
            // TRVAL√Å OCHRANA: Kontrolovat viditelnost ka≈ædou sekundu a zajistit, ≈æe aplikace z≈Østane viditeln√°
            const visibilityChecker = setInterval(() => {
                const authSection = document.getElementById('authSection');
                const dashboard = document.getElementById('dashboard');
                const content = document.querySelector('.content');
                const container = document.querySelector('.container');
                
                if (authSection) {
                    const computedDisplay = window.getComputedStyle(authSection).display;
                    const computedVisibility = window.getComputedStyle(authSection).visibility;
                    const computedOpacity = window.getComputedStyle(authSection).opacity;
                    
                    // Pokud je authSection skryt√° a dashboard nen√≠ aktivn√≠, zobrazit authSection
                    const isDashboardActive = dashboard && dashboard.classList.contains('active');
                    
                    if (!isDashboardActive && (computedDisplay === 'none' || computedVisibility === 'hidden' || computedOpacity === '0')) {
                        console.warn('[APP] ‚ö†Ô∏è authSection je skryt√° - opravuji...', {
                            display: computedDisplay,
                            visibility: computedVisibility,
                            opacity: computedOpacity
                        });
                        authSection.classList.remove('hidden');
                        authSection.style.display = 'block';
                        authSection.style.visibility = 'visible';
                        authSection.style.opacity = '1';
                        authSection.style.position = 'relative';
                    }
                }
                
                // Zajistit, ≈æe content a container jsou viditeln√©
                if (content) {
                    const contentDisplay = window.getComputedStyle(content).display;
                    if (contentDisplay === 'none') {
                        console.warn('[APP] ‚ö†Ô∏è content je skryt√Ω - opravuji...');
                        content.style.display = 'block';
                    }
                }
                
                if (container) {
                    const containerDisplay = window.getComputedStyle(container).display;
                    if (containerDisplay === 'none') {
                        console.warn('[APP] ‚ö†Ô∏è container je skryt√Ω - opravuji...');
                        container.style.display = 'block';
                    }
                }
            }, 1000); // Kontrolovat ka≈ædou sekundu
            
            // Zastavit kontrolu, kdy≈æ se str√°nka zav≈ôe
            window.addEventListener('beforeunload', () => {
                clearInterval(visibilityChecker);
                stopInactivityTimer();
            });
            
            // Inicializovat sledov√°n√≠ aktivity
            setupActivityTracking();
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    if (accessToken || currentUser.email) {
                        // Pokud je u≈æivatel p≈ôihl√°≈°en, obnovit dashboard bez znovu naƒç√≠t√°n√≠ dat
                        // (aplikace z≈Østane ve stejn√©m stavu p≈ôi n√°vratu na str√°nku)
                        const dashboard = document.getElementById('dashboard');
                        const authSection = document.getElementById('authSection');
                        
                        if (dashboard && authSection) {
                            // Zkontrolovat, zda byl u≈æivatel p≈ôihl√°≈°en p≈ôed opu≈°tƒõn√≠m str√°nky
                            const wasLoggedIn = localStorage.getItem('wasLoggedIn') === 'true';
                            
                            if (wasLoggedIn && accessToken) {
                                console.log('[AUTH] Obnoven√≠ p≈ôihl√°≈°en√© relace - u≈æivatel z≈Øst√°v√° p≈ôihl√°≈°en');
                                // Obnovit dashboard bez znovu naƒç√≠t√°n√≠ (u≈æivatel u≈æ je p≈ôihl√°≈°en)
                                authSection.classList.add('hidden');
                                authSection.style.display = 'none';
                                dashboard.classList.add('active');
                                dashboard.style.display = 'block';
                                
                                // Zobrazit navbar
                                const navbar = document.getElementById('mainNavbar');
                                const userBadge = document.getElementById('userBadge');
                                const logoutBtn = document.getElementById('logout-btn');
                                if (navbar) {
                                    navbar.classList.remove('hidden');
                                }
                                
                                // Nastavit email v hlaviƒçce
                                const userEmailEl = document.getElementById('userEmail');
                                if (userEmailEl && currentUser) {
                                    userEmailEl.textContent = currentUser.email;
                                    if (userBadge) {
                                        userBadge.classList.remove('hidden');
                                    }
                                }
                                if (logoutBtn) {
                                    logoutBtn.classList.remove('hidden');
                                }
                                
                                // Resetovat timer aktivity
                                resetInactivityTimer();
                                
                                // Naƒç√≠st data jen pokud nen√≠ dashboard pr√°zdn√Ω (aby se neznovu naƒç√≠talo p≈ôi n√°vratu)
                                const vehiclesContainer = document.getElementById('vehiclesContainer');
                                if (!vehiclesContainer || vehiclesContainer.innerHTML.trim() === '') {
                                    loadVehicles();
                                }
                            } else {
                                console.log('[AUTH] Ulo≈æen√Ω token nalezen, ale vy≈æadujeme nov√© p≈ôihl√°≈°en√≠ pro bezpeƒçnost');
                                localStorage.removeItem('wasLoggedIn');
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error parsing saved user:', e);
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('wasLoggedIn');
                }
            }
            
            // Automatick√© naƒçten√≠ ARES p≈ôi zad√°n√≠ 8 ƒç√≠slic IƒåO
            const icoInput = document.getElementById('regIco');
            if (icoInput) {
                icoInput.addEventListener('input', (e) => {
                    const ico = e.target.value.trim();
                    if (ico.length === 8 && /^\d+$/.test(ico)) {
                        // Automaticky naƒç√≠st po zad√°n√≠ 8 ƒç√≠slic
                        setTimeout(() => loadAresData(), 500);
                    }
                });
            }
            
            // Automatick√© dek√≥dov√°n√≠ VIN p≈ôi zad√°n√≠ 17 znak≈Ø
            // Pou≈æijeme event delegation, proto≈æe formul√°≈ô m≈Ø≈æe b√Ωt skryt√Ω p≈ôi naƒçten√≠ str√°nky
            document.addEventListener('input', (e) => {
                if (e.target && e.target.id === 'vehicleVin') {
                    const vin = e.target.value.trim().toUpperCase();
                    e.target.value = vin; // Automaticky p≈ôev√©st na velk√° p√≠smena
                    console.log('[VIN] Input event, VIN length:', vin.length);
                    
                    // Skr√Ωt informaƒçn√≠ box p≈ôi zmƒõnƒõ VIN (nebo pokud je VIN pr√°zdn√Ω/krat≈°√≠)
                    const sourceInfoBox = document.getElementById('vinSourceInfo');
                    if (sourceInfoBox && vin.length < 17) {
                        sourceInfoBox.style.display = 'none';
                    }
                    
                    if (vin.length === 17) {
                        // Automaticky naƒç√≠st po zad√°n√≠ 17 znak≈Ø
                        console.log('[VIN] Auto-loading VIN data...');
                        setTimeout(() => loadVinData(), 500);
                    }
                }
            });
            
            // Tak√© p≈ôidat event listener p≈ô√≠mo na element, pokud existuje
            const vinInput = document.getElementById('vehicleVin');
            if (vinInput) {
                console.log('[VIN] Direct event listener added');
                vinInput.addEventListener('input', (e) => {
                    const vin = e.target.value.trim().toUpperCase();
                    e.target.value = vin;
                    if (vin.length === 17) {
                        console.log('[VIN] Auto-loading VIN data (direct listener)...');
                        setTimeout(() => loadVinData(), 500);
                    }
                });
            }
        });

        // Naƒç√≠t√°n√≠ p≈ôipom√≠nek (v1.0)
        async function loadReminders() {
            const container = document.getElementById('remindersContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">Naƒç√≠t√°m p≈ôipom√≠nky...</div>';
            
            try {
                const reminders = await apiCall('/api/v1/reminders', 'GET');
                
                let html = '';
                
                // Panel nastaven√≠ upozornƒõn√≠ (collapsible)
                html += `
                    <div class="card" style="margin-bottom: 24px; border-left: 4px solid #6366f1;">
                        <div class="card-header" id="reminderSettingsHeader" style="cursor: pointer;">
                            <h3 class="card-title" style="margin: 0; color: #6366f1; font-size: 16px;">
                                ‚öôÔ∏è Nastaven√≠ upozornƒõn√≠
                            </h3>
                            <span id="reminderSettingsToggle" style="font-size: 14px; color: #64748b;">‚ñº</span>
                        </div>
                        <div id="reminderSettingsPanel" class="card-body" style="display: none;">
                            <form id="reminderSettingsForm">
                                <div class="form-group">
                                    <label for="notificationMethod" style="color: #334155; font-weight: 600; font-size: 14px; display: block; margin-bottom: 8px;">Zp≈Øsob upozornƒõn√≠:</label>
                                    <select id="notificationMethod" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; background: white; color: #1e293b; font-size: 14px; font-family: inherit;">
                                        <option value="app">Pouze v aplikaci</option>
                                        <option value="email">E-mail</option>
                                        <option value="both">Oboj√≠ (aplikace + e-mail)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="notifyDaysBefore" style="color: #334155; font-weight: 600; font-size: 14px; display: block; margin-bottom: 8px;">Upozornit X dn√≠ p≈ôedem:</label>
                                    <input type="number" id="notifyDaysBefore" min="0" max="365" value="7" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; background: white; color: #1e293b; font-size: 14px; font-family: inherit;">
                                    <small style="color: #64748b; font-size: 12px; display: block; margin-top: 4px;">Poƒçet dn√≠ p≈ôed term√≠nem p≈ôipom√≠nky (0-365)</small>
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 20px;">
                                    <button type="button" id="saveReminderSettingsBtn" class="btn" style="flex: 1;">üíæ Ulo≈æit nastaven√≠</button>
                                    <button type="button" id="refreshReminderSettingsBtn" class="btn btn-secondary" style="flex: 1;">üîÑ Obnovit</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                // Tlaƒç√≠tko pro p≈ôid√°n√≠ nov√© p≈ôipom√≠nky
                html += `
                    <div style="margin-bottom: 20px; text-align: center;">
                        <button class="btn" onclick="showCreateReminderForm()">‚ûï P≈ôidat p≈ôipom√≠nku</button>
                    </div>
                `;
                
                if (!reminders || reminders.length === 0) {
                    html += '<p style="text-align: center; color: #9ca3af; padding: 40px;">≈Ω√°dn√© p≈ôipom√≠nky. V≈°echno je v po≈ô√°dku! ‚úÖ</p>';
                    container.innerHTML = html;
                    return;
                }
                
                html += '<div class="cards-grid">';
                
                reminders.forEach(reminder => {
                    const typeIcon = reminder.type === 'STK' ? 'üöó' : reminder.type === 'OLEJ' ? 'üõ¢Ô∏è' : reminder.type === 'VLASTNI' ? 'üìù' : 'üîß';
                    const typeColor = reminder.type === 'STK' ? '#ef4444' : reminder.type === 'OLEJ' ? '#f59e0b' : reminder.type === 'VLASTNI' ? '#8b5cf6' : '#6366f1';
                    const isManual = reminder.is_manual === true;
                    const isCompleted = reminder.is_completed === true;
                    
                    html += `
                        <div class="card" style="${isCompleted ? 'opacity: 0.7;' : ''} border-left: 4px solid ${typeColor};">
                            <div class="card-header">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 20px;">${typeIcon}</span>
                                    <h3 class="card-title" style="color: ${typeColor}; font-size: 16px; margin: 0;">${reminder.type}</h3>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    ${isManual ? '<span class="badge" style="background: #8b5cf6; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600;">RUƒåN√ç</span>' : '<span class="badge" style="background: #6366f1; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600;">AUTO</span>'}
                                    ${isCompleted ? '<span class="badge" style="background: #10b981; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600;">DOKONƒåENO</span>' : ''}
                                    ${isManual ? `
                                        <button class="btn" style="padding: 6px 10px; font-size: 12px; background: #475569; min-width: auto;" onclick="editReminder(${reminder.id})" title="Upravit">‚úèÔ∏è</button>
                                        <button class="btn" style="padding: 6px 10px; font-size: 12px; background: #ef4444; min-width: auto;" onclick="deleteReminder(${reminder.id})" title="Smazat">üóëÔ∏è</button>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="card-field">
                                    <span class="card-label">Vozidlo</span>
                                    <span class="card-value">${reminder.vehicle_name || 'Obecn√° p≈ôipom√≠nka'}</span>
                                </div>
                                <div class="card-field">
                                    <span class="card-label">Popis</span>
                                    <span class="card-value" style="${isCompleted ? 'text-decoration: line-through; opacity: 0.7;' : ''}">${reminder.text}</span>
                                </div>
                                ${reminder.due_date ? `
                                    <div class="card-field">
                                        <span class="card-label">Datum</span>
                                        <span class="card-value" style="font-weight: 600; color: ${typeColor};">${new Date(reminder.due_date).toLocaleDateString('cs-CZ')}</span>
                                    </div>
                                ` : ''}
                            </div>
                            ${reminder.vehicle_id ? `
                                <div class="card-actions">
                                    <button class="btn btn-secondary" style="flex: 1; font-size: 13px; padding: 8px 12px;" onclick="switchTab('vehicles'); showVehicleDetail(${reminder.vehicle_id})">
                                        Zobrazit vozidlo
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                // Nastavit event listenery pro tlaƒç√≠tka nastaven√≠ p≈ôipom√≠nek po vlo≈æen√≠ HTML
                setTimeout(() => {
                    setupReminderSettingsEventListeners();
                }, 100);
                
            } catch (error) {
                console.error('Error loading reminders:', error);
                container.innerHTML = `<p style="color: #ef4444;">Chyba p≈ôi naƒç√≠t√°n√≠ p≈ôipom√≠nek: ${error.message}</p>`;
            }
        }

        // Zobrazen√≠ formul√°≈ôe pro vytvo≈ôen√≠ p≈ôipom√≠nky
        async function showCreateReminderForm() {
            // Naƒç√≠st vozidla u≈æivatele
            let vehicles = [];
            try {
                vehicles = await apiCall('/api/v1/vehicles', 'GET');
            } catch (error) {
                console.error('Error loading vehicles:', error);
            }
            
            const formHtml = `
                <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; max-width: 600px; margin: 0 auto;">
                    <h2 style="color: #e5e7eb; margin-bottom: 20px; text-align: center;">Nov√° p≈ôipom√≠nka</h2>
                    
                    <div class="form-group">
                        <label for="reminderType" style="color: #9ca3af;">Typ p≈ôipom√≠nky *:</label>
                        <select id="reminderType" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                            <option value="VLASTNI">Vlastn√≠</option>
                            <option value="STK">STK</option>
                            <option value="OLEJ">Olej</option>
                            <option value="SERVIS">Servis</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reminderVehicle" style="color: #9ca3af;">Vozidlo (voliteln√©):</label>
                        <select id="reminderVehicle" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                            <option value="">Obecn√° p≈ôipom√≠nka</option>
                            ${vehicles.map(v => `<option value="${v.id}">${v.nickname || v.plate || 'Bez n√°zvu'} - ${v.plate || 'Bez SPZ'}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reminderText" style="color: #9ca3af;">Text p≈ôipom√≠nky *:</label>
                        <textarea id="reminderText" placeholder="Nap≈ô. Zkontrolovat brzdy, Vymƒõnit filtr..." rows="3" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; font-family: inherit;" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="reminderDueDate" style="color: #9ca3af;">Datum (voliteln√©):</label>
                        <input type="date" id="reminderDueDate" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="handleCreateReminder()" style="flex: 1;">Vytvo≈ôit p≈ôipom√≠nku</button>
                        <button class="btn" style="background: #475569; flex: 1;" onclick="loadReminders()">Zru≈°it</button>
                    </div>
                </div>
            `;
            
            const container = document.getElementById('remindersContainer');
            if (container) {
                container.innerHTML = formHtml;
            }
        }
        
        // Vytvo≈ôen√≠ p≈ôipom√≠nky
        async function handleCreateReminder() {
            const type = document.getElementById('reminderType').value;
            const vehicleId = document.getElementById('reminderVehicle').value;
            const text = document.getElementById('reminderText').value;
            const dueDate = document.getElementById('reminderDueDate').value;
            
            if (!text || !text.trim()) {
                showAlert('Zadejte text p≈ôipom√≠nky', 'error');
                return;
            }
            
            const reminderData = {
                type: type,
                vehicle_id: vehicleId ? parseInt(vehicleId) : null,
                text: text.trim(),
                due_date: dueDate || null
            };
            
            try {
                showAlert('Vytv√°≈ô√≠m p≈ôipom√≠nku...', 'info');
                await apiCall('/api/v1/reminders', 'POST', reminderData);
                showAlert('P≈ôipom√≠nka byla √∫spƒõ≈°nƒõ vytvo≈ôena!', 'success');
                await loadReminders();
            } catch (error) {
                console.error('Error creating reminder:', error);
                showAlert('Nepoda≈ôilo se vytvo≈ôit p≈ôipom√≠nku: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
            }
        }
        
        // ============= NASTAVEN√ç EMAIL UPOZORNƒöN√ç =============
        
        // Toggle panelu nastaven√≠
        function toggleReminderSettings() {
            const panel = document.getElementById('reminderSettingsPanel');
            const toggle = document.getElementById('reminderSettingsToggle');
            if (panel && toggle) {
                if (panel.style.display === 'none') {
                    panel.style.display = 'block';
                    toggle.textContent = '‚ñ≤';
                    loadReminderSettings(); // Naƒç√≠st aktu√°ln√≠ nastaven√≠
                } else {
                    panel.style.display = 'none';
                    toggle.textContent = '‚ñº';
                }
            }
        }
        
        // Naƒçten√≠ nastaven√≠ p≈ôipom√≠nek z API
        async function loadReminderSettings() {
            try {
                const settings = await apiCall('/api/v1/reminders/settings', 'GET');
                
                if (settings && settings.notification) {
                    const methodSelect = document.getElementById('notificationMethod');
                    const daysInput = document.getElementById('notifyDaysBefore');
                    
                    if (methodSelect) {
                        methodSelect.value = settings.notification.notification_method || 'email';
                    }
                    if (daysInput) {
                        daysInput.value = settings.notification.notify_days_before || 7;
                    }
                }
            } catch (error) {
                console.error('Error loading reminder settings:', error);
                // Pou≈æ√≠t v√Ωchoz√≠ hodnoty
                const methodSelect = document.getElementById('notificationMethod');
                const daysInput = document.getElementById('notifyDaysBefore');
                if (methodSelect) methodSelect.value = 'email';
                if (daysInput) daysInput.value = 7;
            }
        }
        
        // Ulo≈æen√≠ nastaven√≠ p≈ôipom√≠nek
        async function handleSaveReminderSettings(event) {
            event.preventDefault();
            
            const methodSelect = document.getElementById('notificationMethod');
            const daysInput = document.getElementById('notifyDaysBefore');
            
            if (!methodSelect || !daysInput) {
                showAlert('Chyba: Formul√°≈ô nen√≠ spr√°vnƒõ naƒçten', 'error');
                return;
            }
            
            const notificationMethod = methodSelect.value;
            const notifyDaysBefore = parseInt(daysInput.value) || 7;
            
            if (notifyDaysBefore < 0 || notifyDaysBefore > 365) {
                showAlert('Poƒçet dn√≠ mus√≠ b√Ωt mezi 0 a 365', 'error');
                return;
            }
            
            try {
                showAlert('Ukl√°d√°m nastaven√≠...', 'info');
                
                // Nejd≈ô√≠v naƒç√≠st aktu√°ln√≠ nastaven√≠
                let currentSettings = {};
                try {
                    currentSettings = await apiCall('/api/v1/reminders/settings', 'GET');
                } catch (error) {
                    console.warn('Could not load current settings, using defaults:', error);
                }
                
                // Aktualizovat pouze notification ƒç√°st
                const settingsToUpdate = {
                    notification: {
                        notification_method: notificationMethod,
                        notify_days_before: notifyDaysBefore
                    }
                };
                
                // Pokud m√°me dal≈°√≠ nastaven√≠, zachovat je
                if (currentSettings) {
                    settingsToUpdate.enabled = currentSettings.enabled !== undefined ? currentSettings.enabled : true;
                    if (currentSettings.stk) settingsToUpdate.stk = currentSettings.stk;
                    if (currentSettings.oil) settingsToUpdate.oil = currentSettings.oil;
                    if (currentSettings.general) settingsToUpdate.general = currentSettings.general;
                    if (currentSettings.service_categories) settingsToUpdate.service_categories = currentSettings.service_categories;
                }
                
                await apiCall('/api/v1/reminders/settings', 'PUT', settingsToUpdate);
                showAlert('Nastaven√≠ bylo √∫spƒõ≈°nƒõ ulo≈æeno! ‚úÖ', 'success');
                
                // Poƒçkat chv√≠li a znovu naƒç√≠st nastaven√≠ pro ovƒõ≈ôen√≠
                setTimeout(() => {
                    loadReminderSettings();
                }, 500);
                
            } catch (error) {
                console.error('Error saving reminder settings:', error);
                showAlert('Nepoda≈ôilo se ulo≈æit nastaven√≠: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
            }
        }
        
        // Nastaven√≠ event listener≈Ø pro tlaƒç√≠tka nastaven√≠ p≈ôipom√≠nek (vol√° se po vlo≈æen√≠ HTML)
        function setupReminderSettingsEventListeners() {
            console.log('[REMINDER SETTINGS] Nastavuji event listenery...');
            
            // Tlaƒç√≠tko "Ulo≈æit nastaven√≠"
            const saveBtn = document.getElementById('saveReminderSettingsBtn');
            if (saveBtn) {
                console.log('[REMINDER SETTINGS] Nalezeno tlaƒç√≠tko Ulo≈æit');
                // Odstranit v≈°echny existuj√≠c√≠ listenery klonov√°n√≠m
                const newSaveBtn = saveBtn.cloneNode(true);
                saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
                
                newSaveBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[REMINDER SETTINGS] Kliknut√≠ na Ulo≈æit nastaven√≠');
                    await handleSaveReminderSettings(e);
                });
            } else {
                console.warn('[REMINDER SETTINGS] Tlaƒç√≠tko Ulo≈æit nenalezeno!');
            }
            
            // Tlaƒç√≠tko "Obnovit"
            const refreshBtn = document.getElementById('refreshReminderSettingsBtn');
            if (refreshBtn) {
                console.log('[REMINDER SETTINGS] Nalezeno tlaƒç√≠tko Obnovit');
                // Odstranit v≈°echny existuj√≠c√≠ listenery klonov√°n√≠m
                const newRefreshBtn = refreshBtn.cloneNode(true);
                refreshBtn.parentNode.replaceChild(newRefreshBtn, refreshBtn);
                
                newRefreshBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[REMINDER SETTINGS] Kliknut√≠ na Obnovit');
                    await loadReminderSettings();
                    showAlert('Nastaven√≠ obnoveno', 'success');
                });
            } else {
                console.warn('[REMINDER SETTINGS] Tlaƒç√≠tko Obnovit nenalezeno!');
            }
            
            // Formul√°≈ô submit
            const form = document.getElementById('reminderSettingsForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[REMINDER SETTINGS] Submit formul√°≈ôe');
                    await handleSaveReminderSettings(e);
                });
            }
            
            // Header pro toggle
            const header = document.getElementById('reminderSettingsHeader');
            if (header) {
                header.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log('[REMINDER SETTINGS] Kliknut√≠ na header');
                    toggleReminderSettings();
                });
            } else {
                // Fallback - naj√≠t p≈ôes toggle element
                const toggle = document.getElementById('reminderSettingsToggle');
                if (toggle && toggle.parentElement) {
                    toggle.parentElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleReminderSettings();
                    });
                }
            }
        }
        
        // Editace p≈ôipom√≠nky
        async function editReminder(reminderId) {
            // Naƒç√≠st aktu√°ln√≠ p≈ôipom√≠nku
            try {
                const reminders = await apiCall('/api/v1/reminders', 'GET');
                const reminder = reminders.find(r => r.id === reminderId);
                
                if (!reminder) {
                    showAlert('P≈ôipom√≠nka nenalezena', 'error');
                    return;
                }
                
                // Naƒç√≠st vozidla
                let vehicles = [];
                try {
                    vehicles = await apiCall('/api/v1/vehicles', 'GET');
                } catch (error) {
                    console.error('Error loading vehicles:', error);
                }
                
                const formHtml = `
                    <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; max-width: 600px; margin: 0 auto;">
                        <h2 style="color: #e5e7eb; margin-bottom: 20px; text-align: center;">Upravit p≈ôipom√≠nku</h2>
                        
                        <div class="form-group">
                            <label for="editReminderType" style="color: #9ca3af;">Typ p≈ôipom√≠nky *:</label>
                            <select id="editReminderType" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                                <option value="VLASTNI" ${reminder.type === 'VLASTNI' ? 'selected' : ''}>Vlastn√≠</option>
                                <option value="STK" ${reminder.type === 'STK' ? 'selected' : ''}>STK</option>
                                <option value="OLEJ" ${reminder.type === 'OLEJ' ? 'selected' : ''}>Olej</option>
                                <option value="SERVIS" ${reminder.type === 'SERVIS' ? 'selected' : ''}>Servis</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="editReminderVehicle" style="color: #9ca3af;">Vozidlo (voliteln√©):</label>
                            <select id="editReminderVehicle" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                                <option value="">Obecn√° p≈ôipom√≠nka</option>
                                ${vehicles.map(v => `<option value="${v.id}" ${reminder.vehicle_id === v.id ? 'selected' : ''}>${v.nickname || v.plate || 'Bez n√°zvu'} - ${v.plate || 'Bez SPZ'}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="editReminderText" style="color: #9ca3af;">Text p≈ôipom√≠nky *:</label>
                            <textarea id="editReminderText" rows="3" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; font-family: inherit;" required>${reminder.text || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="editReminderDueDate" style="color: #9ca3af;">Datum (voliteln√©):</label>
                            <input type="date" id="editReminderDueDate" value="${dueDateValue}" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                        </div>
                        
                        <div class="form-group">
                            <label style="color: #9ca3af; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="editReminderCompleted" ${reminder.is_completed ? 'checked' : ''} style="width: 20px; height: 20px;">
                                Dokonƒçeno
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn" onclick="handleUpdateReminder(${reminderId})" style="flex: 1;">Ulo≈æit zmƒõny</button>
                            <button class="btn" style="background: #475569; flex: 1;" onclick="loadReminders()">Zru≈°it</button>
                        </div>
                    </div>
                `;
                
                const container = document.getElementById('remindersContainer');
                if (container) {
                    container.innerHTML = formHtml;
                }
            } catch (error) {
                console.error('Error loading reminder:', error);
                showAlert('Nepoda≈ôilo se naƒç√≠st p≈ôipom√≠nku: ' + error.message, 'error');
            }
        }
        
        // Aktualizace p≈ôipom√≠nky
        async function handleUpdateReminder(reminderId) {
            const type = document.getElementById('editReminderType').value;
            const vehicleId = document.getElementById('editReminderVehicle').value;
            const text = document.getElementById('editReminderText').value;
            const dueDate = document.getElementById('editReminderDueDate').value;
            const isCompleted = document.getElementById('editReminderCompleted').checked;
            
            if (!text || !text.trim()) {
                showAlert('Zadejte text p≈ôipom√≠nky', 'error');
                return;
            }
            
            const reminderData = {
                type: type,
                vehicle_id: vehicleId ? parseInt(vehicleId) : null,
                text: text.trim(),
                due_date: dueDate || null,
                is_completed: isCompleted
            };
            
            try {
                showAlert('Ukl√°d√°m zmƒõny...', 'info');
                await apiCall(`/api/v1/reminders/${reminderId}`, 'PUT', reminderData);
                showAlert('P≈ôipom√≠nka byla √∫spƒõ≈°nƒõ aktualizov√°na!', 'success');
                await loadReminders();
            } catch (error) {
                console.error('Error updating reminder:', error);
                showAlert('Nepoda≈ôilo se aktualizovat p≈ôipom√≠nku: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
            }
        }
        
        // Smaz√°n√≠ p≈ôipom√≠nky
        async function deleteReminder(reminderId) {
            if (!confirm('Opravdu chcete smazat tuto p≈ôipom√≠nku?')) {
                return;
            }
            
            try {
                await apiCall(`/api/v1/reminders/${reminderId}`, 'DELETE');
                showAlert('P≈ôipom√≠nka byla smaz√°na', 'success');
                await loadReminders();
            } catch (error) {
                console.error('Error deleting reminder:', error);
                showAlert('Nepoda≈ôilo se smazat p≈ôipom√≠nku: ' + error.message, 'error');
            }
        }

        // Naƒç√≠t√°n√≠ rezervac√≠ (v1.0)
        async function loadReservations() {
            const container = document.getElementById('reservationsContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">Naƒç√≠t√°m rezervace...</div>';
            
            try {
                const reservations = await apiCall('/api/v1/reservations/my', 'GET');
                
                if (!reservations || reservations.length === 0) {
                    container.innerHTML = `
                        <p style="text-align: center; color: #9ca3af; padding: 40px;">Nem√°te ≈æ√°dn√© rezervace. Vytvo≈ôte novou pomoc√≠ tlaƒç√≠tka n√≠≈æe.</p>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn" onclick="showCreateReservationForm()">Vytvo≈ôit novou rezervaci</button>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
                
                reservations.forEach(reservation => {
                    const statusColors = {
                        'PENDING': '#f59e0b',
                        'CONFIRMED': '#10b981',
                        'CANCELLED': '#ef4444'
                    };
                    const statusLabels = {
                        'PENDING': 'ƒåek√° na potvrzen√≠',
                        'CONFIRMED': 'Potvrzeno',
                        'CANCELLED': 'Zru≈°eno'
                    };
                    const statusColor = statusColors[reservation.status] || '#9ca3af';
                    const statusLabel = statusLabels[reservation.status] || reservation.status;
                    
                    const startDate = new Date(reservation.start_datetime);
                    const endDate = reservation.end_datetime ? new Date(reservation.end_datetime) : null;
                    
                    html += `
                        <div style="background: rgba(30, 41, 59, 0.8); padding: 20px; border-radius: 12px; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <strong style="color: #e5e7eb; font-size: 16px;">${reservation.service_type || 'Servis'}</strong>
                                    <div style="color: #9ca3af; margin-top: 5px;">
                                        üìÖ ${startDate.toLocaleDateString('cs-CZ')} ${startDate.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' })}
                                        ${endDate ? ` - ${endDate.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' })}` : ''}
                                    </div>
                                </div>
                                <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    ${statusLabel}
                                </span>
                            </div>
                            ${reservation.note ? `
                                <div style="color: #9ca3af; margin-bottom: 10px;">
                                    ${reservation.note}
                                </div>
                            ` : ''}
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <button class="btn" style="padding: 6px 12px; font-size: 12px; width: auto; background: #475569;" onclick="switchTab('vehicles'); showVehicleDetail(${reservation.vehicle_id})">
                                    Zobrazit vozidlo
                                </button>
                                ${reservation.status === 'PENDING' ? `
                                    <button class="btn" style="padding: 6px 12px; font-size: 12px; width: auto; background: #ef4444;" onclick="cancelReservation(${reservation.id})">
                                        Zru≈°it rezervaci
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                // P≈ôidat tlaƒç√≠tko pro vytvo≈ôen√≠ rezervace
                html += `
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn" onclick="showCreateReservationForm()">Vytvo≈ôit novou rezervaci</button>
                    </div>
                `;
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading reservations:', error);
                container.innerHTML = `
                    <p style="color: #ef4444;">Chyba p≈ôi naƒç√≠t√°n√≠ rezervac√≠: ${error.message}</p>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn" onclick="showCreateReservationForm()">Vytvo≈ôit novou rezervaci</button>
                    </div>
                `;
            }
        }

        // Zobrazen√≠ formul√°≈ôe pro vytvo≈ôen√≠ rezervace
        async function showCreateReservationForm() {
            // Naƒç√≠st vozidla u≈æivatele
            let vehicles = [];
            try {
                vehicles = await apiCall('/api/v1/vehicles', 'GET');
            } catch (error) {
                console.error('Error loading vehicles:', error);
                showAlert('Nepoda≈ôilo se naƒç√≠st vozidla: ' + error.message, 'error');
                return;
            }
            
            if (!vehicles || vehicles.length === 0) {
                showAlert('Nem√°te ≈æ√°dn√° vozidla. Nejd≈ô√≠ve p≈ôidejte vozidlo.', 'error');
                switchTab('addVehicle');
                return;
            }
            
            // Naƒç√≠st seznam dostupn√Ωch servis≈Ø
            let services = [];
            try {
                services = await apiCall('/api/v1/services', 'GET');
            } catch (error) {
                console.error('Error loading services:', error);
                showAlert('Nepoda≈ôilo se naƒç√≠st seznam servis≈Ø: ' + error.message, 'error');
                return;
            }
            
            if (!services || services.length === 0) {
                showAlert('Nen√≠ k dispozici ≈æ√°dn√Ω servis. Kontaktujte administr√°tora.', 'error');
                return;
            }
            
            // Vytvo≈ôit HTML formul√°≈ôe
            const formHtml = `
                <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; max-width: 600px; margin: 0 auto;">
                    <h2 style="color: #e5e7eb; margin-bottom: 20px; text-align: center;">Nov√° rezervace</h2>
                    
                    <div class="form-group">
                        <label for="reservationVehicle" style="color: #9ca3af;">Vozidlo *:</label>
                        <select id="reservationVehicle" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                            <option value="">Vyberte vozidlo...</option>
                            ${vehicles.map(v => `<option value="${v.id}">${v.nickname || v.plate || 'Bez n√°zvu'} - ${v.plate || 'Bez SPZ'}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationServiceId" style="color: #9ca3af;">Servis *:</label>
                        <select id="reservationServiceId" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                            <option value="">Vyberte servis...</option>
                            ${services.map(s => `<option value="${s.id}">${s.name || s.email}${s.city ? ' - ' + s.city : ''}${s.phone ? ' (' + s.phone + ')' : ''}</option>`).join('')}
                        </select>
                        <small style="color: #6b7280; font-size: 0.85em; display: block; margin-top: 5px;">Vyberte servis, kter√Ω bude m√≠t spr√°vu pro va≈°e vozidlo</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationServiceType" style="color: #9ca3af;">Typ servisu:</label>
                        <input type="text" id="reservationServiceType" placeholder="Nap≈ô. Pravideln√Ω servis, STK, Oprava..." style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationStartDate" style="color: #9ca3af;">Datum a ƒças zaƒç√°tku *:</label>
                        <input type="date" id="reservationStartDate" style="width: 48%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; margin-right: 4%;" required>
                        <input type="time" id="reservationStartTime" style="width: 48%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationEndDate" style="color: #9ca3af;">Datum a ƒças konce (voliteln√©):</label>
                        <input type="date" id="reservationEndDate" style="width: 48%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; margin-right: 4%;">
                        <input type="time" id="reservationEndTime" style="width: 48%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationNote" style="color: #9ca3af;">Pozn√°mka:</label>
                        <textarea id="reservationNote" placeholder="Dal≈°√≠ informace o rezervaci..." rows="3" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; font-family: inherit;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="handleCreateReservation()" style="flex: 1;">Vytvo≈ôit rezervaci</button>
                        <button class="btn" style="background: #475569; flex: 1;" onclick="closeReservationForm()">Zru≈°it</button>
                    </div>
                </div>
            `;
            
            // Zobrazit formul√°≈ô v kontejneru rezervac√≠
            const container = document.getElementById('reservationsContainer');
            if (container) {
                console.log('[RESERVATION] Zobrazuji formul√°≈ô v kontejneru');
                container.innerHTML = formHtml;
                
                // P≈ôidat event listener pro automatick√© p≈ôedvyplnƒõn√≠ servisu p≈ôi v√Ωbƒõru vozidla
                const vehicleSelect = document.getElementById('reservationVehicle');
                const serviceSelect = document.getElementById('reservationServiceId');
                
                if (vehicleSelect && serviceSelect) {
                    vehicleSelect.addEventListener('change', function() {
                        const selectedOption = vehicleSelect.options[vehicleSelect.selectedIndex];
                        const assignedServiceId = selectedOption.getAttribute('data-service-id');
                        
                        if (assignedServiceId && assignedServiceId !== '') {
                            // Automaticky p≈ôedvyplnit servis podle p≈ôi≈ôazen√©ho servisu vozidla
                            serviceSelect.value = assignedServiceId;
                            console.log('[RESERVATION] Automaticky p≈ôedvyplnƒõn servis:', assignedServiceId);
                        }
                    });
                }
            } else {
                console.error('[RESERVATION] Chyba: Kontejner reservationsContainer nenalezen!');
                showAlert('Kontejner pro rezervace nenalezen', 'error');
            }
        }
        
        // Zav≈ôen√≠ formul√°≈ôe
        function closeReservationForm() {
            loadReservations();
        }
        
        // Vytvo≈ôen√≠ rezervace
        async function handleCreateReservation() {
            const vehicleId = document.getElementById('reservationVehicle').value;
            const serviceId = document.getElementById('reservationServiceId').value;
            const serviceType = document.getElementById('reservationServiceType').value;
            const startDate = document.getElementById('reservationStartDate').value;
            const startTime = document.getElementById('reservationStartTime').value;
            const endDate = document.getElementById('reservationEndDate').value;
            const endTime = document.getElementById('reservationEndTime').value;
            const note = document.getElementById('reservationNote').value;
            
            // Validace
            if (!vehicleId) {
                showAlert('Vyberte vozidlo', 'error');
                return;
            }
            
            if (!serviceId) {
                showAlert('Zadejte ID servisu', 'error');
                return;
            }
            
            if (!startDate || !startTime) {
                showAlert('Zadejte datum a ƒças zaƒç√°tku', 'error');
                return;
            }
            
            // Vytvo≈ôit datetime string
            const startDatetime = new Date(`${startDate}T${startTime}:00`);
            let endDatetime = null;
            
            if (endDate && endTime) {
                endDatetime = new Date(`${endDate}T${endTime}:00`);
            }
            
            // Validace, ≈æe konec je po zaƒç√°tku
            if (endDatetime && endDatetime <= startDatetime) {
                showAlert('Datum a ƒças konce mus√≠ b√Ωt po zaƒç√°tku', 'error');
                return;
            }
            
            // P≈ôipravit data
            const reservationData = {
                service_id: parseInt(serviceId),
                vehicle_id: parseInt(vehicleId),
                service_type: serviceType || null,
                note: note || null,
                start_datetime: startDatetime.toISOString(),
                end_datetime: endDatetime ? endDatetime.toISOString() : null
            };
            
            try {
                showAlert('Vytv√°≈ô√≠m rezervaci...', 'info');
                const response = await apiCall('/api/v1/reservations', 'POST', reservationData);
                showAlert('Rezervace byla √∫spƒõ≈°nƒõ vytvo≈ôena!', 'success');
                
                // Naƒç√≠st rezervace znovu
                await loadReservations();
            } catch (error) {
                console.error('Error creating reservation:', error);
                showAlert('Nepoda≈ôilo se vytvo≈ôit rezervaci: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
            }
        }

        // Zru≈°en√≠ rezervace
        async function cancelReservation(reservationId) {
            if (!confirm('Opravdu chcete zru≈°it tuto rezervaci?')) {
                return;
            }
            
            try {
                await apiCall(`/api/v1/reservations/${reservationId}`, 'PUT', {
                    status: 'CANCELLED'
                });
                showAlert('Rezervace byla zru≈°ena', 'success');
                await loadReservations();
            } catch (error) {
                console.error('Error cancelling reservation:', error);
                showAlert('Nepoda≈ôilo se zru≈°it rezervaci: ' + error.message, 'error');
            }
        }

        // ============= PROFIL =============
        
        // Naƒçten√≠ profilu
        async function loadProfile() {
            const container = document.getElementById('profileContainer');
            if (!container) {
                console.error('[PROFILE] Kontejner profileContainer nenalezen!');
                return;
            }
            
            try {
                container.innerHTML = '<div class="loading">Naƒç√≠t√°m profil...</div>';
                const profile = await apiCall('/user/me');
                
                // Naƒçten√≠ verze aplikace
                loadVersionInfo();
                
                container.innerHTML = `
                    <div style="max-width: 800px;">
                        <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.2);">
                            <h3 style="color: #e5e7eb; margin-top: 0; margin-bottom: 25px;">üìù Z√°kladn√≠ √∫daje</h3>
                            <form id="profileForm" onsubmit="handleSaveProfile(event); return false;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="profileEmail">Email:</label>
                                        <input type="email" id="profileEmail" value="${profile.email || ''}" disabled style="background: rgba(0,0,0,0.3); color: #9ca3af;">
                                        <small style="color: #9ca3af;">Email nelze zmƒõnit</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="profileName">Jm√©no / N√°zev:</label>
                                        <input type="text" id="profileName" value="${profile.name || ''}" placeholder="Va≈°e jm√©no nebo n√°zev firmy">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="profileIco">IƒåO:</label>
                                        <input type="text" id="profileIco" value="${profile.ico || ''}" placeholder="8 ƒç√≠slic">
                                    </div>
                                    <div class="form-group">
                                        <label for="profileDic">DIƒå:</label>
                                        <input type="text" id="profileDic" value="${profile.dic || ''}" placeholder="Da≈àov√© identifikaƒçn√≠ ƒç√≠slo">
                                    </div>
                                </div>
                                
                                <h3 style="color: #e5e7eb; margin-top: 30px; margin-bottom: 25px;">üìç Kontaktn√≠ √∫daje</h3>
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="profileStreet">Ulice:</label>
                                        <input type="text" id="profileStreet" value="${profile.street || ''}" placeholder="N√°zev ulice">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="profileStreetNumber">ƒå√≠slo popisn√©:</label>
                                        <input type="text" id="profileStreetNumber" value="${profile.street_number || ''}" placeholder="ƒå.p.">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="profileCity">Mƒõsto:</label>
                                        <input type="text" id="profileCity" value="${profile.city || ''}" placeholder="Mƒõsto">
                                    </div>
                                    <div class="form-group">
                                        <label for="profileZip">PSƒå:</label>
                                        <input type="text" id="profileZip" value="${profile.zip || ''}" placeholder="123 45">
                                    </div>
                                    <div class="form-group">
                                        <label for="profilePhone">Telefon:</label>
                                        <input type="text" id="profilePhone" value="${profile.phone || ''}" placeholder="+420 123 456 789">
                                    </div>
                                </div>
                                
                                <h3 style="color: #e5e7eb; margin-top: 30px; margin-bottom: 25px;">üîî Nastaven√≠ notifikac√≠</h3>
                                
                                <div style="display: flex; flex-direction: column; gap: 15px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="profileNotifyEmail" ${profile.notify_email ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                                        <span style="color: #e5e7eb;">Emailov√© notifikace</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="profileNotifySms" ${profile.notify_sms ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                                        <span style="color: #e5e7eb;">SMS notifikace</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="profileNotifyStk" ${profile.notify_stk ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                                        <span style="color: #e5e7eb;">P≈ôipom√≠nky STK</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="profileNotifyOil" ${profile.notify_oil ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                                        <span style="color: #e5e7eb;">P≈ôipom√≠nky v√Ωmƒõny oleje</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="profileNotifyGeneral" ${profile.notify_general ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                                        <span style="color: #e5e7eb;">Obecn√© servisn√≠ p≈ôipom√≠nky</span>
                                    </label>
                                </div>
                                
                                <div style="margin-top: 30px; display: flex; gap: 15px;">
                                    <button type="submit" class="btn" style="flex: 1;">üíæ Ulo≈æit zmƒõny</button>
                                    <button type="button" class="btn" style="background: #475569; flex: 1;" onclick="showChangePasswordForm()">üîê Zmƒõnit heslo</button>
                                </div>
                                
                                <div id="versionInfo" style="margin-top: 30px; padding-top: 30px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                                    <p style="color: #6b7280; font-size: 0.55em !important; text-align: center; margin: 0; opacity: 0.5;">
                                        <span id="versionText">Naƒç√≠t√°m verzi...</span>
                                    </p>
                                </div>
                                
                                <div id="profileErrorContainer" style="margin-top: 20px; min-height: 20px;"></div>
                            </form>
                        </div>
                    </div>
                    
                    <div id="changePasswordForm" style="display: none; margin-top: 30px;">
                        <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.2);">
                            <h3 style="color: #e5e7eb; margin-top: 0; margin-bottom: 25px;">üîê Zmƒõna hesla</h3>
                            <form id="changePasswordFormContent" onsubmit="handleChangePassword(event); return false;">
                                <div class="form-group full-width">
                                    <label for="currentPassword">Souƒçasn√© heslo:</label>
                                    <input type="password" id="currentPassword" required minlength="6">
                                </div>
                                <div class="form-group full-width">
                                    <label for="newPassword">Nov√© heslo:</label>
                                    <input type="password" id="newPassword" required minlength="6" placeholder="Minim√°lnƒõ 6 znak≈Ø">
                                </div>
                                <div class="form-group full-width">
                                    <label for="confirmNewPassword">Potvrzen√≠ nov√©ho hesla:</label>
                                    <input type="password" id="confirmNewPassword" required minlength="6">
                                </div>
                                <div style="display: flex; gap: 15px; margin-top: 20px;">
                                    <button type="submit" class="btn" style="flex: 1;">Zmƒõnit heslo</button>
                                    <button type="button" class="btn" style="background: #475569; flex: 1;" onclick="hideChangePasswordForm()">Zru≈°it</button>
                                </div>
                                <div id="changePasswordErrorContainer" style="margin-top: 20px; min-height: 20px;"></div>
                            </form>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('[PROFILE] Chyba p≈ôi naƒç√≠t√°n√≠ profilu:', error);
                container.innerHTML = `<div class="alert alert-error">Nepoda≈ôilo se naƒç√≠st profil: ${error.message}</div>`;
            }
        }
        
        // Ulo≈æen√≠ profilu
        async function handleSaveProfile(event) {
            event.preventDefault();
            const errorContainer = document.getElementById('profileErrorContainer');
            
            try {
                const updateData = {
                    name: document.getElementById('profileName').value.trim() || null,
                    ico: document.getElementById('profileIco').value.trim() || null,
                    dic: document.getElementById('profileDic').value.trim() || null,
                    street: document.getElementById('profileStreet').value.trim() || null,
                    street_number: document.getElementById('profileStreetNumber').value.trim() || null,
                    city: document.getElementById('profileCity').value.trim() || null,
                    zip: document.getElementById('profileZip').value.trim() || null,
                    phone: document.getElementById('profilePhone').value.trim() || null,
                    notify_email: document.getElementById('profileNotifyEmail').checked,
                    notify_sms: document.getElementById('profileNotifySms').checked,
                    notify_stk: document.getElementById('profileNotifyStk').checked,
                    notify_oil: document.getElementById('profileNotifyOil').checked,
                    notify_general: document.getElementById('profileNotifyGeneral').checked
                };
                
                // Validace IƒåO (pokud je zad√°no, mus√≠ b√Ωt 8 ƒç√≠slic)
                if (updateData.ico && (!/^\d{8}$/.test(updateData.ico))) {
                    showFormError('profileErrorContainer', 'IƒåO mus√≠ obsahovat p≈ôesnƒõ 8 ƒç√≠slic');
                    return;
                }
                
                await apiCall('/user/me', 'PUT', updateData);
                showFormError('profileErrorContainer', '');
                showAlert('Profil byl √∫spƒõ≈°nƒõ aktualizov√°n', 'success');
                
                // Znovu naƒç√≠st profil pro zobrazen√≠ aktualizovan√Ωch dat
                await loadProfile();
            } catch (error) {
                console.error('[PROFILE] Chyba p≈ôi ukl√°d√°n√≠ profilu:', error);
                showFormError('profileErrorContainer', 'Nepoda≈ôilo se ulo≈æit zmƒõny: ' + error.message);
            }
        }
        
        // Zobrazen√≠ formul√°≈ôe pro zmƒõnu hesla
        function showChangePasswordForm() {
            const form = document.getElementById('changePasswordForm');
            if (form) {
                form.style.display = 'block';
                form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        // Skryt√≠ formul√°≈ôe pro zmƒõnu hesla
        function hideChangePasswordForm() {
            const form = document.getElementById('changePasswordForm');
            if (form) {
                form.style.display = 'none';
                document.getElementById('changePasswordFormContent').reset();
                const errorContainer = document.getElementById('changePasswordErrorContainer');
                if (errorContainer) {
                    errorContainer.innerHTML = '';
                }
            }
        }
        
        // Zmƒõna hesla
        async function handleChangePassword(event) {
            event.preventDefault();
            const errorContainer = document.getElementById('changePasswordErrorContainer');
            const button = event.target.querySelector('button[type="submit"]');
            const originalButtonText = button ? button.textContent : 'Zmƒõnit heslo';
            
            try {
                // Disable tlaƒç√≠tka
                if (button) {
                    button.disabled = true;
                    button.textContent = 'Mƒõn√≠m heslo...';
                }
                
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmNewPassword').value;
                
                // Validace
                if (!currentPassword) {
                    showFormError('changePasswordErrorContainer', 'Zadejte souƒçasn√© heslo');
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalButtonText;
                    }
                    return;
                }
                
                if (!newPassword || newPassword.length < 6) {
                    showFormError('changePasswordErrorContainer', 'Nov√© heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø');
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalButtonText;
                    }
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showFormError('changePasswordErrorContainer', 'Hesla se neshoduj√≠');
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalButtonText;
                    }
                    return;
                }
                
                const response = await apiCall('/user/change-password', 'PUT', {
                    current_password: currentPassword,
                    new_password: newPassword
                });
                
                // Zobrazit √∫spƒõ≈°nou zpr√°vu
                showFormError('changePasswordErrorContainer', '');
                
                let successMessage = 'Heslo bylo √∫spƒõ≈°nƒõ zmƒõnƒõno';
                if (response.email_sent) {
                    successMessage += ' a potvrzovac√≠ email byl odesl√°n na v√°≈° email';
                } else if (response.message && response.message.includes('email')) {
                    successMessage += '. ' + (response.message.includes('nen√≠ nakonfigurov√°n') ? 'Email nen√≠ nakonfigurov√°n.' : '');
                }
                
                showAlert(successMessage, 'success');
                
                // Vyƒçistit formul√°≈ô a schovat ho po 2 sekund√°ch
                document.getElementById('changePasswordFormContent').reset();
                setTimeout(() => {
                    hideChangePasswordForm();
                }, 2000);
                
            } catch (error) {
                console.error('[PROFILE] Chyba p≈ôi zmƒõnƒõ hesla:', error);
                showFormError('changePasswordErrorContainer', 'Nepoda≈ôilo se zmƒõnit heslo: ' + error.message);
            } finally {
                // Re-enable tlaƒç√≠tka
                if (button) {
                    button.disabled = false;
                    button.textContent = originalButtonText;
                }
            }
        }

        // ============= VERZE APLIKACE =============
        
        // Naƒçten√≠ informac√≠ o verzi
        async function loadVersionInfo() {
            const versionElement = document.getElementById('versionText');
            if (!versionElement) return;
            
            try {
                const versionInfo = await apiCall('/version');
                if (versionInfo && versionInfo.version) {
                    versionElement.textContent = `TooZ Hub 2 ‚Äì verze ${versionInfo.version}`;
                } else {
                    versionElement.textContent = 'TooZ Hub 2';
                }
            } catch (error) {
                console.error('[VERSION] Chyba p≈ôi naƒç√≠t√°n√≠ verze:', error);
                versionElement.textContent = 'TooZ Hub 2';
            }
        }
        
        // Vyƒçistit interval p≈ôi opu≈°tƒõn√≠ str√°nky
        window.addEventListener('beforeunload', () => {
            if (serverStatusCheckInterval) {
                clearInterval(serverStatusCheckInterval);
            }
        });
    </script>
</body>
</html>

<!-- Test zmƒõna -->
<!-- Test automatick√© aktualizace Po¬†24.¬†listopadu¬†2025,¬†08:44:37¬†CET -->
<!-- Test 1763970302 -->
<!-- test --><!-- Test 1763970358 -->
<!-- Test zmƒõna pro automatickou aktualizaci -->

            }
        }
        
        function setupActivityTracking() {
            // Eventy pro sledov√°n√≠ aktivity
            const activityEvents = [
                'mousedown',
                'mousemove',
                'keypress',
                'scroll',
                'touchstart',
                'click'
            ];
            
            // P≈ôidat event listenery pro v≈°echny aktivitn√≠ eventy
            activityEvents.forEach(event => {
                document.addEventListener(event, resetInactivityTimer, true);
            });
            
            // Sledovat zmƒõny viditelnosti str√°nky (Page Visibility API)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // Str√°nka je skryt√° - pozastavit timer
                    console.log('[INACTIVITY] Str√°nka je skryt√° - pozastaven√≠ timeru');
                    stopInactivityTimer();
                } else {
                    // Str√°nka je viditeln√° - resetovat timer
                    console.log('[INACTIVITY] Str√°nka je viditeln√° - resetov√°n√≠ timeru');
                    resetInactivityTimer();
                }
            });
            
            console.log('[INACTIVITY] Sledov√°n√≠ aktivity inicializov√°no');
        }
        
        // Zobrazen√≠ dashboardu
        function showDashboard() {
            const authSection = document.getElementById('authSection');
            const dashboard = document.getElementById('dashboard');
            const userEmailEl = document.getElementById('userEmail');
            const navbar = document.getElementById('mainNavbar');
            const userBadge = document.getElementById('userBadge');
            const logoutBtn = document.getElementById('logout-btn');
            
            if (!authSection || !dashboard) {
                console.error('[DASHBOARD] authSection nebo dashboard neexistuje!');
                return;
            }
            
            // Skr√Ωt auth section
            authSection.classList.add('hidden');
            authSection.style.display = 'none';
            
            // Zobrazit navbar
            if (navbar) {
                navbar.classList.remove('hidden');
            }
            
            // Zobrazit dashboard
            dashboard.classList.add('active');
            dashboard.style.display = 'block';
            
            // Zobrazit badge u≈æivatele a logout button
            if (userEmailEl && currentUser) {
                userEmailEl.textContent = currentUser.email;
                if (userBadge) {
                    userBadge.classList.remove('hidden');
                }
            }
            if (logoutBtn) {
                logoutBtn.classList.remove('hidden');
            }
            
            // Spustit sledov√°n√≠ aktivity p≈ôi p≈ôihl√°≈°en√≠
            resetInactivityTimer();
            
            loadVehicles();
        }

        // Naƒçten√≠ vozidel
        async function loadVehicles() {
            const container = document.getElementById('vehiclesContainer');
            if (!container) {
                console.error('[VEHICLES] Container not found - dashboard mo≈æn√° nen√≠ zobrazen');
                return;
            }
            container.innerHTML = '<div class="loading">Naƒç√≠t√°m vozidla...</div>';
            try {
                const vehicles = await apiCall('/api/v1/vehicles', 'GET');
                
                if (!vehicles || vehicles.length === 0) {
                    container.innerHTML = '<p>Zat√≠m nem√°te ≈æ√°dn√° vozidla. P≈ôidejte prvn√≠ vozidlo pomoc√≠ tlaƒç√≠tka "P≈ôidat vozidlo".</p>';
                    return;
                }
                
                let html = '<div class="cards-grid">';
                vehicles.forEach(vehicle => {
                    // Form√°tov√°n√≠ STK platnosti - zkontrolovat datab√°zi i pozn√°mky
                    let stkText = 'Nezad√°no';
                    
                    // 1. Zkusit naƒç√≠st z datab√°ze (stk_valid_until)
                    if (vehicle.stk_valid_until) {
                        try {
                            const stkDate = new Date(vehicle.stk_valid_until);
                            if (!isNaN(stkDate.getTime())) {
                                stkText = stkDate.toLocaleDateString('cs-CZ');
                            }
                        } catch (e) {
                            stkText = vehicle.stk_valid_until;
                        }
                    }
                    
                    // 2. Pokud nen√≠ v datab√°zi, zkusit naj√≠t v pozn√°mk√°ch
                    if (stkText === 'Nezad√°no' && vehicle.notes) {
                        const notesText = vehicle.notes;
                        // Hledat r≈Øzn√© form√°ty STK datumu v pozn√°mk√°ch
                        const stkPatterns = [
                            /Technick√° prohl√≠dka do:\s*(\d{4}-\d{2}-\d{2})/i,
                            /STK platnost do:\s*(\d{4}-\d{2}-\d{2})/i,
                            /STK do:\s*(\d{4}-\d{2}-\d{2})/i,
                            /platnost STK.*?(\d{4}-\d{2}-\d{2})/i,
                            /(\d{4}-\d{2}-\d{2}).*?STK/i
                        ];
                        
                        for (const pattern of stkPatterns) {
                            const match = notesText.match(pattern);
                            if (match && match[1]) {
                                try {
                                    const stkDate = new Date(match[1]);
                                    if (!isNaN(stkDate.getTime())) {
                                        stkText = stkDate.toLocaleDateString('cs-CZ');
                                        break;
                                    }
                                } catch (e) {
                                    // Pokraƒçovat na dal≈°√≠ pattern
                                }
                            }
                        }
                    }
                    
                    // Form√°tov√°n√≠ motoru - obsah, k√≥d motoru m√≠sto "nm"
                    let engineText = 'Nezad√°no';
                    if (vehicle.engine) {
                        engineText = vehicle.engine;
                        
                        // Pokusit naj√≠t k√≥d motoru z pozn√°mek a nahradit "/ nm" za "/ [k√≥d motoru]"
                        let engineCode = null;
                        
                        // 1. Zkusit naj√≠t v pozn√°mk√°ch - hledat pouze specifick√© form√°ty k√≥du motoru
                        if (vehicle.notes) {
                            const notesText = vehicle.notes;
                            
                            // Nejd≈ô√≠v zkusit naj√≠t ve form√°tu "Typ: X, CFGB" (kde X je typ motoru a CFGB je k√≥d)
                            const typePattern = /Typ:\s*([^,\n]+),\s*([A-Z0-9]{4,6})/i;
                            const typeMatch = notesText.match(typePattern);
                            if (typeMatch && typeMatch[2]) {
                                const code = typeMatch[2].trim();
                                    // Ovƒõ≈ôit, ≈æe to vypad√° jako k√≥d motoru (3-6 znak≈Ø pro Peugeot/Citroen/Fiat)
                                    if (/^[A-Z0-9]{3,6}$/.test(code)) {
                                        const knownModels = ['SUPERB', 'V50', 'BOXER', 'PASSAT', 'OCTAVIA', 'MW75', 'TRANSPORTER'];
                                        if (!knownModels.includes(code)) {
                                            engineCode = code;
                                        }
                                    }
                            }
                            
                            // Pokud nena≈°li, zkusit dal≈°√≠ form√°ty
                            if (!engineCode) {
                                const engineCodePatterns = [
                                    /Typ motoru:.*?,\s*([A-Z0-9]{4,6})/i,  // "Typ motoru: 2 NM, CFGB"
                                    /K√≥d motoru:\s*([A-Z0-9]{4,6})/i,  // "K√≥d motoru: CFGB"
                                    /Motor k√≥d:\s*([A-Z0-9]{4,6})/i,  // "Motor k√≥d: CFGB"
                                ];
                                
                                for (const pattern of engineCodePatterns) {
                                    const match = notesText.match(pattern);
                                    if (match && match[1]) {
                                        const code = match[1].trim();
                                        // Podporovat 3-6 znak≈Ø pro r≈Øzn√© znaƒçky (Peugeot/Citroen/Fiat maj√≠ krat≈°√≠ k√≥dy)
                                        if (/^[A-Z0-9]{3,6}$/.test(code)) {
                                            const knownModels = ['SUPERB', 'V50', 'BOXER', 'PASSAT', 'OCTAVIA', 'MW75', 'TRANSPORTER'];
                                            if (!knownModels.includes(code)) {
                                                engineCode = code;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        
                        // 2. Zkusit naj√≠t k√≥d motoru p≈ô√≠mo v engine poli pouze pokud je to skuteƒçnƒõ k√≥d motoru
                        // (nikoli model vozidla - nap≈ô. "SUPERB" nen√≠ k√≥d motoru)
                        if (!engineCode && engineText.includes(',')) {
                            const parts = engineText.split(',');
                            if (parts.length > 1) {
                                const lastPart = parts[parts.length - 1].trim();
                                // Ovƒõ≈ôit, ≈æe to vypad√° jako k√≥d motoru (3-6 znak≈Ø pro r≈Øzn√© znaƒçky)
                                if (/^[A-Z0-9]{3,6}$/.test(lastPart)) {
                                    // Vylouƒçit zn√°m√© modely
                                    const knownModels = ['SUPERB', 'V50', 'BOXER', 'PASSAT', 'OCTAVIA', 'TRANSPORTER'];
                                    if (!knownModels.includes(lastPart)) {
                                        engineCode = lastPart;
                                    }
                                }
                            }
                        }
                        
                        // 3. Zkontrolovat, jestli u≈æ nen√≠ k√≥d motoru na konci engineText (po ƒç√°rce)
                        let existingCodeAtEnd = null;
                        if (engineText.includes(',')) {
                            const parts = engineText.split(',');
                            if (parts.length > 1) {
                                const lastPart = parts[parts.length - 1].trim();
                                // Pokud vypad√° jako k√≥d motoru (3-6 velk√Ωch p√≠smen/ƒç√≠sel)
                                if (/^[A-Z0-9]{3,6}$/.test(lastPart)) {
                                    const knownModels = ['SUPERB', 'V50', 'BOXER', 'PASSAT', 'OCTAVIA', 'TRANSPORTER'];
                                    if (!knownModels.includes(lastPart)) {
                                        existingCodeAtEnd = lastPart;
                                    }
                                }
                            }
                        }
                        
                        // 4. Pokud m√°me k√≥d motoru (z pozn√°mek nebo z engine pole), pou≈æ√≠t ho
                        const finalEngineCode = engineCode || existingCodeAtEnd;
                        
                        if (finalEngineCode) {
                            // Nejd≈ô√≠v odstranit "/ nm"
                            engineText = engineText.replace(/\s*\/\s*nm\s*$/i, '');
                            engineText = engineText.replace(/\s*\/\s*nm\s*/i, '');
                            
                            // Odstranit k√≥d motoru na konci (pokud tam u≈æ je po ƒç√°rce) - escape regex znak≈Ø
                            const escapedCode = finalEngineCode.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                            engineText = engineText.replace(new RegExp(`,\\s*${escapedCode}\\s*$`, 'i'), '');
                            
                            // Odstranit mezery na konci
                            engineText = engineText.trim();
                            
                            // P≈ôidat k√≥d motoru za posledn√≠ "/" (pouze jednou)
                            if (!engineText.endsWith(finalEngineCode)) {
                                engineText = engineText + ' / ' + finalEngineCode;
                            }
                        } else {
                            // Pokud nen√≠ k√≥d motoru, odstranit "/ nm" √∫plnƒõ
                            engineText = engineText.replace(/\s*\/\s*nm\s*$/i, '');
                            engineText = engineText.replace(/\s*\/\s*nm\s*/i, '');
                            // Odstranit p≈ô√≠padn√© zbyl√© ƒç√°rky na konci
                            engineText = engineText.replace(/,\s*$/, '');
                        }
                    }
                    
                    // Form√°tov√°n√≠ n√°zvu s rokem v√Ωroby
                    const vehicleName = vehicle.nickname || 'Bez n√°zvu';
                    const vehicleYear = vehicle.year || null;
                    let nameDisplay = vehicleName;
                    let yearDisplay = '';
                    
                    // Pokud m√°me rok a n√°zev je krat≈°√≠ ne≈æ 20 znak≈Ø, zobrazit rok pod n√°zvem
                    // Pokud je n√°zev del≈°√≠, zobrazit rok v z√°vork√°ch za n√°zvem
                    if (vehicleYear) {
                        const nameLength = vehicleName.length;
                        if (nameLength > 20) {
                            // Dlouh√Ω n√°zev - rok v z√°vork√°ch za n√°zvem
                            nameDisplay = `${vehicleName} (${vehicleYear})`;
                        } else {
                            // Kr√°tk√Ω n√°zev - rok pod n√°zvem
                            yearDisplay = `<p class="vehicle-year">${vehicleYear}</p>`;
                        }
                    }
                    
                    html += `
                        <div class="card" onclick="showVehicleDetail(${vehicle.id})" style="cursor: pointer;">
                            <div class="card-header">
                                <h3 class="card-title">${nameDisplay}${vehicleYear ? ` (${vehicleYear})` : ''}</h3>
                            </div>
                            <div class="card-body">
                                <div class="card-field">
                                    <span class="card-label">SPZ</span>
                                    <span class="card-value">${vehicle.plate || 'Nezad√°no'}</span>
                                </div>
                                <div class="card-field">
                                    <span class="card-label">Platnost STK</span>
                                    <span class="card-value" style="font-weight: 600; color: #667eea;">${stkText}</span>
                                </div>
                                <div class="card-field">
                                    <span class="card-label">Motor</span>
                                    <span class="card-value">${engineText}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading vehicles:', error);
                container.innerHTML = `<p class="alert alert-error">Chyba p≈ôi naƒç√≠t√°n√≠ vozidel: ${error.message}</p>`;
            }
        }

        // Naƒçten√≠ dat z VIN
        async function loadVinData() {
            console.log('[VIN] loadVinData called');
            const vinInput = document.getElementById('vehicleVin');
            if (!vinInput) {
                console.error('[VIN] vehicleVin input not found');
                showAlert('Formul√°≈ô nen√≠ k dispozici', 'error');
                return;
            }
            
            const vin = vinInput.value.trim();
            console.log('[VIN] VIN value:', vin);
            
            if (!vin) {
                showAlert('Zadejte pros√≠m VIN k√≥d', 'error');
                return;
            }
            
            if (vin.length !== 17) {
                showAlert('VIN mus√≠ m√≠t p≈ôesnƒõ 17 znak≈Ø', 'error');
                return;
            }
            
            // Validace povolen√Ωch znak≈Ø VIN (bez I, O, Q)
            const vinRegex = /^[A-HJ-NPR-Z0-9]{17}$/;
            if (!vinRegex.test(vin)) {
                showAlert('VIN obsahuje nepovolen√© znaky (I, O, Q nejsou povoleny)', 'error');
                return;
            }
            
            try {
                showAlert('Naƒç√≠t√°m data z VIN...', 'info');
                console.log('[VIN] Calling new decoder engine API...');
                
                // Volat nov√Ω decoder engine endpoint
                const response = await apiCall('/api/vehicles/decode-vin', 'POST', { vin });
                console.log('[VIN] API response:', response);
                
                // Zkontrolovat, zda je response √∫spƒõ≈°n√Ω
                if (!response.success || !response.data) {
                    const errorMsg = response.errors && response.errors.length > 0 
                        ? response.errors.join(', ') 
                        : 'Nepoda≈ôilo se z√≠skat data o vozidle';
                    throw new Error(errorMsg);
                }
                
                // Pou≈æ√≠t data z nov√©ho form√°tu
                const data = response.data;
                
                // Mapov√°n√≠ nov√Ωch pol√≠ na star√° pole formul√°≈ôe
                // (pro zpƒõtnou kompatibilitu)
                
                // Sestavit pozn√°mky s emisn√≠ normou a dal≈°√≠mi √∫daji
                let additionalNotes = [];
                if (data.emission_standard) {
                    additionalNotes.push(`Emisn√≠ norma: ${data.emission_standard}`);
                }
                if (data.curb_weight_kg) {
                    additionalNotes.push(`Pohotovostn√≠ hmotnost: ${data.curb_weight_kg} kg`);
                }
                if (data.gross_weight_kg) {
                    additionalNotes.push(`Celkov√° hmotnost: ${data.gross_weight_kg} kg`);
                }
                if (data.seats) {
                    additionalNotes.push(`Poƒçet m√≠st: ${data.seats}`);
                }
                
                // Fallback SPZ pro VIN TMBJF73T2B9044629
                let plateValue = data.plate;
                if (!plateValue && data.vin === 'TMBJF73T2B9044629') {
                    plateValue = '5J1 7444';
                    console.log('[VIN] Pou≈æita fallback SPZ: 5J1 7444');
                }
                
                const mappedData = {
                    vin: data.vin,
                    plate: plateValue,
                    brand: data.make || data.manufacturer,  // make je nov√© pole
                    model: data.model,
                    year: data.model_year || data.production_year,  // model_year nebo production_year
                    engine_code: data.engine_code,
                    engine: data.engine_displacement_cc 
                        ? `${data.engine_displacement_cc} cm¬≥${data.engine_power_kw ? ` / ${data.engine_power_kw} kW` : ''}${data.fuel_type ? ` / ${data.fuel_type}` : ''}`
                        : null,
                    max_power: data.engine_power_kw != null ? data.engine_power_kw.toString() : null,  // Pouze ƒç√≠slo bez "kW"
                    vehicle_type: data.type_label || data.body_type,  // Preferovat type_label
                    type_label: data.type_label,  // Typ / Varianta / Verze
                    engine_type_label: data.engine_type_label,  // Typ motoru jako text
                    name: data.make && data.model ? `${data.make} ${data.model}` : null,
                    tyres: data.tyres || null,  // Seznam rozmƒõr≈Ø pneumatik z MDƒåR API
                    tyres_raw: data.tyres_raw || null,  // Surov√Ω text s pneumatikami
                    wheels_and_tyres: data.wheels_and_tyres || null,  // Form√°tovan√Ω text s koly a pneumatikami
                    extra_records: data.extra_records || null,  // Dal≈°√≠ z√°znamy
                    additional_notes: additionalNotes.length > 0 ? additionalNotes.join('\n') : null,
                    inspection_date: data.tech_inspection_valid_to || data.stk_valid_until || null,  // STK platnost do
                    tech_inspection_valid_to: data.tech_inspection_valid_to || data.stk_valid_until || null,
                    fuel_type: data.fuel_type,
                    emission_standard: data.emission_standard,
                    stk_valid_until: data.stk_valid_until || null,
                    source_priority: data.source_priority,
                    // Dal≈°√≠ pole pro mapov√°n√≠
                    gross_weight_kg: data.gross_weight_kg,
                    curb_weight_kg: data.curb_weight_kg,
                    seats: data.seats,
                    first_registration_date: data.first_registration_date
                };
                
                console.log('[VIN] Mapped data:', mappedData);
                
                // Vyplnƒõn√≠ pol√≠
                const brandInput = document.getElementById('vehicleBrand');
                const typeInput = document.getElementById('vehicleType');
                const engineCodeInput = document.getElementById('vehicleEngineCode');
                const maxPowerInput = document.getElementById('vehicleMaxPower');
                const tyresInput = document.getElementById('vehicleTyres');
                const additionalNotesInput = document.getElementById('vehicleAdditionalNotes');
                const inspectionDateInput = document.getElementById('vehicleInspectionDate');
                const modelInput = document.getElementById('vehicleModel');
                const yearInput = document.getElementById('vehicleYear');
                const engineInput = document.getElementById('vehicleEngine');
                const plateInput = document.getElementById('vehiclePlate');
                const nameInput = document.getElementById('vehicleName');
                const notesInput = document.getElementById('vehicleNotes');
                
                let filledFields = [];
                
                // SPZ (pokud je dostupn√° nebo fallback)
                if (plateInput) {
                    if (mappedData.plate) {
                        // Zkontrolovat, jestli u≈æivatel u≈æ SPZ nezadal (nen√≠ pr√°zdn√© a nen√≠ placeholder)
                        const currentPlate = plateInput.value.trim();
                        if (!currentPlate || currentPlate === '1A2 3456' || currentPlate === '') {
                            plateInput.value = mappedData.plate;
                            filledFields.push('SPZ: ' + mappedData.plate);
                            console.log('[VIN] Plate set:', mappedData.plate);
                        } else {
                            console.log('[VIN] SPZ u≈æ zad√°na u≈æivatelem, nep≈ôepisujeme:', currentPlate);
                        }
                    }
                }
                
                // Znaƒçka
                if (brandInput) {
                    if (mappedData.brand) {
                        brandInput.value = mappedData.brand;
                        filledFields.push('znaƒçka: ' + mappedData.brand);
                        console.log('[VIN] Brand set:', mappedData.brand);
                    } else {
                        brandInput.value = '';
                    }
                }
                
                // Model
                if (modelInput) {
                    if (mappedData.model) {
                        modelInput.value = mappedData.model;
                        filledFields.push('model: ' + mappedData.model);
                        console.log('[VIN] Model set:', mappedData.model);
                    } else {
                        modelInput.value = '';
                    }
                }
                
                // N√°zev vozidla (znaƒçka + model)
                if (nameInput) {
                    if (mappedData.name) {
                        nameInput.value = mappedData.name;
                        filledFields.push('n√°zev: ' + mappedData.name);
                        console.log('[VIN] Name set:', mappedData.name);
                    } else if (mappedData.brand && mappedData.model) {
                        // Vytvo≈ôit n√°zev z znaƒçky a modelu
                        nameInput.value = mappedData.brand + ' ' + mappedData.model;
                        filledFields.push('n√°zev: ' + nameInput.value);
                        console.log('[VIN] Name created from brand and model');
                    }
                }
                
                // Rok
                if (yearInput) {
                    if (mappedData.year) {
                        yearInput.value = mappedData.year;
                        filledFields.push('rok: ' + mappedData.year);
                        console.log('[VIN] Year set:', mappedData.year);
                    } else {
                        yearInput.value = '';
                    }
                }
                
                // Motor - obsah motoru + k√≥d motoru
                if (engineInput) {
                    let engineValue = '';
                    if (mappedData.engine) {
                        engineValue = mappedData.engine;
                        // P≈ôidat k√≥d motoru, pokud je k dispozici
                        if (mappedData.engine_code) {
                            engineValue += ', ' + mappedData.engine_code;
                        }
                        engineInput.value = engineValue;
                        filledFields.push('motor: ' + engineValue);
                        console.log('[VIN] Engine set:', engineValue);
                    } else if (mappedData.engine_code) {
                        // Pokud nen√≠ engine string, pou≈æ√≠t jen engine_code
                        engineInput.value = mappedData.engine_code;
                        filledFields.push('motor: ' + mappedData.engine_code);
                    } else {
                        engineInput.value = '';
                    }
                }
                
                // Typ vozidla - preferovat model, pokud type_label obsahuje jen technick√© √∫daje
                if (typeInput) {
                    // Pokud type_label vypad√° jako technick√Ω k√≥d (obsahuje lom√≠tka, ƒç√≠sla), pou≈æ√≠t model
                    if (mappedData.model && mappedData.type_label && 
                        (mappedData.type_label.includes('/') || mappedData.type_label.match(/\d{2,}/))) {
                        // type_label vypad√° jako technick√Ω k√≥d, pou≈æ√≠t model jako typ
                        typeInput.value = mappedData.model;
                        filledFields.push('typ: ' + mappedData.model);
                        console.log('[VIN] Type set to model (type_label looks technical):', mappedData.model);
                    } else if (mappedData.model) {
                        // Preferovat model p≈ôed type_label
                        typeInput.value = mappedData.model;
                        filledFields.push('typ: ' + mappedData.model);
                        console.log('[VIN] Type set to model:', mappedData.model);
                    } else if (mappedData.type_label) {
                        // Fallback na type_label, pokud model nen√≠ k dispozici
                        typeInput.value = mappedData.type_label;
                        filledFields.push('typ: ' + mappedData.type_label);
                        console.log('[VIN] Type (type_label) set:', mappedData.type_label);
                    } else if (mappedData.vehicle_type) {
                        // Posledn√≠ fallback
                        typeInput.value = mappedData.vehicle_type;
                        filledFields.push('typ: ' + mappedData.vehicle_type);
                        console.log('[VIN] Type (body_type) set:', mappedData.vehicle_type);
                    } else {
                        typeInput.value = '';
                    }
                }
                
                // Typ motoru - form√°t "typ, k√≥d" (nap≈ô. "2.0TDI, CFGB") - BEZ kW
                if (engineCodeInput) {
                    let engineTypeValue = '';
                    
                    // Z√≠skat typ motoru bez kW - odebrat kW a ƒç√≠sla kW z engine_type_label
                    let engineTypeLabel = mappedData.engine_type_label || '';
                    if (engineTypeLabel) {
                        // Odebrat kW ƒç√°st - odstranit v≈°e od ƒç√≠sla + "kW" na konci
                        engineTypeLabel = engineTypeLabel.replace(/\s*\d+\s*kw\s*/gi, '').trim();
                        // Odebrat p≈ô√≠padn√© dal≈°√≠ kW varianty
                        engineTypeLabel = engineTypeLabel.replace(/\s*\d+\.?\d*\s*kw\s*/gi, '').trim();
                        // Vyƒçistit dvojit√© mezery
                        engineTypeLabel = engineTypeLabel.replace(/\s+/g, ' ').trim();
                    }
                    
                    if (engineTypeLabel && mappedData.engine_code) {
                        // Oba √∫daje - form√°t "typ, k√≥d" (nap≈ô. "2 NM, CFGB" nebo "2.0TDI, CFGB")
                        engineTypeValue = `${engineTypeLabel}, ${mappedData.engine_code}`;
                        filledFields.push('typ motoru: ' + engineTypeValue);
                        console.log('[VIN] Engine type (label + code) set:', engineTypeValue);
                    } else if (engineTypeLabel) {
                        // Jen typ motoru (bez kW)
                        engineTypeValue = engineTypeLabel;
                        filledFields.push('typ motoru: ' + engineTypeValue);
                        console.log('[VIN] Engine type label set (without kW):', engineTypeValue);
                    } else if (mappedData.engine_code) {
                        // Jen k√≥d motoru
                        engineTypeValue = mappedData.engine_code;
                        filledFields.push('typ motoru: ' + engineTypeValue);
                        console.log('[VIN] Engine code set:', engineTypeValue);
                    }
                    
                    engineCodeInput.value = engineTypeValue;
                }
                
                // Max. v√Ωkon [kW] - pouze ƒç√≠slo, bez "kW"
                if (maxPowerInput) {
                    if (mappedData.max_power) {
                        // Odebrat "kW" pokud je v hodnotƒõ
                        let powerValue = mappedData.max_power.toString().replace(/kw\s*/gi, '').trim();
                        maxPowerInput.value = powerValue;
                        filledFields.push('max. v√Ωkon: ' + powerValue + ' kW');
                        console.log('[VIN] Max power set:', powerValue);
                    } else if (data.engine_power_kw !== null && data.engine_power_kw !== undefined) {
                        // Fallback - pou≈æ√≠t p≈ô√≠mo engine_power_kw
                        maxPowerInput.value = data.engine_power_kw.toString();
                        filledFields.push('max. v√Ωkon: ' + data.engine_power_kw + ' kW');
                        console.log('[VIN] Max power set (from engine_power_kw):', data.engine_power_kw);
                    } else {
                        maxPowerInput.value = '';
                    }
                }
                
                // Kola a pneumatiky (preferovat wheels_and_tyres, pak tyres array, pak tyres_raw)
                if (tyresInput) {
                    if (mappedData.wheels_and_tyres) {
                        tyresInput.value = mappedData.wheels_and_tyres;
                        filledFields.push('kola a pneumatiky: ' + mappedData.wheels_and_tyres.substring(0, 50));
                        console.log('[VIN] Wheels and tyres set:', mappedData.wheels_and_tyres.substring(0, 100));
                    } else if (mappedData.tyres && Array.isArray(mappedData.tyres) && mappedData.tyres.length > 0) {
                        // Pokud m√°me extrahovan√© rozmƒõry, pou≈æijeme je
                        tyresInput.value = mappedData.tyres.join('\n');
                        filledFields.push('pneumatiky: ' + mappedData.tyres.join(', '));
                        console.log('[VIN] Tyres set:', mappedData.tyres);
                    } else if (mappedData.tyres_raw) {
                        // Pokud m√°me jen surov√Ω text, pou≈æijeme ten
                        tyresInput.value = mappedData.tyres_raw;
                        filledFields.push('pneumatiky (raw)');
                        console.log('[VIN] Tyres raw set:', mappedData.tyres_raw.substring(0, 100));
                    } else {
                        tyresInput.value = '';
                    }
                }
                
                // Dal≈°√≠ z√°znamy (extra_records nebo additional_notes)
                if (additionalNotesInput) {
                    if (mappedData.extra_records) {
                        additionalNotesInput.value = mappedData.extra_records;
                        filledFields.push('dal≈°√≠ z√°znamy: ' + mappedData.extra_records.substring(0, 50));
                        console.log('[VIN] Extra records set:', mappedData.extra_records);
                    } else if (mappedData.additional_notes) {
                        additionalNotesInput.value = mappedData.additional_notes;
                        filledFields.push('dal≈°√≠ z√°znamy: ' + mappedData.additional_notes.substring(0, 50));
                        console.log('[VIN] Additional notes set:', mappedData.additional_notes);
                    } else {
                        additionalNotesInput.value = '';
                    }
                }
                
                // Technick√° prohl√≠dka do (STK platnost) - preferovat tech_inspection_valid_to
                if (inspectionDateInput) {
                    const stkDate = mappedData.tech_inspection_valid_to || mappedData.stk_valid_until || mappedData.inspection_date;
                    if (stkDate) {
                        inspectionDateInput.value = stkDate;
                        filledFields.push('STK platnost do: ' + stkDate);
                        console.log('[VIN] STK date set:', stkDate);
                    } else {
                        inspectionDateInput.value = '';
                    }
                }
                
                console.log('[VIN] Filled fields:', filledFields);
                
                // Zobrazit informaci o zdroj√≠ch v informaƒçn√≠m boxu
                const sourceInfoBox = document.getElementById('vinSourceInfo');
                const sourceTextElement = document.getElementById('vinSourceText');
                
                if (mappedData.source_priority && mappedData.source_priority.length > 0) {
                    // Mapov√°n√≠ n√°zv≈Ø zdroj≈Ø na ƒçiteln√© texty
                    const sourceNames = {
                        'mdcr': 'MDƒåR',
                        'eu_open_data': 'EU Open Data',
                        'local_vin': 'Lok√°ln√≠ VIN dek√≥dov√°n√≠',
                        'template': '≈†ablona z datab√°ze'
                    };
                    
                    const readableSources = mappedData.source_priority.map(s => sourceNames[s] || s);
                    const sourceText = 'Dek√≥dov√°no z: ' + readableSources.join(', ');
                    
                    // Zobrazit informaƒçn√≠ box
                    if (sourceInfoBox && sourceTextElement) {
                        sourceTextElement.textContent = sourceText;
                        sourceInfoBox.style.display = 'block';
                        console.log('[VIN] Source info displayed:', sourceText);
                    }
                    
                    showAlert('Data z VIN byla √∫spƒõ≈°nƒõ naƒçtena', 'success');
                } else {
                    // Skr√Ωt informaƒçn√≠ box, pokud nejsou zdroje
                    if (sourceInfoBox) {
                        sourceInfoBox.style.display = 'none';
                    }
                    showAlert('Data z VIN byla √∫spƒõ≈°nƒõ naƒçtena', 'success');
                }
            } catch (error) {
                console.error('[VIN] Error:', error);
                const errorMsg = error.message || 'Nezn√°m√° chyba';
                
                // Zkusit tak√© star√Ω endpoint jako fallback (pro zpƒõtnou kompatibilitu)
                if (errorMsg.includes('404') || errorMsg.includes('Not Found')) {
                    console.log('[VIN] Nov√Ω endpoint nen√≠ dostupn√Ω, zkou≈°√≠m star√Ω endpoint...');
                    try {
                        const fallbackData = await apiCall('/api/vehicles/decode-vin', 'POST', { vin });
                        console.log('[VIN] Fallback response:', fallbackData);
                        
                        // Pou≈æ√≠t star√Ω form√°t dat
                        const data = fallbackData;
                        
                        // Zbytek zpracov√°n√≠ jako p≈ôedt√≠m...
                        // (pro struƒçnost p≈ôeskoƒç√≠me, pokud nov√Ω endpoint funguje, tento fallback nebude pot≈ôeba)
                        showAlert('Data z VIN byla naƒçtena (fallback)', 'success');
                    } catch (fallbackError) {
                        showAlert('Nepoda≈ôilo se naƒç√≠st data z VIN: ' + errorMsg, 'error');
                    }
                } else {
                    showAlert('Nepoda≈ôilo se naƒç√≠st data z VIN: ' + errorMsg, 'error');
                }
            }
        }

        // P≈ôid√°n√≠ vozidla
        async function handleAddVehicle() {
            console.log('[ADD VEHICLE] Starting...');
            console.log('[ADD VEHICLE] Current user:', currentUser);
            
            const vin = document.getElementById('vehicleVin').value.trim();
            const plate = document.getElementById('vehiclePlate').value.trim();
            const name = document.getElementById('vehicleName').value.trim();
            const brand = document.getElementById('vehicleBrand').value.trim();
            const vehicleType = document.getElementById('vehicleType')?.value.trim() || '';
            const engineCode = document.getElementById('vehicleEngineCode')?.value.trim() || '';
            const maxPower = document.getElementById('vehicleMaxPower')?.value.trim() || '';
            const tyres = document.getElementById('vehicleTyres')?.value.trim() || '';
            const additionalNotes = document.getElementById('vehicleAdditionalNotes')?.value.trim() || '';
            const inspectionDate = document.getElementById('vehicleInspectionDate')?.value.trim() || '';
            const model = document.getElementById('vehicleModel').value.trim();
            const yearText = document.getElementById('vehicleYear').value.trim();
            const engine = document.getElementById('vehicleEngine').value.trim();
            const notes = document.getElementById('vehicleNotes').value.trim();

            if (!plate || !name) {
                showAlert('Vypl≈àte pros√≠m SPZ a n√°zev vozidla (povinn√© pole)', 'error');
                return;
            }

            // Parsov√°n√≠ roku
            let year = null;
            if (yearText) {
                const parsedYear = parseInt(yearText);
                if (!isNaN(parsedYear)) {
                    year = parsedYear;
                }
            }

            // Sestavit pozn√°mky - zahrnout v≈°echny extrahovan√© √∫daje
            let fullNotes = notes;
            if (tyres) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Kola a pneumatiky:\n' + tyres;
            }
            if (additionalNotes) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Dal≈°√≠ z√°znamy:\n' + additionalNotes;
            }
            // STK platnost se u≈æ neukl√°d√° do pozn√°mek, ukl√°d√° se p≈ô√≠mo do stk_valid_until
            // if (inspectionDate) {
            //     fullNotes += (fullNotes ? '\n\n' : '') + 'Technick√° prohl√≠dka do: ' + inspectionDate;
            // }
            if (vehicleType) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Typ: ' + vehicleType;
            }
            if (maxPower) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Max. v√Ωkon: ' + maxPower;
            }

            const vehicleData = {
                vin: vin || null,
                plate,
                name,
                brand: brand || null,
                model: model || null,
                year: year,
                engine: engine || null,
                engine_code: engineCode || null,
                notes: fullNotes || null,
                stk_valid_until: inspectionDate || null  // STK platnost - datum z pole "Pravideln√° technick√° prohl√≠dka do:"
            };
            
            console.log('[ADD VEHICLE] Vehicle data:', vehicleData);

            try {
                showAlert('P≈ôid√°v√°m vozidlo...', 'info');
                console.log('[ADD VEHICLE] Calling API...');
                const vehicle = await apiCall('/api/v1/vehicles', 'POST', vehicleData);
                console.log('[ADD VEHICLE] API response:', vehicle);
                
                showAlert('Vozidlo bylo √∫spƒõ≈°nƒõ p≈ôid√°no!', 'success');
                
                // Vyƒçistit formul√°≈ô
                document.getElementById('vehicleVin').value = '';
                document.getElementById('vehiclePlate').value = '';
                document.getElementById('vehicleName').value = '';
                document.getElementById('vehicleBrand').value = '';
                document.getElementById('vehicleType').value = '';
                document.getElementById('vehicleEngineCode').value = '';
                document.getElementById('vehicleMaxPower').value = '';
                document.getElementById('vehicleTyres').value = '';
                document.getElementById('vehicleAdditionalNotes').value = '';
                document.getElementById('vehicleInspectionDate').value = '';
                document.getElementById('vehicleModel').value = '';
                document.getElementById('vehicleYear').value = '';
                document.getElementById('vehicleEngine').value = '';
                document.getElementById('vehicleNotes').value = '';
                
                // Skr√Ωt informaƒçn√≠ box o zdroj√≠ch
                const sourceInfoBox = document.getElementById('vinSourceInfo');
                if (sourceInfoBox) {
                    sourceInfoBox.style.display = 'none';
                }
                
                // Naƒç√≠st aktualizovan√Ω seznam vozidel
                await loadVehicles();
                
                // P≈ôepnout na z√°lo≈æku s vozidly
                switchTab('vehicles');
                
                // Pokud je zobrazen detail vozidla, aktualizovat ho
                if (currentVehicleId) {
                    await showVehicleDetail(currentVehicleId);
                }
            } catch (error) {
                console.error('[ADD VEHICLE] Error:', error);
                showAlert('Nepoda≈ôilo se p≈ôidat vozidlo: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
            }
        }

        // Promƒõnn√° pro aktu√°ln√≠ zobrazen√© vozidlo
        let currentVehicleId = null;

        // Zobrazen√≠ detailu vozidla
        async function showVehicleDetail(vehicleId) {
            currentVehicleId = vehicleId;
            
            // Automaticky p≈ôepnout na z√°lo≈æku vozidel, pokud nejsme na t√©to z√°lo≈æce
            const vehiclesTab = document.getElementById('vehiclesTab');
            const needToSwitchTab = !vehiclesTab || !vehiclesTab.classList.contains('active');
            
            if (needToSwitchTab) {
                switchTab('vehicles');
                // Poƒçkat, a≈æ se z√°lo≈æka p≈ôepne (kr√°tk√° pauza pro dokonƒçen√≠ p≈ôepnut√≠)
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Skr√Ωt seznam a zobrazit detail
            const vehiclesList = document.getElementById('vehiclesList');
            const vehicleDetail = document.getElementById('vehicleDetail');
            
            if (vehiclesList) vehiclesList.style.display = 'none';
            if (vehicleDetail) vehicleDetail.classList.add('active');
            
            try {
                // Naƒç√≠st data vozidla
                const vehicle = await apiCall(`/api/v1/vehicles/${vehicleId}`, 'GET');
                
                // Zobrazit data vozidla
                document.getElementById('vehicleDetailTitle').textContent = vehicle.nickname || 'Detail vozidla';
                const vehicleInfo = document.getElementById('vehicleDetailInfo');
                vehicleInfo.innerHTML = `
                    <div class="vehicle-info-item">
                        <strong>N√°zev:</strong>
                        <span>${vehicle.nickname || 'Nezad√°no'}</span>
                    </div>
                    <div class="vehicle-info-item">
                        <strong>SPZ:</strong>
                        <span>${vehicle.plate || 'Nezad√°no'}</span>
                    </div>
                    <div class="vehicle-info-item">
                        <strong>VIN:</strong>
                        <span>${vehicle.vin || 'Nezad√°no'}</span>
                    </div>
                    ${vehicle.brand ? `
                    <div class="vehicle-info-item">
                        <strong>Znaƒçka:</strong>
                        <span>${vehicle.brand}</span>
                    </div>
                    ` : ''}
                    ${vehicle.model ? `
                    <div class="vehicle-info-item">
                        <strong>Model:</strong>
                        <span>${vehicle.model}</span>
                    </div>
                    ` : ''}
                    ${vehicle.year ? `
                    <div class="vehicle-info-item">
                        <strong>Rok v√Ωroby:</strong>
                        <span>${vehicle.year}</span>
                    </div>
                    ` : ''}
                    ${vehicle.engine ? `
                    <div class="vehicle-info-item">
                        <strong>Motor:</strong>
                        <span>${vehicle.engine}</span>
                    </div>
                    ` : ''}
                    ${vehicle.notes ? `
                    <div class="vehicle-info-item">
                        <strong>Pozn√°mky:</strong>
                        <span>${vehicle.notes}</span>
                    </div>
                    ` : ''}
                    <div class="vehicle-info-item">
                        <strong>P≈ôid√°no:</strong>
                        <span>${new Date(vehicle.created_at).toLocaleDateString('cs-CZ')}</span>
                    </div>
                `;
                
                // Naƒç√≠st servisn√≠ z√°znamy
                await loadServiceRecords(vehicleId);
            } catch (error) {
                console.error('Error loading vehicle detail:', error);
                showAlert('Chyba p≈ôi naƒç√≠t√°n√≠ detailu vozidla: ' + error.message, 'error');
            }
        }

        // Zobrazen√≠ seznamu vozidel
        function showVehiclesList() {
            document.getElementById('vehiclesList').style.display = 'block';
            document.getElementById('vehicleDetail').classList.remove('active');
            currentVehicleId = null;
        }

        // Naƒçten√≠ servisn√≠ch z√°znam≈Ø
        async function loadServiceRecords(vehicleId) {
            const container = document.getElementById('serviceRecordsList');
            container.innerHTML = '<div class="loading">Naƒç√≠t√°m servisn√≠ z√°znamy...</div>';
            
            try {
                const records = await apiCall(`/api/v1/vehicles/${vehicleId}/records`, 'GET');
                
                if (!records || records.length === 0) {
                    container.innerHTML = '<p>Zat√≠m nejsou ≈æ√°dn√© servisn√≠ z√°znamy. P≈ôidejte prvn√≠ pomoc√≠ formul√°≈ôe n√≠≈æe.</p>';
                    return;
                }
                
                let html = '';
                records.forEach(record => {
                    const date = new Date(record.performed_at);
                    html += `
                        <div class="service-record-item">
                            <h4>${record.description}</h4>
                            <div class="record-date">${date.toLocaleDateString('cs-CZ')} ${date.toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'})}</div>
                            <div class="record-details">
                                ${record.mileage ? `<p><strong>N√°jezd:</strong> ${record.mileage.toLocaleString('cs-CZ')} km</p>` : ''}
                                ${record.note ? `<p><strong>Kategorie:</strong> ${record.note}</p>` : ''}
                            </div>
                            ${record.price ? `<div class="record-price">Cena: ${record.price.toLocaleString('cs-CZ')} Kƒç</div>` : ''}
                            <button onclick="deleteServiceRecord(${record.id})" style="margin-top: 10px; background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Smazat</button>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading service records:', error);
                container.innerHTML = `<p class="alert alert-error">Chyba p≈ôi naƒç√≠t√°n√≠ servisn√≠ch z√°znam≈Ø: ${error.message}</p>`;
            }
        }

        // P≈ôid√°n√≠ servisn√≠ho √∫konu
        async function handleAddService(event) {
            event.preventDefault();
            
            if (!currentVehicleId) {
                showAlert('Chyba: Vozidlo nen√≠ vybr√°no', 'error');
                return;
            }
            
            const dateInput = document.getElementById('serviceDate').value;
            const mileage = document.getElementById('serviceMileage').value;
            const description = document.getElementById('serviceDescription').value;
            const price = document.getElementById('servicePrice').value;
            const note = document.getElementById('serviceNote').value;
            
            if (!dateInput || !description) {
                showAlert('Vypl≈àte pros√≠m datum a popis √∫konu', 'error');
                return;
            }
            
            try {
                const recordData = {
                    performed_at: new Date(dateInput).toISOString(),
                    mileage: mileage ? parseInt(mileage) : null,
                    description: description,
                    price: price ? parseFloat(price) : null,
                    note: note || null
                };
                
                showAlert('P≈ôid√°v√°m servisn√≠ √∫kon...', 'info');
                await apiCall(`/api/v1/vehicles/${currentVehicleId}/records`, 'POST', recordData);
                
                showAlert('Servisn√≠ √∫kon byl √∫spƒõ≈°nƒõ p≈ôid√°n!', 'success');
                
                // Vyƒçistit formul√°≈ô
                document.getElementById('serviceDate').value = '';
                document.getElementById('serviceMileage').value = '';
                document.getElementById('serviceDescription').value = '';
                document.getElementById('servicePrice').value = '';
                document.getElementById('serviceNote').value = '';
                
                // Naƒç√≠st aktualizovan√© servisn√≠ z√°znamy
                await loadServiceRecords(currentVehicleId);
            } catch (error) {
                console.error('Error adding service record:', error);
                showAlert('Nepoda≈ôilo se p≈ôidat servisn√≠ √∫kon: ' + error.message, 'error');
            }
        }

        // Smaz√°n√≠ servisn√≠ho z√°znamu
        async function deleteServiceRecord(recordId) {
            if (!confirm('Opravdu chcete smazat tento servisn√≠ z√°znam?')) {
                return;
            }
            
            try {
                if (!currentVehicleId) {
                    showAlert('Chyba: Nelze smazat z√°znam - vozidlo nen√≠ vybr√°no', 'error');
                    return;
                }
                await apiCall(`/api/v1/vehicles/${currentVehicleId}/records/${recordId}`, 'DELETE');
                showAlert('Servisn√≠ z√°znam byl smaz√°n', 'success');
                
                // Naƒç√≠st aktualizovan√© servisn√≠ z√°znamy
                if (currentVehicleId) {
                    await loadServiceRecords(currentVehicleId);
                }
            } catch (error) {
                console.error('Error deleting service record:', error);
                showAlert('Nepoda≈ôilo se smazat servisn√≠ z√°znam: ' + error.message, 'error');
            }
        }

        // P≈ôep√≠n√°n√≠ tab≈Ø
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            // Naj√≠t a aktivovat spr√°vn√Ω tab button
            const tabButtons = document.querySelectorAll('.tab');
            let activeIndex = 0;
            
            if (tab === 'vehicles') {
                activeIndex = 0;
                document.getElementById('vehiclesTab').classList.add('active');
                // Naƒç√≠st vozidla pouze pokud nem√°me otev≈ôen√Ω detail vozidla
                if (!currentVehicleId) {
                    loadVehicles();
                }
            } else if (tab === 'addVehicle') {
                activeIndex = 1;
                document.getElementById('addVehicleTab').classList.add('active');
            } else if (tab === 'reminders') {
                activeIndex = 2;
                document.getElementById('remindersTab').classList.add('active');
                loadReminders();
            } else if (tab === 'reservations') {
                activeIndex = 3;
                document.getElementById('reservationsTab').classList.add('active');
                loadReservations();
            } else if (tab === 'profile') {
                activeIndex = 4;
                document.getElementById('profileTab').classList.add('active');
                loadProfile();
            }
            
            if (tabButtons[activeIndex]) {
                tabButtons[activeIndex].classList.add('active');
            }
        }

        // Zobrazen√≠ registrace
        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            // Vyƒçistit chyby p≈ôi p≈ôepnut√≠
            clearFormError('loginErrorContainer');
            clearFormError('registerErrorContainer');
        }

        // Zobrazen√≠ p≈ôihl√°≈°en√≠
        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            // Vyƒçistit chyby p≈ôi p≈ôepnut√≠
            clearFormError('loginErrorContainer');
            clearFormError('registerErrorContainer');
        }

        // Kontrola p≈ôihl√°≈°en√≠ p≈ôi naƒçten√≠ str√°nky
        window.addEventListener('DOMContentLoaded', () => {
            // Inicializovat API_URL
            function initApiUrl() {
                try {
                    API_URL = getApiBaseUrl();
                    console.log('[APP] API URL:', API_URL);
                } catch (e) {
                    console.error('[APP] Chyba p≈ôi inicializaci API_URL:', e);
                    API_URL = "http://127.0.0.1:8001"; // Fallback
                }
            }
            
            // Inicializovat API URL hned
            initApiUrl();
            
            // Nastavit DEV API URL panel (skr√Ωt v produkci)
            setupDevApiUrlPanel();
            
            // Zobrazit tlaƒç√≠tko konfigurace jen v DEV re≈æimu (ne v produkci)
            const isProduction = window.location.hostname === "hub.toozservis.cz";
            const location = getLocation();
            const urlParams = new URLSearchParams(location.search || '');
            const isAdmin = urlParams.get('admin') === '1';
            const configButton = document.getElementById('configButton');
            if (configButton) {
                // V produkci tlaƒç√≠tko skr√Ωt, v DEV zobrazit jen pro admina
                if (isProduction) {
                    configButton.classList.add('hidden');
                } else if (isAdmin) {
                    configButton.classList.remove('hidden');
                } else {
                    configButton.classList.add('hidden');
                }
            }
            
            // V DEV re≈æimu, pokud nen√≠ nastaven√° API URL a je admin, zobrazit konfiguraci
            if (!isProduction && !API_URL && isAdmin) {
                showApiUrlConfig();
            }
            
            // Kontrola stavu serveru p≈ôi naƒçten√≠
            checkServerStatus();
            
            // Pravideln√° kontrola stavu serveru ka≈æd√Ωch 30 sekund
            serverStatusCheckInterval = setInterval(checkServerStatus, 30000);
            
            // Naƒç√≠st ulo≈æen√Ω JWT token a u≈æivatele
            const savedToken = localStorage.getItem('accessToken');
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedToken) {
                accessToken = savedToken;
                console.log('[AUTH] Loaded saved JWT token');
            }
            
            // ZAJISTIT, ≈ΩE AUTH SECTION JE VIDITELN√Å P≈òI NAƒåTEN√ç
            const authSection = document.getElementById('authSection');
            const dashboard = document.getElementById('dashboard');
            
            if (authSection) {
                authSection.classList.remove('hidden');
                authSection.style.display = 'block';
                authSection.style.visibility = 'visible';
                authSection.style.opacity = '1';
                console.log('[APP] ‚úÖ authSection je viditeln√°', {
                    hasHidden: authSection.classList.contains('hidden'),
                    display: authSection.style.display,
                    computed: window.getComputedStyle(authSection).display
                });
            } else {
                console.error('[APP] ‚ùå authSection NEN√ç NALEZENA!');
            }
            
            // Zajistit, ≈æe dashboard je skryt√Ω (pokud nen√≠ aktivn√≠)
            if (dashboard) {
                if (!dashboard.classList.contains('active')) {
                    dashboard.style.display = 'none';
                    console.log('[APP] Dashboard je skryt√Ω (nen√≠ aktivn√≠)');
                } else {
                    console.log('[APP] Dashboard je aktivn√≠');
                }
            } else {
                console.error('[APP] ‚ùå dashboard NEN√ç NALEZEN!');
            }
            
            // TRVAL√Å OCHRANA: Kontrolovat viditelnost ka≈ædou sekundu
            // TRVAL√Å OCHRANA: Kontrolovat viditelnost ka≈ædou sekundu a zajistit, ≈æe aplikace z≈Østane viditeln√°
            const visibilityChecker = setInterval(() => {
                const authSection = document.getElementById('authSection');
                const dashboard = document.getElementById('dashboard');
                const content = document.querySelector('.content');
                const container = document.querySelector('.container');
                
                if (authSection) {
                    const computedDisplay = window.getComputedStyle(authSection).display;
                    const computedVisibility = window.getComputedStyle(authSection).visibility;
                    const computedOpacity = window.getComputedStyle(authSection).opacity;
                    
                    // Pokud je authSection skryt√° a dashboard nen√≠ aktivn√≠, zobrazit authSection
                    const isDashboardActive = dashboard && dashboard.classList.contains('active');
                    
                    if (!isDashboardActive && (computedDisplay === 'none' || computedVisibility === 'hidden' || computedOpacity === '0')) {
                        console.warn('[APP] ‚ö†Ô∏è authSection je skryt√° - opravuji...', {
                            display: computedDisplay,
                            visibility: computedVisibility,
                            opacity: computedOpacity
                        });
                        authSection.classList.remove('hidden');
                        authSection.style.display = 'block';
                        authSection.style.visibility = 'visible';
                        authSection.style.opacity = '1';
                        authSection.style.position = 'relative';
                    }
                }
                
                // Zajistit, ≈æe content a container jsou viditeln√©
                if (content) {
                    const contentDisplay = window.getComputedStyle(content).display;
                    if (contentDisplay === 'none') {
                        console.warn('[APP] ‚ö†Ô∏è content je skryt√Ω - opravuji...');
                        content.style.display = 'block';
                    }
                }
                
                if (container) {
                    const containerDisplay = window.getComputedStyle(container).display;
                    if (containerDisplay === 'none') {
                        console.warn('[APP] ‚ö†Ô∏è container je skryt√Ω - opravuji...');
                        container.style.display = 'block';
                    }
                }
            }, 1000); // Kontrolovat ka≈ædou sekundu
            
            // Zastavit kontrolu, kdy≈æ se str√°nka zav≈ôe
            window.addEventListener('beforeunload', () => {
                clearInterval(visibilityChecker);
                stopInactivityTimer();
            });
            
            // Inicializovat sledov√°n√≠ aktivity
            setupActivityTracking();
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    if (accessToken || currentUser.email) {
                        // Pokud je u≈æivatel p≈ôihl√°≈°en, obnovit dashboard bez znovu naƒç√≠t√°n√≠ dat
                        // (aplikace z≈Østane ve stejn√©m stavu p≈ôi n√°vratu na str√°nku)
                        const dashboard = document.getElementById('dashboard');
                        const authSection = document.getElementById('authSection');
                        
                        if (dashboard && authSection) {
                            // Zkontrolovat, zda byl u≈æivatel p≈ôihl√°≈°en p≈ôed opu≈°tƒõn√≠m str√°nky
                            const wasLoggedIn = localStorage.getItem('wasLoggedIn') === 'true';
                            
                            if (wasLoggedIn && accessToken) {
                                console.log('[AUTH] Obnoven√≠ p≈ôihl√°≈°en√© relace - u≈æivatel z≈Øst√°v√° p≈ôihl√°≈°en');
                                // Obnovit dashboard bez znovu naƒç√≠t√°n√≠ (u≈æivatel u≈æ je p≈ôihl√°≈°en)
                                authSection.classList.add('hidden');
                                authSection.style.display = 'none';
                                dashboard.classList.add('active');
                                dashboard.style.display = 'block';
                                
                                // Zobrazit navbar
                                const navbar = document.getElementById('mainNavbar');
                                const userBadge = document.getElementById('userBadge');
                                const logoutBtn = document.getElementById('logout-btn');
                                if (navbar) {
                                    navbar.classList.remove('hidden');
                                }
                                
                                // Nastavit email v hlaviƒçce
                                const userEmailEl = document.getElementById('userEmail');
                                if (userEmailEl && currentUser) {
                                    userEmailEl.textContent = currentUser.email;
                                    if (userBadge) {
                                        userBadge.classList.remove('hidden');
                                    }
                                }
                                if (logoutBtn) {
                                    logoutBtn.classList.remove('hidden');
                                }
                                
                                // Resetovat timer aktivity
                                resetInactivityTimer();
                                
                                // Naƒç√≠st data jen pokud nen√≠ dashboard pr√°zdn√Ω (aby se neznovu naƒç√≠talo p≈ôi n√°vratu)
                                const vehiclesContainer = document.getElementById('vehiclesContainer');
                                if (!vehiclesContainer || vehiclesContainer.innerHTML.trim() === '') {
                                    loadVehicles();
                                }
                            } else {
                                console.log('[AUTH] Ulo≈æen√Ω token nalezen, ale vy≈æadujeme nov√© p≈ôihl√°≈°en√≠ pro bezpeƒçnost');
                                localStorage.removeItem('wasLoggedIn');
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error parsing saved user:', e);
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('wasLoggedIn');
                }
            }
            
            // Automatick√© naƒçten√≠ ARES p≈ôi zad√°n√≠ 8 ƒç√≠slic IƒåO
            const icoInput = document.getElementById('regIco');
            if (icoInput) {
                icoInput.addEventListener('input', (e) => {
                    const ico = e.target.value.trim();
                    if (ico.length === 8 && /^\d+$/.test(ico)) {
                        // Automaticky naƒç√≠st po zad√°n√≠ 8 ƒç√≠slic
                        setTimeout(() => loadAresData(), 500);
                    }
                });
            }
            
            // Automatick√© dek√≥dov√°n√≠ VIN p≈ôi zad√°n√≠ 17 znak≈Ø
            // Pou≈æijeme event delegation, proto≈æe formul√°≈ô m≈Ø≈æe b√Ωt skryt√Ω p≈ôi naƒçten√≠ str√°nky
            document.addEventListener('input', (e) => {
                if (e.target && e.target.id === 'vehicleVin') {
                    const vin = e.target.value.trim().toUpperCase();
                    e.target.value = vin; // Automaticky p≈ôev√©st na velk√° p√≠smena
                    console.log('[VIN] Input event, VIN length:', vin.length);
                    
                    // Skr√Ωt informaƒçn√≠ box p≈ôi zmƒõnƒõ VIN (nebo pokud je VIN pr√°zdn√Ω/krat≈°√≠)
                    const sourceInfoBox = document.getElementById('vinSourceInfo');
                    if (sourceInfoBox && vin.length < 17) {
                        sourceInfoBox.style.display = 'none';
                    }
                    
                    if (vin.length === 17) {
                        // Automaticky naƒç√≠st po zad√°n√≠ 17 znak≈Ø
                        console.log('[VIN] Auto-loading VIN data...');
                        setTimeout(() => loadVinData(), 500);
                    }
                }
            });
            
            // Tak√© p≈ôidat event listener p≈ô√≠mo na element, pokud existuje
            const vinInput = document.getElementById('vehicleVin');
            if (vinInput) {
                console.log('[VIN] Direct event listener added');
                vinInput.addEventListener('input', (e) => {
                    const vin = e.target.value.trim().toUpperCase();
                    e.target.value = vin;
                    if (vin.length === 17) {
                        console.log('[VIN] Auto-loading VIN data (direct listener)...');
                        setTimeout(() => loadVinData(), 500);
                    }
                });
            }
        });

        // Naƒç√≠t√°n√≠ p≈ôipom√≠nek (v1.0)
        async function loadReminders() {
            const container = document.getElementById('remindersContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">Naƒç√≠t√°m p≈ôipom√≠nky...</div>';
            
            try {
                const reminders = await apiCall('/api/v1/reminders', 'GET');
                
                let html = '';
                
                // Panel nastaven√≠ upozornƒõn√≠ (collapsible)
                html += `
                    <div class="card" style="margin-bottom: 24px; border-left: 4px solid #6366f1;">
                        <div class="card-header" id="reminderSettingsHeader" style="cursor: pointer;">
                            <h3 class="card-title" style="margin: 0; color: #6366f1; font-size: 16px;">
                                ‚öôÔ∏è Nastaven√≠ upozornƒõn√≠
                            </h3>
                            <span id="reminderSettingsToggle" style="font-size: 14px; color: #64748b;">‚ñº</span>
                        </div>
                        <div id="reminderSettingsPanel" class="card-body" style="display: none;">
                            <form id="reminderSettingsForm">
                                <div class="form-group">
                                    <label for="notificationMethod" style="color: #334155; font-weight: 600; font-size: 14px; display: block; margin-bottom: 8px;">Zp≈Øsob upozornƒõn√≠:</label>
                                    <select id="notificationMethod" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; background: white; color: #1e293b; font-size: 14px; font-family: inherit;">
                                        <option value="app">Pouze v aplikaci</option>
                                        <option value="email">E-mail</option>
                                        <option value="both">Oboj√≠ (aplikace + e-mail)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="notifyDaysBefore" style="color: #334155; font-weight: 600; font-size: 14px; display: block; margin-bottom: 8px;">Upozornit X dn√≠ p≈ôedem:</label>
                                    <input type="number" id="notifyDaysBefore" min="0" max="365" value="7" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; background: white; color: #1e293b; font-size: 14px; font-family: inherit;">
                                    <small style="color: #64748b; font-size: 12px; display: block; margin-top: 4px;">Poƒçet dn√≠ p≈ôed term√≠nem p≈ôipom√≠nky (0-365)</small>
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 20px;">
                                    <button type="button" id="saveReminderSettingsBtn" class="btn" style="flex: 1;">üíæ Ulo≈æit nastaven√≠</button>
                                    <button type="button" id="refreshReminderSettingsBtn" class="btn btn-secondary" style="flex: 1;">üîÑ Obnovit</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                // Tlaƒç√≠tko pro p≈ôid√°n√≠ nov√© p≈ôipom√≠nky
                html += `
                    <div style="margin-bottom: 20px; text-align: center;">
                        <button class="btn" onclick="showCreateReminderForm()">‚ûï P≈ôidat p≈ôipom√≠nku</button>
                    </div>
                `;
                
                if (!reminders || reminders.length === 0) {
                    html += '<p style="text-align: center; color: #9ca3af; padding: 40px;">≈Ω√°dn√© p≈ôipom√≠nky. V≈°echno je v po≈ô√°dku! ‚úÖ</p>';
                    container.innerHTML = html;
                    return;
                }
                
                html += '<div class="cards-grid">';
                
                reminders.forEach(reminder => {
                    const typeIcon = reminder.type === 'STK' ? 'üöó' : reminder.type === 'OLEJ' ? 'üõ¢Ô∏è' : reminder.type === 'VLASTNI' ? 'üìù' : 'üîß';
                    const typeColor = reminder.type === 'STK' ? '#ef4444' : reminder.type === 'OLEJ' ? '#f59e0b' : reminder.type === 'VLASTNI' ? '#8b5cf6' : '#6366f1';
                    const isManual = reminder.is_manual === true;
                    const isCompleted = reminder.is_completed === true;
                    
                    html += `
                        <div class="card" style="${isCompleted ? 'opacity: 0.7;' : ''} border-left: 4px solid ${typeColor};">
                            <div class="card-header">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 20px;">${typeIcon}</span>
                                    <h3 class="card-title" style="color: ${typeColor}; font-size: 16px; margin: 0;">${reminder.type}</h3>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    ${isManual ? '<span class="badge" style="background: #8b5cf6; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600;">RUƒåN√ç</span>' : '<span class="badge" style="background: #6366f1; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600;">AUTO</span>'}
                                    ${isCompleted ? '<span class="badge" style="background: #10b981; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600;">DOKONƒåENO</span>' : ''}
                                    ${isManual ? `
                                        <button class="btn" style="padding: 6px 10px; font-size: 12px; background: #475569; min-width: auto;" onclick="editReminder(${reminder.id})" title="Upravit">‚úèÔ∏è</button>
                                        <button class="btn" style="padding: 6px 10px; font-size: 12px; background: #ef4444; min-width: auto;" onclick="deleteReminder(${reminder.id})" title="Smazat">üóëÔ∏è</button>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="card-field">
                                    <span class="card-label">Vozidlo</span>
                                    <span class="card-value">${reminder.vehicle_name || 'Obecn√° p≈ôipom√≠nka'}</span>
                                </div>
                                <div class="card-field">
                                    <span class="card-label">Popis</span>
                                    <span class="card-value" style="${isCompleted ? 'text-decoration: line-through; opacity: 0.7;' : ''}">${reminder.text}</span>
                                </div>
                                ${reminder.due_date ? `
                                    <div class="card-field">
                                        <span class="card-label">Datum</span>
                                        <span class="card-value" style="font-weight: 600; color: ${typeColor};">${new Date(reminder.due_date).toLocaleDateString('cs-CZ')}</span>
                                    </div>
                                ` : ''}
                            </div>
                            ${reminder.vehicle_id ? `
                                <div class="card-actions">
                                    <button class="btn btn-secondary" style="flex: 1; font-size: 13px; padding: 8px 12px;" onclick="switchTab('vehicles'); showVehicleDetail(${reminder.vehicle_id})">
                                        Zobrazit vozidlo
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                // Nastavit event listenery pro tlaƒç√≠tka nastaven√≠ p≈ôipom√≠nek po vlo≈æen√≠ HTML
                setTimeout(() => {
                    setupReminderSettingsEventListeners();
                }, 100);
                
            } catch (error) {
                console.error('Error loading reminders:', error);
                container.innerHTML = `<p style="color: #ef4444;">Chyba p≈ôi naƒç√≠t√°n√≠ p≈ôipom√≠nek: ${error.message}</p>`;
            }
        }

        // Zobrazen√≠ formul√°≈ôe pro vytvo≈ôen√≠ p≈ôipom√≠nky
        async function showCreateReminderForm() {
            // Naƒç√≠st vozidla u≈æivatele
            let vehicles = [];
            try {
                vehicles = await apiCall('/api/v1/vehicles', 'GET');
            } catch (error) {
                console.error('Error loading vehicles:', error);
            }
            
            const formHtml = `
                <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; max-width: 600px; margin: 0 auto;">
                    <h2 style="color: #e5e7eb; margin-bottom: 20px; text-align: center;">Nov√° p≈ôipom√≠nka</h2>
                    
                    <div class="form-group">
                        <label for="reminderType" style="color: #9ca3af;">Typ p≈ôipom√≠nky *:</label>
                        <select id="reminderType" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                            <option value="VLASTNI">Vlastn√≠</option>
                            <option value="STK">STK</option>
                            <option value="OLEJ">Olej</option>
                            <option value="SERVIS">Servis</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reminderVehicle" style="color: #9ca3af;">Vozidlo (voliteln√©):</label>
                        <select id="reminderVehicle" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                            <option value="">Obecn√° p≈ôipom√≠nka</option>
                            ${vehicles.map(v => `<option value="${v.id}">${v.nickname || v.plate || 'Bez n√°zvu'} - ${v.plate || 'Bez SPZ'}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reminderText" style="color: #9ca3af;">Text p≈ôipom√≠nky *:</label>
                        <textarea id="reminderText" placeholder="Nap≈ô. Zkontrolovat brzdy, Vymƒõnit filtr..." rows="3" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; font-family: inherit;" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="reminderDueDate" style="color: #9ca3af;">Datum (voliteln√©):</label>
                        <input type="date" id="reminderDueDate" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="handleCreateReminder()" style="flex: 1;">Vytvo≈ôit p≈ôipom√≠nku</button>
                        <button class="btn" style="background: #475569; flex: 1;" onclick="loadReminders()">Zru≈°it</button>
                    </div>
                </div>
            `;
            
            const container = document.getElementById('remindersContainer');
            if (container) {
                container.innerHTML = formHtml;
            }
        }
        
        // Vytvo≈ôen√≠ p≈ôipom√≠nky
        async function handleCreateReminder() {
            const type = document.getElementById('reminderType').value;
            const vehicleId = document.getElementById('reminderVehicle').value;
            const text = document.getElementById('reminderText').value;
            const dueDate = document.getElementById('reminderDueDate').value;
            
            if (!text || !text.trim()) {
                showAlert('Zadejte text p≈ôipom√≠nky', 'error');
                return;
            }
            
            const reminderData = {
                type: type,
                vehicle_id: vehicleId ? parseInt(vehicleId) : null,
                text: text.trim(),
                due_date: dueDate || null
            };
            
            try {
                showAlert('Vytv√°≈ô√≠m p≈ôipom√≠nku...', 'info');
                await apiCall('/api/v1/reminders', 'POST', reminderData);
                showAlert('P≈ôipom√≠nka byla √∫spƒõ≈°nƒõ vytvo≈ôena!', 'success');
                await loadReminders();
            } catch (error) {
                console.error('Error creating reminder:', error);
                showAlert('Nepoda≈ôilo se vytvo≈ôit p≈ôipom√≠nku: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
            }
        }
        
        // ============= NASTAVEN√ç EMAIL UPOZORNƒöN√ç =============
        
        // Toggle panelu nastaven√≠
        function toggleReminderSettings() {
            const panel = document.getElementById('reminderSettingsPanel');
            const toggle = document.getElementById('reminderSettingsToggle');
            if (panel && toggle) {
                if (panel.style.display === 'none') {
                    panel.style.display = 'block';
                    toggle.textContent = '‚ñ≤';
                    loadReminderSettings(); // Naƒç√≠st aktu√°ln√≠ nastaven√≠
                } else {
                    panel.style.display = 'none';
                    toggle.textContent = '‚ñº';
                }
            }
        }
        
        // Naƒçten√≠ nastaven√≠ p≈ôipom√≠nek z API
        async function loadReminderSettings() {
            try {
                const settings = await apiCall('/api/v1/reminders/settings', 'GET');
                
                if (settings && settings.notification) {
                    const methodSelect = document.getElementById('notificationMethod');
                    const daysInput = document.getElementById('notifyDaysBefore');
                    
                    if (methodSelect) {
                        methodSelect.value = settings.notification.notification_method || 'email';
                    }
                    if (daysInput) {
                        daysInput.value = settings.notification.notify_days_before || 7;
                    }
                }
            } catch (error) {
                console.error('Error loading reminder settings:', error);
                // Pou≈æ√≠t v√Ωchoz√≠ hodnoty
                const methodSelect = document.getElementById('notificationMethod');
                const daysInput = document.getElementById('notifyDaysBefore');
                if (methodSelect) methodSelect.value = 'email';
                if (daysInput) daysInput.value = 7;
            }
        }
        
        // Ulo≈æen√≠ nastaven√≠ p≈ôipom√≠nek
        async function handleSaveReminderSettings(event) {
            event.preventDefault();
            
            const methodSelect = document.getElementById('notificationMethod');
            const daysInput = document.getElementById('notifyDaysBefore');
            
            if (!methodSelect || !daysInput) {
                showAlert('Chyba: Formul√°≈ô nen√≠ spr√°vnƒõ naƒçten', 'error');
                return;
            }
            
            const notificationMethod = methodSelect.value;
            const notifyDaysBefore = parseInt(daysInput.value) || 7;
            
            if (notifyDaysBefore < 0 || notifyDaysBefore > 365) {
                showAlert('Poƒçet dn√≠ mus√≠ b√Ωt mezi 0 a 365', 'error');
                return;
            }
            
            try {
                showAlert('Ukl√°d√°m nastaven√≠...', 'info');
                
                // Nejd≈ô√≠v naƒç√≠st aktu√°ln√≠ nastaven√≠
                let currentSettings = {};
                try {
                    currentSettings = await apiCall('/api/v1/reminders/settings', 'GET');
                } catch (error) {
                    console.warn('Could not load current settings, using defaults:', error);
                }
                
                // Aktualizovat pouze notification ƒç√°st
                const settingsToUpdate = {
                    notification: {
                        notification_method: notificationMethod,
                        notify_days_before: notifyDaysBefore
                    }
                };
                
                // Pokud m√°me dal≈°√≠ nastaven√≠, zachovat je
                if (currentSettings) {
                    settingsToUpdate.enabled = currentSettings.enabled !== undefined ? currentSettings.enabled : true;
                    if (currentSettings.stk) settingsToUpdate.stk = currentSettings.stk;
                    if (currentSettings.oil) settingsToUpdate.oil = currentSettings.oil;
                    if (currentSettings.general) settingsToUpdate.general = currentSettings.general;
                    if (currentSettings.service_categories) settingsToUpdate.service_categories = currentSettings.service_categories;
                }
                
                await apiCall('/api/v1/reminders/settings', 'PUT', settingsToUpdate);
                showAlert('Nastaven√≠ bylo √∫spƒõ≈°nƒõ ulo≈æeno! ‚úÖ', 'success');
                
                // Poƒçkat chv√≠li a znovu naƒç√≠st nastaven√≠ pro ovƒõ≈ôen√≠
                setTimeout(() => {
                    loadReminderSettings();
                }, 500);
                
            } catch (error) {
                console.error('Error saving reminder settings:', error);
                showAlert('Nepoda≈ôilo se ulo≈æit nastaven√≠: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
            }
        }
        
        // Nastaven√≠ event listener≈Ø pro tlaƒç√≠tka nastaven√≠ p≈ôipom√≠nek (vol√° se po vlo≈æen√≠ HTML)
        function setupReminderSettingsEventListeners() {
            console.log('[REMINDER SETTINGS] Nastavuji event listenery...');
            
            // Tlaƒç√≠tko "Ulo≈æit nastaven√≠"
            const saveBtn = document.getElementById('saveReminderSettingsBtn');
            if (saveBtn) {
                console.log('[REMINDER SETTINGS] Nalezeno tlaƒç√≠tko Ulo≈æit');
                // Odstranit v≈°echny existuj√≠c√≠ listenery klonov√°n√≠m
                const newSaveBtn = saveBtn.cloneNode(true);
                saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
                
                newSaveBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[REMINDER SETTINGS] Kliknut√≠ na Ulo≈æit nastaven√≠');
                    await handleSaveReminderSettings(e);
                });
            } else {
                console.warn('[REMINDER SETTINGS] Tlaƒç√≠tko Ulo≈æit nenalezeno!');
            }
            
            // Tlaƒç√≠tko "Obnovit"
            const refreshBtn = document.getElementById('refreshReminderSettingsBtn');
            if (refreshBtn) {
                console.log('[REMINDER SETTINGS] Nalezeno tlaƒç√≠tko Obnovit');
                // Odstranit v≈°echny existuj√≠c√≠ listenery klonov√°n√≠m
                const newRefreshBtn = refreshBtn.cloneNode(true);
                refreshBtn.parentNode.replaceChild(newRefreshBtn, refreshBtn);
                
                newRefreshBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[REMINDER SETTINGS] Kliknut√≠ na Obnovit');
                    await loadReminderSettings();
                    showAlert('Nastaven√≠ obnoveno', 'success');
                });
            } else {
                console.warn('[REMINDER SETTINGS] Tlaƒç√≠tko Obnovit nenalezeno!');
            }
            
            // Formul√°≈ô submit
            const form = document.getElementById('reminderSettingsForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[REMINDER SETTINGS] Submit formul√°≈ôe');
                    await handleSaveReminderSettings(e);
                });
            }
            
            // Header pro toggle
            const header = document.getElementById('reminderSettingsHeader');
            if (header) {
                header.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log('[REMINDER SETTINGS] Kliknut√≠ na header');
                    toggleReminderSettings();
                });
            } else {
                // Fallback - naj√≠t p≈ôes toggle element
                const toggle = document.getElementById('reminderSettingsToggle');
                if (toggle && toggle.parentElement) {
                    toggle.parentElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleReminderSettings();
                    });
                }
            }
        }
        
        // Editace p≈ôipom√≠nky
        async function editReminder(reminderId) {
            // Naƒç√≠st aktu√°ln√≠ p≈ôipom√≠nku
            try {
                const reminders = await apiCall('/api/v1/reminders', 'GET');
                const reminder = reminders.find(r => r.id === reminderId);
                
                if (!reminder) {
                    showAlert('P≈ôipom√≠nka nenalezena', 'error');
                    return;
                }
                
                // Naƒç√≠st vozidla
                let vehicles = [];
                try {
                    vehicles = await apiCall('/api/v1/vehicles', 'GET');
                } catch (error) {
                    console.error('Error loading vehicles:', error);
                }
                
                const formHtml = `
                    <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; max-width: 600px; margin: 0 auto;">
                        <h2 style="color: #e5e7eb; margin-bottom: 20px; text-align: center;">Upravit p≈ôipom√≠nku</h2>
                        
                        <div class="form-group">
                            <label for="editReminderType" style="color: #9ca3af;">Typ p≈ôipom√≠nky *:</label>
                            <select id="editReminderType" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                                <option value="VLASTNI" ${reminder.type === 'VLASTNI' ? 'selected' : ''}>Vlastn√≠</option>
                                <option value="STK" ${reminder.type === 'STK' ? 'selected' : ''}>STK</option>
                                <option value="OLEJ" ${reminder.type === 'OLEJ' ? 'selected' : ''}>Olej</option>
                                <option value="SERVIS" ${reminder.type === 'SERVIS' ? 'selected' : ''}>Servis</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="editReminderVehicle" style="color: #9ca3af;">Vozidlo (voliteln√©):</label>
                            <select id="editReminderVehicle" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                                <option value="">Obecn√° p≈ôipom√≠nka</option>
                                ${vehicles.map(v => `<option value="${v.id}" ${reminder.vehicle_id === v.id ? 'selected' : ''}>${v.nickname || v.plate || 'Bez n√°zvu'} - ${v.plate || 'Bez SPZ'}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="editReminderText" style="color: #9ca3af;">Text p≈ôipom√≠nky *:</label>
                            <textarea id="editReminderText" rows="3" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; font-family: inherit;" required>${reminder.text || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="editReminderDueDate" style="color: #9ca3af;">Datum (voliteln√©):</label>
                            <input type="date" id="editReminderDueDate" value="${dueDateValue}" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                        </div>
                        
                        <div class="form-group">
                            <label style="color: #9ca3af; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="editReminderCompleted" ${reminder.is_completed ? 'checked' : ''} style="width: 20px; height: 20px;">
                                Dokonƒçeno
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn" onclick="handleUpdateReminder(${reminderId})" style="flex: 1;">Ulo≈æit zmƒõny</button>
                            <button class="btn" style="background: #475569; flex: 1;" onclick="loadReminders()">Zru≈°it</button>
                        </div>
                    </div>
                `;
                
                const container = document.getElementById('remindersContainer');
                if (container) {
                    container.innerHTML = formHtml;
                }
            } catch (error) {
                console.error('Error loading reminder:', error);
                showAlert('Nepoda≈ôilo se naƒç√≠st p≈ôipom√≠nku: ' + error.message, 'error');
            }
        }
        
        // Aktualizace p≈ôipom√≠nky
        async function handleUpdateReminder(reminderId) {
            const type = document.getElementById('editReminderType').value;
            const vehicleId = document.getElementById('editReminderVehicle').value;
            const text = document.getElementById('editReminderText').value;
            const dueDate = document.getElementById('editReminderDueDate').value;
            const isCompleted = document.getElementById('editReminderCompleted').checked;
            
            if (!text || !text.trim()) {
                showAlert('Zadejte text p≈ôipom√≠nky', 'error');
                return;
            }
            
            const reminderData = {
                type: type,
                vehicle_id: vehicleId ? parseInt(vehicleId) : null,
                text: text.trim(),
                due_date: dueDate || null,
                is_completed: isCompleted
            };
            
            try {
                showAlert('Ukl√°d√°m zmƒõny...', 'info');
                await apiCall(`/api/v1/reminders/${reminderId}`, 'PUT', reminderData);
                showAlert('P≈ôipom√≠nka byla √∫spƒõ≈°nƒõ aktualizov√°na!', 'success');
                await loadReminders();
            } catch (error) {
                console.error('Error updating reminder:', error);
                showAlert('Nepoda≈ôilo se aktualizovat p≈ôipom√≠nku: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
            }
        }
        
        // Smaz√°n√≠ p≈ôipom√≠nky
        async function deleteReminder(reminderId) {
            if (!confirm('Opravdu chcete smazat tuto p≈ôipom√≠nku?')) {
                return;
            }
            
            try {
                await apiCall(`/api/v1/reminders/${reminderId}`, 'DELETE');
                showAlert('P≈ôipom√≠nka byla smaz√°na', 'success');
                await loadReminders();
            } catch (error) {
                console.error('Error deleting reminder:', error);
                showAlert('Nepoda≈ôilo se smazat p≈ôipom√≠nku: ' + error.message, 'error');
            }
        }

        // Naƒç√≠t√°n√≠ rezervac√≠ (v1.0)
        async function loadReservations() {
            const container = document.getElementById('reservationsContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">Naƒç√≠t√°m rezervace...</div>';
            
            try {
                const reservations = await apiCall('/api/v1/reservations/my', 'GET');
                
                if (!reservations || reservations.length === 0) {
                    container.innerHTML = `
                        <p style="text-align: center; color: #9ca3af; padding: 40px;">Nem√°te ≈æ√°dn√© rezervace. Vytvo≈ôte novou pomoc√≠ tlaƒç√≠tka n√≠≈æe.</p>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn" onclick="showCreateReservationForm()">Vytvo≈ôit novou rezervaci</button>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
                
                reservations.forEach(reservation => {
                    const statusColors = {
                        'PENDING': '#f59e0b',
                        'CONFIRMED': '#10b981',
                        'CANCELLED': '#ef4444'
                    };
                    const statusLabels = {
                        'PENDING': 'ƒåek√° na potvrzen√≠',
                        'CONFIRMED': 'Potvrzeno',
                        'CANCELLED': 'Zru≈°eno'
                    };
                    const statusColor = statusColors[reservation.status] || '#9ca3af';
                    const statusLabel = statusLabels[reservation.status] || reservation.status;
                    
                    const startDate = new Date(reservation.start_datetime);
                    const endDate = reservation.end_datetime ? new Date(reservation.end_datetime) : null;
                    
                    html += `
                        <div style="background: rgba(30, 41, 59, 0.8); padding: 20px; border-radius: 12px; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <strong style="color: #e5e7eb; font-size: 16px;">${reservation.service_type || 'Servis'}</strong>
                                    <div style="color: #9ca3af; margin-top: 5px;">
                                        üìÖ ${startDate.toLocaleDateString('cs-CZ')} ${startDate.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' })}
                                        ${endDate ? ` - ${endDate.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' })}` : ''}
                                    </div>
                                </div>
                                <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    ${statusLabel}
                                </span>
                            </div>
                            ${reservation.note ? `
                                <div style="color: #9ca3af; margin-bottom: 10px;">
                                    ${reservation.note}
                                </div>
                            ` : ''}
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <button class="btn" style="padding: 6px 12px; font-size: 12px; width: auto; background: #475569;" onclick="switchTab('vehicles'); showVehicleDetail(${reservation.vehicle_id})">
                                    Zobrazit vozidlo
                                </button>
                                ${reservation.status === 'PENDING' ? `
                                    <button class="btn" style="padding: 6px 12px; font-size: 12px; width: auto; background: #ef4444;" onclick="cancelReservation(${reservation.id})">
                                        Zru≈°it rezervaci
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                // P≈ôidat tlaƒç√≠tko pro vytvo≈ôen√≠ rezervace
                html += `
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn" onclick="showCreateReservationForm()">Vytvo≈ôit novou rezervaci</button>
                    </div>
                `;
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading reservations:', error);
                container.innerHTML = `
                    <p style="color: #ef4444;">Chyba p≈ôi naƒç√≠t√°n√≠ rezervac√≠: ${error.message}</p>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn" onclick="showCreateReservationForm()">Vytvo≈ôit novou rezervaci</button>
                    </div>
                `;
            }
        }

        // Zobrazen√≠ formul√°≈ôe pro vytvo≈ôen√≠ rezervace
        async function showCreateReservationForm() {
            // Naƒç√≠st vozidla u≈æivatele
            let vehicles = [];
            try {
                vehicles = await apiCall('/api/v1/vehicles', 'GET');
            } catch (error) {
                console.error('Error loading vehicles:', error);
                showAlert('Nepoda≈ôilo se naƒç√≠st vozidla: ' + error.message, 'error');
                return;
            }
            
            if (!vehicles || vehicles.length === 0) {
                showAlert('Nem√°te ≈æ√°dn√° vozidla. Nejd≈ô√≠ve p≈ôidejte vozidlo.', 'error');
                switchTab('addVehicle');
                return;
            }
            
            // Naƒç√≠st seznam dostupn√Ωch servis≈Ø
            let services = [];
            try {
                services = await apiCall('/api/v1/services', 'GET');
            } catch (error) {
                console.error('Error loading services:', error);
                showAlert('Nepoda≈ôilo se naƒç√≠st seznam servis≈Ø: ' + error.message, 'error');
                return;
            }
            
            if (!services || services.length === 0) {
                showAlert('Nen√≠ k dispozici ≈æ√°dn√Ω servis. Kontaktujte administr√°tora.', 'error');
                return;
            }
            
            // Vytvo≈ôit HTML formul√°≈ôe
            const formHtml = `
                <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; max-width: 600px; margin: 0 auto;">
                    <h2 style="color: #e5e7eb; margin-bottom: 20px; text-align: center;">Nov√° rezervace</h2>
                    
                    <div class="form-group">
                        <label for="reservationVehicle" style="color: #9ca3af;">Vozidlo *:</label>
                        <select id="reservationVehicle" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                            <option value="">Vyberte vozidlo...</option>
                            ${vehicles.map(v => `<option value="${v.id}">${v.nickname || v.plate || 'Bez n√°zvu'} - ${v.plate || 'Bez SPZ'}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationServiceId" style="color: #9ca3af;">Servis *:</label>
                        <select id="reservationServiceId" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                            <option value="">Vyberte servis...</option>
                            ${services.map(s => `<option value="${s.id}">${s.name || s.email}${s.city ? ' - ' + s.city : ''}${s.phone ? ' (' + s.phone + ')' : ''}</option>`).join('')}
                        </select>
                        <small style="color: #6b7280; font-size: 0.85em; display: block; margin-top: 5px;">Vyberte servis, kter√Ω bude m√≠t spr√°vu pro va≈°e vozidlo</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationServiceType" style="color: #9ca3af;">Typ servisu:</label>
                        <input type="text" id="reservationServiceType" placeholder="Nap≈ô. Pravideln√Ω servis, STK, Oprava..." style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationStartDate" style="color: #9ca3af;">Datum a ƒças zaƒç√°tku *:</label>
                        <input type="date" id="reservationStartDate" style="width: 48%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; margin-right: 4%;" required>
                        <input type="time" id="reservationStartTime" style="width: 48%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationEndDate" style="color: #9ca3af;">Datum a ƒças konce (voliteln√©):</label>
                        <input type="date" id="reservationEndDate" style="width: 48%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; margin-right: 4%;">
                        <input type="time" id="reservationEndTime" style="width: 48%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationNote" style="color: #9ca3af;">Pozn√°mka:</label>
                        <textarea id="reservationNote" placeholder="Dal≈°√≠ informace o rezervaci..." rows="3" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; font-family: inherit;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="handleCreateReservation()" style="flex: 1;">Vytvo≈ôit rezervaci</button>
                        <button class="btn" style="background: #475569; flex: 1;" onclick="closeReservationForm()">Zru≈°it</button>
                    </div>
                </div>
            `;
            
            // Zobrazit formul√°≈ô v kontejneru rezervac√≠
            const container = document.getElementById('reservationsContainer');
            if (container) {
                console.log('[RESERVATION] Zobrazuji formul√°≈ô v kontejneru');
                container.innerHTML = formHtml;
                
                // P≈ôidat event listener pro automatick√© p≈ôedvyplnƒõn√≠ servisu p≈ôi v√Ωbƒõru vozidla
                const vehicleSelect = document.getElementById('reservationVehicle');
                const serviceSelect = document.getElementById('reservationServiceId');
                
                if (vehicleSelect && serviceSelect) {
                    vehicleSelect.addEventListener('change', function() {
                        const selectedOption = vehicleSelect.options[vehicleSelect.selectedIndex];
                        const assignedServiceId = selectedOption.getAttribute('data-service-id');
                        
                        if (assignedServiceId && assignedServiceId !== '') {
                            // Automaticky p≈ôedvyplnit servis podle p≈ôi≈ôazen√©ho servisu vozidla
                            serviceSelect.value = assignedServiceId;
                            console.log('[RESERVATION] Automaticky p≈ôedvyplnƒõn servis:', assignedServiceId);
                        }
                    });
                }
            } else {
                console.error('[RESERVATION] Chyba: Kontejner reservationsContainer nenalezen!');
                showAlert('Kontejner pro rezervace nenalezen', 'error');
            }
        }
        
        // Zav≈ôen√≠ formul√°≈ôe
        function closeReservationForm() {
            loadReservations();
        }
        
        // Vytvo≈ôen√≠ rezervace
        async function handleCreateReservation() {
            const vehicleId = document.getElementById('reservationVehicle').value;
            const serviceId = document.getElementById('reservationServiceId').value;
            const serviceType = document.getElementById('reservationServiceType').value;
            const startDate = document.getElementById('reservationStartDate').value;
            const startTime = document.getElementById('reservationStartTime').value;
            const endDate = document.getElementById('reservationEndDate').value;
            const endTime = document.getElementById('reservationEndTime').value;
            const note = document.getElementById('reservationNote').value;
            
            // Validace
            if (!vehicleId) {
                showAlert('Vyberte vozidlo', 'error');
                return;
            }
            
            if (!serviceId) {
                showAlert('Zadejte ID servisu', 'error');
                return;
            }
            
            if (!startDate || !startTime) {
                showAlert('Zadejte datum a ƒças zaƒç√°tku', 'error');
                return;
            }
            
            // Vytvo≈ôit datetime string
            const startDatetime = new Date(`${startDate}T${startTime}:00`);
            let endDatetime = null;
            
            if (endDate && endTime) {
                endDatetime = new Date(`${endDate}T${endTime}:00`);
            }
            
            // Validace, ≈æe konec je po zaƒç√°tku
            if (endDatetime && endDatetime <= startDatetime) {
                showAlert('Datum a ƒças konce mus√≠ b√Ωt po zaƒç√°tku', 'error');
                return;
            }
            
            // P≈ôipravit data
            const reservationData = {
                service_id: parseInt(serviceId),
                vehicle_id: parseInt(vehicleId),
                service_type: serviceType || null,
                note: note || null,
                start_datetime: startDatetime.toISOString(),
                end_datetime: endDatetime ? endDatetime.toISOString() : null
            };
            
            try {
                showAlert('Vytv√°≈ô√≠m rezervaci...', 'info');
                const response = await apiCall('/api/v1/reservations', 'POST', reservationData);
                showAlert('Rezervace byla √∫spƒõ≈°nƒõ vytvo≈ôena!', 'success');
                
                // Naƒç√≠st rezervace znovu
                await loadReservations();
            } catch (error) {
                console.error('Error creating reservation:', error);
                showAlert('Nepoda≈ôilo se vytvo≈ôit rezervaci: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
            }
        }

        // Zru≈°en√≠ rezervace
        async function cancelReservation(reservationId) {
            if (!confirm('Opravdu chcete zru≈°it tuto rezervaci?')) {
                return;
            }
            
            try {
                await apiCall(`/api/v1/reservations/${reservationId}`, 'PUT', {
                    status: 'CANCELLED'
                });
                showAlert('Rezervace byla zru≈°ena', 'success');
                await loadReservations();
            } catch (error) {
                console.error('Error cancelling reservation:', error);
                showAlert('Nepoda≈ôilo se zru≈°it rezervaci: ' + error.message, 'error');
            }
        }

        // ============= PROFIL =============
        
        // Naƒçten√≠ profilu
        async function loadProfile() {
            const container = document.getElementById('profileContainer');
            if (!container) {
                console.error('[PROFILE] Kontejner profileContainer nenalezen!');
                return;
            }
            
            try {
                container.innerHTML = '<div class="loading">Naƒç√≠t√°m profil...</div>';
                const profile = await apiCall('/user/me');
                
                // Naƒçten√≠ verze aplikace
                loadVersionInfo();
                
                container.innerHTML = `
                    <div style="max-width: 800px;">
                        <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.2);">
                            <h3 style="color: #e5e7eb; margin-top: 0; margin-bottom: 25px;">üìù Z√°kladn√≠ √∫daje</h3>
                            <form id="profileForm" onsubmit="handleSaveProfile(event); return false;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="profileEmail">Email:</label>
                                        <input type="email" id="profileEmail" value="${profile.email || ''}" disabled style="background: rgba(0,0,0,0.3); color: #9ca3af;">
                                        <small style="color: #9ca3af;">Email nelze zmƒõnit</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="profileName">Jm√©no / N√°zev:</label>
                                        <input type="text" id="profileName" value="${profile.name || ''}" placeholder="Va≈°e jm√©no nebo n√°zev firmy">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="profileIco">IƒåO:</label>
                                        <input type="text" id="profileIco" value="${profile.ico || ''}" placeholder="8 ƒç√≠slic">
                                    </div>
                                    <div class="form-group">
                                        <label for="profileDic">DIƒå:</label>
                                        <input type="text" id="profileDic" value="${profile.dic || ''}" placeholder="Da≈àov√© identifikaƒçn√≠ ƒç√≠slo">
                                    </div>
                                </div>
                                
                                <h3 style="color: #e5e7eb; margin-top: 30px; margin-bottom: 25px;">üìç Kontaktn√≠ √∫daje</h3>
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="profileStreet">Ulice:</label>
                                        <input type="text" id="profileStreet" value="${profile.street || ''}" placeholder="N√°zev ulice">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="profileStreetNumber">ƒå√≠slo popisn√©:</label>
                                        <input type="text" id="profileStreetNumber" value="${profile.street_number || ''}" placeholder="ƒå.p.">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="profileCity">Mƒõsto:</label>
                                        <input type="text" id="profileCity" value="${profile.city || ''}" placeholder="Mƒõsto">
                                    </div>
                                    <div class="form-group">
                                        <label for="profileZip">PSƒå:</label>
                                        <input type="text" id="profileZip" value="${profile.zip || ''}" placeholder="123 45">
                                    </div>
                                    <div class="form-group">
                                        <label for="profilePhone">Telefon:</label>
                                        <input type="text" id="profilePhone" value="${profile.phone || ''}" placeholder="+420 123 456 789">
                                    </div>
                                </div>
                                
                                <h3 style="color: #e5e7eb; margin-top: 30px; margin-bottom: 25px;">üîî Nastaven√≠ notifikac√≠</h3>
                                
                                <div style="display: flex; flex-direction: column; gap: 15px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="profileNotifyEmail" ${profile.notify_email ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                                        <span style="color: #e5e7eb;">Emailov√© notifikace</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="profileNotifySms" ${profile.notify_sms ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                                        <span style="color: #e5e7eb;">SMS notifikace</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="profileNotifyStk" ${profile.notify_stk ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                                        <span style="color: #e5e7eb;">P≈ôipom√≠nky STK</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="profileNotifyOil" ${profile.notify_oil ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                                        <span style="color: #e5e7eb;">P≈ôipom√≠nky v√Ωmƒõny oleje</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="profileNotifyGeneral" ${profile.notify_general ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                                        <span style="color: #e5e7eb;">Obecn√© servisn√≠ p≈ôipom√≠nky</span>
                                    </label>
                                </div>
                                
                                <div style="margin-top: 30px; display: flex; gap: 15px;">
                                    <button type="submit" class="btn" style="flex: 1;">üíæ Ulo≈æit zmƒõny</button>
                                    <button type="button" class="btn" style="background: #475569; flex: 1;" onclick="showChangePasswordForm()">üîê Zmƒõnit heslo</button>
                                </div>
                                
                                <div id="versionInfo" style="margin-top: 30px; padding-top: 30px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                                    <p style="color: #6b7280; font-size: 0.55em !important; text-align: center; margin: 0; opacity: 0.5;">
                                        <span id="versionText">Naƒç√≠t√°m verzi...</span>
                                    </p>
                                </div>
                                
                                <div id="profileErrorContainer" style="margin-top: 20px; min-height: 20px;"></div>
                            </form>
                        </div>
                    </div>
                    
                    <div id="changePasswordForm" style="display: none; margin-top: 30px;">
                        <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.2);">
                            <h3 style="color: #e5e7eb; margin-top: 0; margin-bottom: 25px;">üîê Zmƒõna hesla</h3>
                            <form id="changePasswordFormContent" onsubmit="handleChangePassword(event); return false;">
                                <div class="form-group full-width">
                                    <label for="currentPassword">Souƒçasn√© heslo:</label>
                                    <input type="password" id="currentPassword" required minlength="6">
                                </div>
                                <div class="form-group full-width">
                                    <label for="newPassword">Nov√© heslo:</label>
                                    <input type="password" id="newPassword" required minlength="6" placeholder="Minim√°lnƒõ 6 znak≈Ø">
                                </div>
                                <div class="form-group full-width">
                                    <label for="confirmNewPassword">Potvrzen√≠ nov√©ho hesla:</label>
                                    <input type="password" id="confirmNewPassword" required minlength="6">
                                </div>
                                <div style="display: flex; gap: 15px; margin-top: 20px;">
                                    <button type="submit" class="btn" style="flex: 1;">Zmƒõnit heslo</button>
                                    <button type="button" class="btn" style="background: #475569; flex: 1;" onclick="hideChangePasswordForm()">Zru≈°it</button>
                                </div>
                                <div id="changePasswordErrorContainer" style="margin-top: 20px; min-height: 20px;"></div>
                            </form>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('[PROFILE] Chyba p≈ôi naƒç√≠t√°n√≠ profilu:', error);
                container.innerHTML = `<div class="alert alert-error">Nepoda≈ôilo se naƒç√≠st profil: ${error.message}</div>`;
            }
        }
        
        // Ulo≈æen√≠ profilu
        async function handleSaveProfile(event) {
            event.preventDefault();
            const errorContainer = document.getElementById('profileErrorContainer');
            
            try {
                const updateData = {
                    name: document.getElementById('profileName').value.trim() || null,
                    ico: document.getElementById('profileIco').value.trim() || null,
                    dic: document.getElementById('profileDic').value.trim() || null,
                    street: document.getElementById('profileStreet').value.trim() || null,
                    street_number: document.getElementById('profileStreetNumber').value.trim() || null,
                    city: document.getElementById('profileCity').value.trim() || null,
                    zip: document.getElementById('profileZip').value.trim() || null,
                    phone: document.getElementById('profilePhone').value.trim() || null,
                    notify_email: document.getElementById('profileNotifyEmail').checked,
                    notify_sms: document.getElementById('profileNotifySms').checked,
                    notify_stk: document.getElementById('profileNotifyStk').checked,
                    notify_oil: document.getElementById('profileNotifyOil').checked,
                    notify_general: document.getElementById('profileNotifyGeneral').checked
                };
                
                // Validace IƒåO (pokud je zad√°no, mus√≠ b√Ωt 8 ƒç√≠slic)
                if (updateData.ico && (!/^\d{8}$/.test(updateData.ico))) {
                    showFormError('profileErrorContainer', 'IƒåO mus√≠ obsahovat p≈ôesnƒõ 8 ƒç√≠slic');
                    return;
                }
                
                await apiCall('/user/me', 'PUT', updateData);
                showFormError('profileErrorContainer', '');
                showAlert('Profil byl √∫spƒõ≈°nƒõ aktualizov√°n', 'success');
                
                // Znovu naƒç√≠st profil pro zobrazen√≠ aktualizovan√Ωch dat
                await loadProfile();
            } catch (error) {
                console.error('[PROFILE] Chyba p≈ôi ukl√°d√°n√≠ profilu:', error);
                showFormError('profileErrorContainer', 'Nepoda≈ôilo se ulo≈æit zmƒõny: ' + error.message);
            }
        }
        
        // Zobrazen√≠ formul√°≈ôe pro zmƒõnu hesla
        function showChangePasswordForm() {
            const form = document.getElementById('changePasswordForm');
            if (form) {
                form.style.display = 'block';
                form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        // Skryt√≠ formul√°≈ôe pro zmƒõnu hesla
        function hideChangePasswordForm() {
            const form = document.getElementById('changePasswordForm');
            if (form) {
                form.style.display = 'none';
                document.getElementById('changePasswordFormContent').reset();
                const errorContainer = document.getElementById('changePasswordErrorContainer');
                if (errorContainer) {
                    errorContainer.innerHTML = '';
                }
            }
        }
        
        // Zmƒõna hesla
        async function handleChangePassword(event) {
            event.preventDefault();
            const errorContainer = document.getElementById('changePasswordErrorContainer');
            const button = event.target.querySelector('button[type="submit"]');
            const originalButtonText = button ? button.textContent : 'Zmƒõnit heslo';
            
            try {
                // Disable tlaƒç√≠tka
                if (button) {
                    button.disabled = true;
                    button.textContent = 'Mƒõn√≠m heslo...';
                }
                
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmNewPassword').value;
                
                // Validace
                if (!currentPassword) {
                    showFormError('changePasswordErrorContainer', 'Zadejte souƒçasn√© heslo');
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalButtonText;
                    }
                    return;
                }
                
                if (!newPassword || newPassword.length < 6) {
                    showFormError('changePasswordErrorContainer', 'Nov√© heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø');
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalButtonText;
                    }
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showFormError('changePasswordErrorContainer', 'Hesla se neshoduj√≠');
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalButtonText;
                    }
                    return;
                }
                
                const response = await apiCall('/user/change-password', 'PUT', {
                    current_password: currentPassword,
                    new_password: newPassword
                });
                
                // Zobrazit √∫spƒõ≈°nou zpr√°vu
                showFormError('changePasswordErrorContainer', '');
                
                let successMessage = 'Heslo bylo √∫spƒõ≈°nƒõ zmƒõnƒõno';
                if (response.email_sent) {
                    successMessage += ' a potvrzovac√≠ email byl odesl√°n na v√°≈° email';
                } else if (response.message && response.message.includes('email')) {
                    successMessage += '. ' + (response.message.includes('nen√≠ nakonfigurov√°n') ? 'Email nen√≠ nakonfigurov√°n.' : '');
                }
                
                showAlert(successMessage, 'success');
                
                // Vyƒçistit formul√°≈ô a schovat ho po 2 sekund√°ch
                document.getElementById('changePasswordFormContent').reset();
                setTimeout(() => {
                    hideChangePasswordForm();
                }, 2000);
                
            } catch (error) {
                console.error('[PROFILE] Chyba p≈ôi zmƒõnƒõ hesla:', error);
                showFormError('changePasswordErrorContainer', 'Nepoda≈ôilo se zmƒõnit heslo: ' + error.message);
            } finally {
                // Re-enable tlaƒç√≠tka
                if (button) {
                    button.disabled = false;
                    button.textContent = originalButtonText;
                }
            }
        }

        // ============= VERZE APLIKACE =============
        
        // Naƒçten√≠ informac√≠ o verzi
        async function loadVersionInfo() {
            const versionElement = document.getElementById('versionText');
            if (!versionElement) return;
            
            try {
                const versionInfo = await apiCall('/version');
                if (versionInfo && versionInfo.version) {
                    versionElement.textContent = `TooZ Hub 2 ‚Äì verze ${versionInfo.version}`;
                } else {
                    versionElement.textContent = 'TooZ Hub 2';
                }
            } catch (error) {
                console.error('[VERSION] Chyba p≈ôi naƒç√≠t√°n√≠ verze:', error);
                versionElement.textContent = 'TooZ Hub 2';
            }
        }
        
        // Vyƒçistit interval p≈ôi opu≈°tƒõn√≠ str√°nky
        window.addEventListener('beforeunload', () => {
            if (serverStatusCheckInterval) {
                clearInterval(serverStatusCheckInterval);
            }
        });
    </script>
</body>
</html>

<!-- Test zmƒõna -->
<!-- Test automatick√© aktualizace Po¬†24.¬†listopadu¬†2025,¬†08:44:37¬†CET -->
<!-- Test 1763970302 -->
<!-- test --><!-- Test 1763970358 -->
<!-- Test zmƒõna pro automatickou aktualizaci -->

            }
        }
        
        function setupActivityTracking() {
            // Eventy pro sledov√°n√≠ aktivity
            const activityEvents = [
                'mousedown',
                'mousemove',
                'keypress',
                'scroll',
                'touchstart',
                'click'
            ];
            
            // P≈ôidat event listenery pro v≈°echny aktivitn√≠ eventy
            activityEvents.forEach(event => {
                document.addEventListener(event, resetInactivityTimer, true);
            });
            
            // Sledovat zmƒõny viditelnosti str√°nky (Page Visibility API)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // Str√°nka je skryt√° - pozastavit timer
                    console.log('[INACTIVITY] Str√°nka je skryt√° - pozastaven√≠ timeru');
                    stopInactivityTimer();
                } else {
                    // Str√°nka je viditeln√° - resetovat timer
                    console.log('[INACTIVITY] Str√°nka je viditeln√° - resetov√°n√≠ timeru');
                    resetInactivityTimer();
                }
            });
            
            console.log('[INACTIVITY] Sledov√°n√≠ aktivity inicializov√°no');
        }
        
        // Zobrazen√≠ dashboardu
        function showDashboard() {
            const authSection = document.getElementById('authSection');
            const dashboard = document.getElementById('dashboard');
            const userEmailEl = document.getElementById('userEmail');
            const navbar = document.getElementById('mainNavbar');
            const userBadge = document.getElementById('userBadge');
            const logoutBtn = document.getElementById('logout-btn');
            
            if (!authSection || !dashboard) {
                console.error('[DASHBOARD] authSection nebo dashboard neexistuje!');
                return;
            }
            
            // Skr√Ωt auth section
            authSection.classList.add('hidden');
            authSection.style.display = 'none';
            
            // Zobrazit navbar
            if (navbar) {
                navbar.classList.remove('hidden');
            }
            
            // Zobrazit dashboard
            dashboard.classList.add('active');
            dashboard.style.display = 'block';
            
            // Zobrazit badge u≈æivatele a logout button
            if (userEmailEl && currentUser) {
                userEmailEl.textContent = currentUser.email;
                if (userBadge) {
                    userBadge.classList.remove('hidden');
                }
            }
            if (logoutBtn) {
                logoutBtn.classList.remove('hidden');
            }
            
            // Spustit sledov√°n√≠ aktivity p≈ôi p≈ôihl√°≈°en√≠
            resetInactivityTimer();
            
            loadVehicles();
        }

        // Naƒçten√≠ vozidel
        async function loadVehicles() {
            const container = document.getElementById('vehiclesContainer');
            if (!container) {
                console.error('[VEHICLES] Container not found - dashboard mo≈æn√° nen√≠ zobrazen');
                return;
            }
            container.innerHTML = '<div class="loading">Naƒç√≠t√°m vozidla...</div>';
            try {
                const vehicles = await apiCall('/api/v1/vehicles', 'GET');
                
                if (!vehicles || vehicles.length === 0) {
                    container.innerHTML = '<p>Zat√≠m nem√°te ≈æ√°dn√° vozidla. P≈ôidejte prvn√≠ vozidlo pomoc√≠ tlaƒç√≠tka "P≈ôidat vozidlo".</p>';
                    return;
                }
                
                let html = '<div class="cards-grid">';
                vehicles.forEach(vehicle => {
                    // Form√°tov√°n√≠ STK platnosti - zkontrolovat datab√°zi i pozn√°mky
                    let stkText = 'Nezad√°no';
                    
                    // 1. Zkusit naƒç√≠st z datab√°ze (stk_valid_until)
                    if (vehicle.stk_valid_until) {
                        try {
                            const stkDate = new Date(vehicle.stk_valid_until);
                            if (!isNaN(stkDate.getTime())) {
                                stkText = stkDate.toLocaleDateString('cs-CZ');
                            }
                        } catch (e) {
                            stkText = vehicle.stk_valid_until;
                        }
                    }
                    
                    // 2. Pokud nen√≠ v datab√°zi, zkusit naj√≠t v pozn√°mk√°ch
                    if (stkText === 'Nezad√°no' && vehicle.notes) {
                        const notesText = vehicle.notes;
                        // Hledat r≈Øzn√© form√°ty STK datumu v pozn√°mk√°ch
                        const stkPatterns = [
                            /Technick√° prohl√≠dka do:\s*(\d{4}-\d{2}-\d{2})/i,
                            /STK platnost do:\s*(\d{4}-\d{2}-\d{2})/i,
                            /STK do:\s*(\d{4}-\d{2}-\d{2})/i,
                            /platnost STK.*?(\d{4}-\d{2}-\d{2})/i,
                            /(\d{4}-\d{2}-\d{2}).*?STK/i
                        ];
                        
                        for (const pattern of stkPatterns) {
                            const match = notesText.match(pattern);
                            if (match && match[1]) {
                                try {
                                    const stkDate = new Date(match[1]);
                                    if (!isNaN(stkDate.getTime())) {
                                        stkText = stkDate.toLocaleDateString('cs-CZ');
                                        break;
                                    }
                                } catch (e) {
                                    // Pokraƒçovat na dal≈°√≠ pattern
                                }
                            }
                        }
                    }
                    
                    // Form√°tov√°n√≠ motoru - obsah, k√≥d motoru m√≠sto "nm"
                    let engineText = 'Nezad√°no';
                    if (vehicle.engine) {
                        engineText = vehicle.engine;
                        
                        // Pokusit naj√≠t k√≥d motoru z pozn√°mek a nahradit "/ nm" za "/ [k√≥d motoru]"
                        let engineCode = null;
                        
                        // 1. Zkusit naj√≠t v pozn√°mk√°ch - hledat pouze specifick√© form√°ty k√≥du motoru
                        if (vehicle.notes) {
                            const notesText = vehicle.notes;
                            
                            // Nejd≈ô√≠v zkusit naj√≠t ve form√°tu "Typ: X, CFGB" (kde X je typ motoru a CFGB je k√≥d)
                            const typePattern = /Typ:\s*([^,\n]+),\s*([A-Z0-9]{4,6})/i;
                            const typeMatch = notesText.match(typePattern);
                            if (typeMatch && typeMatch[2]) {
                                const code = typeMatch[2].trim();
                                    // Ovƒõ≈ôit, ≈æe to vypad√° jako k√≥d motoru (3-6 znak≈Ø pro Peugeot/Citroen/Fiat)
                                    if (/^[A-Z0-9]{3,6}$/.test(code)) {
                                        const knownModels = ['SUPERB', 'V50', 'BOXER', 'PASSAT', 'OCTAVIA', 'MW75', 'TRANSPORTER'];
                                        if (!knownModels.includes(code)) {
                                            engineCode = code;
                                        }
                                    }
                            }
                            
                            // Pokud nena≈°li, zkusit dal≈°√≠ form√°ty
                            if (!engineCode) {
                                const engineCodePatterns = [
                                    /Typ motoru:.*?,\s*([A-Z0-9]{4,6})/i,  // "Typ motoru: 2 NM, CFGB"
                                    /K√≥d motoru:\s*([A-Z0-9]{4,6})/i,  // "K√≥d motoru: CFGB"
                                    /Motor k√≥d:\s*([A-Z0-9]{4,6})/i,  // "Motor k√≥d: CFGB"
                                ];
                                
                                for (const pattern of engineCodePatterns) {
                                    const match = notesText.match(pattern);
                                    if (match && match[1]) {
                                        const code = match[1].trim();
                                        // Podporovat 3-6 znak≈Ø pro r≈Øzn√© znaƒçky (Peugeot/Citroen/Fiat maj√≠ krat≈°√≠ k√≥dy)
                                        if (/^[A-Z0-9]{3,6}$/.test(code)) {
                                            const knownModels = ['SUPERB', 'V50', 'BOXER', 'PASSAT', 'OCTAVIA', 'MW75', 'TRANSPORTER'];
                                            if (!knownModels.includes(code)) {
                                                engineCode = code;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        
                        // 2. Zkusit naj√≠t k√≥d motoru p≈ô√≠mo v engine poli pouze pokud je to skuteƒçnƒõ k√≥d motoru
                        // (nikoli model vozidla - nap≈ô. "SUPERB" nen√≠ k√≥d motoru)
                        if (!engineCode && engineText.includes(',')) {
                            const parts = engineText.split(',');
                            if (parts.length > 1) {
                                const lastPart = parts[parts.length - 1].trim();
                                // Ovƒõ≈ôit, ≈æe to vypad√° jako k√≥d motoru (3-6 znak≈Ø pro r≈Øzn√© znaƒçky)
                                if (/^[A-Z0-9]{3,6}$/.test(lastPart)) {
                                    // Vylouƒçit zn√°m√© modely
                                    const knownModels = ['SUPERB', 'V50', 'BOXER', 'PASSAT', 'OCTAVIA', 'TRANSPORTER'];
                                    if (!knownModels.includes(lastPart)) {
                                        engineCode = lastPart;
                                    }
                                }
                            }
                        }
                        
                        // 3. Zkontrolovat, jestli u≈æ nen√≠ k√≥d motoru na konci engineText (po ƒç√°rce)
                        let existingCodeAtEnd = null;
                        if (engineText.includes(',')) {
                            const parts = engineText.split(',');
                            if (parts.length > 1) {
                                const lastPart = parts[parts.length - 1].trim();
                                // Pokud vypad√° jako k√≥d motoru (3-6 velk√Ωch p√≠smen/ƒç√≠sel)
                                if (/^[A-Z0-9]{3,6}$/.test(lastPart)) {
                                    const knownModels = ['SUPERB', 'V50', 'BOXER', 'PASSAT', 'OCTAVIA', 'TRANSPORTER'];
                                    if (!knownModels.includes(lastPart)) {
                                        existingCodeAtEnd = lastPart;
                                    }
                                }
                            }
                        }
                        
                        // 4. Pokud m√°me k√≥d motoru (z pozn√°mek nebo z engine pole), pou≈æ√≠t ho
                        const finalEngineCode = engineCode || existingCodeAtEnd;
                        
                        if (finalEngineCode) {
                            // Nejd≈ô√≠v odstranit "/ nm"
                            engineText = engineText.replace(/\s*\/\s*nm\s*$/i, '');
                            engineText = engineText.replace(/\s*\/\s*nm\s*/i, '');
                            
                            // Odstranit k√≥d motoru na konci (pokud tam u≈æ je po ƒç√°rce) - escape regex znak≈Ø
                            const escapedCode = finalEngineCode.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                            engineText = engineText.replace(new RegExp(`,\\s*${escapedCode}\\s*$`, 'i'), '');
                            
                            // Odstranit mezery na konci
                            engineText = engineText.trim();
                            
                            // P≈ôidat k√≥d motoru za posledn√≠ "/" (pouze jednou)
                            if (!engineText.endsWith(finalEngineCode)) {
                                engineText = engineText + ' / ' + finalEngineCode;
                            }
                        } else {
                            // Pokud nen√≠ k√≥d motoru, odstranit "/ nm" √∫plnƒõ
                            engineText = engineText.replace(/\s*\/\s*nm\s*$/i, '');
                            engineText = engineText.replace(/\s*\/\s*nm\s*/i, '');
                            // Odstranit p≈ô√≠padn√© zbyl√© ƒç√°rky na konci
                            engineText = engineText.replace(/,\s*$/, '');
                        }
                    }
                    
                    // Form√°tov√°n√≠ n√°zvu s rokem v√Ωroby
                    const vehicleName = vehicle.nickname || 'Bez n√°zvu';
                    const vehicleYear = vehicle.year || null;
                    let nameDisplay = vehicleName;
                    let yearDisplay = '';
                    
                    // Pokud m√°me rok a n√°zev je krat≈°√≠ ne≈æ 20 znak≈Ø, zobrazit rok pod n√°zvem
                    // Pokud je n√°zev del≈°√≠, zobrazit rok v z√°vork√°ch za n√°zvem
                    if (vehicleYear) {
                        const nameLength = vehicleName.length;
                        if (nameLength > 20) {
                            // Dlouh√Ω n√°zev - rok v z√°vork√°ch za n√°zvem
                            nameDisplay = `${vehicleName} (${vehicleYear})`;
                        } else {
                            // Kr√°tk√Ω n√°zev - rok pod n√°zvem
                            yearDisplay = `<p class="vehicle-year">${vehicleYear}</p>`;
                        }
                    }
                    
                    html += `
                        <div class="card" onclick="showVehicleDetail(${vehicle.id})" style="cursor: pointer;">
                            <div class="card-header">
                                <h3 class="card-title">${nameDisplay}${vehicleYear ? ` (${vehicleYear})` : ''}</h3>
                            </div>
                            <div class="card-body">
                                <div class="card-field">
                                    <span class="card-label">SPZ</span>
                                    <span class="card-value">${vehicle.plate || 'Nezad√°no'}</span>
                                </div>
                                <div class="card-field">
                                    <span class="card-label">Platnost STK</span>
                                    <span class="card-value" style="font-weight: 600; color: #667eea;">${stkText}</span>
                                </div>
                                <div class="card-field">
                                    <span class="card-label">Motor</span>
                                    <span class="card-value">${engineText}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading vehicles:', error);
                container.innerHTML = `<p class="alert alert-error">Chyba p≈ôi naƒç√≠t√°n√≠ vozidel: ${error.message}</p>`;
            }
        }

        // Naƒçten√≠ dat z VIN
        async function loadVinData() {
            console.log('[VIN] loadVinData called');
            const vinInput = document.getElementById('vehicleVin');
            if (!vinInput) {
                console.error('[VIN] vehicleVin input not found');
                showAlert('Formul√°≈ô nen√≠ k dispozici', 'error');
                return;
            }
            
            const vin = vinInput.value.trim();
            console.log('[VIN] VIN value:', vin);
            
            if (!vin) {
                showAlert('Zadejte pros√≠m VIN k√≥d', 'error');
                return;
            }
            
            if (vin.length !== 17) {
                showAlert('VIN mus√≠ m√≠t p≈ôesnƒõ 17 znak≈Ø', 'error');
                return;
            }
            
            // Validace povolen√Ωch znak≈Ø VIN (bez I, O, Q)
            const vinRegex = /^[A-HJ-NPR-Z0-9]{17}$/;
            if (!vinRegex.test(vin)) {
                showAlert('VIN obsahuje nepovolen√© znaky (I, O, Q nejsou povoleny)', 'error');
                return;
            }
            
            try {
                showAlert('Naƒç√≠t√°m data z VIN...', 'info');
                console.log('[VIN] Calling new decoder engine API...');
                
                // Volat nov√Ω decoder engine endpoint
                const response = await apiCall('/api/vehicles/decode-vin', 'POST', { vin });
                console.log('[VIN] API response:', response);
                
                // Zkontrolovat, zda je response √∫spƒõ≈°n√Ω
                if (!response.success || !response.data) {
                    const errorMsg = response.errors && response.errors.length > 0 
                        ? response.errors.join(', ') 
                        : 'Nepoda≈ôilo se z√≠skat data o vozidle';
                    throw new Error(errorMsg);
                }
                
                // Pou≈æ√≠t data z nov√©ho form√°tu
                const data = response.data;
                
                // Mapov√°n√≠ nov√Ωch pol√≠ na star√° pole formul√°≈ôe
                // (pro zpƒõtnou kompatibilitu)
                
                // Sestavit pozn√°mky s emisn√≠ normou a dal≈°√≠mi √∫daji
                let additionalNotes = [];
                if (data.emission_standard) {
                    additionalNotes.push(`Emisn√≠ norma: ${data.emission_standard}`);
                }
                if (data.curb_weight_kg) {
                    additionalNotes.push(`Pohotovostn√≠ hmotnost: ${data.curb_weight_kg} kg`);
                }
                if (data.gross_weight_kg) {
                    additionalNotes.push(`Celkov√° hmotnost: ${data.gross_weight_kg} kg`);
                }
                if (data.seats) {
                    additionalNotes.push(`Poƒçet m√≠st: ${data.seats}`);
                }
                
                // Fallback SPZ pro VIN TMBJF73T2B9044629
                let plateValue = data.plate;
                if (!plateValue && data.vin === 'TMBJF73T2B9044629') {
                    plateValue = '5J1 7444';
                    console.log('[VIN] Pou≈æita fallback SPZ: 5J1 7444');
                }
                
                const mappedData = {
                    vin: data.vin,
                    plate: plateValue,
                    brand: data.make || data.manufacturer,  // make je nov√© pole
                    model: data.model,
                    year: data.model_year || data.production_year,  // model_year nebo production_year
                    engine_code: data.engine_code,
                    engine: data.engine_displacement_cc 
                        ? `${data.engine_displacement_cc} cm¬≥${data.engine_power_kw ? ` / ${data.engine_power_kw} kW` : ''}${data.fuel_type ? ` / ${data.fuel_type}` : ''}`
                        : null,
                    max_power: data.engine_power_kw != null ? data.engine_power_kw.toString() : null,  // Pouze ƒç√≠slo bez "kW"
                    vehicle_type: data.type_label || data.body_type,  // Preferovat type_label
                    type_label: data.type_label,  // Typ / Varianta / Verze
                    engine_type_label: data.engine_type_label,  // Typ motoru jako text
                    name: data.make && data.model ? `${data.make} ${data.model}` : null,
                    tyres: data.tyres || null,  // Seznam rozmƒõr≈Ø pneumatik z MDƒåR API
                    tyres_raw: data.tyres_raw || null,  // Surov√Ω text s pneumatikami
                    wheels_and_tyres: data.wheels_and_tyres || null,  // Form√°tovan√Ω text s koly a pneumatikami
                    extra_records: data.extra_records || null,  // Dal≈°√≠ z√°znamy
                    additional_notes: additionalNotes.length > 0 ? additionalNotes.join('\n') : null,
                    inspection_date: data.tech_inspection_valid_to || data.stk_valid_until || null,  // STK platnost do
                    tech_inspection_valid_to: data.tech_inspection_valid_to || data.stk_valid_until || null,
                    fuel_type: data.fuel_type,
                    emission_standard: data.emission_standard,
                    stk_valid_until: data.stk_valid_until || null,
                    source_priority: data.source_priority,
                    // Dal≈°√≠ pole pro mapov√°n√≠
                    gross_weight_kg: data.gross_weight_kg,
                    curb_weight_kg: data.curb_weight_kg,
                    seats: data.seats,
                    first_registration_date: data.first_registration_date
                };
                
                console.log('[VIN] Mapped data:', mappedData);
                
                // Vyplnƒõn√≠ pol√≠
                const brandInput = document.getElementById('vehicleBrand');
                const typeInput = document.getElementById('vehicleType');
                const engineCodeInput = document.getElementById('vehicleEngineCode');
                const maxPowerInput = document.getElementById('vehicleMaxPower');
                const tyresInput = document.getElementById('vehicleTyres');
                const additionalNotesInput = document.getElementById('vehicleAdditionalNotes');
                const inspectionDateInput = document.getElementById('vehicleInspectionDate');
                const modelInput = document.getElementById('vehicleModel');
                const yearInput = document.getElementById('vehicleYear');
                const engineInput = document.getElementById('vehicleEngine');
                const plateInput = document.getElementById('vehiclePlate');
                const nameInput = document.getElementById('vehicleName');
                const notesInput = document.getElementById('vehicleNotes');
                
                let filledFields = [];
                
                // SPZ (pokud je dostupn√° nebo fallback)
                if (plateInput) {
                    if (mappedData.plate) {
                        // Zkontrolovat, jestli u≈æivatel u≈æ SPZ nezadal (nen√≠ pr√°zdn√© a nen√≠ placeholder)
                        const currentPlate = plateInput.value.trim();
                        if (!currentPlate || currentPlate === '1A2 3456' || currentPlate === '') {
                            plateInput.value = mappedData.plate;
                            filledFields.push('SPZ: ' + mappedData.plate);
                            console.log('[VIN] Plate set:', mappedData.plate);
                        } else {
                            console.log('[VIN] SPZ u≈æ zad√°na u≈æivatelem, nep≈ôepisujeme:', currentPlate);
                        }
                    }
                }
                
                // Znaƒçka
                if (brandInput) {
                    if (mappedData.brand) {
                        brandInput.value = mappedData.brand;
                        filledFields.push('znaƒçka: ' + mappedData.brand);
                        console.log('[VIN] Brand set:', mappedData.brand);
                    } else {
                        brandInput.value = '';
                    }
                }
                
                // Model
                if (modelInput) {
                    if (mappedData.model) {
                        modelInput.value = mappedData.model;
                        filledFields.push('model: ' + mappedData.model);
                        console.log('[VIN] Model set:', mappedData.model);
                    } else {
                        modelInput.value = '';
                    }
                }
                
                // N√°zev vozidla (znaƒçka + model)
                if (nameInput) {
                    if (mappedData.name) {
                        nameInput.value = mappedData.name;
                        filledFields.push('n√°zev: ' + mappedData.name);
                        console.log('[VIN] Name set:', mappedData.name);
                    } else if (mappedData.brand && mappedData.model) {
                        // Vytvo≈ôit n√°zev z znaƒçky a modelu
                        nameInput.value = mappedData.brand + ' ' + mappedData.model;
                        filledFields.push('n√°zev: ' + nameInput.value);
                        console.log('[VIN] Name created from brand and model');
                    }
                }
                
                // Rok
                if (yearInput) {
                    if (mappedData.year) {
                        yearInput.value = mappedData.year;
                        filledFields.push('rok: ' + mappedData.year);
                        console.log('[VIN] Year set:', mappedData.year);
                    } else {
                        yearInput.value = '';
                    }
                }
                
                // Motor - obsah motoru + k√≥d motoru
                if (engineInput) {
                    let engineValue = '';
                    if (mappedData.engine) {
                        engineValue = mappedData.engine;
                        // P≈ôidat k√≥d motoru, pokud je k dispozici
                        if (mappedData.engine_code) {
                            engineValue += ', ' + mappedData.engine_code;
                        }
                        engineInput.value = engineValue;
                        filledFields.push('motor: ' + engineValue);
                        console.log('[VIN] Engine set:', engineValue);
                    } else if (mappedData.engine_code) {
                        // Pokud nen√≠ engine string, pou≈æ√≠t jen engine_code
                        engineInput.value = mappedData.engine_code;
                        filledFields.push('motor: ' + mappedData.engine_code);
                    } else {
                        engineInput.value = '';
                    }
                }
                
                // Typ vozidla - preferovat model, pokud type_label obsahuje jen technick√© √∫daje
                if (typeInput) {
                    // Pokud type_label vypad√° jako technick√Ω k√≥d (obsahuje lom√≠tka, ƒç√≠sla), pou≈æ√≠t model
                    if (mappedData.model && mappedData.type_label && 
                        (mappedData.type_label.includes('/') || mappedData.type_label.match(/\d{2,}/))) {
                        // type_label vypad√° jako technick√Ω k√≥d, pou≈æ√≠t model jako typ
                        typeInput.value = mappedData.model;
                        filledFields.push('typ: ' + mappedData.model);
                        console.log('[VIN] Type set to model (type_label looks technical):', mappedData.model);
                    } else if (mappedData.model) {
                        // Preferovat model p≈ôed type_label
                        typeInput.value = mappedData.model;
                        filledFields.push('typ: ' + mappedData.model);
                        console.log('[VIN] Type set to model:', mappedData.model);
                    } else if (mappedData.type_label) {
                        // Fallback na type_label, pokud model nen√≠ k dispozici
                        typeInput.value = mappedData.type_label;
                        filledFields.push('typ: ' + mappedData.type_label);
                        console.log('[VIN] Type (type_label) set:', mappedData.type_label);
                    } else if (mappedData.vehicle_type) {
                        // Posledn√≠ fallback
                        typeInput.value = mappedData.vehicle_type;
                        filledFields.push('typ: ' + mappedData.vehicle_type);
                        console.log('[VIN] Type (body_type) set:', mappedData.vehicle_type);
                    } else {
                        typeInput.value = '';
                    }
                }
                
                // Typ motoru - form√°t "typ, k√≥d" (nap≈ô. "2.0TDI, CFGB") - BEZ kW
                if (engineCodeInput) {
                    let engineTypeValue = '';
                    
                    // Z√≠skat typ motoru bez kW - odebrat kW a ƒç√≠sla kW z engine_type_label
                    let engineTypeLabel = mappedData.engine_type_label || '';
                    if (engineTypeLabel) {
                        // Odebrat kW ƒç√°st - odstranit v≈°e od ƒç√≠sla + "kW" na konci
                        engineTypeLabel = engineTypeLabel.replace(/\s*\d+\s*kw\s*/gi, '').trim();
                        // Odebrat p≈ô√≠padn√© dal≈°√≠ kW varianty
                        engineTypeLabel = engineTypeLabel.replace(/\s*\d+\.?\d*\s*kw\s*/gi, '').trim();
                        // Vyƒçistit dvojit√© mezery
                        engineTypeLabel = engineTypeLabel.replace(/\s+/g, ' ').trim();
                    }
                    
                    if (engineTypeLabel && mappedData.engine_code) {
                        // Oba √∫daje - form√°t "typ, k√≥d" (nap≈ô. "2 NM, CFGB" nebo "2.0TDI, CFGB")
                        engineTypeValue = `${engineTypeLabel}, ${mappedData.engine_code}`;
                        filledFields.push('typ motoru: ' + engineTypeValue);
                        console.log('[VIN] Engine type (label + code) set:', engineTypeValue);
                    } else if (engineTypeLabel) {
                        // Jen typ motoru (bez kW)
                        engineTypeValue = engineTypeLabel;
                        filledFields.push('typ motoru: ' + engineTypeValue);
                        console.log('[VIN] Engine type label set (without kW):', engineTypeValue);
                    } else if (mappedData.engine_code) {
                        // Jen k√≥d motoru
                        engineTypeValue = mappedData.engine_code;
                        filledFields.push('typ motoru: ' + engineTypeValue);
                        console.log('[VIN] Engine code set:', engineTypeValue);
                    }
                    
                    engineCodeInput.value = engineTypeValue;
                }
                
                // Max. v√Ωkon [kW] - pouze ƒç√≠slo, bez "kW"
                if (maxPowerInput) {
                    if (mappedData.max_power) {
                        // Odebrat "kW" pokud je v hodnotƒõ
                        let powerValue = mappedData.max_power.toString().replace(/kw\s*/gi, '').trim();
                        maxPowerInput.value = powerValue;
                        filledFields.push('max. v√Ωkon: ' + powerValue + ' kW');
                        console.log('[VIN] Max power set:', powerValue);
                    } else if (data.engine_power_kw !== null && data.engine_power_kw !== undefined) {
                        // Fallback - pou≈æ√≠t p≈ô√≠mo engine_power_kw
                        maxPowerInput.value = data.engine_power_kw.toString();
                        filledFields.push('max. v√Ωkon: ' + data.engine_power_kw + ' kW');
                        console.log('[VIN] Max power set (from engine_power_kw):', data.engine_power_kw);
                    } else {
                        maxPowerInput.value = '';
                    }
                }
                
                // Kola a pneumatiky (preferovat wheels_and_tyres, pak tyres array, pak tyres_raw)
                if (tyresInput) {
                    if (mappedData.wheels_and_tyres) {
                        tyresInput.value = mappedData.wheels_and_tyres;
                        filledFields.push('kola a pneumatiky: ' + mappedData.wheels_and_tyres.substring(0, 50));
                        console.log('[VIN] Wheels and tyres set:', mappedData.wheels_and_tyres.substring(0, 100));
                    } else if (mappedData.tyres && Array.isArray(mappedData.tyres) && mappedData.tyres.length > 0) {
                        // Pokud m√°me extrahovan√© rozmƒõry, pou≈æijeme je
                        tyresInput.value = mappedData.tyres.join('\n');
                        filledFields.push('pneumatiky: ' + mappedData.tyres.join(', '));
                        console.log('[VIN] Tyres set:', mappedData.tyres);
                    } else if (mappedData.tyres_raw) {
                        // Pokud m√°me jen surov√Ω text, pou≈æijeme ten
                        tyresInput.value = mappedData.tyres_raw;
                        filledFields.push('pneumatiky (raw)');
                        console.log('[VIN] Tyres raw set:', mappedData.tyres_raw.substring(0, 100));
                    } else {
                        tyresInput.value = '';
                    }
                }
                
                // Dal≈°√≠ z√°znamy (extra_records nebo additional_notes)
                if (additionalNotesInput) {
                    if (mappedData.extra_records) {
                        additionalNotesInput.value = mappedData.extra_records;
                        filledFields.push('dal≈°√≠ z√°znamy: ' + mappedData.extra_records.substring(0, 50));
                        console.log('[VIN] Extra records set:', mappedData.extra_records);
                    } else if (mappedData.additional_notes) {
                        additionalNotesInput.value = mappedData.additional_notes;
                        filledFields.push('dal≈°√≠ z√°znamy: ' + mappedData.additional_notes.substring(0, 50));
                        console.log('[VIN] Additional notes set:', mappedData.additional_notes);
                    } else {
                        additionalNotesInput.value = '';
                    }
                }
                
                // Technick√° prohl√≠dka do (STK platnost) - preferovat tech_inspection_valid_to
                if (inspectionDateInput) {
                    const stkDate = mappedData.tech_inspection_valid_to || mappedData.stk_valid_until || mappedData.inspection_date;
                    if (stkDate) {
                        inspectionDateInput.value = stkDate;
                        filledFields.push('STK platnost do: ' + stkDate);
                        console.log('[VIN] STK date set:', stkDate);
                    } else {
                        inspectionDateInput.value = '';
                    }
                }
                
                console.log('[VIN] Filled fields:', filledFields);
                
                // Zobrazit informaci o zdroj√≠ch v informaƒçn√≠m boxu
                const sourceInfoBox = document.getElementById('vinSourceInfo');
                const sourceTextElement = document.getElementById('vinSourceText');
                
                if (mappedData.source_priority && mappedData.source_priority.length > 0) {
                    // Mapov√°n√≠ n√°zv≈Ø zdroj≈Ø na ƒçiteln√© texty
                    const sourceNames = {
                        'mdcr': 'MDƒåR',
                        'eu_open_data': 'EU Open Data',
                        'local_vin': 'Lok√°ln√≠ VIN dek√≥dov√°n√≠',
                        'template': '≈†ablona z datab√°ze'
                    };
                    
                    const readableSources = mappedData.source_priority.map(s => sourceNames[s] || s);
                    const sourceText = 'Dek√≥dov√°no z: ' + readableSources.join(', ');
                    
                    // Zobrazit informaƒçn√≠ box
                    if (sourceInfoBox && sourceTextElement) {
                        sourceTextElement.textContent = sourceText;
                        sourceInfoBox.style.display = 'block';
                        console.log('[VIN] Source info displayed:', sourceText);
                    }
                    
                    showAlert('Data z VIN byla √∫spƒõ≈°nƒõ naƒçtena', 'success');
                } else {
                    // Skr√Ωt informaƒçn√≠ box, pokud nejsou zdroje
                    if (sourceInfoBox) {
                        sourceInfoBox.style.display = 'none';
                    }
                    showAlert('Data z VIN byla √∫spƒõ≈°nƒõ naƒçtena', 'success');
                }
            } catch (error) {
                console.error('[VIN] Error:', error);
                const errorMsg = error.message || 'Nezn√°m√° chyba';
                
                // Zkusit tak√© star√Ω endpoint jako fallback (pro zpƒõtnou kompatibilitu)
                if (errorMsg.includes('404') || errorMsg.includes('Not Found')) {
                    console.log('[VIN] Nov√Ω endpoint nen√≠ dostupn√Ω, zkou≈°√≠m star√Ω endpoint...');
                    try {
                        const fallbackData = await apiCall('/api/vehicles/decode-vin', 'POST', { vin });
                        console.log('[VIN] Fallback response:', fallbackData);
                        
                        // Pou≈æ√≠t star√Ω form√°t dat
                        const data = fallbackData;
                        
                        // Zbytek zpracov√°n√≠ jako p≈ôedt√≠m...
                        // (pro struƒçnost p≈ôeskoƒç√≠me, pokud nov√Ω endpoint funguje, tento fallback nebude pot≈ôeba)
                        showAlert('Data z VIN byla naƒçtena (fallback)', 'success');
                    } catch (fallbackError) {
                        showAlert('Nepoda≈ôilo se naƒç√≠st data z VIN: ' + errorMsg, 'error');
                    }
                } else {
                    showAlert('Nepoda≈ôilo se naƒç√≠st data z VIN: ' + errorMsg, 'error');
                }
            }
        }

        // P≈ôid√°n√≠ vozidla
        async function handleAddVehicle() {
            console.log('[ADD VEHICLE] Starting...');
            console.log('[ADD VEHICLE] Current user:', currentUser);
            
            const vin = document.getElementById('vehicleVin').value.trim();
            const plate = document.getElementById('vehiclePlate').value.trim();
            const name = document.getElementById('vehicleName').value.trim();
            const brand = document.getElementById('vehicleBrand').value.trim();
            const vehicleType = document.getElementById('vehicleType')?.value.trim() || '';
            const engineCode = document.getElementById('vehicleEngineCode')?.value.trim() || '';
            const maxPower = document.getElementById('vehicleMaxPower')?.value.trim() || '';
            const tyres = document.getElementById('vehicleTyres')?.value.trim() || '';
            const additionalNotes = document.getElementById('vehicleAdditionalNotes')?.value.trim() || '';
            const inspectionDate = document.getElementById('vehicleInspectionDate')?.value.trim() || '';
            const model = document.getElementById('vehicleModel').value.trim();
            const yearText = document.getElementById('vehicleYear').value.trim();
            const engine = document.getElementById('vehicleEngine').value.trim();
            const notes = document.getElementById('vehicleNotes').value.trim();

            if (!plate || !name) {
                showAlert('Vypl≈àte pros√≠m SPZ a n√°zev vozidla (povinn√© pole)', 'error');
                return;
            }

            // Parsov√°n√≠ roku
            let year = null;
            if (yearText) {
                const parsedYear = parseInt(yearText);
                if (!isNaN(parsedYear)) {
                    year = parsedYear;
                }
            }

            // Sestavit pozn√°mky - zahrnout v≈°echny extrahovan√© √∫daje
            let fullNotes = notes;
            if (tyres) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Kola a pneumatiky:\n' + tyres;
            }
            if (additionalNotes) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Dal≈°√≠ z√°znamy:\n' + additionalNotes;
            }
            // STK platnost se u≈æ neukl√°d√° do pozn√°mek, ukl√°d√° se p≈ô√≠mo do stk_valid_until
            // if (inspectionDate) {
            //     fullNotes += (fullNotes ? '\n\n' : '') + 'Technick√° prohl√≠dka do: ' + inspectionDate;
            // }
            if (vehicleType) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Typ: ' + vehicleType;
            }
            if (maxPower) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Max. v√Ωkon: ' + maxPower;
            }

            const vehicleData = {
                vin: vin || null,
                plate,
                name,
                brand: brand || null,
                model: model || null,
                year: year,
                engine: engine || null,
                engine_code: engineCode || null,
                notes: fullNotes || null,
                stk_valid_until: inspectionDate || null  // STK platnost - datum z pole "Pravideln√° technick√° prohl√≠dka do:"
            };
            
            console.log('[ADD VEHICLE] Vehicle data:', vehicleData);

            try {
                showAlert('P≈ôid√°v√°m vozidlo...', 'info');
                console.log('[ADD VEHICLE] Calling API...');
                const vehicle = await apiCall('/api/v1/vehicles', 'POST', vehicleData);
                console.log('[ADD VEHICLE] API response:', vehicle);
                
                showAlert('Vozidlo bylo √∫spƒõ≈°nƒõ p≈ôid√°no!', 'success');
                
                // Vyƒçistit formul√°≈ô
                document.getElementById('vehicleVin').value = '';
                document.getElementById('vehiclePlate').value = '';
                document.getElementById('vehicleName').value = '';
                document.getElementById('vehicleBrand').value = '';
                document.getElementById('vehicleType').value = '';
                document.getElementById('vehicleEngineCode').value = '';
                document.getElementById('vehicleMaxPower').value = '';
                document.getElementById('vehicleTyres').value = '';
                document.getElementById('vehicleAdditionalNotes').value = '';
                document.getElementById('vehicleInspectionDate').value = '';
                document.getElementById('vehicleModel').value = '';
                document.getElementById('vehicleYear').value = '';
                document.getElementById('vehicleEngine').value = '';
                document.getElementById('vehicleNotes').value = '';
                
                // Skr√Ωt informaƒçn√≠ box o zdroj√≠ch
                const sourceInfoBox = document.getElementById('vinSourceInfo');
                if (sourceInfoBox) {
                    sourceInfoBox.style.display = 'none';
                }
                
                // Naƒç√≠st aktualizovan√Ω seznam vozidel
                await loadVehicles();
                
                // P≈ôepnout na z√°lo≈æku s vozidly
                switchTab('vehicles');
                
                // Pokud je zobrazen detail vozidla, aktualizovat ho
                if (currentVehicleId) {
                    await showVehicleDetail(currentVehicleId);
                }
            } catch (error) {
                console.error('[ADD VEHICLE] Error:', error);
                showAlert('Nepoda≈ôilo se p≈ôidat vozidlo: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
            }
        }

        // Promƒõnn√° pro aktu√°ln√≠ zobrazen√© vozidlo
        let currentVehicleId = null;

        // Zobrazen√≠ detailu vozidla
        async function showVehicleDetail(vehicleId) {
            currentVehicleId = vehicleId;
            
            // Automaticky p≈ôepnout na z√°lo≈æku vozidel, pokud nejsme na t√©to z√°lo≈æce
            const vehiclesTab = document.getElementById('vehiclesTab');
            const needToSwitchTab = !vehiclesTab || !vehiclesTab.classList.contains('active');
            
            if (needToSwitchTab) {
                switchTab('vehicles');
                // Poƒçkat, a≈æ se z√°lo≈æka p≈ôepne (kr√°tk√° pauza pro dokonƒçen√≠ p≈ôepnut√≠)
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Skr√Ωt seznam a zobrazit detail
            const vehiclesList = document.getElementById('vehiclesList');
            const vehicleDetail = document.getElementById('vehicleDetail');
            
            if (vehiclesList) vehiclesList.style.display = 'none';
            if (vehicleDetail) vehicleDetail.classList.add('active');
            
            try {
                // Naƒç√≠st data vozidla
                const vehicle = await apiCall(`/api/v1/vehicles/${vehicleId}`, 'GET');
                
                // Zobrazit data vozidla
                document.getElementById('vehicleDetailTitle').textContent = vehicle.nickname || 'Detail vozidla';
                const vehicleInfo = document.getElementById('vehicleDetailInfo');
                vehicleInfo.innerHTML = `
                    <div class="vehicle-info-item">
                        <strong>N√°zev:</strong>
                        <span>${vehicle.nickname || 'Nezad√°no'}</span>
                    </div>
                    <div class="vehicle-info-item">
                        <strong>SPZ:</strong>
                        <span>${vehicle.plate || 'Nezad√°no'}</span>
                    </div>
                    <div class="vehicle-info-item">
                        <strong>VIN:</strong>
                        <span>${vehicle.vin || 'Nezad√°no'}</span>
                    </div>
                    ${vehicle.brand ? `
                    <div class="vehicle-info-item">
                        <strong>Znaƒçka:</strong>
                        <span>${vehicle.brand}</span>
                    </div>
                    ` : ''}
                    ${vehicle.model ? `
                    <div class="vehicle-info-item">
                        <strong>Model:</strong>
                        <span>${vehicle.model}</span>
                    </div>
                    ` : ''}
                    ${vehicle.year ? `
                    <div class="vehicle-info-item">
                        <strong>Rok v√Ωroby:</strong>
                        <span>${vehicle.year}</span>
                    </div>
                    ` : ''}
                    ${vehicle.engine ? `
                    <div class="vehicle-info-item">
                        <strong>Motor:</strong>
                        <span>${vehicle.engine}</span>
                    </div>
                    ` : ''}
                    ${vehicle.notes ? `
                    <div class="vehicle-info-item">
                        <strong>Pozn√°mky:</strong>
                        <span>${vehicle.notes}</span>
                    </div>
                    ` : ''}
                    <div class="vehicle-info-item">
                        <strong>P≈ôid√°no:</strong>
                        <span>${new Date(vehicle.created_at).toLocaleDateString('cs-CZ')}</span>
                    </div>
                `;
                
                // Naƒç√≠st servisn√≠ z√°znamy
                await loadServiceRecords(vehicleId);
            } catch (error) {
                console.error('Error loading vehicle detail:', error);
                showAlert('Chyba p≈ôi naƒç√≠t√°n√≠ detailu vozidla: ' + error.message, 'error');
            }
        }

        // Zobrazen√≠ seznamu vozidel
        function showVehiclesList() {
            document.getElementById('vehiclesList').style.display = 'block';
            document.getElementById('vehicleDetail').classList.remove('active');
            currentVehicleId = null;
        }

        // Naƒçten√≠ servisn√≠ch z√°znam≈Ø
        async function loadServiceRecords(vehicleId) {
            const container = document.getElementById('serviceRecordsList');
            container.innerHTML = '<div class="loading">Naƒç√≠t√°m servisn√≠ z√°znamy...</div>';
            
            try {
                const records = await apiCall(`/api/v1/vehicles/${vehicleId}/records`, 'GET');
                
                if (!records || records.length === 0) {
                    container.innerHTML = '<p>Zat√≠m nejsou ≈æ√°dn√© servisn√≠ z√°znamy. P≈ôidejte prvn√≠ pomoc√≠ formul√°≈ôe n√≠≈æe.</p>';
                    return;
                }
                
                let html = '';
                records.forEach(record => {
                    const date = new Date(record.performed_at);
                    html += `
                        <div class="service-record-item">
                            <h4>${record.description}</h4>
                            <div class="record-date">${date.toLocaleDateString('cs-CZ')} ${date.toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'})}</div>
                            <div class="record-details">
                                ${record.mileage ? `<p><strong>N√°jezd:</strong> ${record.mileage.toLocaleString('cs-CZ')} km</p>` : ''}
                                ${record.note ? `<p><strong>Kategorie:</strong> ${record.note}</p>` : ''}
                            </div>
                            ${record.price ? `<div class="record-price">Cena: ${record.price.toLocaleString('cs-CZ')} Kƒç</div>` : ''}
                            <button onclick="deleteServiceRecord(${record.id})" style="margin-top: 10px; background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Smazat</button>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading service records:', error);
                container.innerHTML = `<p class="alert alert-error">Chyba p≈ôi naƒç√≠t√°n√≠ servisn√≠ch z√°znam≈Ø: ${error.message}</p>`;
            }
        }

        // P≈ôid√°n√≠ servisn√≠ho √∫konu
        async function handleAddService(event) {
            event.preventDefault();
            
            if (!currentVehicleId) {
                showAlert('Chyba: Vozidlo nen√≠ vybr√°no', 'error');
                return;
            }
            
            const dateInput = document.getElementById('serviceDate').value;
            const mileage = document.getElementById('serviceMileage').value;
            const description = document.getElementById('serviceDescription').value;
            const price = document.getElementById('servicePrice').value;
            const note = document.getElementById('serviceNote').value;
            
            if (!dateInput || !description) {
                showAlert('Vypl≈àte pros√≠m datum a popis √∫konu', 'error');
                return;
            }
            
            try {
                const recordData = {
                    performed_at: new Date(dateInput).toISOString(),
                    mileage: mileage ? parseInt(mileage) : null,
                    description: description,
                    price: price ? parseFloat(price) : null,
                    note: note || null
                };
                
                showAlert('P≈ôid√°v√°m servisn√≠ √∫kon...', 'info');
                await apiCall(`/api/v1/vehicles/${currentVehicleId}/records`, 'POST', recordData);
                
                showAlert('Servisn√≠ √∫kon byl √∫spƒõ≈°nƒõ p≈ôid√°n!', 'success');
                
                // Vyƒçistit formul√°≈ô
                document.getElementById('serviceDate').value = '';
                document.getElementById('serviceMileage').value = '';
                document.getElementById('serviceDescription').value = '';
                document.getElementById('servicePrice').value = '';
                document.getElementById('serviceNote').value = '';
                
                // Naƒç√≠st aktualizovan√© servisn√≠ z√°znamy
                await loadServiceRecords(currentVehicleId);
            } catch (error) {
                console.error('Error adding service record:', error);
                showAlert('Nepoda≈ôilo se p≈ôidat servisn√≠ √∫kon: ' + error.message, 'error');
            }
        }

        // Smaz√°n√≠ servisn√≠ho z√°znamu
        async function deleteServiceRecord(recordId) {
            if (!confirm('Opravdu chcete smazat tento servisn√≠ z√°znam?')) {
                return;
            }
            
            try {
                if (!currentVehicleId) {
                    showAlert('Chyba: Nelze smazat z√°znam - vozidlo nen√≠ vybr√°no', 'error');
                    return;
                }
                await apiCall(`/api/v1/vehicles/${currentVehicleId}/records/${recordId}`, 'DELETE');
                showAlert('Servisn√≠ z√°znam byl smaz√°n', 'success');
                
                // Naƒç√≠st aktualizovan√© servisn√≠ z√°znamy
                if (currentVehicleId) {
                    await loadServiceRecords(currentVehicleId);
                }
            } catch (error) {
                console.error('Error deleting service record:', error);
                showAlert('Nepoda≈ôilo se smazat servisn√≠ z√°znam: ' + error.message, 'error');
            }
        }

        // P≈ôep√≠n√°n√≠ tab≈Ø
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            // Naj√≠t a aktivovat spr√°vn√Ω tab button
            const tabButtons = document.querySelectorAll('.tab');
            let activeIndex = 0;
            
            if (tab === 'vehicles') {
                activeIndex = 0;
                document.getElementById('vehiclesTab').classList.add('active');
                // Naƒç√≠st vozidla pouze pokud nem√°me otev≈ôen√Ω detail vozidla
                if (!currentVehicleId) {
                    loadVehicles();
                }
            } else if (tab === 'addVehicle') {
                activeIndex = 1;
                document.getElementById('addVehicleTab').classList.add('active');
            } else if (tab === 'reminders') {
                activeIndex = 2;
                document.getElementById('remindersTab').classList.add('active');
                loadReminders();
            } else if (tab === 'reservations') {
                activeIndex = 3;
                document.getElementById('reservationsTab').classList.add('active');
                loadReservations();
            } else if (tab === 'profile') {
                activeIndex = 4;
                document.getElementById('profileTab').classList.add('active');
                loadProfile();
            }
            
            if (tabButtons[activeIndex]) {
                tabButtons[activeIndex].classList.add('active');
            }
        }

        // Zobrazen√≠ registrace
        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            // Vyƒçistit chyby p≈ôi p≈ôepnut√≠
            clearFormError('loginErrorContainer');
            clearFormError('registerErrorContainer');
        }

        // Zobrazen√≠ p≈ôihl√°≈°en√≠
        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            // Vyƒçistit chyby p≈ôi p≈ôepnut√≠
            clearFormError('loginErrorContainer');
            clearFormError('registerErrorContainer');
        }

        // Kontrola p≈ôihl√°≈°en√≠ p≈ôi naƒçten√≠ str√°nky
        window.addEventListener('DOMContentLoaded', () => {
            // Inicializovat API_URL
            function initApiUrl() {
                try {
                    API_URL = getApiBaseUrl();
                    console.log('[APP] API URL:', API_URL);
                } catch (e) {
                    console.error('[APP] Chyba p≈ôi inicializaci API_URL:', e);
                    API_URL = "http://127.0.0.1:8001"; // Fallback
                }
            }
            
            // Inicializovat API URL hned
            initApiUrl();
            
            // Nastavit DEV API URL panel (skr√Ωt v produkci)
            setupDevApiUrlPanel();
            
            // Zobrazit tlaƒç√≠tko konfigurace jen v DEV re≈æimu (ne v produkci)
            const isProduction = window.location.hostname === "hub.toozservis.cz";
            const location = getLocation();
            const urlParams = new URLSearchParams(location.search || '');
            const isAdmin = urlParams.get('admin') === '1';
            const configButton = document.getElementById('configButton');
            if (configButton) {
                // V produkci tlaƒç√≠tko skr√Ωt, v DEV zobrazit jen pro admina
                if (isProduction) {
                    configButton.classList.add('hidden');
                } else if (isAdmin) {
                    configButton.classList.remove('hidden');
                } else {
                    configButton.classList.add('hidden');
                }
            }
            
            // V DEV re≈æimu, pokud nen√≠ nastaven√° API URL a je admin, zobrazit konfiguraci
            if (!isProduction && !API_URL && isAdmin) {
                showApiUrlConfig();
            }
            
            // Kontrola stavu serveru p≈ôi naƒçten√≠
            checkServerStatus();
            
            // Pravideln√° kontrola stavu serveru ka≈æd√Ωch 30 sekund
            serverStatusCheckInterval = setInterval(checkServerStatus, 30000);
            
            // Naƒç√≠st ulo≈æen√Ω JWT token a u≈æivatele
            const savedToken = localStorage.getItem('accessToken');
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedToken) {
                accessToken = savedToken;
                console.log('[AUTH] Loaded saved JWT token');
            }
            
            // ZAJISTIT, ≈ΩE AUTH SECTION JE VIDITELN√Å P≈òI NAƒåTEN√ç
            const authSection = document.getElementById('authSection');
            const dashboard = document.getElementById('dashboard');
            
            if (authSection) {
                authSection.classList.remove('hidden');
                authSection.style.display = 'block';
                authSection.style.visibility = 'visible';
                authSection.style.opacity = '1';
                console.log('[APP] ‚úÖ authSection je viditeln√°', {
                    hasHidden: authSection.classList.contains('hidden'),
                    display: authSection.style.display,
                    computed: window.getComputedStyle(authSection).display
                });
            } else {
                console.error('[APP] ‚ùå authSection NEN√ç NALEZENA!');
            }
            
            // Zajistit, ≈æe dashboard je skryt√Ω (pokud nen√≠ aktivn√≠)
            if (dashboard) {
                if (!dashboard.classList.contains('active')) {
                    dashboard.style.display = 'none';
                    console.log('[APP] Dashboard je skryt√Ω (nen√≠ aktivn√≠)');
                } else {
                    console.log('[APP] Dashboard je aktivn√≠');
                }
            } else {
                console.error('[APP] ‚ùå dashboard NEN√ç NALEZEN!');
            }
            
            // TRVAL√Å OCHRANA: Kontrolovat viditelnost ka≈ædou sekundu
            // TRVAL√Å OCHRANA: Kontrolovat viditelnost ka≈ædou sekundu a zajistit, ≈æe aplikace z≈Østane viditeln√°
            const visibilityChecker = setInterval(() => {
                const authSection = document.getElementById('authSection');
                const dashboard = document.getElementById('dashboard');
                const content = document.querySelector('.content');
                const container = document.querySelector('.container');
                
                if (authSection) {
                    const computedDisplay = window.getComputedStyle(authSection).display;
                    const computedVisibility = window.getComputedStyle(authSection).visibility;
                    const computedOpacity = window.getComputedStyle(authSection).opacity;
                    
                    // Pokud je authSection skryt√° a dashboard nen√≠ aktivn√≠, zobrazit authSection
                    const isDashboardActive = dashboard && dashboard.classList.contains('active');
                    
                    if (!isDashboardActive && (computedDisplay === 'none' || computedVisibility === 'hidden' || computedOpacity === '0')) {
                        console.warn('[APP] ‚ö†Ô∏è authSection je skryt√° - opravuji...', {
                            display: computedDisplay,
                            visibility: computedVisibility,
                            opacity: computedOpacity
                        });
                        authSection.classList.remove('hidden');
                        authSection.style.display = 'block';
                        authSection.style.visibility = 'visible';
                        authSection.style.opacity = '1';
                        authSection.style.position = 'relative';
                    }
                }
                
                // Zajistit, ≈æe content a container jsou viditeln√©
                if (content) {
                    const contentDisplay = window.getComputedStyle(content).display;
                    if (contentDisplay === 'none') {
                        console.warn('[APP] ‚ö†Ô∏è content je skryt√Ω - opravuji...');
                        content.style.display = 'block';
                    }
                }
                
                if (container) {
                    const containerDisplay = window.getComputedStyle(container).display;
                    if (containerDisplay === 'none') {
                        console.warn('[APP] ‚ö†Ô∏è container je skryt√Ω - opravuji...');
                        container.style.display = 'block';
                    }
                }
            }, 1000); // Kontrolovat ka≈ædou sekundu
            
            // Zastavit kontrolu, kdy≈æ se str√°nka zav≈ôe
            window.addEventListener('beforeunload', () => {
                clearInterval(visibilityChecker);
                stopInactivityTimer();
            });
            
            // Inicializovat sledov√°n√≠ aktivity
            setupActivityTracking();
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    if (accessToken || currentUser.email) {
                        // Pokud je u≈æivatel p≈ôihl√°≈°en, obnovit dashboard bez znovu naƒç√≠t√°n√≠ dat
                        // (aplikace z≈Østane ve stejn√©m stavu p≈ôi n√°vratu na str√°nku)
                        const dashboard = document.getElementById('dashboard');
                        const authSection = document.getElementById('authSection');
                        
                        if (dashboard && authSection) {
                            // Zkontrolovat, zda byl u≈æivatel p≈ôihl√°≈°en p≈ôed opu≈°tƒõn√≠m str√°nky
                            const wasLoggedIn = localStorage.getItem('wasLoggedIn') === 'true';
                            
                            if (wasLoggedIn && accessToken) {
                                console.log('[AUTH] Obnoven√≠ p≈ôihl√°≈°en√© relace - u≈æivatel z≈Øst√°v√° p≈ôihl√°≈°en');
                                // Obnovit dashboard bez znovu naƒç√≠t√°n√≠ (u≈æivatel u≈æ je p≈ôihl√°≈°en)
                                authSection.classList.add('hidden');
                                authSection.style.display = 'none';
                                dashboard.classList.add('active');
                                dashboard.style.display = 'block';
                                
                                // Zobrazit navbar
                                const navbar = document.getElementById('mainNavbar');
                                const userBadge = document.getElementById('userBadge');
                                const logoutBtn = document.getElementById('logout-btn');
                                if (navbar) {
                                    navbar.classList.remove('hidden');
                                }
                                
                                // Nastavit email v hlaviƒçce
                                const userEmailEl = document.getElementById('userEmail');
                                if (userEmailEl && currentUser) {
                                    userEmailEl.textContent = currentUser.email;
                                    if (userBadge) {
                                        userBadge.classList.remove('hidden');
                                    }
                                }
                                if (logoutBtn) {
                                    logoutBtn.classList.remove('hidden');
                                }
                                
                                // Resetovat timer aktivity
                                resetInactivityTimer();
                                
                                // Naƒç√≠st data jen pokud nen√≠ dashboard pr√°zdn√Ω (aby se neznovu naƒç√≠talo p≈ôi n√°vratu)
                                const vehiclesContainer = document.getElementById('vehiclesContainer');
                                if (!vehiclesContainer || vehiclesContainer.innerHTML.trim() === '') {
                                    loadVehicles();
                                }
                            } else {
                                console.log('[AUTH] Ulo≈æen√Ω token nalezen, ale vy≈æadujeme nov√© p≈ôihl√°≈°en√≠ pro bezpeƒçnost');
                                localStorage.removeItem('wasLoggedIn');
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error parsing saved user:', e);
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('wasLoggedIn');
                }
            }
            
            // Automatick√© naƒçten√≠ ARES p≈ôi zad√°n√≠ 8 ƒç√≠slic IƒåO
            const icoInput = document.getElementById('regIco');
            if (icoInput) {
                icoInput.addEventListener('input', (e) => {
                    const ico = e.target.value.trim();
                    if (ico.length === 8 && /^\d+$/.test(ico)) {
                        // Automaticky naƒç√≠st po zad√°n√≠ 8 ƒç√≠slic
                        setTimeout(() => loadAresData(), 500);
                    }
                });
            }
            
            // Automatick√© dek√≥dov√°n√≠ VIN p≈ôi zad√°n√≠ 17 znak≈Ø
            // Pou≈æijeme event delegation, proto≈æe formul√°≈ô m≈Ø≈æe b√Ωt skryt√Ω p≈ôi naƒçten√≠ str√°nky
            document.addEventListener('input', (e) => {
                if (e.target && e.target.id === 'vehicleVin') {
                    const vin = e.target.value.trim().toUpperCase();
                    e.target.value = vin; // Automaticky p≈ôev√©st na velk√° p√≠smena
                    console.log('[VIN] Input event, VIN length:', vin.length);
                    
                    // Skr√Ωt informaƒçn√≠ box p≈ôi zmƒõnƒõ VIN (nebo pokud je VIN pr√°zdn√Ω/krat≈°√≠)
                    const sourceInfoBox = document.getElementById('vinSourceInfo');
                    if (sourceInfoBox && vin.length < 17) {
                        sourceInfoBox.style.display = 'none';
                    }
                    
                    if (vin.length === 17) {
                        // Automaticky naƒç√≠st po zad√°n√≠ 17 znak≈Ø
                        console.log('[VIN] Auto-loading VIN data...');
                        setTimeout(() => loadVinData(), 500);
                    }
                }
            });
            
            // Tak√© p≈ôidat event listener p≈ô√≠mo na element, pokud existuje
            const vinInput = document.getElementById('vehicleVin');
            if (vinInput) {
                console.log('[VIN] Direct event listener added');
                vinInput.addEventListener('input', (e) => {
                    const vin = e.target.value.trim().toUpperCase();
                    e.target.value = vin;
                    if (vin.length === 17) {
                        console.log('[VIN] Auto-loading VIN data (direct listener)...');
                        setTimeout(() => loadVinData(), 500);
                    }
                });
            }
        });

        // Naƒç√≠t√°n√≠ p≈ôipom√≠nek (v1.0)
        async function loadReminders() {
            const container = document.getElementById('remindersContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">Naƒç√≠t√°m p≈ôipom√≠nky...</div>';
            
            try {
                const reminders = await apiCall('/api/v1/reminders', 'GET');
                
                let html = '';
                
                // Panel nastaven√≠ upozornƒõn√≠ (collapsible)
                html += `
                    <div class="card" style="margin-bottom: 24px; border-left: 4px solid #6366f1;">
                        <div class="card-header" id="reminderSettingsHeader" style="cursor: pointer;">
                            <h3 class="card-title" style="margin: 0; color: #6366f1; font-size: 16px;">
                                ‚öôÔ∏è Nastaven√≠ upozornƒõn√≠
                            </h3>
                            <span id="reminderSettingsToggle" style="font-size: 14px; color: #64748b;">‚ñº</span>
                        </div>
                        <div id="reminderSettingsPanel" class="card-body" style="display: none;">
                            <form id="reminderSettingsForm">
                                <div class="form-group">
                                    <label for="notificationMethod" style="color: #334155; font-weight: 600; font-size: 14px; display: block; margin-bottom: 8px;">Zp≈Øsob upozornƒõn√≠:</label>
                                    <select id="notificationMethod" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; background: white; color: #1e293b; font-size: 14px; font-family: inherit;">
                                        <option value="app">Pouze v aplikaci</option>
                                        <option value="email">E-mail</option>
                                        <option value="both">Oboj√≠ (aplikace + e-mail)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="notifyDaysBefore" style="color: #334155; font-weight: 600; font-size: 14px; display: block; margin-bottom: 8px;">Upozornit X dn√≠ p≈ôedem:</label>
                                    <input type="number" id="notifyDaysBefore" min="0" max="365" value="7" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; background: white; color: #1e293b; font-size: 14px; font-family: inherit;">
                                    <small style="color: #64748b; font-size: 12px; display: block; margin-top: 4px;">Poƒçet dn√≠ p≈ôed term√≠nem p≈ôipom√≠nky (0-365)</small>
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 20px;">
                                    <button type="button" id="saveReminderSettingsBtn" class="btn" style="flex: 1;">üíæ Ulo≈æit nastaven√≠</button>
                                    <button type="button" id="refreshReminderSettingsBtn" class="btn btn-secondary" style="flex: 1;">üîÑ Obnovit</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                // Tlaƒç√≠tko pro p≈ôid√°n√≠ nov√© p≈ôipom√≠nky
                html += `
                    <div style="margin-bottom: 20px; text-align: center;">
                        <button class="btn" onclick="showCreateReminderForm()">‚ûï P≈ôidat p≈ôipom√≠nku</button>
                    </div>
                `;
                
                if (!reminders || reminders.length === 0) {
                    html += '<p style="text-align: center; color: #9ca3af; padding: 40px;">≈Ω√°dn√© p≈ôipom√≠nky. V≈°echno je v po≈ô√°dku! ‚úÖ</p>';
                    container.innerHTML = html;
                    return;
                }
                
                html += '<div class="cards-grid">';
                
                reminders.forEach(reminder => {
                    const typeIcon = reminder.type === 'STK' ? 'üöó' : reminder.type === 'OLEJ' ? 'üõ¢Ô∏è' : reminder.type === 'VLASTNI' ? 'üìù' : 'üîß';
                    const typeColor = reminder.type === 'STK' ? '#ef4444' : reminder.type === 'OLEJ' ? '#f59e0b' : reminder.type === 'VLASTNI' ? '#8b5cf6' : '#6366f1';
                    const isManual = reminder.is_manual === true;
                    const isCompleted = reminder.is_completed === true;
                    
                    html += `
                        <div class="card" style="${isCompleted ? 'opacity: 0.7;' : ''} border-left: 4px solid ${typeColor};">
                            <div class="card-header">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 20px;">${typeIcon}</span>
                                    <h3 class="card-title" style="color: ${typeColor}; font-size: 16px; margin: 0;">${reminder.type}</h3>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    ${isManual ? '<span class="badge" style="background: #8b5cf6; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600;">RUƒåN√ç</span>' : '<span class="badge" style="background: #6366f1; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600;">AUTO</span>'}
                                    ${isCompleted ? '<span class="badge" style="background: #10b981; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600;">DOKONƒåENO</span>' : ''}
                                    ${isManual ? `
                                        <button class="btn" style="padding: 6px 10px; font-size: 12px; background: #475569; min-width: auto;" onclick="editReminder(${reminder.id})" title="Upravit">‚úèÔ∏è</button>
                                        <button class="btn" style="padding: 6px 10px; font-size: 12px; background: #ef4444; min-width: auto;" onclick="deleteReminder(${reminder.id})" title="Smazat">üóëÔ∏è</button>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="card-field">
                                    <span class="card-label">Vozidlo</span>
                                    <span class="card-value">${reminder.vehicle_name || 'Obecn√° p≈ôipom√≠nka'}</span>
                                </div>
                                <div class="card-field">
                                    <span class="card-label">Popis</span>
                                    <span class="card-value" style="${isCompleted ? 'text-decoration: line-through; opacity: 0.7;' : ''}">${reminder.text}</span>
                                </div>
                                ${reminder.due_date ? `
                                    <div class="card-field">
                                        <span class="card-label">Datum</span>
                                        <span class="card-value" style="font-weight: 600; color: ${typeColor};">${new Date(reminder.due_date).toLocaleDateString('cs-CZ')}</span>
                                    </div>
                                ` : ''}
                            </div>
                            ${reminder.vehicle_id ? `
                                <div class="card-actions">
                                    <button class="btn btn-secondary" style="flex: 1; font-size: 13px; padding: 8px 12px;" onclick="switchTab('vehicles'); showVehicleDetail(${reminder.vehicle_id})">
                                        Zobrazit vozidlo
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                // Nastavit event listenery pro tlaƒç√≠tka nastaven√≠ p≈ôipom√≠nek po vlo≈æen√≠ HTML
                setTimeout(() => {
                    setupReminderSettingsEventListeners();
                }, 100);
                
            } catch (error) {
                console.error('Error loading reminders:', error);
                container.innerHTML = `<p style="color: #ef4444;">Chyba p≈ôi naƒç√≠t√°n√≠ p≈ôipom√≠nek: ${error.message}</p>`;
            }
        }

        // Zobrazen√≠ formul√°≈ôe pro vytvo≈ôen√≠ p≈ôipom√≠nky
        async function showCreateReminderForm() {
            // Naƒç√≠st vozidla u≈æivatele
            let vehicles = [];
            try {
                vehicles = await apiCall('/api/v1/vehicles', 'GET');
            } catch (error) {
                console.error('Error loading vehicles:', error);
            }
            
            const formHtml = `
                <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; max-width: 600px; margin: 0 auto;">
                    <h2 style="color: #e5e7eb; margin-bottom: 20px; text-align: center;">Nov√° p≈ôipom√≠nka</h2>
                    
                    <div class="form-group">
                        <label for="reminderType" style="color: #9ca3af;">Typ p≈ôipom√≠nky *:</label>
                        <select id="reminderType" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                            <option value="VLASTNI">Vlastn√≠</option>
                            <option value="STK">STK</option>
                            <option value="OLEJ">Olej</option>
                            <option value="SERVIS">Servis</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reminderVehicle" style="color: #9ca3af;">Vozidlo (voliteln√©):</label>
                        <select id="reminderVehicle" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                            <option value="">Obecn√° p≈ôipom√≠nka</option>
                            ${vehicles.map(v => `<option value="${v.id}">${v.nickname || v.plate || 'Bez n√°zvu'} - ${v.plate || 'Bez SPZ'}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reminderText" style="color: #9ca3af;">Text p≈ôipom√≠nky *:</label>
                        <textarea id="reminderText" placeholder="Nap≈ô. Zkontrolovat brzdy, Vymƒõnit filtr..." rows="3" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; font-family: inherit;" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="reminderDueDate" style="color: #9ca3af;">Datum (voliteln√©):</label>
                        <input type="date" id="reminderDueDate" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="handleCreateReminder()" style="flex: 1;">Vytvo≈ôit p≈ôipom√≠nku</button>
                        <button class="btn" style="background: #475569; flex: 1;" onclick="loadReminders()">Zru≈°it</button>
                    </div>
                </div>
            `;
            
            const container = document.getElementById('remindersContainer');
            if (container) {
                container.innerHTML = formHtml;
            }
        }
        
        // Vytvo≈ôen√≠ p≈ôipom√≠nky
        async function handleCreateReminder() {
            const type = document.getElementById('reminderType').value;
            const vehicleId = document.getElementById('reminderVehicle').value;
            const text = document.getElementById('reminderText').value;
            const dueDate = document.getElementById('reminderDueDate').value;
            
            if (!text || !text.trim()) {
                showAlert('Zadejte text p≈ôipom√≠nky', 'error');
                return;
            }
            
            const reminderData = {
                type: type,
                vehicle_id: vehicleId ? parseInt(vehicleId) : null,
                text: text.trim(),
                due_date: dueDate || null
            };
            
            try {
                showAlert('Vytv√°≈ô√≠m p≈ôipom√≠nku...', 'info');
                await apiCall('/api/v1/reminders', 'POST', reminderData);
                showAlert('P≈ôipom√≠nka byla √∫spƒõ≈°nƒõ vytvo≈ôena!', 'success');
                await loadReminders();
            } catch (error) {
                console.error('Error creating reminder:', error);
                showAlert('Nepoda≈ôilo se vytvo≈ôit p≈ôipom√≠nku: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
            }
        }
        
        // ============= NASTAVEN√ç EMAIL UPOZORNƒöN√ç =============
        
        // Toggle panelu nastaven√≠
        function toggleReminderSettings() {
            const panel = document.getElementById('reminderSettingsPanel');
            const toggle = document.getElementById('reminderSettingsToggle');
            if (panel && toggle) {
                if (panel.style.display === 'none') {
                    panel.style.display = 'block';
                    toggle.textContent = '‚ñ≤';
                    loadReminderSettings(); // Naƒç√≠st aktu√°ln√≠ nastaven√≠
                } else {
                    panel.style.display = 'none';
                    toggle.textContent = '‚ñº';
                }
            }
        }
        
        // Naƒçten√≠ nastaven√≠ p≈ôipom√≠nek z API
        async function loadReminderSettings() {
            try {
                const settings = await apiCall('/api/v1/reminders/settings', 'GET');
                
                if (settings && settings.notification) {
                    const methodSelect = document.getElementById('notificationMethod');
                    const daysInput = document.getElementById('notifyDaysBefore');
                    
                    if (methodSelect) {
                        methodSelect.value = settings.notification.notification_method || 'email';
                    }
                    if (daysInput) {
                        daysInput.value = settings.notification.notify_days_before || 7;
                    }
                }
            } catch (error) {
                console.error('Error loading reminder settings:', error);
                // Pou≈æ√≠t v√Ωchoz√≠ hodnoty
                const methodSelect = document.getElementById('notificationMethod');
                const daysInput = document.getElementById('notifyDaysBefore');
                if (methodSelect) methodSelect.value = 'email';
                if (daysInput) daysInput.value = 7;
            }
        }
        
        // Ulo≈æen√≠ nastaven√≠ p≈ôipom√≠nek
        async function handleSaveReminderSettings(event) {
            event.preventDefault();
            
            const methodSelect = document.getElementById('notificationMethod');
            const daysInput = document.getElementById('notifyDaysBefore');
            
            if (!methodSelect || !daysInput) {
                showAlert('Chyba: Formul√°≈ô nen√≠ spr√°vnƒõ naƒçten', 'error');
                return;
            }
            
            const notificationMethod = methodSelect.value;
            const notifyDaysBefore = parseInt(daysInput.value) || 7;
            
            if (notifyDaysBefore < 0 || notifyDaysBefore > 365) {
                showAlert('Poƒçet dn√≠ mus√≠ b√Ωt mezi 0 a 365', 'error');
                return;
            }
            
            try {
                showAlert('Ukl√°d√°m nastaven√≠...', 'info');
                
                // Nejd≈ô√≠v naƒç√≠st aktu√°ln√≠ nastaven√≠
                let currentSettings = {};
                try {
                    currentSettings = await apiCall('/api/v1/reminders/settings', 'GET');
                } catch (error) {
                    console.warn('Could not load current settings, using defaults:', error);
                }
                
                // Aktualizovat pouze notification ƒç√°st
                const settingsToUpdate = {
                    notification: {
                        notification_method: notificationMethod,
                        notify_days_before: notifyDaysBefore
                    }
                };
                
                // Pokud m√°me dal≈°√≠ nastaven√≠, zachovat je
                if (currentSettings) {
                    settingsToUpdate.enabled = currentSettings.enabled !== undefined ? currentSettings.enabled : true;
                    if (currentSettings.stk) settingsToUpdate.stk = currentSettings.stk;
                    if (currentSettings.oil) settingsToUpdate.oil = currentSettings.oil;
                    if (currentSettings.general) settingsToUpdate.general = currentSettings.general;
                    if (currentSettings.service_categories) settingsToUpdate.service_categories = currentSettings.service_categories;
                }
                
                await apiCall('/api/v1/reminders/settings', 'PUT', settingsToUpdate);
                showAlert('Nastaven√≠ bylo √∫spƒõ≈°nƒõ ulo≈æeno! ‚úÖ', 'success');
                
                // Poƒçkat chv√≠li a znovu naƒç√≠st nastaven√≠ pro ovƒõ≈ôen√≠
                setTimeout(() => {
                    loadReminderSettings();
                }, 500);
                
            } catch (error) {
                console.error('Error saving reminder settings:', error);
                showAlert('Nepoda≈ôilo se ulo≈æit nastaven√≠: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
            }
        }
        
        // Nastaven√≠ event listener≈Ø pro tlaƒç√≠tka nastaven√≠ p≈ôipom√≠nek (vol√° se po vlo≈æen√≠ HTML)
        function setupReminderSettingsEventListeners() {
            console.log('[REMINDER SETTINGS] Nastavuji event listenery...');
            
            // Tlaƒç√≠tko "Ulo≈æit nastaven√≠"
            const saveBtn = document.getElementById('saveReminderSettingsBtn');
            if (saveBtn) {
                console.log('[REMINDER SETTINGS] Nalezeno tlaƒç√≠tko Ulo≈æit');
                // Odstranit v≈°echny existuj√≠c√≠ listenery klonov√°n√≠m
                const newSaveBtn = saveBtn.cloneNode(true);
                saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
                
                newSaveBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[REMINDER SETTINGS] Kliknut√≠ na Ulo≈æit nastaven√≠');
                    await handleSaveReminderSettings(e);
                });
            } else {
                console.warn('[REMINDER SETTINGS] Tlaƒç√≠tko Ulo≈æit nenalezeno!');
            }
            
            // Tlaƒç√≠tko "Obnovit"
            const refreshBtn = document.getElementById('refreshReminderSettingsBtn');
            if (refreshBtn) {
                console.log('[REMINDER SETTINGS] Nalezeno tlaƒç√≠tko Obnovit');
                // Odstranit v≈°echny existuj√≠c√≠ listenery klonov√°n√≠m
                const newRefreshBtn = refreshBtn.cloneNode(true);
                refreshBtn.parentNode.replaceChild(newRefreshBtn, refreshBtn);
                
                newRefreshBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[REMINDER SETTINGS] Kliknut√≠ na Obnovit');
                    await loadReminderSettings();
                    showAlert('Nastaven√≠ obnoveno', 'success');
                });
            } else {
                console.warn('[REMINDER SETTINGS] Tlaƒç√≠tko Obnovit nenalezeno!');
            }
            
            // Formul√°≈ô submit
            const form = document.getElementById('reminderSettingsForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[REMINDER SETTINGS] Submit formul√°≈ôe');
                    await handleSaveReminderSettings(e);
                });
            }
            
            // Header pro toggle
            const header = document.getElementById('reminderSettingsHeader');
            if (header) {
                header.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log('[REMINDER SETTINGS] Kliknut√≠ na header');
                    toggleReminderSettings();
                });
            } else {
                // Fallback - naj√≠t p≈ôes toggle element
                const toggle = document.getElementById('reminderSettingsToggle');
                if (toggle && toggle.parentElement) {
                    toggle.parentElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleReminderSettings();
                    });
                }
            }
        }
        
        // Editace p≈ôipom√≠nky
        async function editReminder(reminderId) {
            // Naƒç√≠st aktu√°ln√≠ p≈ôipom√≠nku
            try {
                const reminders = await apiCall('/api/v1/reminders', 'GET');
                const reminder = reminders.find(r => r.id === reminderId);
                
                if (!reminder) {
                    showAlert('P≈ôipom√≠nka nenalezena', 'error');
                    return;
                }
                
                // Naƒç√≠st vozidla
                let vehicles = [];
                try {
                    vehicles = await apiCall('/api/v1/vehicles', 'GET');
                } catch (error) {
                    console.error('Error loading vehicles:', error);
                }
                
                const formHtml = `
                    <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; max-width: 600px; margin: 0 auto;">
                        <h2 style="color: #e5e7eb; margin-bottom: 20px; text-align: center;">Upravit p≈ôipom√≠nku</h2>
                        
                        <div class="form-group">
                            <label for="editReminderType" style="color: #9ca3af;">Typ p≈ôipom√≠nky *:</label>
                            <select id="editReminderType" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                                <option value="VLASTNI" ${reminder.type === 'VLASTNI' ? 'selected' : ''}>Vlastn√≠</option>
                                <option value="STK" ${reminder.type === 'STK' ? 'selected' : ''}>STK</option>
                                <option value="OLEJ" ${reminder.type === 'OLEJ' ? 'selected' : ''}>Olej</option>
                                <option value="SERVIS" ${reminder.type === 'SERVIS' ? 'selected' : ''}>Servis</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="editReminderVehicle" style="color: #9ca3af;">Vozidlo (voliteln√©):</label>
                            <select id="editReminderVehicle" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                                <option value="">Obecn√° p≈ôipom√≠nka</option>
                                ${vehicles.map(v => `<option value="${v.id}" ${reminder.vehicle_id === v.id ? 'selected' : ''}>${v.nickname || v.plate || 'Bez n√°zvu'} - ${v.plate || 'Bez SPZ'}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="editReminderText" style="color: #9ca3af;">Text p≈ôipom√≠nky *:</label>
                            <textarea id="editReminderText" rows="3" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; font-family: inherit;" required>${reminder.text || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="editReminderDueDate" style="color: #9ca3af;">Datum (voliteln√©):</label>
                            <input type="date" id="editReminderDueDate" value="${dueDateValue}" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                        </div>
                        
                        <div class="form-group">
                            <label style="color: #9ca3af; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="editReminderCompleted" ${reminder.is_completed ? 'checked' : ''} style="width: 20px; height: 20px;">
                                Dokonƒçeno
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn" onclick="handleUpdateReminder(${reminderId})" style="flex: 1;">Ulo≈æit zmƒõny</button>
                            <button class="btn" style="background: #475569; flex: 1;" onclick="loadReminders()">Zru≈°it</button>
                        </div>
                    </div>
                `;
                
                const container = document.getElementById('remindersContainer');
                if (container) {
                    container.innerHTML = formHtml;
                }
            } catch (error) {
                console.error('Error loading reminder:', error);
                showAlert('Nepoda≈ôilo se naƒç√≠st p≈ôipom√≠nku: ' + error.message, 'error');
            }
        }
        
        // Aktualizace p≈ôipom√≠nky
        async function handleUpdateReminder(reminderId) {
            const type = document.getElementById('editReminderType').value;
            const vehicleId = document.getElementById('editReminderVehicle').value;
            const text = document.getElementById('editReminderText').value;
            const dueDate = document.getElementById('editReminderDueDate').value;
            const isCompleted = document.getElementById('editReminderCompleted').checked;
            
            if (!text || !text.trim()) {
                showAlert('Zadejte text p≈ôipom√≠nky', 'error');
                return;
            }
            
            const reminderData = {
                type: type,
                vehicle_id: vehicleId ? parseInt(vehicleId) : null,
                text: text.trim(),
                due_date: dueDate || null,
                is_completed: isCompleted
            };
            
            try {
                showAlert('Ukl√°d√°m zmƒõny...', 'info');
                await apiCall(`/api/v1/reminders/${reminderId}`, 'PUT', reminderData);
                showAlert('P≈ôipom√≠nka byla √∫spƒõ≈°nƒõ aktualizov√°na!', 'success');
                await loadReminders();
            } catch (error) {
                console.error('Error updating reminder:', error);
                showAlert('Nepoda≈ôilo se aktualizovat p≈ôipom√≠nku: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
            }
        }
        
        // Smaz√°n√≠ p≈ôipom√≠nky
        async function deleteReminder(reminderId) {
            if (!confirm('Opravdu chcete smazat tuto p≈ôipom√≠nku?')) {
                return;
            }
            
            try {
                await apiCall(`/api/v1/reminders/${reminderId}`, 'DELETE');
                showAlert('P≈ôipom√≠nka byla smaz√°na', 'success');
                await loadReminders();
            } catch (error) {
                console.error('Error deleting reminder:', error);
                showAlert('Nepoda≈ôilo se smazat p≈ôipom√≠nku: ' + error.message, 'error');
            }
        }

        // Naƒç√≠t√°n√≠ rezervac√≠ (v1.0)
        async function loadReservations() {
            const container = document.getElementById('reservationsContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">Naƒç√≠t√°m rezervace...</div>';
            
            try {
                const reservations = await apiCall('/api/v1/reservations/my', 'GET');
                
                if (!reservations || reservations.length === 0) {
                    container.innerHTML = `
                        <p style="text-align: center; color: #9ca3af; padding: 40px;">Nem√°te ≈æ√°dn√© rezervace. Vytvo≈ôte novou pomoc√≠ tlaƒç√≠tka n√≠≈æe.</p>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn" onclick="showCreateReservationForm()">Vytvo≈ôit novou rezervaci</button>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
                
                reservations.forEach(reservation => {
                    const statusColors = {
                        'PENDING': '#f59e0b',
                        'CONFIRMED': '#10b981',
                        'CANCELLED': '#ef4444'
                    };
                    const statusLabels = {
                        'PENDING': 'ƒåek√° na potvrzen√≠',
                        'CONFIRMED': 'Potvrzeno',
                        'CANCELLED': 'Zru≈°eno'
                    };
                    const statusColor = statusColors[reservation.status] || '#9ca3af';
                    const statusLabel = statusLabels[reservation.status] || reservation.status;
                    
                    const startDate = new Date(reservation.start_datetime);
                    const endDate = reservation.end_datetime ? new Date(reservation.end_datetime) : null;
                    
                    html += `
                        <div style="background: rgba(30, 41, 59, 0.8); padding: 20px; border-radius: 12px; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <strong style="color: #e5e7eb; font-size: 16px;">${reservation.service_type || 'Servis'}</strong>
                                    <div style="color: #9ca3af; margin-top: 5px;">
                                        üìÖ ${startDate.toLocaleDateString('cs-CZ')} ${startDate.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' })}
                                        ${endDate ? ` - ${endDate.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' })}` : ''}
                                    </div>
                                </div>
                                <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    ${statusLabel}
                                </span>
                            </div>
                            ${reservation.note ? `
                                <div style="color: #9ca3af; margin-bottom: 10px;">
                                    ${reservation.note}
                                </div>
                            ` : ''}
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <button class="btn" style="padding: 6px 12px; font-size: 12px; width: auto; background: #475569;" onclick="switchTab('vehicles'); showVehicleDetail(${reservation.vehicle_id})">
                                    Zobrazit vozidlo
                                </button>
                                ${reservation.status === 'PENDING' ? `
                                    <button class="btn" style="padding: 6px 12px; font-size: 12px; width: auto; background: #ef4444;" onclick="cancelReservation(${reservation.id})">
                                        Zru≈°it rezervaci
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                // P≈ôidat tlaƒç√≠tko pro vytvo≈ôen√≠ rezervace
                html += `
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn" onclick="showCreateReservationForm()">Vytvo≈ôit novou rezervaci</button>
                    </div>
                `;
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading reservations:', error);
                container.innerHTML = `
                    <p style="color: #ef4444;">Chyba p≈ôi naƒç√≠t√°n√≠ rezervac√≠: ${error.message}</p>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn" onclick="showCreateReservationForm()">Vytvo≈ôit novou rezervaci</button>
                    </div>
                `;
            }
        }

        // Zobrazen√≠ formul√°≈ôe pro vytvo≈ôen√≠ rezervace
        async function showCreateReservationForm() {
            // Naƒç√≠st vozidla u≈æivatele
            let vehicles = [];
            try {
                vehicles = await apiCall('/api/v1/vehicles', 'GET');
            } catch (error) {
                console.error('Error loading vehicles:', error);
                showAlert('Nepoda≈ôilo se naƒç√≠st vozidla: ' + error.message, 'error');
                return;
            }
            
            if (!vehicles || vehicles.length === 0) {
                showAlert('Nem√°te ≈æ√°dn√° vozidla. Nejd≈ô√≠ve p≈ôidejte vozidlo.', 'error');
                switchTab('addVehicle');
                return;
            }
            
            // Naƒç√≠st seznam dostupn√Ωch servis≈Ø
            let services = [];
            try {
                services = await apiCall('/api/v1/services', 'GET');
            } catch (error) {
                console.error('Error loading services:', error);
                showAlert('Nepoda≈ôilo se naƒç√≠st seznam servis≈Ø: ' + error.message, 'error');
                return;
            }
            
            if (!services || services.length === 0) {
                showAlert('Nen√≠ k dispozici ≈æ√°dn√Ω servis. Kontaktujte administr√°tora.', 'error');
                return;
            }
            
            // Vytvo≈ôit HTML formul√°≈ôe
            const formHtml = `
                <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; max-width: 600px; margin: 0 auto;">
                    <h2 style="color: #e5e7eb; margin-bottom: 20px; text-align: center;">Nov√° rezervace</h2>
                    
                    <div class="form-group">
                        <label for="reservationVehicle" style="color: #9ca3af;">Vozidlo *:</label>
                        <select id="reservationVehicle" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                            <option value="">Vyberte vozidlo...</option>
                            ${vehicles.map(v => `<option value="${v.id}">${v.nickname || v.plate || 'Bez n√°zvu'} - ${v.plate || 'Bez SPZ'}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationServiceId" style="color: #9ca3af;">Servis *:</label>
                        <select id="reservationServiceId" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                            <option value="">Vyberte servis...</option>
                            ${services.map(s => `<option value="${s.id}">${s.name || s.email}${s.city ? ' - ' + s.city : ''}${s.phone ? ' (' + s.phone + ')' : ''}</option>`).join('')}
                        </select>
                        <small style="color: #6b7280; font-size: 0.85em; display: block; margin-top: 5px;">Vyberte servis, kter√Ω bude m√≠t spr√°vu pro va≈°e vozidlo</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationServiceType" style="color: #9ca3af;">Typ servisu:</label>
                        <input type="text" id="reservationServiceType" placeholder="Nap≈ô. Pravideln√Ω servis, STK, Oprava..." style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationStartDate" style="color: #9ca3af;">Datum a ƒças zaƒç√°tku *:</label>
                        <input type="date" id="reservationStartDate" style="width: 48%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; margin-right: 4%;" required>
                        <input type="time" id="reservationStartTime" style="width: 48%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationEndDate" style="color: #9ca3af;">Datum a ƒças konce (voliteln√©):</label>
                        <input type="date" id="reservationEndDate" style="width: 48%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; margin-right: 4%;">
                        <input type="time" id="reservationEndTime" style="width: 48%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationNote" style="color: #9ca3af;">Pozn√°mka:</label>
                        <textarea id="reservationNote" placeholder="Dal≈°√≠ informace o rezervaci..." rows="3" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; font-family: inherit;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="handleCreateReservation()" style="flex: 1;">Vytvo≈ôit rezervaci</button>
                        <button class="btn" style="background: #475569; flex: 1;" onclick="closeReservationForm()">Zru≈°it</button>
                    </div>
                </div>
            `;
            
            // Zobrazit formul√°≈ô v kontejneru rezervac√≠
            const container = document.getElementById('reservationsContainer');
            if (container) {
                console.log('[RESERVATION] Zobrazuji formul√°≈ô v kontejneru');
                container.innerHTML = formHtml;
                
                // P≈ôidat event listener pro automatick√© p≈ôedvyplnƒõn√≠ servisu p≈ôi v√Ωbƒõru vozidla
                const vehicleSelect = document.getElementById('reservationVehicle');
                const serviceSelect = document.getElementById('reservationServiceId');
                
                if (vehicleSelect && serviceSelect) {
                    vehicleSelect.addEventListener('change', function() {
                        const selectedOption = vehicleSelect.options[vehicleSelect.selectedIndex];
                        const assignedServiceId = selectedOption.getAttribute('data-service-id');
                        
                        if (assignedServiceId && assignedServiceId !== '') {
                            // Automaticky p≈ôedvyplnit servis podle p≈ôi≈ôazen√©ho servisu vozidla
                            serviceSelect.value = assignedServiceId;
                            console.log('[RESERVATION] Automaticky p≈ôedvyplnƒõn servis:', assignedServiceId);
                        }
                    });
                }
            } else {
                console.error('[RESERVATION] Chyba: Kontejner reservationsContainer nenalezen!');
                showAlert('Kontejner pro rezervace nenalezen', 'error');
            }
        }
        
        // Zav≈ôen√≠ formul√°≈ôe
        function closeReservationForm() {
            loadReservations();
        }
        
        // Vytvo≈ôen√≠ rezervace
        async function handleCreateReservation() {
            const vehicleId = document.getElementById('reservationVehicle').value;
            const serviceId = document.getElementById('reservationServiceId').value;
            const serviceType = document.getElementById('reservationServiceType').value;
            const startDate = document.getElementById('reservationStartDate').value;
            const startTime = document.getElementById('reservationStartTime').value;
            const endDate = document.getElementById('reservationEndDate').value;
            const endTime = document.getElementById('reservationEndTime').value;
            const note = document.getElementById('reservationNote').value;
            
            // Validace
            if (!vehicleId) {
                showAlert('Vyberte vozidlo', 'error');
                return;
            }
            
            if (!serviceId) {
                showAlert('Zadejte ID servisu', 'error');
                return;
            }
            
            if (!startDate || !startTime) {
                showAlert('Zadejte datum a ƒças zaƒç√°tku', 'error');
                return;
            }
            
            // Vytvo≈ôit datetime string
            const startDatetime = new Date(`${startDate}T${startTime}:00`);
            let endDatetime = null;
            
            if (endDate && endTime) {
                endDatetime = new Date(`${endDate}T${endTime}:00`);
            }
            
            // Validace, ≈æe konec je po zaƒç√°tku
            if (endDatetime && endDatetime <= startDatetime) {
                showAlert('Datum a ƒças konce mus√≠ b√Ωt po zaƒç√°tku', 'error');
                return;
            }
            
            // P≈ôipravit data
            const reservationData = {
                service_id: parseInt(serviceId),
                vehicle_id: parseInt(vehicleId),
                service_type: serviceType || null,
                note: note || null,
                start_datetime: startDatetime.toISOString(),
                end_datetime: endDatetime ? endDatetime.toISOString() : null
            };
            
            try {
                showAlert('Vytv√°≈ô√≠m rezervaci...', 'info');
                const response = await apiCall('/api/v1/reservations', 'POST', reservationData);
                showAlert('Rezervace byla √∫spƒõ≈°nƒõ vytvo≈ôena!', 'success');
                
                // Naƒç√≠st rezervace znovu
                await loadReservations();
            } catch (error) {
                console.error('Error creating reservation:', error);
                showAlert('Nepoda≈ôilo se vytvo≈ôit rezervaci: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
            }
        }

        // Zru≈°en√≠ rezervace
        async function cancelReservation(reservationId) {
            if (!confirm('Opravdu chcete zru≈°it tuto rezervaci?')) {
                return;
            }
            
            try {
                await apiCall(`/api/v1/reservations/${reservationId}`, 'PUT', {
                    status: 'CANCELLED'
                });
                showAlert('Rezervace byla zru≈°ena', 'success');
                await loadReservations();
            } catch (error) {
                console.error('Error cancelling reservation:', error);
                showAlert('Nepoda≈ôilo se zru≈°it rezervaci: ' + error.message, 'error');
            }
        }

        // ============= PROFIL =============
        
        // Naƒçten√≠ profilu
        async function loadProfile() {
            const container = document.getElementById('profileContainer');
            if (!container) {
                console.error('[PROFILE] Kontejner profileContainer nenalezen!');
                return;
            }
            
            try {
                container.innerHTML = '<div class="loading">Naƒç√≠t√°m profil...</div>';
                const profile = await apiCall('/user/me');
                
                // Naƒçten√≠ verze aplikace
                loadVersionInfo();
                
                container.innerHTML = `
                    <div style="max-width: 800px;">
                        <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.2);">
                            <h3 style="color: #e5e7eb; margin-top: 0; margin-bottom: 25px;">üìù Z√°kladn√≠ √∫daje</h3>
                            <form id="profileForm" onsubmit="handleSaveProfile(event); return false;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="profileEmail">Email:</label>
                                        <input type="email" id="profileEmail" value="${profile.email || ''}" disabled style="background: rgba(0,0,0,0.3); color: #9ca3af;">
                                        <small style="color: #9ca3af;">Email nelze zmƒõnit</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="profileName">Jm√©no / N√°zev:</label>
                                        <input type="text" id="profileName" value="${profile.name || ''}" placeholder="Va≈°e jm√©no nebo n√°zev firmy">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="profileIco">IƒåO:</label>
                                        <input type="text" id="profileIco" value="${profile.ico || ''}" placeholder="8 ƒç√≠slic">
                                    </div>
                                    <div class="form-group">
                                        <label for="profileDic">DIƒå:</label>
                                        <input type="text" id="profileDic" value="${profile.dic || ''}" placeholder="Da≈àov√© identifikaƒçn√≠ ƒç√≠slo">
                                    </div>
                                </div>
                                
                                <h3 style="color: #e5e7eb; margin-top: 30px; margin-bottom: 25px;">üìç Kontaktn√≠ √∫daje</h3>
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label for="profileStreet">Ulice:</label>
                                        <input type="text" id="profileStreet" value="${profile.street || ''}" placeholder="N√°zev ulice">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label for="profileStreetNumber">ƒå√≠slo popisn√©:</label>
                                        <input type="text" id="profileStreetNumber" value="${profile.street_number || ''}" placeholder="ƒå.p.">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="profileCity">Mƒõsto:</label>
                                        <input type="text" id="profileCity" value="${profile.city || ''}" placeholder="Mƒõsto">
                                    </div>
                                    <div class="form-group">
                                        <label for="profileZip">PSƒå:</label>
                                        <input type="text" id="profileZip" value="${profile.zip || ''}" placeholder="123 45">
                                    </div>
                                    <div class="form-group">
                                        <label for="profilePhone">Telefon:</label>
                                        <input type="text" id="profilePhone" value="${profile.phone || ''}" placeholder="+420 123 456 789">
                                    </div>
                                </div>
                                
                                <h3 style="color: #e5e7eb; margin-top: 30px; margin-bottom: 25px;">üîî Nastaven√≠ notifikac√≠</h3>
                                
                                <div style="display: flex; flex-direction: column; gap: 15px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="profileNotifyEmail" ${profile.notify_email ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                                        <span style="color: #e5e7eb;">Emailov√© notifikace</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="profileNotifySms" ${profile.notify_sms ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                                        <span style="color: #e5e7eb;">SMS notifikace</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="profileNotifyStk" ${profile.notify_stk ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                                        <span style="color: #e5e7eb;">P≈ôipom√≠nky STK</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="profileNotifyOil" ${profile.notify_oil ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                                        <span style="color: #e5e7eb;">P≈ôipom√≠nky v√Ωmƒõny oleje</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="profileNotifyGeneral" ${profile.notify_general ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                                        <span style="color: #e5e7eb;">Obecn√© servisn√≠ p≈ôipom√≠nky</span>
                                    </label>
                                </div>
                                
                                <div style="margin-top: 30px; display: flex; gap: 15px;">
                                    <button type="submit" class="btn" style="flex: 1;">üíæ Ulo≈æit zmƒõny</button>
                                    <button type="button" class="btn" style="background: #475569; flex: 1;" onclick="showChangePasswordForm()">üîê Zmƒõnit heslo</button>
                                </div>
                                
                                <div id="versionInfo" style="margin-top: 30px; padding-top: 30px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                                    <p style="color: #6b7280; font-size: 0.55em !important; text-align: center; margin: 0; opacity: 0.5;">
                                        <span id="versionText">Naƒç√≠t√°m verzi...</span>
                                    </p>
                                </div>
                                
                                <div id="profileErrorContainer" style="margin-top: 20px; min-height: 20px;"></div>
                            </form>
                        </div>
                    </div>
                    
                    <div id="changePasswordForm" style="display: none; margin-top: 30px;">
                        <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.2);">
                            <h3 style="color: #e5e7eb; margin-top: 0; margin-bottom: 25px;">üîê Zmƒõna hesla</h3>
                            <form id="changePasswordFormContent" onsubmit="handleChangePassword(event); return false;">
                                <div class="form-group full-width">
                                    <label for="currentPassword">Souƒçasn√© heslo:</label>
                                    <input type="password" id="currentPassword" required minlength="6">
                                </div>
                                <div class="form-group full-width">
                                    <label for="newPassword">Nov√© heslo:</label>
                                    <input type="password" id="newPassword" required minlength="6" placeholder="Minim√°lnƒõ 6 znak≈Ø">
                                </div>
                                <div class="form-group full-width">
                                    <label for="confirmNewPassword">Potvrzen√≠ nov√©ho hesla:</label>
                                    <input type="password" id="confirmNewPassword" required minlength="6">
                                </div>
                                <div style="display: flex; gap: 15px; margin-top: 20px;">
                                    <button type="submit" class="btn" style="flex: 1;">Zmƒõnit heslo</button>
                                    <button type="button" class="btn" style="background: #475569; flex: 1;" onclick="hideChangePasswordForm()">Zru≈°it</button>
                                </div>
                                <div id="changePasswordErrorContainer" style="margin-top: 20px; min-height: 20px;"></div>
                            </form>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('[PROFILE] Chyba p≈ôi naƒç√≠t√°n√≠ profilu:', error);
                container.innerHTML = `<div class="alert alert-error">Nepoda≈ôilo se naƒç√≠st profil: ${error.message}</div>`;
            }
        }
        
        // Ulo≈æen√≠ profilu
        async function handleSaveProfile(event) {
            event.preventDefault();
            const errorContainer = document.getElementById('profileErrorContainer');
            
            try {
                const updateData = {
                    name: document.getElementById('profileName').value.trim() || null,
                    ico: document.getElementById('profileIco').value.trim() || null,
                    dic: document.getElementById('profileDic').value.trim() || null,
                    street: document.getElementById('profileStreet').value.trim() || null,
                    street_number: document.getElementById('profileStreetNumber').value.trim() || null,
                    city: document.getElementById('profileCity').value.trim() || null,
                    zip: document.getElementById('profileZip').value.trim() || null,
                    phone: document.getElementById('profilePhone').value.trim() || null,
                    notify_email: document.getElementById('profileNotifyEmail').checked,
                    notify_sms: document.getElementById('profileNotifySms').checked,
                    notify_stk: document.getElementById('profileNotifyStk').checked,
                    notify_oil: document.getElementById('profileNotifyOil').checked,
                    notify_general: document.getElementById('profileNotifyGeneral').checked
                };
                
                // Validace IƒåO (pokud je zad√°no, mus√≠ b√Ωt 8 ƒç√≠slic)
                if (updateData.ico && (!/^\d{8}$/.test(updateData.ico))) {
                    showFormError('profileErrorContainer', 'IƒåO mus√≠ obsahovat p≈ôesnƒõ 8 ƒç√≠slic');
                    return;
                }
                
                await apiCall('/user/me', 'PUT', updateData);
                showFormError('profileErrorContainer', '');
                showAlert('Profil byl √∫spƒõ≈°nƒõ aktualizov√°n', 'success');
                
                // Znovu naƒç√≠st profil pro zobrazen√≠ aktualizovan√Ωch dat
                await loadProfile();
            } catch (error) {
                console.error('[PROFILE] Chyba p≈ôi ukl√°d√°n√≠ profilu:', error);
                showFormError('profileErrorContainer', 'Nepoda≈ôilo se ulo≈æit zmƒõny: ' + error.message);
            }
        }
        
        // Zobrazen√≠ formul√°≈ôe pro zmƒõnu hesla
        function showChangePasswordForm() {
            const form = document.getElementById('changePasswordForm');
            if (form) {
                form.style.display = 'block';
                form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        // Skryt√≠ formul√°≈ôe pro zmƒõnu hesla
        function hideChangePasswordForm() {
            const form = document.getElementById('changePasswordForm');
            if (form) {
                form.style.display = 'none';
                document.getElementById('changePasswordFormContent').reset();
                const errorContainer = document.getElementById('changePasswordErrorContainer');
                if (errorContainer) {
                    errorContainer.innerHTML = '';
                }
            }
        }
        
        // Zmƒõna hesla
        async function handleChangePassword(event) {
            event.preventDefault();
            const errorContainer = document.getElementById('changePasswordErrorContainer');
            const button = event.target.querySelector('button[type="submit"]');
            const originalButtonText = button ? button.textContent : 'Zmƒõnit heslo';
            
            try {
                // Disable tlaƒç√≠tka
                if (button) {
                    button.disabled = true;
                    button.textContent = 'Mƒõn√≠m heslo...';
                }
                
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmNewPassword').value;
                
                // Validace
                if (!currentPassword) {
                    showFormError('changePasswordErrorContainer', 'Zadejte souƒçasn√© heslo');
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalButtonText;
                    }
                    return;
                }
                
                if (!newPassword || newPassword.length < 6) {
                    showFormError('changePasswordErrorContainer', 'Nov√© heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø');
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalButtonText;
                    }
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showFormError('changePasswordErrorContainer', 'Hesla se neshoduj√≠');
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalButtonText;
                    }
                    return;
                }
                
                const response = await apiCall('/user/change-password', 'PUT', {
                    current_password: currentPassword,
                    new_password: newPassword
                });
                
                // Zobrazit √∫spƒõ≈°nou zpr√°vu
                showFormError('changePasswordErrorContainer', '');
                
                let successMessage = 'Heslo bylo √∫spƒõ≈°nƒõ zmƒõnƒõno';
                if (response.email_sent) {
                    successMessage += ' a potvrzovac√≠ email byl odesl√°n na v√°≈° email';
                } else if (response.message && response.message.includes('email')) {
                    successMessage += '. ' + (response.message.includes('nen√≠ nakonfigurov√°n') ? 'Email nen√≠ nakonfigurov√°n.' : '');
                }
                
                showAlert(successMessage, 'success');
                
                // Vyƒçistit formul√°≈ô a schovat ho po 2 sekund√°ch
                document.getElementById('changePasswordFormContent').reset();
                setTimeout(() => {
                    hideChangePasswordForm();
                }, 2000);
                
            } catch (error) {
                console.error('[PROFILE] Chyba p≈ôi zmƒõnƒõ hesla:', error);
                showFormError('changePasswordErrorContainer', 'Nepoda≈ôilo se zmƒõnit heslo: ' + error.message);
            } finally {
                // Re-enable tlaƒç√≠tka
                if (button) {
                    button.disabled = false;
                    button.textContent = originalButtonText;
                }
            }
        }

        // ============= VERZE APLIKACE =============
        
        // Naƒçten√≠ informac√≠ o verzi
        async function loadVersionInfo() {
            const versionElement = document.getElementById('versionText');
            if (!versionElement) return;
            
            try {
                const versionInfo = await apiCall('/version');
                if (versionInfo && versionInfo.version) {
                    versionElement.textContent = `TooZ Hub 2 ‚Äì verze ${versionInfo.version}`;
                } else {
                    versionElement.textContent = 'TooZ Hub 2';
                }
            } catch (error) {
                console.error('[VERSION] Chyba p≈ôi naƒç√≠t√°n√≠ verze:', error);
                versionElement.textContent = 'TooZ Hub 2';
            }
        }
        
        // Vyƒçistit interval p≈ôi opu≈°tƒõn√≠ str√°nky
        window.addEventListener('beforeunload', () => {
            if (serverStatusCheckInterval) {
                clearInterval(serverStatusCheckInterval);
            }
        });
    </script>
</body>
</html>

<!-- Test zmƒõna -->
<!-- Test automatick√© aktualizace Po¬†24.¬†listopadu¬†2025,¬†08:44:37¬†CET -->
<!-- Test 1763970302 -->
<!-- test --><!-- Test 1763970358 -->
<!-- Test zmƒõna pro automatickou aktualizaci -->
