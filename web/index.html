<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TooZ Hub 2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .auth-section {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
            resize: vertical;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Kompaktn√≠ formul√°≈ô s grid layoutem - 2 sloupce */
        .form-compact {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .form-compact .form-group {
            margin-bottom: 0;
        }

        .form-compact .form-group.full-width {
            grid-column: 1 / -1;
        }

        /* VIN p≈ôes celou ≈°√≠≈ôku */
        .form-compact .form-group:nth-child(1) {
            grid-column: 1 / -1;
        }

        /* Pozn√°mky p≈ôes celou ≈°√≠≈ôku (nyn√≠ 9. pole kv≈Øli k√≥du motoru) */
        .form-compact .form-group:nth-child(9) {
            grid-column: 1 / -1;
        }

        /* Na mal√Ωch obrazovk√°ch 1 sloupec */
        @media (max-width: 768px) {
            .form-compact {
                grid-template-columns: 1fr;
            }
        }

        /* Kompaktnƒõj≈°√≠ inputy v formul√°≈ôi pro vozidla */
        #addVehicleTab {
            padding: 15px;
        }

        #addVehicleTab .form-group label {
            font-size: 11px;
            margin-bottom: 2px;
            font-weight: 500;
        }

        #addVehicleTab .form-group input,
        #addVehicleTab .form-group textarea {
            padding: 5px 8px;
            font-size: 12px;
            border-width: 1px;
        }

        #addVehicleTab h2 {
            font-size: 1.2em;
            margin-bottom: 12px;
            margin-top: 0;
        }

        #addVehicleTab .btn {
            padding: 7px 14px;
            font-size: 12px;
        }

        .btn {
            width: 100%;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .user-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vehicles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .vehicle-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .vehicle-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .vehicle-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .vehicle-card p {
            color: #666;
            margin: 5px 0;
        }

        .vehicle-card {
            cursor: pointer;
        }

        /* Detail vozidla */
        .vehicle-detail {
            display: none;
        }

        .vehicle-detail.active {
            display: block;
        }

        .vehicle-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .vehicle-detail-header h2 {
            margin: 0;
            color: #667eea;
        }

        .vehicle-detail-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .vehicle-detail-left, .vehicle-detail-right {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .vehicle-detail-left h3, .vehicle-detail-right h3 {
            margin-top: 0;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .vehicle-info-item {
            margin: 15px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .vehicle-info-item strong {
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        .vehicle-info-item span {
            color: #666;
        }

        .service-records-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .service-record-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .service-record-item h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .service-record-item .record-date {
            color: #999;
            font-size: 0.9em;
        }

        .service-record-item .record-details {
            margin-top: 10px;
            color: #666;
        }

        .service-record-item .record-price {
            font-weight: bold;
            color: #667eea;
            margin-top: 10px;
        }

        .add-service-form {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
        }

        .add-service-form h4 {
            margin-top: 0;
            color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row.full-width {
            grid-template-columns: 1fr;
        }

        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .back-button:hover {
            background: #5a6268;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: color 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .status-online {
            background: #51cf66 !important;
            animation: none !important;
        }

        .status-offline {
            background: #ff6b6b !important;
        }

        .status-checking {
            background: #ffd43b !important;
        }

        .api-url-config {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .api-url-config h3 {
            margin-top: 0;
            color: #856404;
        }

        .api-url-input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .api-url-input-group input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ffc107;
            border-radius: 6px;
            font-size: 14px;
        }

        .api-url-input-group button {
            padding: 10px 20px;
            background: #ffc107;
            color: #856404;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .api-url-input-group button:hover {
            background: #ffb300;
        }

        .config-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .config-button:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div>
                    <h1>üöó TooZ Hub 2</h1>
                    <p>Spr√°va vozidel a servisn√≠ch z√°znam≈Ø</p>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div id="serverStatus" style="display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 20px;">
                        <div id="statusIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #ff6b6b; animation: pulse 2s infinite;"></div>
                        <span id="statusText" style="font-size: 14px; font-weight: 600;">Kontroluji server...</span>
                    </div>
                    <button id="configButton" class="config-button hidden" onclick="showApiUrlConfig()" title="Nastavit API URL (pouze pro admina)">‚öôÔ∏è</button>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- Konfigurace API URL (pouze pro DEV) -->
            <div id="dev-api-url-panel" class="api-url-config hidden">
                <h3>üîß Nastaven√≠ API URL (DEV)</h3>
                <p style="margin: 10px 0; color: #856404;">
                    Pro lok√°ln√≠ v√Ωvoj m≈Ø≈æete nastavit vlastn√≠ API URL.
                    <br><strong>Postup:</strong>
                    <br>1. Zadejte URL va≈°eho API serveru (nap≈ô. http://127.0.0.1:8001)
                    <br>2. Kliknƒõte na "Ulo≈æit"
                </p>
                <div class="api-url-input-group">
                    <input type="text" id="apiUrlInput" placeholder="http://127.0.0.1:8001" value="">
                    <button onclick="saveApiUrl()">Ulo≈æit</button>
                    <button onclick="hideApiUrlConfig()" style="background: #6c757d; color: white;">Zav≈ô√≠t</button>
                </div>
                <p id="currentApiUrl" style="margin-top: 10px; font-size: 12px; color: #856404;"></p>
            </div>

            <!-- P≈ôihla≈°ovac√≠ sekce -->
            <div id="authSection" class="auth-section">
                <div id="alertContainer"></div>
                
                <div id="loginForm">
                    <h2 style="margin-bottom: 20px; text-align: center;">P≈ôihl√°≈°en√≠</h2>
                    <div class="form-group">
                        <label for="loginEmail">Email:</label>
                        <input type="email" id="loginEmail" placeholder="email@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Heslo:</label>
                        <input type="password" id="loginPassword" placeholder="Heslo" required>
                    </div>
                    <button class="btn" onclick="handleLogin()">P≈ôihl√°sit se</button>
                    <button class="btn btn-secondary" onclick="showRegister()">Registrace</button>
                </div>

                <div id="registerForm" class="hidden">
                    <h2 style="margin-bottom: 20px; text-align: center;">Registrace</h2>
                    <div class="form-group">
                        <label for="regEmail">Email:</label>
                        <input type="email" id="regEmail" placeholder="email@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="regPassword">Heslo:</label>
                        <input type="password" id="regPassword" placeholder="Heslo" required>
                    </div>
                    <div class="form-group">
                        <label for="regPasswordConfirm">Potvrzen√≠ hesla:</label>
                        <input type="password" id="regPasswordConfirm" placeholder="Potvrzen√≠ hesla" required>
                    </div>
                    <div class="form-group">
                        <label for="regIco">IƒåO:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="regIco" placeholder="12345678" maxlength="8" style="flex: 1;">
                            <button type="button" class="btn" onclick="loadAresData()" style="width: auto; padding: 12px 20px; white-space: nowrap;">Naƒç√≠st z ARES</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="regDic">DIƒå:</label>
                        <input type="text" id="regDic" placeholder="CZ12345678">
                    </div>
                    <div class="form-group">
                        <label for="regStreet">Ulice:</label>
                        <input type="text" id="regStreet" placeholder="N√°zev ulice">
                    </div>
                    <div class="form-group">
                        <label for="regStreetNumber">ƒå√≠slo popisn√©:</label>
                        <input type="text" id="regStreetNumber" placeholder="123">
                    </div>
                    <div class="form-group">
                        <label for="regCity">Mƒõsto:</label>
                        <input type="text" id="regCity" placeholder="Mƒõsto">
                    </div>
                    <div class="form-group">
                        <label for="regZip">PSƒå:</label>
                        <input type="text" id="regZip" placeholder="12345">
                    </div>
                    <div class="form-group">
                        <label for="regPhone">Telefon:</label>
                        <input type="text" id="regPhone" placeholder="+420 123 456 789">
                    </div>
                    <div class="form-group">
                        <label for="regName">N√°zev firmy:</label>
                        <input type="text" id="regName" placeholder="N√°zev firmy">
                    </div>
                    <button class="btn" onclick="handleRegister()">Registrovat</button>
                    <button class="btn btn-secondary" onclick="showLogin()">Zpƒõt na p≈ôihl√°≈°en√≠</button>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="dashboard">
                <div class="user-info">
                    <div>
                        <strong>P≈ôihl√°≈°en jako:</strong> <span id="userEmail"></span>
                    </div>
                    <button class="btn btn-secondary" onclick="handleLogout()" style="width: auto; padding: 8px 20px;">Odhl√°sit se</button>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchTab('vehicles')">Vozidla</button>
                    <button class="tab" onclick="switchTab('addVehicle')">P≈ôidat vozidlo</button>
                </div>

                <div id="vehiclesTab" class="tab-content active">
                    <div id="vehiclesList">
                        <h2>Moje vozidla</h2>
                        <div id="vehiclesContainer" class="loading">Naƒç√≠t√°m vozidla...</div>
                    </div>
                    
                    <!-- Detail vozidla -->
                    <div id="vehicleDetail" class="vehicle-detail">
                        <div class="vehicle-detail-header">
                            <h2 id="vehicleDetailTitle">Detail vozidla</h2>
                            <button class="back-button" onclick="showVehiclesList()">‚Üê Zpƒõt na seznam</button>
                        </div>
                        <div class="vehicle-detail-content">
                            <div class="vehicle-detail-left">
                                <h3>Data vozidla</h3>
                                <div id="vehicleDetailInfo"></div>
                            </div>
                            <div class="vehicle-detail-right">
                                <h3>Servisn√≠ √∫kony</h3>
                                <div id="serviceRecordsList" class="service-records-list"></div>
                                <div class="add-service-form">
                                    <h4>P≈ôidat nov√Ω servisn√≠ √∫kon</h4>
                                    <form id="addServiceForm" onsubmit="handleAddService(event)">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="serviceDate">Datum *:</label>
                                                <input type="datetime-local" id="serviceDate" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="serviceMileage">N√°jezd (km):</label>
                                                <input type="number" id="serviceMileage" min="0">
                                            </div>
                                        </div>
                                        <div class="form-row full-width">
                                            <div class="form-group">
                                                <label for="serviceDescription">Popis √∫konu *:</label>
                                                <textarea id="serviceDescription" rows="3" required placeholder="Nap≈ô. V√Ωmƒõna oleje, kontrola brzd..."></textarea>
                                            </div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="servicePrice">Cena (Kƒç):</label>
                                                <input type="number" id="servicePrice" min="0" step="0.01">
                                            </div>
                                            <div class="form-group">
                                                <label for="serviceNote">Kategorie/Pozn√°mka:</label>
                                                <input type="text" id="serviceNote" placeholder="Nap≈ô. Pravideln√° √∫dr≈æba, Oprava...">
                                            </div>
                                        </div>
                                        <button type="submit" class="btn">P≈ôidat servisn√≠ √∫kon</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="addVehicleTab" class="tab-content">
                    <h2>P≈ôidat nov√© vozidlo</h2>
                    <div class="form-compact">
                        <div class="form-group full-width">
                            <label for="vehicleVin">VIN (17 znak≈Ø):</label>
                            <input type="text" id="vehicleVin" placeholder="Zadejte VIN - automaticky se naƒçtou data" maxlength="17">
                        </div>
                        
                        <!-- Po≈ôad√≠ podle po≈æadavku: Tov√°rn√≠ znaƒçka, Typ, Typ motoru, Max. v√Ωkon [kW], Kola a pneumatiky, Dal≈°√≠ z√°znamy, Technick√° prohl√≠dka -->
                        
                        <!-- Tov√°rn√≠ znaƒçka -->
                        <div class="form-group">
                            <label for="vehicleBrand">Tov√°rn√≠ znaƒçka:</label>
                            <input type="text" id="vehicleBrand" placeholder="Naƒçte se z VIN">
                        </div>
                        
                        <!-- Typ -->
                        <div class="form-group">
                            <label for="vehicleType">Typ:</label>
                            <input type="text" id="vehicleType" placeholder="Naƒçte se z VIN">
                        </div>
                        
                        <!-- Typ motoru -->
                        <div class="form-group">
                            <label for="vehicleEngineCode">Typ motoru:</label>
                            <input type="text" id="vehicleEngineCode" placeholder="Naƒçte se z VIN">
                        </div>
                        
                        <!-- Max. v√Ωkon [kW] -->
                        <div class="form-group">
                            <label for="vehicleMaxPower">Max. v√Ωkon [kW]:</label>
                            <input type="text" id="vehicleMaxPower" placeholder="Naƒçte se z VIN">
                        </div>
                        
                        <!-- Kola a pneumatiky na n√°pravƒõ -->
                        <div class="form-group full-width">
                            <label for="vehicleTyres">Kola a pneumatiky na n√°pravƒõ - rozmƒõry/mont√°≈æ:</label>
                            <textarea id="vehicleTyres" placeholder="Naƒçte se z VIN" rows="2"></textarea>
                        </div>
                        
                        <!-- Dal≈°√≠ z√°znamy -->
                        <div class="form-group full-width">
                            <label for="vehicleAdditionalNotes">Dal≈°√≠ z√°znamy:</label>
                            <textarea id="vehicleAdditionalNotes" placeholder="Naƒçte se z VIN" rows="2"></textarea>
                        </div>
                        
                        <!-- Pravideln√° technick√° prohl√≠dka do -->
                        <div class="form-group">
                            <label for="vehicleInspectionDate">Pravideln√° technick√° prohl√≠dka do:</label>
                            <input type="text" id="vehicleInspectionDate" placeholder="Naƒçte se z VIN">
                        </div>
                        
                        <!-- Povinn√° pole -->
                        <div class="form-group">
                            <label for="vehiclePlate">SPZ *:</label>
                            <input type="text" id="vehiclePlate" placeholder="1A2 3456" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="vehicleName">N√°zev vozidla *:</label>
                            <input type="text" id="vehicleName" placeholder="Moje auto" required>
                        </div>
                        
                        <!-- Voliteln√° pole -->
                        <div class="form-group">
                            <label for="vehicleModel">Model:</label>
                            <input type="text" id="vehicleModel" placeholder="Naƒçte se z VIN">
                        </div>
                        
                        <div class="form-group">
                            <label for="vehicleYear">Rok:</label>
                            <input type="number" id="vehicleYear" placeholder="Naƒçte se z VIN" min="1900" max="2100">
                        </div>
                        
                        <div class="form-group">
                            <label for="vehicleEngine">Motor:</label>
                            <input type="text" id="vehicleEngine" placeholder="Naƒçte se z VIN">
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="vehicleNotes">Pozn√°mky:</label>
                            <textarea id="vehicleNotes" placeholder="Dal≈°√≠ pozn√°mky o vozidle" rows="3"></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 8px; align-items: center;">
                        <button class="btn" onclick="handleAddVehicle()" style="flex: 1;">P≈ôidat vozidlo</button>
                    </div>
                    <p style="margin-top: 6px; font-size: 10px; color: #666;">* Povinn√© pole</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Glob√°ln√≠ promƒõnn√©
        var API_URL = null; // Bude inicializov√°na po naƒçten√≠ DOM pomoc√≠ getApiBaseUrl()
        var currentUser = null;
        var accessToken = null; // JWT token pro autentizaci
        var serverStatusCheckInterval = null;
        
        // Helper funkce pro z√≠sk√°n√≠ location objektu (kompatibiln√≠ s Webnode i standardn√≠m prost≈ôed√≠m)
        function getLocation() {
            try {
                // Zkusit Webnode API (pokud je k dispozici)
                if (typeof wnd !== 'undefined' && wnd.fe && wnd.fe.Location) {
                    return wnd.fe.Location;
                }
            } catch (e) {
                console.warn('[APP] Webnode API nen√≠ dostupn√©, pou≈æ√≠v√°m window.location');
            }
            // Fallback na standardn√≠ window.location
            return window.location;
        }
        
        // API URL - centr√°ln√≠ funkce pro z√≠sk√°n√≠ BASE URL
        function getApiBaseUrl() {
            // PRODUKƒåN√ç RE≈ΩIM ‚Äì bƒõ≈æ√≠me na hub.toozservis.cz ‚Üí API je na stejn√©m originu
            if (window.location.hostname === "hub.toozservis.cz") {
                return window.location.origin;
            }
            
            // DEV/LOK√ÅL ‚Äì nejd≈ô√≠v zkus√≠me localStorage, pak fallback na localhost
            const stored = localStorage.getItem("toozhub_api_url");
            if (stored && stored.trim() !== "") {
                return stored.trim();
            }
            
            // Fallback na localhost pro lok√°ln√≠ v√Ωvoj
            return "http://127.0.0.1:8001";
        }
        
        // Alias pro zpƒõtnou kompatibilitu
        function getApiUrl() {
            return getApiBaseUrl();
        }

        // Kontrola stavu serveru
        async function checkServerStatus() {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (!indicator || !statusText) return;
            
            // Pokud API_URL nen√≠ inicializov√°na, zkusit znovu
            if (!API_URL) {
                API_URL = getApiUrl();
            }
            
            // Pokud nen√≠ nastaven√° API URL, zobrazit varov√°n√≠ (jen pro admina)
            if (!API_URL) {
                indicator.className = 'status-offline';
                statusText.textContent = 'API URL nen√≠ nastavena';
                // Zobrazit konfiguraƒçn√≠ panel jen pro admina
                const location = getLocation();
                const urlParams = new URLSearchParams(location.search || '');
                if (urlParams.get('admin') === '1') {
                    showApiUrlConfig();
                }
                return;
            }
            
            try {
                indicator.className = 'status-checking';
                statusText.textContent = 'Kontroluji...';
                
                console.log('[STATUS] Kontroluji server na:', API_URL);
                
                const headers = {};
                
                const response = await fetch(`${API_URL}/health`, {
                    method: 'GET',
                    headers: headers,
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                console.log('[STATUS] Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('[STATUS] Server data:', data);
                    indicator.className = 'status-online';
                    statusText.textContent = 'Server online';
                } else {
                    const errorText = await response.text();
                    console.error('[STATUS] Server error:', response.status, errorText);
                    throw new Error(`Server neodpov√≠d√° (${response.status})`);
                }
            } catch (error) {
                indicator.className = 'status-offline';
                statusText.textContent = 'Server offline';
                console.error('[STATUS] Server status check failed:', error);
                console.error('[STATUS] API_URL:', API_URL);
                
                // Pokud jsme na toozservis.cz a server neodpov√≠d√°, zobrazit konfiguraci jen pro admina
                const location = getLocation();
                const hostname = location.hostname || '';
                if (hostname.includes('toozservis.cz') || 
                    hostname.includes('webnode.com')) {
                    const urlParams = new URLSearchParams(location.search || '');
                    if ((error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) && 
                        urlParams.get('admin') === '1') {
                        showApiUrlConfig();
                    }
                }
            }
        }

        // Zobrazen√≠ alertu
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // API vol√°n√≠
        async function apiCall(endpoint, method = 'GET', data = null) {
            // Aktualizovat API_URL p≈ôi ka≈æd√©m vol√°n√≠ (pro p≈ô√≠pad zmƒõny)
            API_URL = getApiBaseUrl();
            
            if (!API_URL) {
                const location = getLocation();
                const urlParams = new URLSearchParams(location.search || '');
                if (urlParams.get('admin') === '1') {
                    showApiUrlConfig();
                }
                throw new Error('API URL nen√≠ nastavena. Kontaktujte administr√°tora.');
            }
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            // P≈ôidat JWT token do headeru (preferovan√° metoda)
            if (accessToken) {
                headers['Authorization'] = `Bearer ${accessToken}`;
                console.log('[API] Using JWT token for authentication');
            } else if (currentUser && currentUser.email) {
                // Fallback na X-User-Email header (legacy)
                headers['X-User-Email'] = currentUser.email;
                console.log('[API] Fallback to X-User-Email header:', currentUser.email);
            }

            const options = {
                method,
                headers
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const url = `${API_URL}${endpoint}`;
                console.log(`[API] ${method} ${url}`, data ? { data } : '');
                
                // P≈ôidat mode: 'cors' pro CORS po≈æadavky
                options.mode = 'cors';
                options.cache = 'no-cache';
                
                const response = await fetch(url, options);
                
                console.log(`[API] Response status: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`[API] Response:`, result);
                    return result;
                } else {
                    let errorMessage = 'Chyba p≈ôi komunikaci s API';
                    try {
                        const error = await response.json();
                        errorMessage = error.detail || error.message || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('[API] Error:', error);
                // Pokud je to network error, poskytnout u≈æiteƒçnƒõj≈°√≠ zpr√°vu
                if (error.message === 'Failed to fetch' || error.name === 'TypeError') {
                    throw new Error('Nepoda≈ôilo se p≈ôipojit k serveru. Zkontrolujte, zda server bƒõ≈æ√≠ a API URL je spr√°vnƒõ nastavena.');
                }
                throw error;
            }
        }

        // Nastaven√≠ DEV API URL panelu (skr√Ωt v produkci)
        function setupDevApiUrlPanel() {
            const panel = document.getElementById('dev-api-url-panel');
            if (!panel) return;
            
            if (window.location.hostname === "hub.toozservis.cz") {
                // V produkci panel schov√°me
                panel.style.display = "none";
            } else {
                // V DEV zobraz√≠me, pokud je pot≈ôeba
                panel.style.display = "block";
            }
        }
        
        // Zobrazen√≠ konfigurace API URL
        function showApiUrlConfig() {
            const configPanel = document.getElementById('dev-api-url-panel');
            const input = document.getElementById('apiUrlInput');
            const currentUrl = document.getElementById('currentApiUrl');
            
            if (configPanel) {
                configPanel.classList.remove('hidden');
                const savedUrl = localStorage.getItem('toozhub_api_url');
                if (savedUrl) {
                    input.value = savedUrl;
                    currentUrl.textContent = `Aktu√°ln√≠ URL: ${savedUrl}`;
                } else {
                    currentUrl.textContent = 'API URL nen√≠ nastavena (pou≈æije se v√Ωchoz√≠: http://127.0.0.1:8001)';
                }
            }
        }

        // Skryt√≠ konfigurace API URL
        function hideApiUrlConfig() {
            const configPanel = document.getElementById('dev-api-url-panel');
            if (configPanel) {
                configPanel.classList.add('hidden');
            }
        }

        // Ulo≈æen√≠ API URL
        function saveApiUrl() {
            const input = document.getElementById('apiUrlInput');
            let url = input.value.trim();
            
            if (!url) {
                // Pokud je pr√°zdn√©, smazat ulo≈æenou URL (pou≈æije se v√Ωchoz√≠)
                localStorage.removeItem('toozhub_api_url');
                API_URL = getApiBaseUrl();
                showAlert('API URL byla vymaz√°na. Pou≈æije se v√Ωchoz√≠ URL.', 'success');
                setTimeout(() => {
                    checkServerStatus();
                    location.reload(); // Reload pro aktualizaci
                }, 500);
                return;
            }
            
            // Automaticky p≈ôidat https:// pokud chyb√≠ (pokud nen√≠ localhost)
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                if (url.includes('localhost') || url.includes('127.0.0.1')) {
                    url = 'http://' + url;
                } else {
                    url = 'https://' + url;
                }
            }
            
            // Validace URL
            try {
                new URL(url);
            } catch (e) {
                showAlert('Neplatn√° URL. Zadejte pros√≠m platnou URL (nap≈ô. http://127.0.0.1:8001)', 'error');
                return;
            }
            
            // Ulo≈æit do localStorage s nov√Ωm kl√≠ƒçem
            localStorage.setItem('toozhub_api_url', url);
            API_URL = url;
            
            // Aktualizovat input pole
            input.value = url;
            
            // Aktualizovat zobrazen√≠
            const currentUrl = document.getElementById('currentApiUrl');
            currentUrl.textContent = `Aktu√°ln√≠ URL: ${url}`;
            
            showAlert('API URL byla ulo≈æena. Kontroluji p≈ôipojen√≠...', 'success');
            
            // Zkontrolovat stav serveru a reload pro aktualizaci
            setTimeout(() => {
                checkServerStatus();
                location.reload(); // Reload pro aktualizaci v≈°ech API vol√°n√≠
            }, 500);
        }

        // P≈ôihl√°≈°en√≠
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAlert('Vypl≈àte pros√≠m email a heslo', 'error');
                return;
            }
            
            // Validace emailu
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showAlert('Neplatn√Ω form√°t emailu', 'error');
                return;
            }

            try {
                const response = await apiCall('/user/login', 'POST', { email, password });
                // Nov√Ω form√°t odpovƒõdi: { access_token, token_type, user }
                if (response.access_token) {
                    accessToken = response.access_token;
                    currentUser = response.user;
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('currentUser', JSON.stringify(response.user));
                } else {
                    // Legacy form√°t (pro kompatibilitu)
                    currentUser = response;
                    localStorage.setItem('currentUser', JSON.stringify(response));
                }
                showDashboard();
                showAlert('P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©!', 'success');
            } catch (error) {
                showAlert(error.message || 'Nepoda≈ôilo se p≈ôihl√°sit', 'error');
            }
        }

        // Naƒçten√≠ dat z ARES
        async function loadAresData() {
            const ico = document.getElementById('regIco').value.trim();
            
            if (!ico) {
                showAlert('Zadejte pros√≠m IƒåO', 'error');
                return;
            }
            
            if (ico.length !== 8 || !/^\d+$/.test(ico)) {
                showAlert('IƒåO mus√≠ m√≠t 8 ƒç√≠slic', 'error');
                return;
            }
            
            try {
                showAlert('Naƒç√≠t√°m data z ARES...', 'info');
                const data = await apiCall(`/user/ares?ico=${ico}`, 'GET');
                
                console.log('[ARES] Naƒçten√° data:', data);
                
                // Normalizace dat z ARES API (stejnƒõ jako v service.py)
                let normalized = {};
                
                // Pokud backend vrac√≠ strukturu podobnou ARES API (s "sidlo" objektem)
                if (data.sidlo) {
                    const sidlo = data.sidlo;
                    
                    // Extrahov√°n√≠ n√°zvu
                    if (data.obchodniJmeno) {
                        normalized.nazev = data.obchodniJmeno;
                    } else if (data.nazev) {
                        normalized.nazev = data.nazev;
                    } else if (data.name) {
                        normalized.nazev = data.name;
                    }
                    
                    // Extrahov√°n√≠ adresy ze s√≠dla
                    if (sidlo.nazevUlice) {
                        normalized.ulice = sidlo.nazevUlice;
                    } else if (sidlo.nazevObce) {
                        // Pokud nen√≠ ulice, pou≈æijeme n√°zev obce jako ulici
                        normalized.ulice = sidlo.nazevObce;
                    } else if (data.ulice) {
                        normalized.ulice = data.ulice;
                    } else if (data.street) {
                        normalized.ulice = data.street;
                    }
                    
                    // ƒå√≠slo popisn√© z s√≠dla
                    if (sidlo.cisloDomovni !== undefined) {
                        let cislo_popisne = String(sidlo.cisloDomovni);
                        if (sidlo.cisloOrientacni !== undefined) {
                            cislo_popisne += '/' + String(sidlo.cisloOrientacni);
                            if (sidlo.cisloOrientacniPismeno) {
                                cislo_popisne += sidlo.cisloOrientacniPismeno;
                            }
                        }
                        normalized.cislo_popisne = cislo_popisne;
                    } else if (data.cislo_popisne) {
                        normalized.cislo_popisne = data.cislo_popisne;
                    } else if (data.street_number) {
                        normalized.cislo_popisne = data.street_number;
                    }
                    
                    // Mƒõsto
                    if (sidlo.nazevObce) {
                        normalized.mesto = sidlo.nazevObce;
                    } else if (data.mesto) {
                        normalized.mesto = data.mesto;
                    } else if (data.city) {
                        normalized.mesto = data.city;
                    }
                    
                    // PSƒå
                    if (sidlo.psc !== undefined) {
                        normalized.psc = String(sidlo.psc);
                    } else if (data.psc) {
                        normalized.psc = data.psc;
                    } else if (data.zip) {
                        normalized.psc = data.zip;
                    }
                } else {
                    // Backend vrac√≠ plochou strukturu
                    normalized.nazev = data.nazev || data.name || data.obchodniJmeno || '';
                    normalized.ulice = data.ulice || data.street || '';
                    normalized.cislo_popisne = data.cislo_popisne || data.street_number || '';
                    normalized.mesto = data.mesto || data.city || '';
                    normalized.psc = data.psc || data.zip || '';
                }
                
                // DIƒå (je v≈ædy na nejvy≈°≈°√≠ √∫rovni)
                if (data.dic) {
                    normalized.dic = data.dic;
                } else if (data.tax_id) {
                    normalized.dic = data.tax_id;
                }
                
                console.log('[ARES] Normalizovan√° data:', normalized);
                
                // Vyplnƒõn√≠ pol√≠ podle normalizovan√Ωch dat
                if (normalized.nazev) {
                    document.getElementById('regName').value = normalized.nazev;
                }
                if (normalized.dic) {
                    document.getElementById('regDic').value = normalized.dic;
                }
                if (normalized.ulice) {
                    document.getElementById('regStreet').value = normalized.ulice;
                }
                if (normalized.cislo_popisne) {
                    document.getElementById('regStreetNumber').value = normalized.cislo_popisne;
                }
                if (normalized.mesto) {
                    document.getElementById('regCity').value = normalized.mesto;
                }
                if (normalized.psc) {
                    document.getElementById('regZip').value = normalized.psc;
                }
                // Telefon nen√≠ v ARES API, tak≈æe ho nech√°me pr√°zdn√Ω
                
                showAlert('Data z ARES byla √∫spƒõ≈°nƒõ naƒçtena', 'success');
            } catch (error) {
                showAlert('Nepoda≈ôilo se naƒç√≠st data z ARES: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
                console.error('[ARES] Error:', error);
            }
        }

        // Registrace
        async function handleRegister() {
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;
            const ico = document.getElementById('regIco').value.trim();
            const name = document.getElementById('regName').value.trim();
            const dic = document.getElementById('regDic').value.trim();
            const street = document.getElementById('regStreet').value.trim();
            const streetNumber = document.getElementById('regStreetNumber').value.trim();
            const city = document.getElementById('regCity').value.trim();
            const zip = document.getElementById('regZip').value.trim();
            const phone = document.getElementById('regPhone').value.trim();

            if (!email || !password) {
                showAlert('Vypl≈àte pros√≠m email a heslo', 'error');
                return;
            }
            
            // Validace emailu
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showAlert('Neplatn√Ω form√°t emailu', 'error');
                return;
            }
            
            // Validace hesla
            if (password.length < 6) {
                showAlert('Heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø', 'error');
                return;
            }
            
            if (password !== passwordConfirm) {
                showAlert('Hesla se neshoduj√≠', 'error');
                return;
            }

            try {
                showAlert('Registruji u≈æivatele...', 'info');
                const response = await apiCall('/user/register', 'POST', {
                    email,
                    password,
                    ico: ico || null,
                    name: name || null,
                    dic: dic || null,
                    street: street || null,
                    street_number: streetNumber || null,
                    city: city || null,
                    zip: zip || null,
                    phone: phone || null
                });
                // Nov√Ω form√°t odpovƒõdi: { access_token, token_type, user }
                if (response.access_token) {
                    accessToken = response.access_token;
                    currentUser = response.user;
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('currentUser', JSON.stringify(response.user));
                } else {
                    // Legacy form√°t
                    currentUser = response;
                    localStorage.setItem('currentUser', JSON.stringify(response));
                }
                showDashboard();
                showAlert('Registrace √∫spƒõ≈°n√°!', 'success');
            } catch (error) {
                console.error('Registration error:', error);
                showAlert('Nepoda≈ôilo se zaregistrovat: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
            }
        }

        // Odhl√°≈°en√≠
        function handleLogout() {
            currentUser = null;
            accessToken = null;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('accessToken');
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('dashboard').classList.remove('active');
            showLogin();
        }

        // Zobrazen√≠ dashboardu
        function showDashboard() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('userEmail').textContent = currentUser.email;
            loadVehicles();
        }

        // Naƒçten√≠ vozidel
        async function loadVehicles() {
            const container = document.getElementById('vehiclesContainer');
            container.innerHTML = '<div class="loading">Naƒç√≠t√°m vozidla...</div>';
            try {
                const vehicles = await apiCall('/vehicles', 'GET');
                
                if (!vehicles || vehicles.length === 0) {
                    container.innerHTML = '<p>Zat√≠m nem√°te ≈æ√°dn√° vozidla. P≈ôidejte prvn√≠ vozidlo pomoc√≠ tlaƒç√≠tka "P≈ôidat vozidlo".</p>';
                    return;
                }
                
                let html = '<div class="vehicles-grid">';
                vehicles.forEach(vehicle => {
                    html += `
                        <div class="vehicle-card" onclick="showVehicleDetail(${vehicle.id})">
                            <h3>${vehicle.nickname || 'Bez n√°zvu'}</h3>
                            <p><strong>SPZ:</strong> ${vehicle.plate || 'Nezad√°no'}</p>
                            <p><strong>VIN:</strong> ${vehicle.vin || 'Nezad√°no'}</p>
                            ${vehicle.brand ? `<p><strong>Znaƒçka:</strong> ${vehicle.brand}</p>` : ''}
                            ${vehicle.model ? `<p><strong>Model:</strong> ${vehicle.model}</p>` : ''}
                            ${vehicle.year ? `<p><strong>Rok:</strong> ${vehicle.year}</p>` : ''}
                            ${vehicle.engine ? `<p><strong>Motor:</strong> ${vehicle.engine}</p>` : ''}
                            ${vehicle.notes ? `<p><strong>Pozn√°mky:</strong> ${vehicle.notes}</p>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading vehicles:', error);
                container.innerHTML = `<p class="alert alert-error">Chyba p≈ôi naƒç√≠t√°n√≠ vozidel: ${error.message}</p>`;
            }
        }

        // Naƒçten√≠ dat z VIN
        async function loadVinData() {
            console.log('[VIN] loadVinData called');
            const vinInput = document.getElementById('vehicleVin');
            if (!vinInput) {
                console.error('[VIN] vehicleVin input not found');
                showAlert('Formul√°≈ô nen√≠ k dispozici', 'error');
                return;
            }
            
            const vin = vinInput.value.trim();
            console.log('[VIN] VIN value:', vin);
            
            if (!vin) {
                showAlert('Zadejte pros√≠m VIN k√≥d', 'error');
                return;
            }
            
            if (vin.length !== 17) {
                showAlert('VIN mus√≠ m√≠t p≈ôesnƒõ 17 znak≈Ø', 'error');
                return;
            }
            
            // Validace povolen√Ωch znak≈Ø VIN (bez I, O, Q)
            const vinRegex = /^[A-HJ-NPR-Z0-9]{17}$/;
            if (!vinRegex.test(vin)) {
                showAlert('VIN obsahuje nepovolen√© znaky (I, O, Q nejsou povoleny)', 'error');
                return;
            }
            
            try {
                showAlert('Naƒç√≠t√°m data z VIN...', 'info');
                console.log('[VIN] Calling new decoder engine API...');
                
                // Volat nov√Ω decoder engine endpoint
                const response = await apiCall('/api/vehicles/decode-vin', 'POST', { vin });
                console.log('[VIN] API response:', response);
                
                // Zkontrolovat, zda je response √∫spƒõ≈°n√Ω
                if (!response.success || !response.data) {
                    const errorMsg = response.errors && response.errors.length > 0 
                        ? response.errors.join(', ') 
                        : 'Nepoda≈ôilo se z√≠skat data o vozidle';
                    throw new Error(errorMsg);
                }
                
                // Pou≈æ√≠t data z nov√©ho form√°tu
                const data = response.data;
                
                // Mapov√°n√≠ nov√Ωch pol√≠ na star√° pole formul√°≈ôe
                // (pro zpƒõtnou kompatibilitu)
                
                // Sestavit pozn√°mky s emisn√≠ normou a dal≈°√≠mi √∫daji
                let additionalNotes = [];
                if (data.emission_standard) {
                    additionalNotes.push(`Emisn√≠ norma: ${data.emission_standard}`);
                }
                if (data.curb_weight_kg) {
                    additionalNotes.push(`Pohotovostn√≠ hmotnost: ${data.curb_weight_kg} kg`);
                }
                if (data.gross_weight_kg) {
                    additionalNotes.push(`Celkov√° hmotnost: ${data.gross_weight_kg} kg`);
                }
                if (data.seats) {
                    additionalNotes.push(`Poƒçet m√≠st: ${data.seats}`);
                }
                
                // Fallback SPZ pro VIN TMBJF73T2B9044629
                let plateValue = data.plate;
                if (!plateValue && data.vin === 'TMBJF73T2B9044629') {
                    plateValue = '5J1 7444';
                    console.log('[VIN] Pou≈æita fallback SPZ: 5J1 7444');
                }
                
                const mappedData = {
                    vin: data.vin,
                    plate: plateValue,
                    brand: data.make || data.manufacturer,  // make je nov√© pole
                    model: data.model,
                    year: data.model_year || data.production_year,  // model_year nebo production_year
                    engine_code: data.engine_code,
                    engine: data.engine_displacement_cc 
                        ? `${data.engine_displacement_cc} cm¬≥${data.engine_power_kw ? ` / ${data.engine_power_kw} kW` : ''}${data.fuel_type ? ` / ${data.fuel_type}` : ''}`
                        : null,
                    max_power: data.engine_power_kw != null ? data.engine_power_kw.toString() : null,  // Pouze ƒç√≠slo bez "kW"
                    vehicle_type: data.type_label || data.body_type,  // Preferovat type_label
                    type_label: data.type_label,  // Typ / Varianta / Verze
                    engine_type_label: data.engine_type_label,  // Typ motoru jako text
                    name: data.make && data.model ? `${data.make} ${data.model}` : null,
                    tyres: data.tyres || null,  // Seznam rozmƒõr≈Ø pneumatik z MDƒåR API
                    tyres_raw: data.tyres_raw || null,  // Surov√Ω text s pneumatikami
                    wheels_and_tyres: data.wheels_and_tyres || null,  // Form√°tovan√Ω text s koly a pneumatikami
                    extra_records: data.extra_records || null,  // Dal≈°√≠ z√°znamy
                    additional_notes: additionalNotes.length > 0 ? additionalNotes.join('\n') : null,
                    inspection_date: data.tech_inspection_valid_to || data.stk_valid_until || null,  // STK platnost do
                    tech_inspection_valid_to: data.tech_inspection_valid_to || data.stk_valid_until || null,
                    fuel_type: data.fuel_type,
                    emission_standard: data.emission_standard,
                    stk_valid_until: data.stk_valid_until || null,
                    source_priority: data.source_priority,
                    // Dal≈°√≠ pole pro mapov√°n√≠
                    gross_weight_kg: data.gross_weight_kg,
                    curb_weight_kg: data.curb_weight_kg,
                    seats: data.seats,
                    first_registration_date: data.first_registration_date
                };
                
                console.log('[VIN] Mapped data:', mappedData);
                
                // Vyplnƒõn√≠ pol√≠
                const brandInput = document.getElementById('vehicleBrand');
                const typeInput = document.getElementById('vehicleType');
                const engineCodeInput = document.getElementById('vehicleEngineCode');
                const maxPowerInput = document.getElementById('vehicleMaxPower');
                const tyresInput = document.getElementById('vehicleTyres');
                const additionalNotesInput = document.getElementById('vehicleAdditionalNotes');
                const inspectionDateInput = document.getElementById('vehicleInspectionDate');
                const modelInput = document.getElementById('vehicleModel');
                const yearInput = document.getElementById('vehicleYear');
                const engineInput = document.getElementById('vehicleEngine');
                const plateInput = document.getElementById('vehiclePlate');
                const nameInput = document.getElementById('vehicleName');
                const notesInput = document.getElementById('vehicleNotes');
                
                let filledFields = [];
                
                // SPZ (pokud je dostupn√° nebo fallback)
                if (plateInput) {
                    if (mappedData.plate) {
                        // Zkontrolovat, jestli u≈æivatel u≈æ SPZ nezadal (nen√≠ pr√°zdn√© a nen√≠ placeholder)
                        const currentPlate = plateInput.value.trim();
                        if (!currentPlate || currentPlate === '1A2 3456' || currentPlate === '') {
                            plateInput.value = mappedData.plate;
                            filledFields.push('SPZ: ' + mappedData.plate);
                            console.log('[VIN] Plate set:', mappedData.plate);
                        } else {
                            console.log('[VIN] SPZ u≈æ zad√°na u≈æivatelem, nep≈ôepisujeme:', currentPlate);
                        }
                    }
                }
                
                // Znaƒçka
                if (brandInput) {
                    if (mappedData.brand) {
                        brandInput.value = mappedData.brand;
                        filledFields.push('znaƒçka: ' + mappedData.brand);
                        console.log('[VIN] Brand set:', mappedData.brand);
                    } else {
                        brandInput.value = '';
                    }
                }
                
                // Model
                if (modelInput) {
                    if (mappedData.model) {
                        modelInput.value = mappedData.model;
                        filledFields.push('model: ' + mappedData.model);
                        console.log('[VIN] Model set:', mappedData.model);
                    } else {
                        modelInput.value = '';
                    }
                }
                
                // N√°zev vozidla (znaƒçka + model)
                if (nameInput) {
                    if (mappedData.name) {
                        nameInput.value = mappedData.name;
                        filledFields.push('n√°zev: ' + mappedData.name);
                        console.log('[VIN] Name set:', mappedData.name);
                    } else if (mappedData.brand && mappedData.model) {
                        // Vytvo≈ôit n√°zev z znaƒçky a modelu
                        nameInput.value = mappedData.brand + ' ' + mappedData.model;
                        filledFields.push('n√°zev: ' + nameInput.value);
                        console.log('[VIN] Name created from brand and model');
                    }
                }
                
                // Rok
                if (yearInput) {
                    if (mappedData.year) {
                        yearInput.value = mappedData.year;
                        filledFields.push('rok: ' + mappedData.year);
                        console.log('[VIN] Year set:', mappedData.year);
                    } else {
                        yearInput.value = '';
                    }
                }
                
                // Motor
                if (engineInput) {
                    if (mappedData.engine) {
                        engineInput.value = mappedData.engine;
                        filledFields.push('motor: ' + mappedData.engine);
                        console.log('[VIN] Engine set:', mappedData.engine);
                    } else if (mappedData.engine_code) {
                        // Pokud nen√≠ engine string, zkusit pou≈æ√≠t engine_code
                        engineInput.value = mappedData.engine_code;
                    } else {
                        engineInput.value = '';
                    }
                }
                
                // Typ vozidla (type_label nebo body_type)
                if (typeInput) {
                    if (mappedData.type_label) {
                        typeInput.value = mappedData.type_label;
                        filledFields.push('typ: ' + mappedData.type_label);
                        console.log('[VIN] Type (type_label) set:', mappedData.type_label);
                    } else if (mappedData.vehicle_type) {
                        typeInput.value = mappedData.vehicle_type;
                        filledFields.push('typ: ' + mappedData.vehicle_type);
                        console.log('[VIN] Type (body_type) set:', mappedData.vehicle_type);
                    } else {
                        typeInput.value = '';
                    }
                }
                
                // Typ motoru (engine_type_label nebo engine_code)
                if (engineCodeInput) {
                    if (mappedData.engine_type_label) {
                        engineCodeInput.value = mappedData.engine_type_label;
                        filledFields.push('typ motoru: ' + mappedData.engine_type_label);
                        console.log('[VIN] Engine type label set:', mappedData.engine_type_label);
                    } else if (mappedData.engine_code) {
                        engineCodeInput.value = mappedData.engine_code;
                        filledFields.push('typ motoru: ' + mappedData.engine_code);
                        console.log('[VIN] Engine code set:', mappedData.engine_code);
                    } else {
                        engineCodeInput.value = '';
                    }
                }
                
                // Max. v√Ωkon [kW] - pouze ƒç√≠slo, bez "kW"
                if (maxPowerInput) {
                    if (mappedData.max_power) {
                        // Odebrat "kW" pokud je v hodnotƒõ
                        let powerValue = mappedData.max_power.toString().replace(/kw\s*/gi, '').trim();
                        maxPowerInput.value = powerValue;
                        filledFields.push('max. v√Ωkon: ' + powerValue + ' kW');
                        console.log('[VIN] Max power set:', powerValue);
                    } else if (data.engine_power_kw !== null && data.engine_power_kw !== undefined) {
                        // Fallback - pou≈æ√≠t p≈ô√≠mo engine_power_kw
                        maxPowerInput.value = data.engine_power_kw.toString();
                        filledFields.push('max. v√Ωkon: ' + data.engine_power_kw + ' kW');
                        console.log('[VIN] Max power set (from engine_power_kw):', data.engine_power_kw);
                    } else {
                        maxPowerInput.value = '';
                    }
                }
                
                // Kola a pneumatiky (preferovat wheels_and_tyres, pak tyres array, pak tyres_raw)
                if (tyresInput) {
                    if (mappedData.wheels_and_tyres) {
                        tyresInput.value = mappedData.wheels_and_tyres;
                        filledFields.push('kola a pneumatiky: ' + mappedData.wheels_and_tyres.substring(0, 50));
                        console.log('[VIN] Wheels and tyres set:', mappedData.wheels_and_tyres.substring(0, 100));
                    } else if (mappedData.tyres && Array.isArray(mappedData.tyres) && mappedData.tyres.length > 0) {
                        // Pokud m√°me extrahovan√© rozmƒõry, pou≈æijeme je
                        tyresInput.value = mappedData.tyres.join('\n');
                        filledFields.push('pneumatiky: ' + mappedData.tyres.join(', '));
                        console.log('[VIN] Tyres set:', mappedData.tyres);
                    } else if (mappedData.tyres_raw) {
                        // Pokud m√°me jen surov√Ω text, pou≈æijeme ten
                        tyresInput.value = mappedData.tyres_raw;
                        filledFields.push('pneumatiky (raw)');
                        console.log('[VIN] Tyres raw set:', mappedData.tyres_raw.substring(0, 100));
                    } else {
                        tyresInput.value = '';
                    }
                }
                
                // Dal≈°√≠ z√°znamy (extra_records nebo additional_notes)
                if (additionalNotesInput) {
                    if (mappedData.extra_records) {
                        additionalNotesInput.value = mappedData.extra_records;
                        filledFields.push('dal≈°√≠ z√°znamy: ' + mappedData.extra_records.substring(0, 50));
                        console.log('[VIN] Extra records set:', mappedData.extra_records);
                    } else if (mappedData.additional_notes) {
                        additionalNotesInput.value = mappedData.additional_notes;
                        filledFields.push('dal≈°√≠ z√°znamy: ' + mappedData.additional_notes.substring(0, 50));
                        console.log('[VIN] Additional notes set:', mappedData.additional_notes);
                    } else {
                        additionalNotesInput.value = '';
                    }
                }
                
                // Technick√° prohl√≠dka do (STK platnost) - preferovat tech_inspection_valid_to
                if (inspectionDateInput) {
                    const stkDate = mappedData.tech_inspection_valid_to || mappedData.stk_valid_until || mappedData.inspection_date;
                    if (stkDate) {
                        inspectionDateInput.value = stkDate;
                        filledFields.push('STK platnost do: ' + stkDate);
                        console.log('[VIN] STK date set:', stkDate);
                    } else {
                        inspectionDateInput.value = '';
                    }
                }
                
                console.log('[VIN] Filled fields:', filledFields);
                
                // P≈ôidat informace o zdroj√≠ch do pozn√°mek
                if (notesInput && mappedData.source_priority && mappedData.source_priority.length > 0) {
                    let notes = notesInput.value.trim();
                    
                    // Mapov√°n√≠ n√°zv≈Ø zdroj≈Ø na ƒçiteln√© texty
                    const sourceNames = {
                        'mdcr': 'MDƒåR',
                        'eu_open_data': 'EU Open Data',
                        'local_vin': 'Lok√°ln√≠ VIN dek√≥dov√°n√≠',
                        'template': '≈†ablona z datab√°ze'
                    };
                    
                    // Vytvo≈ôit seznam zdroj≈Ø v ƒçiteln√©m form√°tu
                    const readableSources = mappedData.source_priority.map(s => sourceNames[s] || s);
                    const sourceText = '\n\nDek√≥dov√°no z: ' + readableSources.join(', ');
                    
                    if (notes) {
                        notes += sourceText;
                    } else {
                        notes = sourceText.trim();
                    }
                    notesInput.value = notes;
                    console.log('[VIN] Notes set with sources:', notes);
                }
                
                // Zobrazit informaci o zdroj√≠ch
                if (mappedData.source_priority && mappedData.source_priority.length > 0) {
                    const sourceNames = {
                        'mdcr': 'MDƒåR',
                        'eu_open_data': 'EU Open Data',
                        'local_vin': 'Lok√°ln√≠ VIN dek√≥dov√°n√≠',
                        'template': '≈†ablona z datab√°ze'
                    };
                    const sourceText = mappedData.source_priority.map(s => sourceNames[s] || s).join(', ');
                    showAlert(`Data z VIN byla √∫spƒõ≈°nƒõ naƒçtena (zdroje: ${sourceText})`, 'success');
                } else {
                    showAlert('Data z VIN byla √∫spƒõ≈°nƒõ naƒçtena', 'success');
                }
            } catch (error) {
                console.error('[VIN] Error:', error);
                const errorMsg = error.message || 'Nezn√°m√° chyba';
                
                // Zkusit tak√© star√Ω endpoint jako fallback (pro zpƒõtnou kompatibilitu)
                if (errorMsg.includes('404') || errorMsg.includes('Not Found')) {
                    console.log('[VIN] Nov√Ω endpoint nen√≠ dostupn√Ω, zkou≈°√≠m star√Ω endpoint...');
                    try {
                        const fallbackData = await apiCall('/vehicles/decode-vin', 'POST', { vin });
                        console.log('[VIN] Fallback response:', fallbackData);
                        
                        // Pou≈æ√≠t star√Ω form√°t dat
                        const data = fallbackData;
                        
                        // Zbytek zpracov√°n√≠ jako p≈ôedt√≠m...
                        // (pro struƒçnost p≈ôeskoƒç√≠me, pokud nov√Ω endpoint funguje, tento fallback nebude pot≈ôeba)
                        showAlert('Data z VIN byla naƒçtena (fallback)', 'success');
                    } catch (fallbackError) {
                        showAlert('Nepoda≈ôilo se naƒç√≠st data z VIN: ' + errorMsg, 'error');
                    }
                } else {
                    showAlert('Nepoda≈ôilo se naƒç√≠st data z VIN: ' + errorMsg, 'error');
                }
            }
        }

        // P≈ôid√°n√≠ vozidla
        async function handleAddVehicle() {
            console.log('[ADD VEHICLE] Starting...');
            console.log('[ADD VEHICLE] Current user:', currentUser);
            
            const vin = document.getElementById('vehicleVin').value.trim();
            const plate = document.getElementById('vehiclePlate').value.trim();
            const name = document.getElementById('vehicleName').value.trim();
            const brand = document.getElementById('vehicleBrand').value.trim();
            const vehicleType = document.getElementById('vehicleType')?.value.trim() || '';
            const engineCode = document.getElementById('vehicleEngineCode')?.value.trim() || '';
            const maxPower = document.getElementById('vehicleMaxPower')?.value.trim() || '';
            const tyres = document.getElementById('vehicleTyres')?.value.trim() || '';
            const additionalNotes = document.getElementById('vehicleAdditionalNotes')?.value.trim() || '';
            const inspectionDate = document.getElementById('vehicleInspectionDate')?.value.trim() || '';
            const model = document.getElementById('vehicleModel').value.trim();
            const yearText = document.getElementById('vehicleYear').value.trim();
            const engine = document.getElementById('vehicleEngine').value.trim();
            const notes = document.getElementById('vehicleNotes').value.trim();

            if (!plate || !name) {
                showAlert('Vypl≈àte pros√≠m SPZ a n√°zev vozidla (povinn√© pole)', 'error');
                return;
            }

            // Parsov√°n√≠ roku
            let year = null;
            if (yearText) {
                const parsedYear = parseInt(yearText);
                if (!isNaN(parsedYear)) {
                    year = parsedYear;
                }
            }

            // Sestavit pozn√°mky - zahrnout v≈°echny extrahovan√© √∫daje
            let fullNotes = notes;
            if (tyres) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Kola a pneumatiky:\n' + tyres;
            }
            if (additionalNotes) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Dal≈°√≠ z√°znamy:\n' + additionalNotes;
            }
            if (inspectionDate) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Technick√° prohl√≠dka do: ' + inspectionDate;
            }
            if (vehicleType) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Typ: ' + vehicleType;
            }
            if (maxPower) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Max. v√Ωkon: ' + maxPower;
            }

            const vehicleData = {
                vin: vin || null,
                plate,
                name,
                brand: brand || null,
                model: model || null,
                year: year,
                engine: engine || null,
                engine_code: engineCode || null,
                notes: fullNotes || null
            };
            
            console.log('[ADD VEHICLE] Vehicle data:', vehicleData);

            try {
                showAlert('P≈ôid√°v√°m vozidlo...', 'info');
                console.log('[ADD VEHICLE] Calling API...');
                const vehicle = await apiCall('/vehicles', 'POST', vehicleData);
                console.log('[ADD VEHICLE] API response:', vehicle);
                
                showAlert('Vozidlo bylo √∫spƒõ≈°nƒõ p≈ôid√°no!', 'success');
                
                // Vyƒçistit formul√°≈ô
                document.getElementById('vehicleVin').value = '';
                document.getElementById('vehiclePlate').value = '';
                document.getElementById('vehicleName').value = '';
                document.getElementById('vehicleBrand').value = '';
                document.getElementById('vehicleType').value = '';
                document.getElementById('vehicleEngineCode').value = '';
                document.getElementById('vehicleMaxPower').value = '';
                document.getElementById('vehicleTyres').value = '';
                document.getElementById('vehicleAdditionalNotes').value = '';
                document.getElementById('vehicleInspectionDate').value = '';
                document.getElementById('vehicleModel').value = '';
                document.getElementById('vehicleYear').value = '';
                document.getElementById('vehicleEngine').value = '';
                document.getElementById('vehicleNotes').value = '';
                
                // Naƒç√≠st aktualizovan√Ω seznam vozidel
                await loadVehicles();
                
                // P≈ôepnout na z√°lo≈æku s vozidly
                switchTab('vehicles');
                
                // Pokud je zobrazen detail vozidla, aktualizovat ho
                if (currentVehicleId) {
                    await showVehicleDetail(currentVehicleId);
                }
            } catch (error) {
                console.error('[ADD VEHICLE] Error:', error);
                showAlert('Nepoda≈ôilo se p≈ôidat vozidlo: ' + (error.message || 'Nezn√°m√° chyba'), 'error');
            }
        }

        // Promƒõnn√° pro aktu√°ln√≠ zobrazen√© vozidlo
        let currentVehicleId = null;

        // Zobrazen√≠ detailu vozidla
        async function showVehicleDetail(vehicleId) {
            currentVehicleId = vehicleId;
            
            // Skr√Ωt seznam a zobrazit detail
            document.getElementById('vehiclesList').style.display = 'none';
            document.getElementById('vehicleDetail').classList.add('active');
            
            try {
                // Naƒç√≠st data vozidla
                const vehicle = await apiCall(`/vehicles/${vehicleId}`, 'GET');
                
                // Zobrazit data vozidla
                document.getElementById('vehicleDetailTitle').textContent = vehicle.nickname || 'Detail vozidla';
                const vehicleInfo = document.getElementById('vehicleDetailInfo');
                vehicleInfo.innerHTML = `
                    <div class="vehicle-info-item">
                        <strong>N√°zev:</strong>
                        <span>${vehicle.nickname || 'Nezad√°no'}</span>
                    </div>
                    <div class="vehicle-info-item">
                        <strong>SPZ:</strong>
                        <span>${vehicle.plate || 'Nezad√°no'}</span>
                    </div>
                    <div class="vehicle-info-item">
                        <strong>VIN:</strong>
                        <span>${vehicle.vin || 'Nezad√°no'}</span>
                    </div>
                    ${vehicle.brand ? `
                    <div class="vehicle-info-item">
                        <strong>Znaƒçka:</strong>
                        <span>${vehicle.brand}</span>
                    </div>
                    ` : ''}
                    ${vehicle.model ? `
                    <div class="vehicle-info-item">
                        <strong>Model:</strong>
                        <span>${vehicle.model}</span>
                    </div>
                    ` : ''}
                    ${vehicle.year ? `
                    <div class="vehicle-info-item">
                        <strong>Rok v√Ωroby:</strong>
                        <span>${vehicle.year}</span>
                    </div>
                    ` : ''}
                    ${vehicle.engine ? `
                    <div class="vehicle-info-item">
                        <strong>Motor:</strong>
                        <span>${vehicle.engine}</span>
                    </div>
                    ` : ''}
                    ${vehicle.notes ? `
                    <div class="vehicle-info-item">
                        <strong>Pozn√°mky:</strong>
                        <span>${vehicle.notes}</span>
                    </div>
                    ` : ''}
                    <div class="vehicle-info-item">
                        <strong>P≈ôid√°no:</strong>
                        <span>${new Date(vehicle.created_at).toLocaleDateString('cs-CZ')}</span>
                    </div>
                `;
                
                // Naƒç√≠st servisn√≠ z√°znamy
                await loadServiceRecords(vehicleId);
            } catch (error) {
                console.error('Error loading vehicle detail:', error);
                showAlert('Chyba p≈ôi naƒç√≠t√°n√≠ detailu vozidla: ' + error.message, 'error');
            }
        }

        // Zobrazen√≠ seznamu vozidel
        function showVehiclesList() {
            document.getElementById('vehiclesList').style.display = 'block';
            document.getElementById('vehicleDetail').classList.remove('active');
            currentVehicleId = null;
        }

        // Naƒçten√≠ servisn√≠ch z√°znam≈Ø
        async function loadServiceRecords(vehicleId) {
            const container = document.getElementById('serviceRecordsList');
            container.innerHTML = '<div class="loading">Naƒç√≠t√°m servisn√≠ z√°znamy...</div>';
            
            try {
                const records = await apiCall(`/vehicles/${vehicleId}/service-records`, 'GET');
                
                if (!records || records.length === 0) {
                    container.innerHTML = '<p>Zat√≠m nejsou ≈æ√°dn√© servisn√≠ z√°znamy. P≈ôidejte prvn√≠ pomoc√≠ formul√°≈ôe n√≠≈æe.</p>';
                    return;
                }
                
                let html = '';
                records.forEach(record => {
                    const date = new Date(record.performed_at);
                    html += `
                        <div class="service-record-item">
                            <h4>${record.description}</h4>
                            <div class="record-date">${date.toLocaleDateString('cs-CZ')} ${date.toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'})}</div>
                            <div class="record-details">
                                ${record.mileage ? `<p><strong>N√°jezd:</strong> ${record.mileage.toLocaleString('cs-CZ')} km</p>` : ''}
                                ${record.note ? `<p><strong>Kategorie:</strong> ${record.note}</p>` : ''}
                            </div>
                            ${record.price ? `<div class="record-price">Cena: ${record.price.toLocaleString('cs-CZ')} Kƒç</div>` : ''}
                            <button onclick="deleteServiceRecord(${record.id})" style="margin-top: 10px; background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Smazat</button>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading service records:', error);
                container.innerHTML = `<p class="alert alert-error">Chyba p≈ôi naƒç√≠t√°n√≠ servisn√≠ch z√°znam≈Ø: ${error.message}</p>`;
            }
        }

        // P≈ôid√°n√≠ servisn√≠ho √∫konu
        async function handleAddService(event) {
            event.preventDefault();
            
            if (!currentVehicleId) {
                showAlert('Chyba: Vozidlo nen√≠ vybr√°no', 'error');
                return;
            }
            
            const dateInput = document.getElementById('serviceDate').value;
            const mileage = document.getElementById('serviceMileage').value;
            const description = document.getElementById('serviceDescription').value;
            const price = document.getElementById('servicePrice').value;
            const note = document.getElementById('serviceNote').value;
            
            if (!dateInput || !description) {
                showAlert('Vypl≈àte pros√≠m datum a popis √∫konu', 'error');
                return;
            }
            
            try {
                const recordData = {
                    performed_at: new Date(dateInput).toISOString(),
                    mileage: mileage ? parseInt(mileage) : null,
                    description: description,
                    price: price ? parseFloat(price) : null,
                    note: note || null
                };
                
                showAlert('P≈ôid√°v√°m servisn√≠ √∫kon...', 'info');
                await apiCall(`/vehicles/${currentVehicleId}/service-records`, 'POST', recordData);
                
                showAlert('Servisn√≠ √∫kon byl √∫spƒõ≈°nƒõ p≈ôid√°n!', 'success');
                
                // Vyƒçistit formul√°≈ô
                document.getElementById('serviceDate').value = '';
                document.getElementById('serviceMileage').value = '';
                document.getElementById('serviceDescription').value = '';
                document.getElementById('servicePrice').value = '';
                document.getElementById('serviceNote').value = '';
                
                // Naƒç√≠st aktualizovan√© servisn√≠ z√°znamy
                await loadServiceRecords(currentVehicleId);
            } catch (error) {
                console.error('Error adding service record:', error);
                showAlert('Nepoda≈ôilo se p≈ôidat servisn√≠ √∫kon: ' + error.message, 'error');
            }
        }

        // Smaz√°n√≠ servisn√≠ho z√°znamu
        async function deleteServiceRecord(recordId) {
            if (!confirm('Opravdu chcete smazat tento servisn√≠ z√°znam?')) {
                return;
            }
            
            try {
                await apiCall(`/service-records/${recordId}`, 'DELETE');
                showAlert('Servisn√≠ z√°znam byl smaz√°n', 'success');
                
                // Naƒç√≠st aktualizovan√© servisn√≠ z√°znamy
                if (currentVehicleId) {
                    await loadServiceRecords(currentVehicleId);
                }
            } catch (error) {
                console.error('Error deleting service record:', error);
                showAlert('Nepoda≈ôilo se smazat servisn√≠ z√°znam: ' + error.message, 'error');
            }
        }

        // P≈ôep√≠n√°n√≠ tab≈Ø
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            if (tab === 'vehicles') {
                document.querySelector('.tab').classList.add('active');
                document.getElementById('vehiclesTab').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('addVehicleTab').classList.add('active');
            }
        }

        // Zobrazen√≠ registrace
        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        // Zobrazen√≠ p≈ôihl√°≈°en√≠
        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        // Kontrola p≈ôihl√°≈°en√≠ p≈ôi naƒçten√≠ str√°nky
        window.addEventListener('DOMContentLoaded', () => {
            // Inicializovat API_URL
            function initApiUrl() {
                try {
                    API_URL = getApiBaseUrl();
                    console.log('[APP] API URL:', API_URL);
                } catch (e) {
                    console.error('[APP] Chyba p≈ôi inicializaci API_URL:', e);
                    API_URL = "http://127.0.0.1:8001"; // Fallback
                }
            }
            
            // Inicializovat API URL hned
            initApiUrl();
            
            // Nastavit DEV API URL panel (skr√Ωt v produkci)
            setupDevApiUrlPanel();
            
            // Zobrazit tlaƒç√≠tko konfigurace jen v DEV re≈æimu (ne v produkci)
            const isProduction = window.location.hostname === "hub.toozservis.cz";
            const location = getLocation();
            const urlParams = new URLSearchParams(location.search || '');
            const isAdmin = urlParams.get('admin') === '1';
            const configButton = document.getElementById('configButton');
            if (configButton) {
                // V produkci tlaƒç√≠tko skr√Ωt, v DEV zobrazit jen pro admina
                if (isProduction) {
                    configButton.classList.add('hidden');
                } else if (isAdmin) {
                    configButton.classList.remove('hidden');
                } else {
                    configButton.classList.add('hidden');
                }
            }
            
            // V DEV re≈æimu, pokud nen√≠ nastaven√° API URL a je admin, zobrazit konfiguraci
            if (!isProduction && !API_URL && isAdmin) {
                showApiUrlConfig();
            }
            
            // Kontrola stavu serveru p≈ôi naƒçten√≠
            checkServerStatus();
            
            // Pravideln√° kontrola stavu serveru ka≈æd√Ωch 30 sekund
            serverStatusCheckInterval = setInterval(checkServerStatus, 30000);
            
            // Naƒç√≠st ulo≈æen√Ω JWT token a u≈æivatele
            const savedToken = localStorage.getItem('accessToken');
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedToken) {
                accessToken = savedToken;
                console.log('[AUTH] Loaded saved JWT token');
            }
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    if (accessToken || currentUser.email) {
                        showDashboard();
                    }
                } catch (e) {
                    console.error('Error parsing saved user:', e);
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('accessToken');
                }
            }
            
            // Automatick√© naƒçten√≠ ARES p≈ôi zad√°n√≠ 8 ƒç√≠slic IƒåO
            const icoInput = document.getElementById('regIco');
            if (icoInput) {
                icoInput.addEventListener('input', (e) => {
                    const ico = e.target.value.trim();
                    if (ico.length === 8 && /^\d+$/.test(ico)) {
                        // Automaticky naƒç√≠st po zad√°n√≠ 8 ƒç√≠slic
                        setTimeout(() => loadAresData(), 500);
                    }
                });
            }
            
            // Automatick√© dek√≥dov√°n√≠ VIN p≈ôi zad√°n√≠ 17 znak≈Ø
            // Pou≈æijeme event delegation, proto≈æe formul√°≈ô m≈Ø≈æe b√Ωt skryt√Ω p≈ôi naƒçten√≠ str√°nky
            document.addEventListener('input', (e) => {
                if (e.target && e.target.id === 'vehicleVin') {
                    const vin = e.target.value.trim().toUpperCase();
                    e.target.value = vin; // Automaticky p≈ôev√©st na velk√° p√≠smena
                    console.log('[VIN] Input event, VIN length:', vin.length);
                    if (vin.length === 17) {
                        // Automaticky naƒç√≠st po zad√°n√≠ 17 znak≈Ø
                        console.log('[VIN] Auto-loading VIN data...');
                        setTimeout(() => loadVinData(), 500);
                    }
                }
            });
            
            // Tak√© p≈ôidat event listener p≈ô√≠mo na element, pokud existuje
            const vinInput = document.getElementById('vehicleVin');
            if (vinInput) {
                console.log('[VIN] Direct event listener added');
                vinInput.addEventListener('input', (e) => {
                    const vin = e.target.value.trim().toUpperCase();
                    e.target.value = vin;
                    if (vin.length === 17) {
                        console.log('[VIN] Auto-loading VIN data (direct listener)...');
                        setTimeout(() => loadVinData(), 500);
                    }
                });
            }
        });

        // Vyƒçistit interval p≈ôi opu≈°tƒõn√≠ str√°nky
        window.addEventListener('beforeunload', () => {
            if (serverStatusCheckInterval) {
                clearInterval(serverStatusCheckInterval);
            }
        });
    </script>
</body>
</html>

<!-- Test zmƒõna -->
<!-- Test automatick√© aktualizace Po¬†24.¬†listopadu¬†2025,¬†08:44:37¬†CET -->
<!-- Test 1763970302 -->
<!-- test --><!-- Test 1763970358 -->
<!-- Test zmƒõna pro automatickou aktualizaci -->
