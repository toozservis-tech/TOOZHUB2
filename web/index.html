<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>TooZ Hub 2</title>
    <link rel="stylesheet" href="theme.css" />
    <link rel="stylesheet" href="app.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .container {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            background: #f8fafc;
            border-radius: 0 !important;
            box-shadow: none !important;
            overflow: visible;
            min-height: 100vh !important;
        }

        /* Staré .header styly odstraněny - používá se navbar z theme.css */

        .content {
            width: 100% !important;
            max-width: 900px !important;
            margin: 32px auto !important;
            padding: 24px 28px 32px !important;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            color: #1e293b;
        }

        .auth-section {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .auth-section h2 {
            color: #1e293b;
        }

        /* Form styly jsou nyní v theme.css */

        /* Kompaktní formulář s grid layoutem - 2 sloupce */
        .form-compact {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            max-width: 800px;
            margin: 0 auto;
        }

        .form-compact .form-group {
            margin-bottom: 0;
        }

        .form-compact .form-group.full-width {
            grid-column: 1 / -1;
        }

        /* VIN přes celou šířku */
        .form-compact .form-group:nth-child(1) {
            grid-column: 1 / -1;
        }

        /* Poznámky přes celou šířku (nyní 9. pole kvůli kódu motoru) */
        .form-compact .form-group:nth-child(9) {
            grid-column: 1 / -1;
        }

        /* Na malých obrazovkách 1 sloupec */
        @media (max-width: 768px) {
            .form-compact {
                grid-template-columns: 1fr;
            }
        }

        /* Kompaktnější inputy v formuláři pro vozidla */
        #addVehicleTab {
            padding: 20px;
            max-width: 850px;
            margin: 0 auto;
        }

        /* Specifické styly pro addVehicleTab - kompaktnější design */
        #addVehicleTab .form-group label {
            font-size: 0.85rem;
            margin-bottom: 4px;
            font-weight: 500;
        }

        #addVehicleTab .form-group input,
        #addVehicleTab .form-group textarea {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        #addVehicleTab h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            margin-top: 0;
            color: #1e293b;
            text-align: center;
        }

        .dashboard h2 {
            color: #1e293b;
        }

        .dashboard h3 {
            color: #334155;
        }

        #addVehicleTab .btn {
            padding: 7px 14px;
            font-size: 12px;
        }

        .btn {
            width: 100%;
            padding: 10px 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.5);
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #475569;
        }

        .btn-secondary:hover {
            background: #64748b;
            box-shadow: 0 8px 20px rgba(71, 85, 105, 0.5);
        }

        .alert {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.15);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 2px solid rgba(239, 68, 68, 0.5);
            font-weight: 500;
            padding: 15px 20px;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.15);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .alert-warning {
            background: rgba(251, 191, 36, 0.15);
            color: #fcd34d;
            border: 2px solid rgba(251, 191, 36, 0.5);
            font-weight: 500;
            padding: 15px 20px;
        }

        .hidden {
            display: none;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .user-info {
            background: rgba(15, 23, 42, 0.98);
            padding: 16px 20px;
            border-radius: 14px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(148, 163, 184, 0.35);
            color: #e5e7eb;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .user-info strong {
            color: #f9fafb;
        }

        /* Karty vozidel nyní používají styly z theme.css (.cards-grid, .card) */
        /* Staré .vehicles-grid a .vehicle-card styly odstraněny - používají se z theme.css */

        /* Rozbalovací panel pro detail vozidla */
        .vehicle-card-expandable {
            overflow: hidden;
        }

        .vehicle-card-header {
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            transition: background 0.2s;
        }

        .vehicle-card-header:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .vehicle-card-header.expanded {
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        .vehicle-card-toggle {
            font-size: 20px;
            color: #94a3b8;
            transition: transform 0.3s ease, color 0.2s;
            flex-shrink: 0;
            margin-left: 12px;
        }

        .vehicle-card-header.expanded .vehicle-card-toggle {
            transform: rotate(180deg);
            color: #6366f1;
        }

        .vehicle-card-preview {
            padding: 0 16px 16px;
        }

        .vehicle-card-detail {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease, opacity 0.3s ease;
            background: rgba(15, 23, 42, 0.3);
            opacity: 0;
        }

        .vehicle-card-detail.expanded {
            max-height: 10000px;
            padding: 20px 16px;
            opacity: 1;
        }

        .vehicle-card-detail-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .vehicle-card-detail-section {
            background: rgba(30, 41, 59, 0.6);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.15);
        }

        .vehicle-card-detail-section h4 {
            margin: 0 0 16px 0;
            color: #cbd5e1;
            font-size: 16px;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        /* Modal okno pro detail vozidla */
        .vehicle-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
            padding: 0;
            margin: 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .vehicle-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }

        .vehicle-modal-content {
            position: relative;
            background: #1e293b;
            border-radius: 12px;
            width: 95%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
            z-index: 10001;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .vehicle-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            background: rgba(30, 41, 59, 0.8);
            flex-shrink: 0;
        }

        .vehicle-modal-header h2 {
            margin: 0;
            color: #f1f5f9;
            font-size: 18px;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            margin-right: 12px;
        }

        .vehicle-modal-close {
            background: transparent;
            border: none;
            color: #94a3b8;
            font-size: 28px;
            line-height: 1;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .vehicle-modal-close:hover {
            background: rgba(148, 163, 184, 0.2);
            color: #f1f5f9;
        }

        .vehicle-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            max-height: calc(85vh - 65px);
            -webkit-overflow-scrolling: touch;
        }

        .vehicle-modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .vehicle-modal-body::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 4px;
        }

        .vehicle-modal-body::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.3);
            border-radius: 4px;
        }

        .vehicle-modal-body::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.5);
        }

        .vehicle-modal-content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .vehicle-modal-section {
            background: rgba(30, 41, 59, 0.6);
            padding: 16px;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.15);
        }

        .vehicle-modal-section h3 {
            margin: 0 0 16px 0;
            color: #cbd5e1;
            font-size: 16px;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        /* Responzivní modal */
        @media (max-width: 768px) {
            .vehicle-modal {
                padding: 0;
                align-items: flex-start;
            }

            .vehicle-modal-content {
                width: 100%;
                max-width: 100%;
                max-height: 100dvh;
                border-radius: 0;
                height: 100dvh;
                margin: 0;
                box-sizing: border-box;
            }

            .vehicle-modal-content-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .vehicle-modal-header {
                padding: 16px;
                position: sticky;
                top: 0;
                z-index: 10;
                background: rgba(30, 41, 59, 0.95);
                backdrop-filter: blur(10px);
            }

            .vehicle-modal-header h2 {
                font-size: 18px;
            }

            .vehicle-modal-close {
                width: 40px;
                height: 40px;
                font-size: 28px;
                min-width: 40px;
            }

            .vehicle-modal-body {
                padding: 16px;
                max-height: calc(100dvh - 70px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
                padding-bottom: 20px;
                box-sizing: border-box;
            }

            .vehicle-modal-section {
                padding: 16px;
            }

            .vehicle-modal-section h3 {
                font-size: 16px;
                margin-bottom: 14px;
                padding-bottom: 10px;
            }

            .vehicle-info-row {
                padding: 10px 0;
                gap: 12px;
            }

            .vehicle-info-label {
                font-size: 12px;
                min-width: 80px;
            }

            .vehicle-info-value {
                font-size: 14px;
            }

            .vehicle-info-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .add-service-form {
                padding: 16px;
                margin-top: 16px;
            }

            .add-service-form h4 {
                font-size: 15px;
                margin-bottom: 14px;
            }
        }

        /* ============================================
           COMMAND BOT - PLOVOUCÍ BUBLINA A CHAT
           ============================================ */
        
        .command-bot-bubble {
            position: fixed !important;
            bottom: 20px !important;
            right: 20px !important;
            width: 60px !important;
            height: 60px !important;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%) !important;
            border-radius: 50% !important;
            display: none !important; /* Výchozí skrytá, JavaScript ji zobrazí */
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4) !important;
            z-index: 1000 !important;
            transition: all 0.3s ease !important;
            color: white !important;
        }
        
        .command-bot-bubble.show {
            display: flex !important;
        }

        .command-bot-bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
        }

        .command-bot-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .command-bot-chat {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 380px;
            max-width: calc(100vw - 40px);
            height: 500px;
            max-height: calc(100vh - 120px);
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .command-bot-chat-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 16px 16px 0 0;
        }

        .command-bot-chat-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .command-bot-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .command-bot-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .command-bot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .command-bot-welcome {
            background: white;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            color: #1e293b;
            font-size: 14px;
            line-height: 1.6;
        }

        .command-bot-message {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.5;
        }

        .command-bot-message.user {
            background: #6366f1;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .command-bot-message.bot {
            background: white;
            color: #1e293b;
            align-self: flex-start;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 4px;
        }

        .command-bot-message.bot.error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #991b1b;
        }

        .command-bot-message-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 8px;
            font-weight: 500;
        }

        .command-bot-input-container {
            padding: 16px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 8px;
        }

        .command-bot-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }

        .command-bot-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .command-bot-send {
            padding: 10px 20px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .command-bot-send:hover {
            background: #4f46e5;
        }

        .command-bot-send:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .command-bot-chat {
                width: calc(100vw - 20px);
                right: 10px;
                bottom: 80px;
                height: calc(100vh - 100px);
                max-height: calc(100vh - 100px);
            }

            .command-bot-bubble {
                bottom: 15px;
                right: 15px;
                width: 56px;
                height: 56px;
            }
        }

        @media (max-width: 480px) {
            .command-bot-chat {
                width: 100vw;
                right: 0;
                bottom: 0;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }

            .command-bot-chat-header {
                border-radius: 0;
            }

            .command-bot-bubble {
                bottom: 10px;
                right: 10px;
                width: 52px;
                height: 52px;
            }
        }

        /* Velmi malé mobily */
        @media (max-width: 480px) {
            .vehicle-modal-header {
                padding: 14px;
            }

            .vehicle-modal-header h2 {
                font-size: 16px;
            }

            .vehicle-modal-close {
                width: 36px;
                height: 36px;
                font-size: 24px;
            }

            .vehicle-modal-body {
                padding: 14px;
                max-height: calc(100dvh - 65px);
            }

            .vehicle-modal-section {
                padding: 14px;
            }

            .vehicle-modal-section h3 {
                font-size: 15px;
                margin-bottom: 12px;
                padding-bottom: 8px;
            }

            .vehicle-info-row {
                padding: 10px 0;
                gap: 10px;
                flex-wrap: wrap;
            }

            .vehicle-info-label {
                font-size: 12px;
                min-width: 70px;
                width: 100%;
            }

            .vehicle-info-value {
                font-size: 14px;
                width: 100%;
                text-align: left;
            }

            .vehicle-info-display {
                width: 100% !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 8px !important;
            }

            .vehicle-info-display .vehicle-info-value {
                width: 100% !important;
                text-align: left !important;
            }

            .vehicle-info-display .vehicle-info-btn {
                align-self: flex-end;
            }

            .vehicle-info-btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .vehicle-info-edit {
                width: 100%;
                flex-direction: column;
                gap: 8px;
            }

            .vehicle-info-edit input,
            .vehicle-info-edit textarea {
                padding: 8px 10px;
                font-size: 14px;
                width: 100%;
            }

            .vehicle-info-actions {
                width: 100%;
                display: flex;
                gap: 8px;
            }

            .vehicle-info-actions .vehicle-info-btn {
                flex: 1;
            }

            .add-service-form {
                padding: 14px;
                margin-top: 14px;
            }

            .add-service-form h4 {
                font-size: 14px;
                margin-bottom: 12px;
            }

            .service-record-item {
                padding: 12px;
                margin-bottom: 12px;
            }

            .form-group {
                margin-bottom: 14px;
            }

            .form-group label {
                font-size: 13px;
                margin-bottom: 6px;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                padding: 10px;
                font-size: 14px;
            }
        }

        /* Detail vozidla (zachováno pro zpětnou kompatibilitu) */
        .vehicle-detail {
            display: none;
        }

        .vehicle-detail.active {
            display: block;
        }

        .vehicle-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(55, 65, 81, 0.9);
        }

        .vehicle-detail-header h2 {
            margin: 0;
            color: #6366f1;
        }

        .vehicle-detail-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }

        .vehicle-detail-left, .vehicle-detail-right {
            background: rgba(30, 41, 59, 0.6);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.15);
        }

        .vehicle-detail-left h3, .vehicle-detail-right h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #cbd5e1;
            font-size: 18px;
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        /* Minimalistický design pro data vozidla */
        .vehicle-info-list {
            margin-top: 0;
        }

        .vehicle-info-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            gap: 16px;
            min-width: 0;
        }

        .vehicle-info-row:last-child {
            border-bottom: none;
        }

        .vehicle-info-row.editable {
            align-items: flex-start;
        }

        .vehicle-info-label {
            color: #94a3b8;
            font-size: 12px;
            font-weight: 500;
            min-width: 90px;
            flex-shrink: 0;
        }

        .vehicle-info-value {
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 400;
            flex: 1;
            word-break: break-word;
            text-align: right;
        }

        .vehicle-info-display {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex: 1;
            gap: 12px;
            min-width: 0;
        }

        .vehicle-info-display .vehicle-info-value {
            text-align: right;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .vehicle-info-value.empty {
            color: #64748b;
            font-style: italic;
        }

        .vehicle-info-edit {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .vehicle-info-edit input,
        .vehicle-info-edit textarea {
            flex: 1;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 6px;
            padding: 7px 10px;
            color: #f1f5f9;
            font-size: 14px;
            font-weight: 400;
            font-family: inherit;
            transition: all 0.2s;
        }

        .vehicle-info-edit input:focus,
        .vehicle-info-edit textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
            background: rgba(15, 23, 42, 0.95);
        }

        .vehicle-info-edit textarea {
            min-height: 80px;
            resize: vertical;
        }

        .vehicle-info-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .vehicle-info-btn {
            background: transparent;
            border: 1px solid rgba(148, 163, 184, 0.25);
            color: #cbd5e1;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .vehicle-info-btn:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: #6366f1;
            color: #6366f1;
        }

        .vehicle-info-btn.save {
            background: #6366f1;
            border-color: #6366f1;
            color: white;
        }

        .vehicle-info-btn.save:hover {
            background: #4f46e5;
            border-color: #4f46e5;
        }

        .vehicle-info-btn.cancel {
            background: transparent;
            border-color: rgba(148, 163, 184, 0.25);
            color: #94a3b8;
        }

        .vehicle-info-btn.cancel:hover {
            background: rgba(148, 163, 184, 0.1);
            color: #cbd5e1;
        }

        /* Starý styl pro zpětnou kompatibilitu */
        .vehicle-info-item {
            margin: 15px 0;
            padding: 10px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .vehicle-info-item strong {
            color: #e5e7eb;
            display: block;
            margin-bottom: 5px;
        }

        .vehicle-info-item span {
            color: #9ca3af;
        }

        .service-records-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .service-record-item {
            background: rgba(30, 41, 59, 0.8);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 12px;
            border-left: 4px solid #6366f1;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        /* AI záznamy - speciální styl */
        .ai-service-records-list {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        .service-record-item.ai-record {
            background: rgba(99, 102, 241, 0.15);
            border-left: 3px solid #6366f1;
        }

        /* Modal pro detail servisního záznamu - menší velikost */
        .service-record-detail-modal {
            max-width: 400px !important;
            width: 33% !important;
        }

        /* Modal pro přidání servisního záznamu - menší velikost */
        .service-record-add-modal {
            max-width: 400px !important;
            width: 33% !important;
        }

        @media (max-width: 768px) {
            .service-record-detail-modal,
            .service-record-add-modal {
                width: 90% !important;
                max-width: 90% !important;
            }

            .category-dropdown {
                max-height: 250px;
            }

            .category-option {
                padding: 10px 14px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .service-record-detail-modal,
            .service-record-add-modal {
                width: 95% !important;
                max-width: 95% !important;
            }

            .service-records-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .service-record-tile {
                min-height: 70px;
                padding: 10px;
            }

            .service-record-tile .tile-category {
                font-size: 13px;
            }

            .category-dropdown {
                max-height: 200px;
            }

            .category-option {
                padding: 8px 12px;
                font-size: 13px;
            }
        }

        /* Dlaždice pro servisní záznamy */
        .service-records-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        @media (max-width: 768px) {
            .service-records-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }

            .service-record-tile {
                min-height: 80px;
                padding: 12px;
            }

            .service-record-tile .tile-category {
                font-size: 14px;
            }

            .service-record-tile .tile-date {
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .service-records-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .service-record-tile {
                min-height: 70px;
                padding: 10px;
            }

            .service-record-tile .tile-category {
                font-size: 13px;
            }
        }

        .service-record-tile {
            background: rgba(30, 41, 59, 0.8);
            padding: 16px;
            border-radius: 10px;
            border: 2px solid rgba(148, 163, 184, 0.2);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .service-record-tile:hover {
            border-color: #6366f1;
            background: rgba(30, 41, 59, 0.95);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .service-record-tile.ai-tile {
            background: rgba(99, 102, 241, 0.15);
            border-color: #6366f1;
        }

        .service-record-tile .tile-category {
            font-size: 16px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 8px;
        }

        .service-record-tile .tile-date {
            font-size: 12px;
            color: #94a3b8;
        }

        .service-record-tile .tile-ai-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 18px;
        }

        /* Rozbalovací panel pro výběr kategorie */
        .category-selector {
            position: relative;
        }

        .category-selector-button {
            width: 100%;
            padding: 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }

        .category-selector-button:hover {
            border-color: #6366f1;
            background: rgba(15, 23, 42, 0.95);
        }

        .category-selector-button.open {
            border-color: #6366f1;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .category-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.98);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 10002;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 768px) {
            .category-dropdown {
                max-height: 250px;
            }

            .category-option {
                padding: 10px 14px;
                font-size: 14px;
            }
        }

        .category-dropdown.open {
            display: block;
        }

        .category-option {
            padding: 12px 16px;
            color: #e2e8f0;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .category-option:last-child {
            border-bottom: none;
        }

        .category-option:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .category-option.selected {
            background: rgba(99, 102, 241, 0.3);
            color: #6366f1;
            font-weight: 600;
        }

        .service-record-item h4 {
            margin: 0 0 10px 0;
            color: #e5e7eb;
        }

        .service-record-item .record-date {
            color: #9ca3af;
            font-size: 0.9em;
        }

        .service-record-item .record-details {
            margin-top: 10px;
            color: #9ca3af;
        }

        .service-record-item .record-price {
            font-weight: bold;
            color: #6366f1;
            margin-top: 10px;
        }

        .add-service-form {
            margin-top: 20px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .add-service-form h4 {
            margin-top: 0;
            margin-bottom: 14px;
            color: #cbd5e1;
            font-size: 15px;
            font-weight: 600;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .form-row.full-width {
            grid-template-columns: 1fr;
        }

        .back-button {
            background: #475569;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .back-button:hover {
            background: #64748b;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        /* Tabs styly jsou nyní v theme.css - používají světlý design */
        .tabs {
            /* Používá styly z theme.css */
        }

        .tab {
            /* Používá styly z theme.css */
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .status-online {
            background: #51cf66 !important;
            animation: none !important;
        }

        .status-offline {
            background: #ff6b6b !important;
        }

        .status-checking {
            background: #ffd43b !important;
        }

        .api-url-config {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .api-url-config {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 20px;
            color: #e5e7eb;
        }

        .api-url-config h3 {
            margin-top: 0;
            color: #6366f1;
        }

        .api-url-config p {
            color: #9ca3af;
        }

        .api-url-input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .api-url-input-group input {
            flex: 1;
            padding: 10px;
            background: #020617;
            color: #f9fafb;
            border: 1px solid #374151;
            border-radius: 8px;
            font-size: 14px;
        }

        .api-url-input-group input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.4);
        }

        .api-url-input-group button {
            padding: 10px 20px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .api-url-input-group button:hover {
            background: #7c3aed;
        }

        .config-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .config-button:hover {
            background: rgba(255,255,255,0.3);
        }

        /* ========================================
           AGRESIVNÍ CSS PRO CELOU OBRAZOVKU
           Přepíše všechny možné wrappery
           ======================================== */
        html, body {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow-x: hidden !important;
        }

        /* Další možné wrappery */
        .main-container, 
        .page-content,
        #container,
        #content,
        #main-container,
        #page-content {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }

        /* Odstranění všech možných okrajů a paddingů z rodičovských elementů */
        body > * {
            max-width: 100% !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
        }


        /* Zajištění, že vše zabírá celou šířku */
        * {
            box-sizing: border-box;
        }

        /* Odstranění všech možných omezujících šířek */
        [class*="container"],
        [class*="wrapper"],
        [class*="content"],
        [class*="main"],
        [class*="page"],
        [id*="container"],
        [id*="wrapper"],
        [id*="content"],
        [id*="main"],
        [id*="page"] {
            max-width: 100% !important;
        }

        /* ========================================
           RESPONSIVNÍ STYLY - MOBILNÍ OPTIMALIZACE
           ======================================== */
        
        /* Tablet a menší (≤ 768px) */
        @media (max-width: 768px) {
            body {
                font-size: 15px;
            }

            h1 {
                font-size: 1.4rem;
            }

            h2 {
                font-size: 1.2rem;
            }

            .content {
                margin: 16px !important;
                padding: 18px 16px 24px !important;
                border-radius: 14px !important;
            }

            /* Staré .header styly odstraněny - používá se navbar z theme.css */

            .user-info {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .tabs {
                gap: 16px;
                flex-wrap: wrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }

            .tabs::-webkit-scrollbar {
                height: 4px;
            }

            .tab {
                padding: 8px 12px;
                font-size: 14px;
                white-space: nowrap;
                min-height: 44px;
            }

            /* Two-column layout → single column */
            .vehicle-detail-content {
                grid-template-columns: 1fr !important;
                gap: 20px;
            }

            /* Minimalistický design - responzivní */
            .vehicle-info-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .vehicle-info-label {
                min-width: auto;
            }

            .vehicle-info-display {
                width: 100%;
                flex-direction: column;
                align-items: flex-start !important;
                gap: 8px;
            }

            .vehicle-info-edit {
                width: 100%;
                flex-direction: column;
            }

            /* Rozbalovací panel - responzivní */
            .vehicle-card-detail {
                max-height: none !important;
            }

            .vehicle-card-detail.expanded {
                max-height: none !important;
            }

            .vehicle-card-detail-content {
                grid-template-columns: 1fr;
            }

            .form-compact {
                grid-template-columns: 1fr !important;
            }

            .form-row {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }

            /* Vehicles grid - 1 sloupec na mobilu */
            /* Karty vozidel používají .cards-grid z theme.css */

            /* Service records - odstranit nested scroll na mobilu */
            .service-records-list {
                max-height: none !important;
                overflow-y: visible !important;
            }

            /* Buttons - full width na mobilu */
            .btn {
                min-height: 44px; /* Touch-friendly */
                font-size: 15px;
            }

            /* Form inputs - větší pro mobil */
            .form-group input,
            .form-group textarea,
            .form-group select {
                min-height: 44px;
                font-size: 16px; /* Zabraňuje zoomu na iOS */
                padding: 12px;
            }

            .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
            }

            /* Karty vozidel používají .card z theme.css */

            /* Add service form */
            .add-service-form {
                padding: 16px;
            }

            /* Připomínky - optimalizace pro tablet */
            #remindersContainer .form-group input,
            #remindersContainer .form-group select,
            #remindersContainer .form-group textarea {
                min-height: 44px;
                font-size: 16px;
            }

            /* Rezervace - optimalizace pro tablet */
            #reservationsContainer .form-group input,
            #reservationsContainer .form-group select,
            #reservationsContainer .form-group textarea {
                min-height: 44px;
                font-size: 16px;
            }

            /* Profil - optimalizace pro tablet */
            #profileContainer .form-row {
                grid-template-columns: 1fr !important;
            }

            /* Navbar - optimalizace pro tablet */
            .navbar {
                flex-wrap: wrap;
            }

            .navbar-stats {
                font-size: 0.9rem;
            }
        }

        /* Mobilní telefony (≤ 480px) */
        @media (max-width: 480px) {
            body {
                font-size: 15px;
            }

            h1 {
                font-size: 1.3rem;
            }

            h2 {
                font-size: 1.1rem;
            }

            h3 {
                font-size: 1rem;
            }

            /* Staré .header styly odstraněny - používá se navbar z theme.css */

            .content {
                margin: 12px !important;
                padding: 16px 12px 20px !important;
            }

            /* Auth section - full width na malém mobilu */
            .auth-section {
                max-width: 100%;
                padding: 20px;
            }

            /* User info - kompaktnější */
            .user-info {
                padding: 12px 16px;
                font-size: 14px;
            }

            /* Tabs - menší gap */
            .tabs {
                gap: 12px;
                padding-bottom: 8px;
            }

            .tab {
                padding: 8px 10px;
                font-size: 13px;
            }

            /* Form rows - vždy 1 sloupec */
            .form-row {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }

            /* Vehicle detail */
            .vehicle-detail-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .vehicle-detail-left,
            .vehicle-detail-right {
                padding: 16px;
            }

            /* Minimalistický design - mobil */
            .vehicle-info-row {
                padding: 12px 0;
            }

            .vehicle-info-label {
                font-size: 13px;
            }

            .vehicle-info-value {
                font-size: 15px;
            }

            .vehicle-info-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            /* Service records - žádný max-height */
            .service-records-list {
                max-height: none !important;
                overflow-y: visible !important;
            }

            .service-record-item {
                padding: 12px;
            }

            /* Buttons - full width */
            .btn {
                width: 100%;
                min-height: 44px;
                margin-bottom: 10px;
            }

            /* Input groups - full width */
            .api-url-input-group {
                flex-direction: column;
            }

            .api-url-input-group input,
            .api-url-input-group button {
                width: 100%;
                margin-bottom: 8px;
            }

            /* Word wrap pro dlouhé texty */
            .vehicle-info-item,
            .service-record-item,
            .vehicle-card {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            /* Připomínky - optimalizace pro mobil */
            #remindersContainer .card,
            #remindersContainer [style*="background: rgba(30, 41, 59"] {
                margin: 12px 0;
                padding: 16px;
                border-radius: 12px;
            }

            #remindersContainer .form-group {
                margin-bottom: 16px;
            }

            #remindersContainer .form-group input,
            #remindersContainer .form-group select,
            #remindersContainer .form-group textarea {
                width: 100% !important;
                min-height: 44px;
                font-size: 16px;
                padding: 12px;
            }

            #remindersContainer .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
                display: block;
            }

            #remindersContainer button {
                width: 100%;
                min-height: 44px;
                margin-top: 10px;
            }

            /* Rezervace - optimalizace pro mobil */
            #reservationsContainer .card,
            #reservationsContainer [style*="background: rgba(30, 41, 59"] {
                margin: 12px 0;
                padding: 16px;
                border-radius: 12px;
            }

            #reservationsContainer .form-group {
                margin-bottom: 16px;
            }

            #reservationsContainer .form-group input,
            #reservationsContainer .form-group select,
            #reservationsContainer .form-group textarea {
                width: 100% !important;
                min-height: 44px;
                font-size: 16px;
                padding: 12px;
            }

            #reservationsContainer .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
                display: block;
            }

            #reservationsContainer button {
                width: 100%;
                min-height: 44px;
                margin-top: 10px;
            }

            /* Profil - optimalizace pro mobil */
            #profileContainer .form-row {
                grid-template-columns: 1fr !important;
                gap: 16px;
            }

            #profileContainer .form-group {
                margin-bottom: 16px;
            }

            #profileContainer .form-group input,
            #profileContainer .form-group select,
            #profileContainer .form-group textarea {
                width: 100%;
                min-height: 44px;
                font-size: 16px;
                padding: 12px;
            }

            #profileContainer .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
                display: block;
            }

            #profileContainer button {
                width: 100%;
                min-height: 44px;
                margin-bottom: 10px;
            }

            /* Add vehicle tab - optimalizace pro mobil */
            #addVehicleTab {
                padding: 16px 12px !important;
                max-width: 100% !important;
            }

            #addVehicleTab .form-compact {
                grid-template-columns: 1fr !important;
                gap: 16px;
            }

            #addVehicleTab .form-group {
                margin-bottom: 16px;
            }

            #addVehicleTab .form-group input,
            #addVehicleTab .form-group select,
            #addVehicleTab .form-group textarea {
                width: 100%;
                min-height: 44px;
                font-size: 16px;
                padding: 12px;
            }

            #addVehicleTab .form-group label {
                font-size: 14px;
                margin-bottom: 6px;
            }

            #addVehicleTab button {
                width: 100%;
                min-height: 44px;
                margin-top: 10px;
            }

            /* Navbar - optimalizace pro mobil */
            .navbar {
                padding: 12px 16px !important;
                flex-wrap: wrap;
            }

            .navbar-brand {
                font-size: 1rem;
            }

            .navbar-stats {
                font-size: 0.85rem;
                margin-top: 8px;
                width: 100%;
            }

            /* Karty vozidel - optimalizace pro mobil */
            .cards-grid {
                grid-template-columns: 1fr !important;
                gap: 16px;
            }

            .card {
                padding: 16px;
            }

            .card-header h3 {
                font-size: 1.1rem;
            }

            .card-body {
                font-size: 0.9rem;
            }

            /* Detail vozidla - optimalizace pro mobil */
            .vehicle-detail-content {
                grid-template-columns: 1fr !important;
                gap: 16px;
                margin: 16px 0;
            }

            .vehicle-detail-left,
            .vehicle-detail-right {
                padding: 16px;
            }

            .vehicle-info-item {
                padding: 12px;
                margin: 10px 0;
            }

            /* Add service form - optimalizace pro mobil */
            .add-service-form {
                padding: 16px;
                margin: 16px 0;
            }

            .add-service-form .form-row {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }
        }
        
        /* AI Features styly */
        .ai-features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }
        
        .ai-feature-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .ai-feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }
        
        .ai-feature-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .ai-feature-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: #1e293b;
            flex: 1;
        }
        
        .ai-feature-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-low {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-medium {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-high {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .ai-feature-description {
            color: #64748b;
            margin-bottom: 16px;
            line-height: 1.6;
        }
        
        .ai-feature-reasoning {
            background: #f1f5f9;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
            color: #475569;
        }
        
        .ai-feature-meta {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .ai-feature-meta-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .ai-feature-meta-item .label {
            font-weight: 600;
            color: #475569;
            min-width: 120px;
        }
        
        .priority-bar {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .priority-fill {
            height: 100%;
            transition: width 0.3s;
        }
        
        .ai-feature-meta-item .value {
            color: #1e293b;
            font-weight: 500;
        }
        
        .ai-feature-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.875rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #6366f1;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 0.875rem;
        }
        
        .top-endpoints {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 24px;
        }
        
        .top-endpoints h4 {
            margin: 0 0 16px 0;
            color: #1e293b;
        }
        
        .top-endpoints ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .top-endpoints li {
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
            color: #475569;
        }
        
        .top-endpoints li:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 768px) {
            .ai-features-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Velmi malé telefony (≤ 360px) */
        @media (max-width: 360px) {
            .header h1 {
                font-size: 1rem;
            }

            .content {
                margin: 8px !important;
                padding: 12px 10px 16px !important;
            }

            .auth-section {
                padding: 16px;
            }

            .btn {
                font-size: 14px;
                padding: 10px 16px;
            }
        }
    </style>
    
    <!-- Security Protection - Anti-debugging a ochrana kódu -->
    <!-- DOČASNĚ ÚPLNĚ ZAKÁZÁNO - způsobovalo zmizení aplikace -->
    <!-- <script src="security_protection.js"></script> -->
</head>
<body>
    <div class="container">
        <!-- Navbar (pouze když je uživatel přihlášen) -->
        <nav class="navbar hidden" id="mainNavbar">
            <div class="navbar-brand">
                <span class="logo">🚗</span>
                <span class="brand-text">TooZ Hub 2 <span id="navbarVersion" style="font-size: 0.75em; opacity: 0.8; font-weight: normal;">v2.2.0</span></span>
            </div>
            <div class="navbar-stats">
                <span id="userBadge" class="stat-badge hidden">
                    <strong>Přihlášen jako:</strong> <span id="userEmail"></span>
                </span>
                <span id="serverStatus" class="stat-badge">
                    <div id="statusIndicator" style="width: 10px; height: 10px; border-radius: 50%; background: #ff6b6b; display: inline-block; margin-right: 6px;"></div>
                    <span id="statusText">Kontroluji server...</span>
                </span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <button id="configButton" class="config-button hidden" onclick="showApiUrlConfig()" title="Nastavit API URL (pouze pro admina)" style="background: transparent; border: none; font-size: 20px; cursor: pointer; padding: 5px;">⚙️</button>
                <button id="logout-btn" class="btn-logout hidden" onclick="handleLogout()" data-testid="btn-logout">Odhlásit se</button>
            </div>
        </nav>

        <div class="content">
            <!-- Konfigurace API URL (pouze pro DEV) -->
            <div id="dev-api-url-panel" class="api-url-config hidden">
                <h3>🔧 Nastavení API URL (DEV)</h3>
                <p style="margin: 10px 0; color: #856404;">
                    Pro lokální vývoj můžete nastavit vlastní API URL.
                    <br><strong>Postup:</strong>
                    <br>1. Zadejte URL vašeho API serveru (např. http://127.0.0.1:8001)
                    <br>2. Klikněte na "Uložit"
                </p>
                <div class="api-url-input-group">
                    <input type="text" id="apiUrlInput" placeholder="http://127.0.0.1:8001" value="">
                    <button onclick="saveApiUrl()">Uložit</button>
                    <button onclick="hideApiUrlConfig()" style="background: #6c757d; color: white;">Zavřít</button>
                </div>
                <p id="currentApiUrl" style="margin-top: 10px; font-size: 12px; color: #856404;"></p>
            </div>

            <!-- Přihlašovací sekce -->
            <div id="authSection" class="auth-section">
                <div id="alertContainer" data-testid="alert-container"></div>
                
                <div id="loginForm" data-testid="login-form">
                    <h2 style="margin-bottom: 20px; text-align: center;">Přihlášení</h2>
                    <div class="form-group">
                        <label for="loginEmail">Email:</label>
                        <input type="email" id="loginEmail" data-testid="input-email" placeholder="email@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Heslo:</label>
                        <input type="password" id="loginPassword" data-testid="input-password" placeholder="Heslo" required>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="handleLogin()" data-testid="btn-login" style="flex: 1;">Přihlásit se</button>
                        <button class="btn btn-secondary" onclick="showRegister()" data-testid="btn-show-register" style="flex: 1;">Registrace</button>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="#" onclick="handleForgotPassword(); return false;" style="color: #6366f1; text-decoration: none; font-size: 0.9em;">Zapomenuté heslo?</a>
                    </div>
                    <div id="resetPasswordContainer" style="margin-top: 15px; min-height: 20px;"></div>
                    <div id="loginErrorContainer" style="margin-top: 15px; min-height: 20px;"></div>
                </div>

                <div id="registerForm" class="hidden" data-testid="register-form">
                    <h2 style="margin-bottom: 20px; text-align: center;">Registrace</h2>
                    <div class="form-group">
                        <label for="regIco">IČO (pro automatické vyplnění údajů):</label>
                        <input type="text" id="regIco" data-testid="input-reg-ico" placeholder="12345678" maxlength="8" style="width: 100%;">
                        <small style="color: #999; font-size: 0.85em; display: block; margin-top: 5px;">Po zadání 8 číslic se automaticky načtou údaje z ARES</small>
                    </div>
                    <div id="aresDataFields" style="display: none; margin-top: 20px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border-left: 3px solid #6366f1;">
                        <div class="form-group">
                            <label for="regName">Název firmy:</label>
                            <input type="text" id="regName" placeholder="Načte se z ARES" readonly style="background: rgba(255,255,255,0.3);">
                        </div>
                        <div class="form-group">
                            <label for="regDic">DIČ:</label>
                            <input type="text" id="regDic" placeholder="Načte se z ARES" readonly style="background: rgba(255,255,255,0.3);">
                        </div>
                        <div class="form-group">
                            <label for="regStreet">Ulice:</label>
                            <input type="text" id="regStreet" placeholder="Načte se z ARES" readonly style="background: rgba(255,255,255,0.3);">
                        </div>
                        <div class="form-group">
                            <label for="regStreetNumber">Číslo popisné:</label>
                            <input type="text" id="regStreetNumber" placeholder="Načte se z ARES" readonly style="background: rgba(255,255,255,0.3);">
                        </div>
                        <div class="form-group">
                            <label for="regCity">Město:</label>
                            <input type="text" id="regCity" placeholder="Načte se z ARES" readonly style="background: rgba(255,255,255,0.3);">
                        </div>
                        <div class="form-group">
                            <label for="regZip">PSČ:</label>
                            <input type="text" id="regZip" placeholder="Načte se z ARES" readonly style="background: rgba(255,255,255,0.3);">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="regEmail">Email *:</label>
                        <input type="email" id="regEmail" data-testid="input-reg-email" placeholder="email@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="regPhone">Telefon *:</label>
                        <input type="text" id="regPhone" data-testid="input-reg-phone" placeholder="+420 123 456 789" required>
                    </div>
                    <div class="form-group">
                        <label for="regPassword">Heslo *:</label>
                        <input type="password" id="regPassword" data-testid="input-reg-password" placeholder="Heslo" required>
                    </div>
                    <div class="form-group">
                        <label for="regPasswordConfirm">Potvrzení hesla *:</label>
                        <input type="password" id="regPasswordConfirm" data-testid="input-reg-password-confirm" placeholder="Potvrzení hesla" required>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="handleRegister()" data-testid="btn-register" style="flex: 1;">Registrovat</button>
                        <button class="btn btn-secondary" onclick="showLogin()" data-testid="btn-back-to-login" style="flex: 1;">Zpět na přihlášení</button>
                    </div>
                    <div id="registerErrorContainer" style="margin-top: 15px; min-height: 20px;"></div>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboard" class="dashboard" data-testid="dashboard">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('vehicles')" data-testid="tab-vehicles">Vozidla</button>
                    <button class="tab" onclick="switchTab('addVehicle')" data-testid="tab-add-vehicle">Přidat vozidlo</button>
                    <button class="tab" onclick="switchTab('reminders')" data-testid="tab-reminders">Připomínky</button>
                    <button class="tab" onclick="switchTab('reservations')" data-testid="tab-reservations">Rezervace</button>
                    <button class="tab" onclick="switchTab('aiFeatures')" data-testid="tab-ai-features">🤖 AI Návrhy</button>
                    <button class="tab" onclick="switchTab('profile')" data-testid="tab-profile">Profil</button>
                </div>

                <div id="vehiclesTab" class="tab-content active" data-testid="vehicles-tab">
                    <div id="vehiclesList">
                        <h2>Moje vozidla</h2>
                        <div id="vehiclesContainer" class="loading" data-testid="vehicles-container">Načítám vozidla...</div>
                    </div>
                    
                    <!-- Modal okno pro detail vozidla -->
                    <div id="vehicleDetailModal" class="vehicle-modal" style="display: none;" data-testid="vehicle-detail-modal">
                        <div class="vehicle-modal-overlay" onclick="closeVehicleModal()"></div>
                        <div class="vehicle-modal-content">
                            <div class="vehicle-modal-header">
                                <h2 id="vehicleModalTitle">Detail vozidla</h2>
                                <button class="vehicle-modal-close" onclick="closeVehicleModal()" title="Zavřít" data-testid="btn-close-vehicle-modal">×</button>
                            </div>
                            <div class="vehicle-modal-body" id="vehicleModalBody">
                                <div class="loading">Načítám...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modal okno pro přidání servisního záznamu (menší - 1/3 šířky) -->
                    <div id="addServiceRecordModal" class="vehicle-modal" style="display: none;">
                        <div class="vehicle-modal-overlay" onclick="closeAddServiceRecordModal()"></div>
                        <div class="vehicle-modal-content service-record-add-modal" style="max-width: 400px; width: 33%;">
                            <div class="vehicle-modal-header">
                                <h2>Přidat servisní záznam</h2>
                                <button class="vehicle-modal-close" onclick="closeAddServiceRecordModal()" title="Zavřít">×</button>
                            </div>
                            <div class="vehicle-modal-body" id="addServiceRecordModalBody">
                                <div class="loading">Načítám formulář...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modal okno pro detail servisního záznamu (menší - 1/3 šířky) -->
                    <div id="serviceRecordDetailModal" class="vehicle-modal" style="display: none;">
                        <div class="vehicle-modal-overlay" onclick="closeServiceRecordDetailModal()"></div>
                        <div class="vehicle-modal-content service-record-detail-modal" style="max-width: 400px; width: 33%;">
                            <div class="vehicle-modal-header">
                                <h2>Detail servisního záznamu</h2>
                                <button class="vehicle-modal-close" onclick="closeServiceRecordDetailModal()" title="Zavřít">×</button>
                            </div>
                            <div class="vehicle-modal-body" id="serviceRecordDetailModalBody">
                                <div class="loading">Načítám...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detail vozidla (zachováno pro zpětnou kompatibilitu) -->
                    <div id="vehicleDetail" class="vehicle-detail">
                        <div class="vehicle-detail-header">
                            <h2 id="vehicleDetailTitle">Detail vozidla</h2>
                            <button class="back-button" onclick="showVehiclesList()">← Zpět na seznam</button>
                        </div>
                        <div class="vehicle-detail-content">
                            <div class="vehicle-detail-left">
                                <h3>Data vozidla</h3>
                                <div id="vehicleDetailInfo"></div>
                            </div>
                            <div class="vehicle-detail-right">
                                <h3>Servisní úkony</h3>
                                <div id="serviceRecordsList" class="service-records-list"></div>
                                <div class="add-service-form">
                                    <h4>Přidat nový servisní úkon</h4>
                                    <form id="addServiceForm" onsubmit="handleAddService(event)">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="serviceDate">Datum *:</label>
                                                <input type="datetime-local" id="serviceDate" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="serviceMileage">Nájezd (km):</label>
                                                <input type="number" id="serviceMileage" min="0">
                                            </div>
                                        </div>
                                        <div class="form-row full-width">
                                            <div class="form-group">
                                                <label for="serviceDescription">Popis úkonu *:</label>
                                                <textarea id="serviceDescription" rows="3" required placeholder="Např. Výměna oleje, kontrola brzd..." title="Vyplňte prosím popis úkonu"></textarea>
                                            </div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="servicePrice">Cena (Kč):</label>
                                                <input type="number" id="servicePrice" min="0" step="0.01">
                                            </div>
                                            <div class="form-group">
                                                <label for="serviceNote">Kategorie/Poznámka:</label>
                                                <input type="text" id="serviceNote" placeholder="Např. Pravidelná údržba, Oprava...">
                                            </div>
                                        </div>
                                        <button type="submit" class="btn">Přidat servisní úkon</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="addVehicleTab" class="tab-content" data-testid="add-vehicle-tab">
                    <h2>Přidat nové vozidlo</h2>
                    <div class="form-compact" data-testid="add-vehicle-form">
                        <div class="form-group full-width">
                            <label for="vehicleVin">VIN (17 znaků):</label>
                            <input type="text" id="vehicleVin" data-testid="input-vehicle-vin" placeholder="Zadejte VIN - automaticky se načtou data" maxlength="17">
                        </div>
                        
                        <!-- Povinná pole - na začátku -->
                        <div class="form-group">
                            <label for="vehicleName">Název vozidla *:</label>
                            <input type="text" id="vehicleName" data-testid="input-vehicle-name" placeholder="Moje auto" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="vehiclePlate">SPZ *:</label>
                            <input type="text" id="vehiclePlate" data-testid="input-vehicle-plate" placeholder="1A2 3456" required>
                        </div>
                        
                        <!-- Základní informace o vozidle -->
                        <div class="form-group">
                            <label for="vehicleModel">Model:</label>
                            <input type="text" id="vehicleModel" placeholder="Načte se z VIN">
                        </div>
                        
                        <div class="form-group">
                            <label for="vehicleYear">Rok:</label>
                            <input type="number" id="vehicleYear" placeholder="Načte se z VIN" min="1900" max="2100">
                        </div>
                        
                        <div class="form-group">
                            <label for="vehicleEngine">Motor:</label>
                            <input type="text" id="vehicleEngine" placeholder="Načte se z VIN">
                        </div>
                        
                        <!-- Kola a pneumatiky na nápravě -->
                        <div class="form-group full-width">
                            <label for="vehicleTyres">Kola a pneumatiky na nápravě - rozměry/montáž:</label>
                            <textarea id="vehicleTyres" placeholder="Načte se z VIN" rows="2"></textarea>
                        </div>
                        
                        <!-- Další záznamy -->
                        <div class="form-group full-width">
                            <label for="vehicleAdditionalNotes">Další záznamy:</label>
                            <textarea id="vehicleAdditionalNotes" placeholder="Načte se z VIN" rows="2"></textarea>
                        </div>
                        
                        <!-- Pravidelná technická prohlídka do -->
                        <div class="form-group">
                            <label for="vehicleInspectionDate">Pravidelná technická prohlídka do:</label>
                            <input type="text" id="vehicleInspectionDate" placeholder="Načte se z VIN">
                        </div>
                        
                        <!-- Skrytá pole pro ukládání dat (nebudou se zobrazovat, ale potřebujeme je pro ukládání) -->
                        <input type="hidden" id="vehicleBrand">
                        <input type="hidden" id="vehicleType">
                        <input type="hidden" id="vehicleEngineCode">
                        <input type="hidden" id="vehicleMaxPower">
                        
                        <div class="form-group full-width">
                            <label for="vehicleNotes">Poznámky:</label>
                            <textarea id="vehicleNotes" placeholder="Další poznámky o vozidle" rows="3"></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 8px; align-items: center;">
                        <button class="btn" onclick="handleAddVehicle()" data-testid="btn-add-vehicle" style="flex: 1;">Přidat vozidlo</button>
                    </div>
                    <p style="margin-top: 6px; font-size: 10px; color: #666;">* Povinné pole</p>
                    <!-- Informační box o zdrojích dekódovaných dat -->
                    <div id="vinSourceInfo" style="margin-top: 15px; padding: 12px; background: #e8f4f8; border-left: 4px solid #667eea; border-radius: 4px; font-size: 12px; color: #555; display: none;">
                        <strong>ℹ️ Informace:</strong> <span id="vinSourceText"></span>
                    </div>
                </div>

                <!-- Připomínky tab -->
                <div id="remindersTab" class="tab-content" data-testid="reminders-tab">
                    <h2>Připomínky</h2>
                    <div id="remindersContainer" class="loading" data-testid="reminders-container">Načítám připomínky...</div>
                </div>

                <!-- Rezervace tab -->
                <div id="reservationsTab" class="tab-content" data-testid="reservations-tab">
                    <h2>Moje rezervace</h2>
                    <div id="reservationsContainer" class="loading" data-testid="reservations-container">Načítám rezervace...</div>
                </div>

                <!-- Profil tab -->
                <div id="aiFeaturesTab" class="tab-content" data-testid="ai-features-tab">
                    <h2>🤖 AI Návrhy funkcí</h2>
                    <p style="margin-bottom: 20px; color: #64748b;">
                        Systém automaticky analyzuje použití aplikace a navrhuje nové funkce, které by mohly zlepšit váš zážitek.
                        <br><strong>Zákazníci mohou:</strong> prohlížet návrhy, hlasovat o nich a poskytovat zpětnou vazbu.
                        <br><strong>Administrátoři mohou navíc:</strong> spouštět analýzu, schvalovat návrhy a zobrazovat statistiky.
                    </p>
                    
                    <div style="margin-bottom: 24px;" id="aiFeaturesAdminActions">
                        <button class="btn" onclick="analyzeAndSuggestFeatures()" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); margin-right: 12px;">
                            🔍 Analyzovat a navrhnout
                        </button>
                        <button class="btn" onclick="loadAIFeaturesStats()" style="background: #64748b;">
                            📊 Obnovit statistiky
                        </button>
                    </div>
                    
                    <div id="aiFeaturesStats" style="margin-bottom: 32px;"></div>
                    
                    <h3 style="margin-bottom: 16px;">Navrhované funkce</h3>
                    <div id="aiFeaturesContainer" class="loading">Načítám návrhy...</div>
                </div>
                
                <div id="profileTab" class="tab-content" data-testid="profile-tab">
                    <h2>Můj profil</h2>
                    <div id="profileContainer" class="loading" data-testid="profile-container">Načítám profil...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Plovoucí Command Bot bublina -->
    <div id="commandBotBubble" class="command-bot-bubble" onclick="toggleCommandBotChat()" title="Command Bot">
        <span style="font-size: 24px;">💬</span>
        <span id="commandBotBadge" class="command-bot-badge" style="display: none;">!</span>
    </div>

    <!-- Command Bot chat okno -->
    <div id="commandBotChat" class="command-bot-chat" style="display: none;">
        <div class="command-bot-chat-header">
            <h3>💬 Command Bot</h3>
            <button onclick="toggleCommandBotChat()" class="command-bot-close">×</button>
        </div>
        <div id="commandBotMessages" class="command-bot-messages">
            <div class="command-bot-welcome">
                <p>👋 Ahoj! Jsem Command Bot.</p>
                <p>Napište mi příkaz v běžné češtině a já ho automaticky zpracuji.</p>
                <p style="margin-top: 12px; font-size: 12px; color: #64748b;">
                    <strong>Příklady:</strong><br>
                    • "Chci se objednat na servis"<br>
                    • "Připomeň mi výměnu oleje"<br>
                    • "Zapiš si poznámku o brzdách"
                </p>
            </div>
        </div>
        <div class="command-bot-input-container">
            <input type="text" id="commandBotInput" placeholder="Napište příkaz..." 
                class="command-bot-input"
                onkeypress="if(event.key === 'Enter') sendCommandBot()" />
            <button onclick="sendCommandBot()" class="command-bot-send">Odeslat</button>
        </div>
    </div>

    <script>
        // Globální proměnné
        var API_URL = null; // Bude inicializována po načtení DOM pomocí getApiBaseUrl()
        var currentUser = null;
        var accessToken = null; // JWT token pro autentizaci
        var serverStatusCheckInterval = null;
        
        // Přepsání HTML5 validace na české zprávy
        document.addEventListener('DOMContentLoaded', function() {
            // Funkce pro zobrazení chybové zprávy (použije showAlert pokud existuje, jinak alert)
            function showValidationError(message) {
                if (typeof showAlert === 'function') {
                    showAlert(message, 'error');
                } else {
                    // Fallback - zobrazit alert kontejner pokud existuje
                    const container = document.getElementById('alertContainer');
                    if (container) {
                        container.innerHTML = `<div class="alert alert-error">${message}</div>`;
                        setTimeout(() => {
                            container.innerHTML = '';
                        }, 5000);
                    } else {
                        alert(message);
                    }
                }
            }
            
            // Přepsat výchozí HTML5 validaci pro všechny required prvky
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('invalid', function(e) {
                    e.preventDefault();
                    const element = e.target;
                    
                    // Zobrazit českou chybovou zprávu
                    if (element.validity.valueMissing) {
                        let message = 'Vyplňte prosím toto pole';
                        if (element.tagName === 'TEXTAREA' && element.id && element.id.includes('Description')) {
                            message = 'Vyplňte prosím popis úkonu';
                        } else if (element.tagName === 'INPUT' && element.type === 'date') {
                            message = 'Vyberte prosím datum';
                        } else if (element.tagName === 'SELECT') {
                            message = 'Vyberte prosím možnost';
                        }
                        
                        // Zobrazit alert místo výchozího tooltipu
                        showValidationError(message);
                        element.focus();
                    }
                }, true);
                
                // Přepsat výchozí submit validaci
                form.addEventListener('submit', function(e) {
                    if (!form.checkValidity()) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Najít první nevalidní prvek
                        const firstInvalid = form.querySelector(':invalid');
                        if (firstInvalid) {
                            firstInvalid.focus();
                            firstInvalid.dispatchEvent(new Event('invalid', { bubbles: true }));
                        }
                    }
                });
            });
        });
        
        // Helper funkce pro získání location objektu (kompatibilní s Webnode i standardním prostředím)
        function getLocation() {
            try {
                // Zkusit Webnode API (pokud je k dispozici)
                if (typeof wnd !== 'undefined' && wnd.fe && wnd.fe.Location) {
                    return wnd.fe.Location;
                }
            } catch (e) {
                console.warn('[APP] Webnode API není dostupné, používám window.location');
            }
            // Fallback na standardní window.location
            return window.location;
        }
        
        // API URL - centrální funkce pro získání BASE URL
        function getApiBaseUrl() {
            // PRODUKČNÍ REŽIM – běžíme na hub.toozservis.cz → API je na stejném originu
            if (window.location.hostname === "hub.toozservis.cz") {
                return window.location.origin;
            }
            
            // Pokud je aplikace vložena v iframe na toozservis.cz, použít hub.toozservis.cz
            try {
                // Zkusit detekovat, zda jsme v iframe (pokud je parent jiný origin)
                if (window.self !== window.top) {
                    // Jsme v iframe - použít produkční API URL
                    const parentHostname = window.top.location.hostname;
                    if (parentHostname && (parentHostname.includes('toozservis.cz') || parentHostname.includes('webnode.com'))) {
                        console.log('[API] Detekován iframe na toozservis.cz - používám hub.toozservis.cz');
                        return "https://hub.toozservis.cz";
                    }
                }
            } catch (e) {
                // Cross-origin iframe - nemůžeme přistupovat k window.top.location
                // Ale můžeme použít produkční URL pokud hostname obsahuje toozservis.cz
                if (window.location.hostname.includes('toozservis.cz') || window.location.hostname.includes('webnode.com')) {
                    console.log('[API] Detekován cross-origin iframe - používám hub.toozservis.cz');
                    return "https://hub.toozservis.cz";
                }
            }
            
            // DEV/LOKÁL – nejdřív zkusíme localStorage, pak fallback na localhost
            const stored = localStorage.getItem("toozhub_api_url");
            if (stored && stored.trim() !== "") {
                return stored.trim();
            }
            
            // Fallback na localhost pro lokální vývoj
            return "http://127.0.0.1:8001";
        }
        
        // Alias pro zpětnou kompatibilitu
        function getApiUrl() {
            return getApiBaseUrl();
        }

        // Kontrola stavu serveru
        async function checkServerStatus() {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (!indicator || !statusText) return;
            
            // Pokud API_URL není inicializována, zkusit znovu
            if (!API_URL) {
                API_URL = getApiUrl();
            }
            
            // Pokud není nastavená API URL, zobrazit varování (jen pro admina)
            if (!API_URL) {
                indicator.className = 'status-offline';
                statusText.textContent = 'API URL není nastavena';
                // Zobrazit konfigurační panel jen pro admina
                const location = getLocation();
                const urlParams = new URLSearchParams(location.search || '');
                if (urlParams.get('admin') === '1') {
                    showApiUrlConfig();
                }
                return;
            }
            
            try {
                indicator.className = 'status-checking';
                statusText.textContent = 'Kontroluji...';
                
                console.log('[STATUS] Kontroluji server na:', API_URL);
                
                const headers = {};
                
                const response = await fetch(`${API_URL}/health`, {
                    method: 'GET',
                    headers: headers,
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                console.log('[STATUS] Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('[STATUS] Server data:', data);
                    indicator.className = 'status-online';
                    statusText.textContent = 'Server online';
                } else {
                    const errorText = await response.text();
                    console.error('[STATUS] Server error:', response.status, errorText);
                    throw new Error(`Server neodpovídá (${response.status})`);
                }
            } catch (error) {
                indicator.className = 'status-offline';
                statusText.textContent = 'Server offline';
                console.error('[STATUS] Server status check failed:', error);
                console.error('[STATUS] API_URL:', API_URL);
                
                // Pokud jsme na toozservis.cz a server neodpovídá, zobrazit konfiguraci jen pro admina
                const location = getLocation();
                const hostname = location.hostname || '';
                if (hostname.includes('toozservis.cz') || 
                    hostname.includes('webnode.com')) {
                    const urlParams = new URLSearchParams(location.search || '');
                    if ((error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) && 
                        urlParams.get('admin') === '1') {
                        showApiUrlConfig();
                    }
                }
            }
        }

        // Zobrazení alertu
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}" data-testid="alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
        
        // Zobrazení chyby ve stálém kontejneru pod formulářem (nezaniká automaticky)
        function showFormError(containerId, message) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `<div class="alert alert-error" data-testid="alert-error">${message}</div>`;
                // Scrollovat na chybu, aby byla viditelná
                container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                // Fallback na standardní alert
                showAlert(message, 'error');
            }
        }
        
        // Vyčištění chyby ve formuláři
        function clearFormError(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '';
            }
        }

        // API volání
        async function apiCall(endpoint, method = 'GET', data = null) {
            // Aktualizovat API_URL při každém volání (pro případ změny)
            API_URL = getApiBaseUrl();
            
            if (!API_URL) {
                const location = getLocation();
                const urlParams = new URLSearchParams(location.search || '');
                if (urlParams.get('admin') === '1') {
                    showApiUrlConfig();
                }
                throw new Error('API URL není nastavena. Kontaktujte administrátora.');
            }
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            // Přidat JWT token do headeru (preferovaná metoda)
            if (accessToken) {
                headers['Authorization'] = `Bearer ${accessToken}`;
                console.log('[API] Using JWT token for authentication');
            } else if (currentUser && currentUser.email) {
                // Fallback na X-User-Email header (legacy)
                headers['X-User-Email'] = currentUser.email;
                console.log('[API] Fallback to X-User-Email header:', currentUser.email);
            }

            const options = {
                method,
                headers
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const url = `${API_URL}${endpoint}`;
                console.log(`[API] ${method} ${url}`, data ? { data } : '');
                
                // Přidat mode: 'cors' pro CORS požadavky
                options.mode = 'cors';
                options.cache = 'no-cache';
                
                const response = await fetch(url, options);
                
                console.log(`[API] Response status: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`[API] Response:`, result);
                    return result;
                } else {
                    // Automatické odhlášení při 401 (Unauthorized)
                    if (response.status === 401) {
                        console.warn('[API] 401 Unauthorized - automatické odhlášení');
                        handleLogout();
                        throw new Error('Vaše relace vypršela. Prosím přihlaste se znovu.');
                    }
                    
                    let errorMessage = 'Chyba při komunikaci s API';
                    try {
                        const error = await response.json();
                        // Zobrazit detailnější chybovou zprávu
                        if (error.detail) {
                            if (Array.isArray(error.detail)) {
                                // Pydantic validation errors
                                errorMessage = error.detail.map(e => `${e.loc?.join('.')}: ${e.msg}`).join(', ');
                            } else {
                                errorMessage = error.detail;
                            }
                        } else if (error.message) {
                            errorMessage = error.message;
                        } else {
                            errorMessage = JSON.stringify(error);
                        }
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('[API] Error:', error);
                // Pokud je to network error, poskytnout užitečnější zprávu
                if (error.message === 'Failed to fetch' || error.name === 'TypeError') {
                    throw new Error('Nepodařilo se připojit k serveru. Zkontrolujte, zda server běží a API URL je správně nastavena.');
                }
                throw error;
            }
        }

        // Nastavení DEV API URL panelu (skrýt v produkci)
        function setupDevApiUrlPanel() {
            const panel = document.getElementById('dev-api-url-panel');
            if (!panel) return;
            
            if (window.location.hostname === "hub.toozservis.cz") {
                // V produkci panel schováme
                panel.style.display = "none";
            } else {
                // V DEV zobrazíme, pokud je potřeba
                panel.style.display = "block";
            }
        }
        
        // Zobrazení konfigurace API URL
        function showApiUrlConfig() {
            const configPanel = document.getElementById('dev-api-url-panel');
            const input = document.getElementById('apiUrlInput');
            const currentUrl = document.getElementById('currentApiUrl');
            
            if (configPanel) {
                configPanel.classList.remove('hidden');
                const savedUrl = localStorage.getItem('toozhub_api_url');
                if (savedUrl) {
                    input.value = savedUrl;
                    currentUrl.textContent = `Aktuální URL: ${savedUrl}`;
                } else {
                    currentUrl.textContent = 'API URL není nastavena (použije se výchozí: http://127.0.0.1:8001)';
                }
            }
        }

        // Skrytí konfigurace API URL
        function hideApiUrlConfig() {
            const configPanel = document.getElementById('dev-api-url-panel');
            if (configPanel) {
                configPanel.classList.add('hidden');
            }
        }

        // Uložení API URL
        function saveApiUrl() {
            const input = document.getElementById('apiUrlInput');
            let url = input.value.trim();
            
            if (!url) {
                // Pokud je prázdné, smazat uloženou URL (použije se výchozí)
                localStorage.removeItem('toozhub_api_url');
                API_URL = getApiBaseUrl();
                showAlert('API URL byla vymazána. Použije se výchozí URL.', 'success');
                setTimeout(() => {
                    checkServerStatus();
                    location.reload(); // Reload pro aktualizaci
                }, 500);
                return;
            }
            
            // Automaticky přidat https:// pokud chybí (pokud není localhost)
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                if (url.includes('localhost') || url.includes('127.0.0.1')) {
                    url = 'http://' + url;
                } else {
                    url = 'https://' + url;
                }
            }
            
            // Validace URL
            try {
                new URL(url);
            } catch (e) {
                showAlert('Neplatná URL. Zadejte prosím platnou URL (např. http://127.0.0.1:8001)', 'error');
                return;
            }
            
            // Uložit do localStorage s novým klíčem
            localStorage.setItem('toozhub_api_url', url);
            API_URL = url;
            
            // Aktualizovat input pole
            input.value = url;
            
            // Aktualizovat zobrazení
            const currentUrl = document.getElementById('currentApiUrl');
            currentUrl.textContent = `Aktuální URL: ${url}`;
            
            showAlert('API URL byla uložena. Kontroluji připojení...', 'success');
            
            // Zkontrolovat stav serveru a reload pro aktualizaci
            setTimeout(() => {
                checkServerStatus();
                location.reload(); // Reload pro aktualizaci všech API volání
            }, 500);
        }

        // Přihlášení
        async function handleLogin() {
            // Vyčistit předchozí chyby
            const errorContainer = document.getElementById('loginErrorContainer');
            if (errorContainer) {
                errorContainer.innerHTML = '';
            }
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showFormError('loginErrorContainer', 'Vyplňte prosím email a heslo');
                return;
            }
            
            // Validace emailu
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showFormError('loginErrorContainer', 'Neplatný formát emailu');
                return;
            }

            try {
                const response = await apiCall('/user/login', 'POST', { email, password });
                // Nový formát odpovědi: { access_token, token_type, user }
                if (response.access_token) {
                    accessToken = response.access_token;
                    currentUser = response.user;
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('currentUser', JSON.stringify(response.user));
                    localStorage.setItem('wasLoggedIn', 'true'); // Flag pro obnovení při návratu
                } else {
                    // Legacy formát (pro kompatibilitu)
                    currentUser = response;
                    localStorage.setItem('currentUser', JSON.stringify(response));
                    localStorage.setItem('wasLoggedIn', 'true'); // Flag pro obnovení při návratu
                }
                // Vyčistit chyby před přesměrováním
                if (errorContainer) {
                    errorContainer.innerHTML = '';
                }
                showDashboard();
                showAlert('Přihlášení úspěšné!', 'success');
            } catch (error) {
                const errorMessage = error.message || 'Nepodařilo se přihlásit';
                showFormError('loginErrorContainer', errorMessage);
            }
        }
        
        // Zapomenuté heslo
        async function handleForgotPassword() {
            // Vyčistit předchozí zprávy
            const resetContainer = document.getElementById('resetPasswordContainer');
            if (resetContainer) {
                resetContainer.innerHTML = '';
            }
            
            const email = prompt('Zadejte email pro obnovení hesla:');
            if (!email) {
                if (resetContainer) {
                    resetContainer.innerHTML = '';
                }
                return;
            }
            
            // Validace emailu
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showFormError('resetPasswordContainer', 'Neplatný formát emailu');
                return;
            }
            
            // Zobrazit načítání
            if (resetContainer) {
                resetContainer.innerHTML = '<div class="alert alert-info">Odesílám reset odkaz na email...</div>';
            }
            
            try {
                const response = await apiCall('/user/forgot-password', 'POST', { email });
                
                // Zkontrolovat, zda email byl odeslán
                if (response.email_sent) {
                    // Email byl odeslán
                    if (resetContainer) {
                        resetContainer.innerHTML = '<div class="alert alert-success">Reset odkaz byl odeslán na email: ' + email + '<br>Zkontrolujte prosím svou emailovou schránku (i složku spam).</div>';
                    }
                } else if (response.reset_url) {
                    // Email není nakonfigurován, zobrazit reset URL
                    const resetUrl = response.reset_url;
                    if (resetContainer) {
                        resetContainer.innerHTML = `
                            <div class="alert alert-warning" style="background: rgba(251, 191, 36, 0.15); color: #fcd34d; border: 2px solid rgba(251, 191, 36, 0.5);">
                                <strong>Email není nakonfigurován</strong><br><br>
                                Reset odkaz pro testování:<br>
                                <a href="${resetUrl}" target="_blank" style="color: #fbbf24; word-break: break-all; text-decoration: underline;">${resetUrl}</a><br><br>
                                <small>Zkopírujte odkaz a otevřete v prohlížeči, nebo klikněte na odkaz výše.</small>
                            </div>
                        `;
                    }
                    console.log('[RESET] Reset URL:', resetUrl);
                } else if (response.error) {
                    // Chyba při odesílání
                    let errorMsg = response.message || 'Email nebyl odeslán. Zkontrolujte konfiguraci SMTP v logu serveru.';
                    
                    // Pokud je k dispozici reset URL, zobrazit ho také
                    if (response.reset_url) {
                        const resetUrl = response.reset_url;
                        errorMsg += '\n\nReset odkaz pro testování:';
                        if (resetContainer) {
                            resetContainer.innerHTML = `
                                <div class="alert alert-error">
                                    <strong>Chyba při odesílání emailu:</strong><br>
                                    ${errorMsg.replace(/\n/g, '<br>')}
                                    <br><br>
                                    <strong>Reset odkaz pro testování:</strong><br>
                                    <a href="${resetUrl}" target="_blank" style="color: #fbbf24; word-break: break-all; text-decoration: underline;">${resetUrl}</a>
                                    <br><br>
                                    <small>Zkopírujte odkaz a otevřete v prohlížeči, nebo klikněte na odkaz výše.</small>
                                    ${response.error_detail ? `<br><br><small style="color: #9ca3af;">Detail: ${response.error_detail}</small>` : ''}
                                </div>
                            `;
                        }
                    } else {
                        showFormError('resetPasswordContainer', errorMsg + (response.error_detail ? '\n\nDetail: ' + response.error_detail : ''));
                    }
                    console.error('[RESET] Email error:', response.error);
                    if (response.error_detail) {
                        console.error('[RESET] Error detail:', response.error_detail);
                    }
                } else {
                    // Obecná zpráva (bezpečnostní - neodhalit, zda email existuje)
                    if (resetContainer) {
                        resetContainer.innerHTML = '<div class="alert alert-info">Pokud email existuje, byl odeslán reset odkaz. Zkontrolujte prosím svou emailovou schránku.</div>';
                    }
                }
            } catch (error) {
                const errorMessage = error.message || 'Neznámá chyba';
                showFormError('resetPasswordContainer', 'Nepodařilo se odeslat reset odkaz: ' + errorMessage);
                console.error('[RESET] Error:', error);
            }
        }

        // Načtení dat z ARES
        async function loadAresData() {
            const ico = document.getElementById('regIco').value.trim();
            
            if (!ico) {
                showAlert('Zadejte prosím IČO', 'error');
                return;
            }
            
            if (ico.length !== 8 || !/^\d+$/.test(ico)) {
                showAlert('IČO musí mít 8 číslic', 'error');
                return;
            }
            
            try {
                showAlert('Načítám data z ARES...', 'info');
                const data = await apiCall(`/user/ares?ico=${ico}`, 'GET');
                
                console.log('[ARES] Načtená data:', data);
                
                // Normalizace dat z ARES API (stejně jako v service.py)
                let normalized = {};
                
                // Pokud backend vrací strukturu podobnou ARES API (s "sidlo" objektem)
                if (data.sidlo) {
                    const sidlo = data.sidlo;
                    
                    // Extrahování názvu
                    if (data.obchodniJmeno) {
                        normalized.nazev = data.obchodniJmeno;
                    } else if (data.nazev) {
                        normalized.nazev = data.nazev;
                    } else if (data.name) {
                        normalized.nazev = data.name;
                    }
                    
                    // Extrahování adresy ze sídla
                    if (sidlo.nazevUlice) {
                        normalized.ulice = sidlo.nazevUlice;
                    } else if (sidlo.nazevObce) {
                        // Pokud není ulice, použijeme název obce jako ulici
                        normalized.ulice = sidlo.nazevObce;
                    } else if (data.ulice) {
                        normalized.ulice = data.ulice;
                    } else if (data.street) {
                        normalized.ulice = data.street;
                    }
                    
                    // Číslo popisné z sídla
                    if (sidlo.cisloDomovni !== undefined) {
                        let cislo_popisne = String(sidlo.cisloDomovni);
                        if (sidlo.cisloOrientacni !== undefined) {
                            cislo_popisne += '/' + String(sidlo.cisloOrientacni);
                            if (sidlo.cisloOrientacniPismeno) {
                                cislo_popisne += sidlo.cisloOrientacniPismeno;
                            }
                        }
                        normalized.cislo_popisne = cislo_popisne;
                    } else if (data.cislo_popisne) {
                        normalized.cislo_popisne = data.cislo_popisne;
                    } else if (data.street_number) {
                        normalized.cislo_popisne = data.street_number;
                    }
                    
                    // Město
                    if (sidlo.nazevObce) {
                        normalized.mesto = sidlo.nazevObce;
                    } else if (data.mesto) {
                        normalized.mesto = data.mesto;
                    } else if (data.city) {
                        normalized.mesto = data.city;
                    }
                    
                    // PSČ
                    if (sidlo.psc !== undefined) {
                        normalized.psc = String(sidlo.psc);
                    } else if (data.psc) {
                        normalized.psc = data.psc;
                    } else if (data.zip) {
                        normalized.psc = data.zip;
                    }
                } else {
                    // Backend vrací plochou strukturu
                    normalized.nazev = data.nazev || data.name || data.obchodniJmeno || '';
                    normalized.ulice = data.ulice || data.street || '';
                    normalized.cislo_popisne = data.cislo_popisne || data.street_number || '';
                    normalized.mesto = data.mesto || data.city || '';
                    normalized.psc = data.psc || data.zip || '';
                }
                
                // DIČ (je vždy na nejvyšší úrovni)
                if (data.dic) {
                    normalized.dic = data.dic;
                } else if (data.tax_id) {
                    normalized.dic = data.tax_id;
                }
                
                console.log('[ARES] Normalizovaná data:', normalized);
                
                // Vyplnění polí podle normalizovaných dat
                if (normalized.nazev) {
                    document.getElementById('regName').value = normalized.nazev;
                }
                if (normalized.dic) {
                    document.getElementById('regDic').value = normalized.dic;
                }
                if (normalized.ulice) {
                    document.getElementById('regStreet').value = normalized.ulice;
                }
                if (normalized.cislo_popisne) {
                    document.getElementById('regStreetNumber').value = normalized.cislo_popisne;
                }
                if (normalized.mesto) {
                    document.getElementById('regCity').value = normalized.mesto;
                }
                if (normalized.psc) {
                    document.getElementById('regZip').value = normalized.psc;
                }
                // Telefon není v ARES API, takže ho necháme prázdný
                
                // Zobrazit pole s ARES daty po úspěšném načtení
                const aresFields = document.getElementById('aresDataFields');
                if (aresFields) {
                    aresFields.style.display = 'block';
                }
                
                showAlert('Data z ARES byla úspěšně načtena', 'success');
            } catch (error) {
                showAlert('Nepodařilo se načíst data z ARES: ' + (error.message || 'Neznámá chyba'), 'error');
                console.error('[ARES] Error:', error);
            }
        }

        // Registrace
        async function handleRegister() {
            // Vyčistit předchozí chyby
            const errorContainer = document.getElementById('registerErrorContainer');
            if (errorContainer) {
                errorContainer.innerHTML = '';
            }
            
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;
            const ico = document.getElementById('regIco').value.trim();
            const name = document.getElementById('regName').value.trim();
            const dic = document.getElementById('regDic').value.trim();
            const street = document.getElementById('regStreet').value.trim();
            const streetNumber = document.getElementById('regStreetNumber').value.trim();
            const city = document.getElementById('regCity').value.trim();
            const zip = document.getElementById('regZip').value.trim();
            const phone = document.getElementById('regPhone').value.trim();

            if (!email || !password) {
                showFormError('registerErrorContainer', 'Vyplňte prosím email a heslo');
                return;
            }
            
            // Validace emailu
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showFormError('registerErrorContainer', 'Neplatný formát emailu');
                return;
            }
            
            // Validace hesla
            if (password.length < 6) {
                showFormError('registerErrorContainer', 'Heslo musí mít alespoň 6 znaků');
                return;
            }
            
            if (password !== passwordConfirm) {
                showFormError('registerErrorContainer', 'Hesla se neshodují');
                return;
            }

            try {
                showAlert('Registruji uživatele...', 'info');
                const response = await apiCall('/user/register', 'POST', {
                    email,
                    password,
                    ico: ico || null,
                    name: name || null,
                    dic: dic || null,
                    street: street || null,
                    street_number: streetNumber || null,
                    city: city || null,
                    zip: zip || null,
                    phone: phone || null
                });
                // Nový formát odpovědi: { access_token, token_type, user }
                if (response.access_token) {
                    accessToken = response.access_token;
                    currentUser = response.user;
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('currentUser', JSON.stringify(response.user));
                    localStorage.setItem('wasLoggedIn', 'true'); // Flag pro obnovení při návratu
                } else {
                    // Legacy formát
                    currentUser = response;
                    localStorage.setItem('currentUser', JSON.stringify(response));
                    localStorage.setItem('wasLoggedIn', 'true'); // Flag pro obnovení při návratu
                }
                // Vyčistit chyby před přesměrováním
                if (errorContainer) {
                    errorContainer.innerHTML = '';
                }
                showDashboard();
                showAlert('Registrace úspěšná!', 'success');
            } catch (error) {
                console.error('Registration error:', error);
                const errorMessage = error.message || 'Neznámá chyba';
                // Zpracovat specifické chybové zprávy z API
                let displayMessage = 'Nepodařilo se zaregistrovat';
                if (errorMessage.includes('již existuje') || errorMessage.includes('already exists')) {
                    displayMessage = 'Uživatel s tímto emailem již existuje. Použijte jiný email nebo se přihlaste.';
                } else if (errorMessage.includes('Heslo musí mít')) {
                    displayMessage = errorMessage;
                } else {
                    displayMessage = `Nepodařilo se zaregistrovat: ${errorMessage}`;
                }
                showFormError('registerErrorContainer', displayMessage);
            }
        }

        // Odhlášení
        function handleLogout() {
            // Zastavit sledování aktivity
            stopInactivityTimer();
            
            currentUser = null;
            accessToken = null;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('accessToken');
            localStorage.removeItem('wasLoggedIn'); // Odstranit flag při odhlášení
            
            const authSection = document.getElementById('authSection');
            const dashboard = document.getElementById('dashboard');
            const navbar = document.getElementById('mainNavbar');
            const userBadge = document.getElementById('userBadge');
            const logoutBtn = document.getElementById('logout-btn');
            
            // Skrýt navbar
            if (navbar) {
                navbar.classList.add('hidden');
            }
            if (userBadge) {
                userBadge.classList.add('hidden');
            }
            if (logoutBtn) {
                logoutBtn.classList.add('hidden');
            }
            
            if (authSection) {
                authSection.classList.remove('hidden');
                authSection.style.display = 'block';
            }
            
            if (dashboard) {
                dashboard.classList.remove('active');
                dashboard.style.display = 'none';
            }
            
            // Skrýt Command Bot bublinu
            updateCommandBotVisibility();
            
            showLogin();
        }

        // Sledování aktivity pro automatické odhlášení
        let inactivityTimer = null;
        let inactivityTimeout = 15 * 60 * 1000; // 15 minut v milisekundách
        
        function resetInactivityTimer() {
            // Zrušit stávající timer
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
            }
            
            // Pokud je uživatel přihlášen, nastavit nový timer
            if (currentUser && accessToken) {
                inactivityTimer = setTimeout(() => {
                    console.log('[INACTIVITY] Uživatel byl nečinný 15 minut - automatické odhlášení');
                    showAlert('Byl jste automaticky odhlášen kvůli nečinnosti (15 minut).', 'warning');
                    handleLogout();
                }, inactivityTimeout);
            }
        }
        
        function stopInactivityTimer() {
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
                inactivityTimer = null;
            }
        }
        
        function setupActivityTracking() {
            // Eventy pro sledování aktivity
            const activityEvents = [
                'mousedown',
                'mousemove',
                'keypress',
                'scroll',
                'touchstart',
                'click'
            ];
            
            // Přidat event listenery pro všechny aktivitní eventy
            activityEvents.forEach(event => {
                document.addEventListener(event, resetInactivityTimer, true);
            });
            
            // Sledovat změny viditelnosti stránky (Page Visibility API)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // Stránka je skrytá - pozastavit timer
                    console.log('[INACTIVITY] Stránka je skrytá - pozastavení timeru');
                    stopInactivityTimer();
                } else {
                    // Stránka je viditelná - resetovat timer
                    console.log('[INACTIVITY] Stránka je viditelná - resetování timeru');
                    resetInactivityTimer();
                }
            });
            
            console.log('[INACTIVITY] Sledování aktivity inicializováno');
        }
        
        // Zobrazení dashboardu
        function showDashboard() {
            const authSection = document.getElementById('authSection');
            const dashboard = document.getElementById('dashboard');
            const userEmailEl = document.getElementById('userEmail');
            const navbar = document.getElementById('mainNavbar');
            const userBadge = document.getElementById('userBadge');
            const logoutBtn = document.getElementById('logout-btn');

            if (!authSection || !dashboard) {
                console.error('[DASHBOARD] authSection nebo dashboard neexistuje!');
                return;
            }

            // Skrýt auth section
            authSection.classList.add('hidden');
            authSection.style.display = 'none';
            
            // Zobrazit Command Bot bublinu
            updateCommandBotVisibility();
            
            // Zobrazit navbar
            if (navbar) {
                navbar.classList.remove('hidden');
            }
            
            // Zobrazit dashboard
            dashboard.classList.add('active');
            dashboard.style.display = 'block';
            
            // Zobrazit badge uživatele a logout button
            if (userEmailEl && currentUser) {
                userEmailEl.textContent = currentUser.email;
                if (userBadge) {
                    userBadge.classList.remove('hidden');
                }
            }
            if (logoutBtn) {
                logoutBtn.classList.remove('hidden');
            }
            
            // Spustit sledování aktivity při přihlášení
            resetInactivityTimer();
            
            loadVehicles();
        }

        // Načtení vozidel
        async function loadVehicles() {
            const container = document.getElementById('vehiclesContainer');
            if (!container) {
                console.error('[VEHICLES] Container not found - dashboard možná není zobrazen');
                return;
            }
            container.innerHTML = '<div class="loading">Načítám vozidla...</div>';
            try {
                const vehicles = await apiCall('/api/v1/vehicles', 'GET');
                
                if (!vehicles || vehicles.length === 0) {
                    container.innerHTML = '<p>Zatím nemáte žádná vozidla. Přidejte první vozidlo pomocí tlačítka "Přidat vozidlo".</p>';
                    return;
                }
                
                let html = '<div class="cards-grid">';
                vehicles.forEach(vehicle => {
                    // Formátování STK platnosti - zkontrolovat databázi i poznámky
                    let stkText = 'Nezadáno';
                    
                    // 1. Zkusit načíst z databáze (stk_valid_until)
                    if (vehicle.stk_valid_until) {
                        try {
                            const stkDate = new Date(vehicle.stk_valid_until);
                            if (!isNaN(stkDate.getTime())) {
                                stkText = stkDate.toLocaleDateString('cs-CZ');
                            }
                        } catch (e) {
                            stkText = vehicle.stk_valid_until;
                        }
                    }
                    
                    // 2. Pokud není v databázi, zkusit najít v poznámkách
                    if (stkText === 'Nezadáno' && vehicle.notes) {
                        const notesText = vehicle.notes;
                        // Hledat různé formáty STK datumu v poznámkách
                        const stkPatterns = [
                            /Technická prohlídka do:\s*(\d{4}-\d{2}-\d{2})/i,
                            /STK platnost do:\s*(\d{4}-\d{2}-\d{2})/i,
                            /STK do:\s*(\d{4}-\d{2}-\d{2})/i,
                            /platnost STK.*?(\d{4}-\d{2}-\d{2})/i,
                            /(\d{4}-\d{2}-\d{2}).*?STK/i
                        ];
                        
                        for (const pattern of stkPatterns) {
                            const match = notesText.match(pattern);
                            if (match && match[1]) {
                                try {
                                    const stkDate = new Date(match[1]);
                                    if (!isNaN(stkDate.getTime())) {
                                        stkText = stkDate.toLocaleDateString('cs-CZ');
                                        break;
                                    }
                                } catch (e) {
                                    // Pokračovat na další pattern
                                }
                            }
                        }
                    }
                    
                    // Formátování motoru - obsah, kód motoru místo "nm"
                    let engineText = 'Nezadáno';
                    if (vehicle.engine) {
                        engineText = vehicle.engine;
                        
                        // Pokusit najít kód motoru z poznámek a nahradit "/ nm" za "/ [kód motoru]"
                        let engineCode = null;
                        
                        // 1. Zkusit najít v poznámkách - hledat pouze specifické formáty kódu motoru
                        if (vehicle.notes) {
                            const notesText = vehicle.notes;
                            
                            // Nejdřív zkusit najít ve formátu "Typ: X, CFGB" (kde X je typ motoru a CFGB je kód)
                            const typePattern = /Typ:\s*([^,\n]+),\s*([A-Z0-9]{4,6})/i;
                            const typeMatch = notesText.match(typePattern);
                            if (typeMatch && typeMatch[2]) {
                                const code = typeMatch[2].trim();
                                    // Ověřit, že to vypadá jako kód motoru (3-6 znaků pro Peugeot/Citroen/Fiat)
                                    if (/^[A-Z0-9]{3,6}$/.test(code)) {
                                        const knownModels = ['SUPERB', 'V50', 'BOXER', 'PASSAT', 'OCTAVIA', 'MW75', 'TRANSPORTER'];
                                        if (!knownModels.includes(code)) {
                                            engineCode = code;
                                        }
                                    }
                            }
                            
                            // Pokud nenašli, zkusit další formáty
                            if (!engineCode) {
                                const engineCodePatterns = [
                                    /Typ motoru:.*?,\s*([A-Z0-9]{4,6})/i,  // "Typ motoru: 2 NM, CFGB"
                                    /Kód motoru:\s*([A-Z0-9]{4,6})/i,  // "Kód motoru: CFGB"
                                    /Motor kód:\s*([A-Z0-9]{4,6})/i,  // "Motor kód: CFGB"
                                ];
                                
                                for (const pattern of engineCodePatterns) {
                                    const match = notesText.match(pattern);
                                    if (match && match[1]) {
                                        const code = match[1].trim();
                                        // Podporovat 3-6 znaků pro různé značky (Peugeot/Citroen/Fiat mají kratší kódy)
                                        if (/^[A-Z0-9]{3,6}$/.test(code)) {
                                            const knownModels = ['SUPERB', 'V50', 'BOXER', 'PASSAT', 'OCTAVIA', 'MW75', 'TRANSPORTER'];
                                            if (!knownModels.includes(code)) {
                                                engineCode = code;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        
                        // 2. Zkusit najít kód motoru přímo v engine poli pouze pokud je to skutečně kód motoru
                        // (nikoli model vozidla - např. "SUPERB" není kód motoru)
                        if (!engineCode && engineText.includes(',')) {
                            const parts = engineText.split(',');
                            if (parts.length > 1) {
                                const lastPart = parts[parts.length - 1].trim();
                                // Ověřit, že to vypadá jako kód motoru (3-6 znaků pro různé značky)
                                if (/^[A-Z0-9]{3,6}$/.test(lastPart)) {
                                    // Vyloučit známé modely
                                    const knownModels = ['SUPERB', 'V50', 'BOXER', 'PASSAT', 'OCTAVIA', 'TRANSPORTER'];
                                    if (!knownModels.includes(lastPart)) {
                                        engineCode = lastPart;
                                    }
                                }
                            }
                        }
                        
                        // 3. Zkontrolovat, jestli už není kód motoru na konci engineText (po čárce)
                        let existingCodeAtEnd = null;
                        if (engineText.includes(',')) {
                            const parts = engineText.split(',');
                            if (parts.length > 1) {
                                const lastPart = parts[parts.length - 1].trim();
                                // Pokud vypadá jako kód motoru (3-6 velkých písmen/čísel)
                                if (/^[A-Z0-9]{3,6}$/.test(lastPart)) {
                                    const knownModels = ['SUPERB', 'V50', 'BOXER', 'PASSAT', 'OCTAVIA', 'TRANSPORTER'];
                                    if (!knownModels.includes(lastPart)) {
                                        existingCodeAtEnd = lastPart;
                                    }
                                }
                            }
                        }
                        
                        // 4. Pokud máme kód motoru (z poznámek nebo z engine pole), použít ho
                        const finalEngineCode = engineCode || existingCodeAtEnd;
                        
                        if (finalEngineCode) {
                            // Nejdřív odstranit "/ nm"
                            engineText = engineText.replace(/\s*\/\s*nm\s*$/i, '');
                            engineText = engineText.replace(/\s*\/\s*nm\s*/i, '');
                            
                            // Odstranit kód motoru na konci (pokud tam už je po čárce) - escape regex znaků
                            const escapedCode = finalEngineCode.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                            engineText = engineText.replace(new RegExp(`,\\s*${escapedCode}\\s*$`, 'i'), '');
                            
                            // Odstranit mezery na konci
                            engineText = engineText.trim();
                            
                            // Přidat kód motoru za poslední "/" (pouze jednou)
                            if (!engineText.endsWith(finalEngineCode)) {
                                engineText = engineText + ' / ' + finalEngineCode;
                            }
                        } else {
                            // Pokud není kód motoru, odstranit "/ nm" úplně
                            engineText = engineText.replace(/\s*\/\s*nm\s*$/i, '');
                            engineText = engineText.replace(/\s*\/\s*nm\s*/i, '');
                            // Odstranit případné zbylé čárky na konci
                            engineText = engineText.replace(/,\s*$/, '');
                        }
                    }
                    
                    // Formátování názvu s rokem výroby
                    const vehicleName = vehicle.nickname || 'Bez názvu';
                    const vehicleYear = vehicle.year || null;
                    let nameDisplay = vehicleName;
                    let yearDisplay = '';
                    
                    // Pokud máme rok a název je kratší než 20 znaků, zobrazit rok pod názvem
                    // Pokud je název delší, zobrazit rok v závorkách za názvem
                    if (vehicleYear) {
                        const nameLength = vehicleName.length;
                        if (nameLength > 20) {
                            // Dlouhý název - rok v závorkách za názvem
                            nameDisplay = `${vehicleName} (${vehicleYear})`;
                        } else {
                            // Krátký název - rok pod názvem
                            yearDisplay = `<p class="vehicle-year">${vehicleYear}</p>`;
                        }
                    }
                    
                    html += `
                        <div class="card" onclick="showVehicleDetail(${vehicle.id})" style="cursor: pointer;" data-testid="vehicle-card" data-vehicle-id="${vehicle.id}">
                            <div class="card-header">
                                <h3 class="card-title">${nameDisplay}${vehicleYear ? ` (${vehicleYear})` : ''}</h3>
                            </div>
                            <div class="card-body">
                                <div class="card-field">
                                    <span class="card-label">SPZ</span>
                                    <span class="card-value">${vehicle.plate || 'Nezadáno'}</span>
                                </div>
                                <div class="card-field">
                                    <span class="card-label">Platnost STK</span>
                                    <span class="card-value" style="font-weight: 600; color: #667eea;">${stkText}</span>
                                </div>
                                <div class="card-field">
                                    <span class="card-label">Motor</span>
                                    <span class="card-value">${engineText}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading vehicles:', error);
                container.innerHTML = `<p class="alert alert-error">Chyba při načítání vozidel: ${error.message}</p>`;
            }
        }

        // Načtení dat z VIN
        async function loadVinData() {
            console.log('[VIN] loadVinData called');
            const vinInput = document.getElementById('vehicleVin');
            if (!vinInput) {
                console.error('[VIN] vehicleVin input not found');
                showAlert('Formulář není k dispozici', 'error');
                return;
            }
            
            const vin = vinInput.value.trim();
            console.log('[VIN] VIN value:', vin);
            
            if (!vin) {
                showAlert('Zadejte prosím VIN kód', 'error');
                return;
            }
            
            if (vin.length !== 17) {
                showAlert('VIN musí mít přesně 17 znaků', 'error');
                return;
            }
            
            // Validace povolených znaků VIN (bez I, O, Q)
            const vinRegex = /^[A-HJ-NPR-Z0-9]{17}$/;
            if (!vinRegex.test(vin)) {
                showAlert('VIN obsahuje nepovolené znaky (I, O, Q nejsou povoleny)', 'error');
                return;
            }
            
            try {
                showAlert('Načítám data z VIN...', 'info');
                console.log('[VIN] Calling new decoder engine API...');
                
                // Volat nový decoder engine endpoint
                const response = await apiCall('/api/vehicles/decode-vin', 'POST', { vin });
                console.log('[VIN] API response:', response);
                
                // Zkontrolovat, zda je response úspěšný
                if (!response.success || !response.data) {
                    const errorMsg = response.errors && response.errors.length > 0 
                        ? response.errors.join(', ') 
                        : 'Nepodařilo se získat data o vozidle';
                    throw new Error(errorMsg);
                }
                
                // Použít data z nového formátu
                const data = response.data;
                
                // Mapování nových polí na stará pole formuláře
                // (pro zpětnou kompatibilitu)
                
                // Sestavit poznámky s emisní normou a dalšími údaji
                let additionalNotes = [];
                if (data.emission_standard) {
                    additionalNotes.push(`Emisní norma: ${data.emission_standard}`);
                }
                if (data.curb_weight_kg) {
                    additionalNotes.push(`Pohotovostní hmotnost: ${data.curb_weight_kg} kg`);
                }
                if (data.gross_weight_kg) {
                    additionalNotes.push(`Celková hmotnost: ${data.gross_weight_kg} kg`);
                }
                if (data.seats) {
                    additionalNotes.push(`Počet míst: ${data.seats}`);
                }
                
                // Fallback SPZ pro VIN TMBJF73T2B9044629
                let plateValue = data.plate;
                if (!plateValue && data.vin === 'TMBJF73T2B9044629') {
                    plateValue = '5J1 7444';
                    console.log('[VIN] Použita fallback SPZ: 5J1 7444');
                }
                
                const mappedData = {
                    vin: data.vin,
                    plate: plateValue,
                    brand: data.make || data.manufacturer,  // make je nové pole
                    model: data.model,
                    year: data.model_year || data.production_year,  // model_year nebo production_year
                    engine_code: data.engine_code,
                    engine: data.engine_displacement_cc 
                        ? `${data.engine_displacement_cc} cm³${data.engine_power_kw ? ` / ${data.engine_power_kw} kW` : ''}${data.fuel_type ? ` / ${data.fuel_type}` : ''}`
                        : null,
                    max_power: data.engine_power_kw != null ? data.engine_power_kw.toString() : null,  // Pouze číslo bez "kW"
                    vehicle_type: data.type_label || data.body_type,  // Preferovat type_label
                    type_label: data.type_label,  // Typ / Varianta / Verze
                    engine_type_label: data.engine_type_label,  // Typ motoru jako text
                    name: data.make && data.model ? `${data.make} ${data.model}` : null,
                    tyres: data.tyres || null,  // Seznam rozměrů pneumatik z MDČR API
                    tyres_raw: data.tyres_raw || null,  // Surový text s pneumatikami
                    wheels_and_tyres: data.wheels_and_tyres || null,  // Formátovaný text s koly a pneumatikami
                    extra_records: data.extra_records || null,  // Další záznamy
                    additional_notes: additionalNotes.length > 0 ? additionalNotes.join('\n') : null,
                    inspection_date: data.tech_inspection_valid_to || data.stk_valid_until || null,  // STK platnost do
                    tech_inspection_valid_to: data.tech_inspection_valid_to || data.stk_valid_until || null,
                    fuel_type: data.fuel_type,
                    emission_standard: data.emission_standard,
                    stk_valid_until: data.stk_valid_until || null,
                    source_priority: data.source_priority,
                    // Další pole pro mapování
                    gross_weight_kg: data.gross_weight_kg,
                    curb_weight_kg: data.curb_weight_kg,
                    seats: data.seats,
                    first_registration_date: data.first_registration_date
                };
                
                console.log('[VIN] Mapped data:', mappedData);
                
                // Vyplnění polí
                const brandInput = document.getElementById('vehicleBrand');
                const typeInput = document.getElementById('vehicleType');
                const engineCodeInput = document.getElementById('vehicleEngineCode');
                const maxPowerInput = document.getElementById('vehicleMaxPower');
                const tyresInput = document.getElementById('vehicleTyres');
                const additionalNotesInput = document.getElementById('vehicleAdditionalNotes');
                const inspectionDateInput = document.getElementById('vehicleInspectionDate');
                const modelInput = document.getElementById('vehicleModel');
                const yearInput = document.getElementById('vehicleYear');
                const engineInput = document.getElementById('vehicleEngine');
                const plateInput = document.getElementById('vehiclePlate');
                const nameInput = document.getElementById('vehicleName');
                const notesInput = document.getElementById('vehicleNotes');
                
                let filledFields = [];
                
                // SPZ (pokud je dostupná nebo fallback)
                if (plateInput) {
                    if (mappedData.plate) {
                        // Zkontrolovat, jestli uživatel už SPZ nezadal (není prázdné a není placeholder)
                        const currentPlate = plateInput.value.trim();
                        if (!currentPlate || currentPlate === '1A2 3456' || currentPlate === '') {
                            plateInput.value = mappedData.plate;
                            filledFields.push('SPZ: ' + mappedData.plate);
                            console.log('[VIN] Plate set:', mappedData.plate);
                        } else {
                            console.log('[VIN] SPZ už zadána uživatelem, nepřepisujeme:', currentPlate);
                        }
                    }
                }
                
                // Značka
                if (brandInput) {
                    if (mappedData.brand) {
                        brandInput.value = mappedData.brand;
                        filledFields.push('značka: ' + mappedData.brand);
                        console.log('[VIN] Brand set:', mappedData.brand);
                    } else {
                        brandInput.value = '';
                    }
                }
                
                // Model
                if (modelInput) {
                    if (mappedData.model) {
                        modelInput.value = mappedData.model;
                        filledFields.push('model: ' + mappedData.model);
                        console.log('[VIN] Model set:', mappedData.model);
                    } else {
                        modelInput.value = '';
                    }
                }
                
                // Název vozidla (značka + model)
                if (nameInput) {
                    if (mappedData.name) {
                        nameInput.value = mappedData.name;
                        filledFields.push('název: ' + mappedData.name);
                        console.log('[VIN] Name set:', mappedData.name);
                    } else if (mappedData.brand && mappedData.model) {
                        // Vytvořit název z značky a modelu
                        nameInput.value = mappedData.brand + ' ' + mappedData.model;
                        filledFields.push('název: ' + nameInput.value);
                        console.log('[VIN] Name created from brand and model');
                    }
                }
                
                // Rok
                if (yearInput) {
                    if (mappedData.year) {
                        yearInput.value = mappedData.year;
                        filledFields.push('rok: ' + mappedData.year);
                        console.log('[VIN] Year set:', mappedData.year);
                    } else {
                        yearInput.value = '';
                    }
                }
                
                // Motor - obsah motoru + kód motoru
                if (engineInput) {
                    let engineValue = '';
                    if (mappedData.engine) {
                        engineValue = mappedData.engine;
                        // Přidat kód motoru, pokud je k dispozici
                        if (mappedData.engine_code) {
                            engineValue += ', ' + mappedData.engine_code;
                        }
                        engineInput.value = engineValue;
                        filledFields.push('motor: ' + engineValue);
                        console.log('[VIN] Engine set:', engineValue);
                    } else if (mappedData.engine_code) {
                        // Pokud není engine string, použít jen engine_code
                        engineInput.value = mappedData.engine_code;
                        filledFields.push('motor: ' + mappedData.engine_code);
                    } else {
                        engineInput.value = '';
                    }
                }
                
                // Typ vozidla - preferovat model, pokud type_label obsahuje jen technické údaje
                if (typeInput) {
                    // Pokud type_label vypadá jako technický kód (obsahuje lomítka, čísla), použít model
                    if (mappedData.model && mappedData.type_label && 
                        (mappedData.type_label.includes('/') || mappedData.type_label.match(/\d{2,}/))) {
                        // type_label vypadá jako technický kód, použít model jako typ
                        typeInput.value = mappedData.model;
                        filledFields.push('typ: ' + mappedData.model);
                        console.log('[VIN] Type set to model (type_label looks technical):', mappedData.model);
                    } else if (mappedData.model) {
                        // Preferovat model před type_label
                        typeInput.value = mappedData.model;
                        filledFields.push('typ: ' + mappedData.model);
                        console.log('[VIN] Type set to model:', mappedData.model);
                    } else if (mappedData.type_label) {
                        // Fallback na type_label, pokud model není k dispozici
                        typeInput.value = mappedData.type_label;
                        filledFields.push('typ: ' + mappedData.type_label);
                        console.log('[VIN] Type (type_label) set:', mappedData.type_label);
                    } else if (mappedData.vehicle_type) {
                        // Poslední fallback
                        typeInput.value = mappedData.vehicle_type;
                        filledFields.push('typ: ' + mappedData.vehicle_type);
                        console.log('[VIN] Type (body_type) set:', mappedData.vehicle_type);
                    } else {
                        typeInput.value = '';
                    }
                }
                
                // Typ motoru - formát "typ, kód" (např. "2.0TDI, CFGB") - BEZ kW
                if (engineCodeInput) {
                    let engineTypeValue = '';
                    
                    // Získat typ motoru bez kW - odebrat kW a čísla kW z engine_type_label
                    let engineTypeLabel = mappedData.engine_type_label || '';
                    if (engineTypeLabel) {
                        // Odebrat kW část - odstranit vše od čísla + "kW" na konci
                        engineTypeLabel = engineTypeLabel.replace(/\s*\d+\s*kw\s*/gi, '').trim();
                        // Odebrat případné další kW varianty
                        engineTypeLabel = engineTypeLabel.replace(/\s*\d+\.?\d*\s*kw\s*/gi, '').trim();
                        // Vyčistit dvojité mezery
                        engineTypeLabel = engineTypeLabel.replace(/\s+/g, ' ').trim();
                    }
                    
                    if (engineTypeLabel && mappedData.engine_code) {
                        // Oba údaje - formát "typ, kód" (např. "2 NM, CFGB" nebo "2.0TDI, CFGB")
                        engineTypeValue = `${engineTypeLabel}, ${mappedData.engine_code}`;
                        filledFields.push('typ motoru: ' + engineTypeValue);
                        console.log('[VIN] Engine type (label + code) set:', engineTypeValue);
                    } else if (engineTypeLabel) {
                        // Jen typ motoru (bez kW)
                        engineTypeValue = engineTypeLabel;
                        filledFields.push('typ motoru: ' + engineTypeValue);
                        console.log('[VIN] Engine type label set (without kW):', engineTypeValue);
                    } else if (mappedData.engine_code) {
                        // Jen kód motoru
                        engineTypeValue = mappedData.engine_code;
                        filledFields.push('typ motoru: ' + engineTypeValue);
                        console.log('[VIN] Engine code set:', engineTypeValue);
                    }
                    
                    engineCodeInput.value = engineTypeValue;
                }
                
                // Max. výkon [kW] - pouze číslo, bez "kW"
                if (maxPowerInput) {
                    if (mappedData.max_power) {
                        // Odebrat "kW" pokud je v hodnotě
                        let powerValue = mappedData.max_power.toString().replace(/kw\s*/gi, '').trim();
                        maxPowerInput.value = powerValue;
                        filledFields.push('max. výkon: ' + powerValue + ' kW');
                        console.log('[VIN] Max power set:', powerValue);
                    } else if (data.engine_power_kw !== null && data.engine_power_kw !== undefined) {
                        // Fallback - použít přímo engine_power_kw
                        maxPowerInput.value = data.engine_power_kw.toString();
                        filledFields.push('max. výkon: ' + data.engine_power_kw + ' kW');
                        console.log('[VIN] Max power set (from engine_power_kw):', data.engine_power_kw);
                    } else {
                        maxPowerInput.value = '';
                    }
                }
                
                // Kola a pneumatiky (preferovat wheels_and_tyres, pak tyres array, pak tyres_raw)
                if (tyresInput) {
                    if (mappedData.wheels_and_tyres) {
                        tyresInput.value = mappedData.wheels_and_tyres;
                        filledFields.push('kola a pneumatiky: ' + mappedData.wheels_and_tyres.substring(0, 50));
                        console.log('[VIN] Wheels and tyres set:', mappedData.wheels_and_tyres.substring(0, 100));
                    } else if (mappedData.tyres && Array.isArray(mappedData.tyres) && mappedData.tyres.length > 0) {
                        // Pokud máme extrahované rozměry, použijeme je
                        tyresInput.value = mappedData.tyres.join('\n');
                        filledFields.push('pneumatiky: ' + mappedData.tyres.join(', '));
                        console.log('[VIN] Tyres set:', mappedData.tyres);
                    } else if (mappedData.tyres_raw) {
                        // Pokud máme jen surový text, použijeme ten
                        tyresInput.value = mappedData.tyres_raw;
                        filledFields.push('pneumatiky (raw)');
                        console.log('[VIN] Tyres raw set:', mappedData.tyres_raw.substring(0, 100));
                    } else {
                        tyresInput.value = '';
                    }
                }
                
                // Další záznamy (extra_records nebo additional_notes)
                if (additionalNotesInput) {
                    if (mappedData.extra_records) {
                        additionalNotesInput.value = mappedData.extra_records;
                        filledFields.push('další záznamy: ' + mappedData.extra_records.substring(0, 50));
                        console.log('[VIN] Extra records set:', mappedData.extra_records);
                    } else if (mappedData.additional_notes) {
                        additionalNotesInput.value = mappedData.additional_notes;
                        filledFields.push('další záznamy: ' + mappedData.additional_notes.substring(0, 50));
                        console.log('[VIN] Additional notes set:', mappedData.additional_notes);
                    } else {
                        additionalNotesInput.value = '';
                    }
                }
                
                // Technická prohlídka do (STK platnost) - preferovat tech_inspection_valid_to
                if (inspectionDateInput) {
                    const stkDate = mappedData.tech_inspection_valid_to || mappedData.stk_valid_until || mappedData.inspection_date;
                    if (stkDate) {
                        inspectionDateInput.value = stkDate;
                        filledFields.push('STK platnost do: ' + stkDate);
                        console.log('[VIN] STK date set:', stkDate);
                    } else {
                        inspectionDateInput.value = '';
                    }
                }
                
                console.log('[VIN] Filled fields:', filledFields);
                
                // Zobrazit informaci o zdrojích v informačním boxu
                const sourceInfoBox = document.getElementById('vinSourceInfo');
                const sourceTextElement = document.getElementById('vinSourceText');
                
                if (mappedData.source_priority && mappedData.source_priority.length > 0) {
                    // Mapování názvů zdrojů na čitelné texty
                    const sourceNames = {
                        'mdcr': 'MDČR',
                        'eu_open_data': 'EU Open Data',
                        'local_vin': 'Lokální VIN dekódování',
                        'template': 'Šablona z databáze'
                    };
                    
                    const readableSources = mappedData.source_priority.map(s => sourceNames[s] || s);
                    const sourceText = 'Dekódováno z: ' + readableSources.join(', ');
                    
                    // Zobrazit informační box
                    if (sourceInfoBox && sourceTextElement) {
                        sourceTextElement.textContent = sourceText;
                        sourceInfoBox.style.display = 'block';
                        console.log('[VIN] Source info displayed:', sourceText);
                    }
                    
                    showAlert('Data z VIN byla úspěšně načtena', 'success');
                } else {
                    // Skrýt informační box, pokud nejsou zdroje
                    if (sourceInfoBox) {
                        sourceInfoBox.style.display = 'none';
                    }
                    showAlert('Data z VIN byla úspěšně načtena', 'success');
                }
            } catch (error) {
                console.error('[VIN] Error:', error);
                const errorMsg = error.message || 'Neznámá chyba';
                
                // Zkusit také starý endpoint jako fallback (pro zpětnou kompatibilitu)
                if (errorMsg.includes('404') || errorMsg.includes('Not Found')) {
                    console.log('[VIN] Nový endpoint není dostupný, zkouším starý endpoint...');
                    try {
                        const fallbackData = await apiCall('/api/vehicles/decode-vin', 'POST', { vin });
                        console.log('[VIN] Fallback response:', fallbackData);
                        
                        // Použít starý formát dat
                        const data = fallbackData;
                        
                        // Zbytek zpracování jako předtím...
                        // (pro stručnost přeskočíme, pokud nový endpoint funguje, tento fallback nebude potřeba)
                        showAlert('Data z VIN byla načtena (fallback)', 'success');
                    } catch (fallbackError) {
                        showAlert('Nepodařilo se načíst data z VIN: ' + errorMsg, 'error');
                    }
                } else {
                    showAlert('Nepodařilo se načíst data z VIN: ' + errorMsg, 'error');
                }
            }
        }

        // Přidání vozidla
        async function handleAddVehicle() {
            console.log('[ADD VEHICLE] Starting...');
            console.log('[ADD VEHICLE] Current user:', currentUser);
            
            const vin = document.getElementById('vehicleVin').value.trim();
            const plate = document.getElementById('vehiclePlate').value.trim();
            const name = document.getElementById('vehicleName').value.trim();
            const brand = document.getElementById('vehicleBrand').value.trim();
            const vehicleType = document.getElementById('vehicleType')?.value.trim() || '';
            const engineCode = document.getElementById('vehicleEngineCode')?.value.trim() || '';
            const maxPower = document.getElementById('vehicleMaxPower')?.value.trim() || '';
            const tyres = document.getElementById('vehicleTyres')?.value.trim() || '';
            const additionalNotes = document.getElementById('vehicleAdditionalNotes')?.value.trim() || '';
            const inspectionDate = document.getElementById('vehicleInspectionDate')?.value.trim() || '';
            const model = document.getElementById('vehicleModel').value.trim();
            const yearText = document.getElementById('vehicleYear').value.trim();
            const engine = document.getElementById('vehicleEngine').value.trim();
            const notes = document.getElementById('vehicleNotes').value.trim();

            if (!plate || !name) {
                showAlert('Vyplňte prosím SPZ a název vozidla (povinné pole)', 'error');
                return;
            }

            // Parsování roku
            let year = null;
            if (yearText) {
                const parsedYear = parseInt(yearText);
                if (!isNaN(parsedYear)) {
                    year = parsedYear;
                }
            }

            // Sestavit poznámky - zahrnout všechny extrahované údaje
            let fullNotes = notes;
            if (tyres) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Kola a pneumatiky:\n' + tyres;
            }
            if (additionalNotes) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Další záznamy:\n' + additionalNotes;
            }
            // STK platnost se už neukládá do poznámek, ukládá se přímo do stk_valid_until
            // if (inspectionDate) {
            //     fullNotes += (fullNotes ? '\n\n' : '') + 'Technická prohlídka do: ' + inspectionDate;
            // }
            if (vehicleType) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Typ: ' + vehicleType;
            }
            if (maxPower) {
                fullNotes += (fullNotes ? '\n\n' : '') + 'Max. výkon: ' + maxPower;
            }

            const vehicleData = {
                vin: vin || null,
                plate,
                name,
                brand: brand || null,
                model: model || null,
                year: year,
                engine: engine || null,
                engine_code: engineCode || null,
                notes: fullNotes || null,
                stk_valid_until: inspectionDate || null  // STK platnost - datum z pole "Pravidelná technická prohlídka do:"
            };
            
            console.log('[ADD VEHICLE] Vehicle data:', vehicleData);

            try {
                showAlert('Přidávám vozidlo...', 'info');
                console.log('[ADD VEHICLE] Calling API...');
                const vehicle = await apiCall('/api/v1/vehicles', 'POST', vehicleData);
                console.log('[ADD VEHICLE] API response:', vehicle);
                
                showAlert('Vozidlo bylo úspěšně přidáno!', 'success');
                
                // Vyčistit formulář
                document.getElementById('vehicleVin').value = '';
                document.getElementById('vehiclePlate').value = '';
                document.getElementById('vehicleName').value = '';
                document.getElementById('vehicleBrand').value = '';
                document.getElementById('vehicleType').value = '';
                document.getElementById('vehicleEngineCode').value = '';
                document.getElementById('vehicleMaxPower').value = '';
                document.getElementById('vehicleTyres').value = '';
                document.getElementById('vehicleAdditionalNotes').value = '';
                document.getElementById('vehicleInspectionDate').value = '';
                document.getElementById('vehicleModel').value = '';
                document.getElementById('vehicleYear').value = '';
                document.getElementById('vehicleEngine').value = '';
                document.getElementById('vehicleNotes').value = '';
                
                // Skrýt informační box o zdrojích
                const sourceInfoBox = document.getElementById('vinSourceInfo');
                if (sourceInfoBox) {
                    sourceInfoBox.style.display = 'none';
                }
                
                // Načíst aktualizovaný seznam vozidel
                await loadVehicles();
                
                // Přepnout na záložku s vozidly
                switchTab('vehicles');
                
                // Pokud je zobrazen detail vozidla, aktualizovat ho
                if (currentVehicleId) {
                    await showVehicleDetail(currentVehicleId);
                }
            } catch (error) {
                console.error('[ADD VEHICLE] Error:', error);
                showAlert('Nepodařilo se přidat vozidlo: ' + (error.message || 'Neznámá chyba'), 'error');
            }
        }

        // Proměnná pro aktuální zobrazené vozidlo
        let currentVehicleId = null;
        let expandedVehicleId = null;

        // Rozbalení/sbalení detailu vozidla v kartě
        async function toggleVehicleDetail(vehicleId) {
            const detailPanel = document.getElementById(`vehicle-detail-${vehicleId}`);
            const header = detailPanel?.previousElementSibling;
            
            if (!detailPanel || !header) return;
            
            const isExpanded = detailPanel.classList.contains('expanded');
            
            if (isExpanded) {
                // Sbalit
                detailPanel.classList.remove('expanded');
                header.classList.remove('expanded');
                expandedVehicleId = null;
            } else {
                // Sbalit ostatní panely
                if (expandedVehicleId && expandedVehicleId !== vehicleId) {
                    const otherPanel = document.getElementById(`vehicle-detail-${expandedVehicleId}`);
                    const otherHeader = otherPanel?.previousElementSibling;
                    if (otherPanel) otherPanel.classList.remove('expanded');
                    if (otherHeader) otherHeader.classList.remove('expanded');
                }
                
                // Rozbalit tento panel
                detailPanel.classList.add('expanded');
                header.classList.add('expanded');
                expandedVehicleId = vehicleId;
                currentVehicleId = vehicleId;
                
                // Načíst data vozidla, pokud ještě nejsou načtena
                const infoContainer = document.getElementById(`vehicle-info-${vehicleId}`);
                if (infoContainer && infoContainer.innerHTML.includes('Načítám')) {
                    await loadVehicleDetailInline(vehicleId);
                }
            }
        }

        // Načtení detailu vozidla do rozbalovacího panelu
        async function loadVehicleDetailInline(vehicleId) {
            const infoContainer = document.getElementById(`vehicle-info-${vehicleId}`);
            const servicesContainer = document.getElementById(`service-records-${vehicleId}`);
            
            if (!infoContainer) return;
            
            try {
                // Načíst data vozidla
                const vehicle = await apiCall(`/api/v1/vehicles/${vehicleId}`, 'GET');
                
                // Uložit aktuální vozidlo pro editaci
                window.currentVehicle = vehicle;
                
                // Zobrazit data vozidla - minimalistický design s možností editace
                infoContainer.innerHTML = `
                    <div class="vehicle-info-list">
                        <!-- Název - editovatelné -->
                        <div class="vehicle-info-row editable" data-field="nickname" data-vehicle-id="${vehicleId}">
                            <span class="vehicle-info-label">Název</span>
                            <div class="vehicle-info-edit" style="display: none;">
                                <input type="text" id="edit-nickname-${vehicleId}" value="${vehicle.nickname || ''}" placeholder="Název vozidla">
                                <div class="vehicle-info-actions">
                                    <button class="vehicle-info-btn save" onclick="saveVehicleFieldInline('nickname', ${vehicleId})">Uložit</button>
                                    <button class="vehicle-info-btn cancel" onclick="cancelEditInline('nickname', ${vehicleId})">Zrušit</button>
                                </div>
                            </div>
                            <div class="vehicle-info-display" style="display: flex; align-items: center; justify-content: space-between; flex: 1; gap: 12px;">
                                <span class="vehicle-info-value ${!vehicle.nickname ? 'empty' : ''}">${vehicle.nickname || 'Nezadáno'}</span>
                                <button class="vehicle-info-btn" onclick="startEditInline('nickname', ${vehicleId})" title="Upravit název">✏️</button>
                            </div>
                        </div>
                        
                        <!-- SPZ - editovatelné -->
                        <div class="vehicle-info-row editable" data-field="plate" data-vehicle-id="${vehicleId}">
                            <span class="vehicle-info-label">SPZ</span>
                            <div class="vehicle-info-edit" style="display: none;">
                                <input type="text" id="edit-plate-${vehicleId}" value="${vehicle.plate || ''}" placeholder="SPZ">
                                <div class="vehicle-info-actions">
                                    <button class="vehicle-info-btn save" onclick="saveVehicleFieldInline('plate', ${vehicleId})">Uložit</button>
                                    <button class="vehicle-info-btn cancel" onclick="cancelEditInline('plate', ${vehicleId})">Zrušit</button>
                                </div>
                            </div>
                            <div class="vehicle-info-display" style="display: flex; align-items: center; justify-content: space-between; flex: 1; gap: 12px;">
                                <span class="vehicle-info-value ${!vehicle.plate ? 'empty' : ''}">${vehicle.plate || 'Nezadáno'}</span>
                                <button class="vehicle-info-btn" onclick="startEditInline('plate', ${vehicleId})" title="Upravit SPZ">✏️</button>
                            </div>
                        </div>
                        
                        <!-- VIN - pouze zobrazení -->
                        <div class="vehicle-info-row">
                            <span class="vehicle-info-label">VIN</span>
                            <span class="vehicle-info-value ${!vehicle.vin ? 'empty' : ''}" style="font-family: monospace; font-size: 14px; text-align: right;">${vehicle.vin || 'Nezadáno'}</span>
                        </div>
                        
                        ${vehicle.brand ? `
                        <div class="vehicle-info-row">
                            <span class="vehicle-info-label">Značka</span>
                            <span class="vehicle-info-value" style="text-align: right;">${vehicle.brand}</span>
                        </div>
                        ` : ''}
                        
                        ${vehicle.model ? `
                        <div class="vehicle-info-row">
                            <span class="vehicle-info-label">Model</span>
                            <span class="vehicle-info-value" style="text-align: right;">${vehicle.model}</span>
                        </div>
                        ` : ''}
                        
                        ${vehicle.year ? `
                        <div class="vehicle-info-row">
                            <span class="vehicle-info-label">Rok výroby</span>
                            <span class="vehicle-info-value" style="text-align: right;">${vehicle.year}</span>
                        </div>
                        ` : ''}
                        
                        ${vehicle.engine ? `
                        <div class="vehicle-info-row">
                            <span class="vehicle-info-label">Motor</span>
                            <span class="vehicle-info-value" style="text-align: right;">${vehicle.engine}</span>
                        </div>
                        ` : ''}
                        
                        <!-- Poznámky - editovatelné -->
                        <div class="vehicle-info-row editable" data-field="notes" data-vehicle-id="${vehicleId}">
                            <span class="vehicle-info-label">Poznámky</span>
                            <div class="vehicle-info-edit" style="display: none; flex-direction: column; gap: 8px; flex: 1;">
                                <textarea id="edit-notes-${vehicleId}" placeholder="Poznámky k vozidlu" rows="4">${vehicle.notes || ''}</textarea>
                                <div class="vehicle-info-actions">
                                    <button class="vehicle-info-btn save" onclick="saveVehicleFieldInline('notes', ${vehicleId})">Uložit</button>
                                    <button class="vehicle-info-btn cancel" onclick="cancelEditInline('notes', ${vehicleId})">Zrušit</button>
                                </div>
                            </div>
                            <div class="vehicle-info-display" style="display: flex; align-items: flex-start; justify-content: space-between; flex: 1; gap: 12px;">
                                <span class="vehicle-info-value ${!vehicle.notes ? 'empty' : ''}" style="white-space: pre-wrap; line-height: 1.6; text-align: left;">${vehicle.notes || 'Nezadáno'}</span>
                                <button class="vehicle-info-btn" onclick="startEditInline('notes', ${vehicleId})" style="flex-shrink: 0;" title="Upravit poznámky">✏️</button>
                            </div>
                        </div>
                        
                        <div class="vehicle-info-row">
                            <span class="vehicle-info-label">Přidáno</span>
                            <span class="vehicle-info-value" style="text-align: right;">${new Date(vehicle.created_at).toLocaleDateString('cs-CZ')}</span>
                        </div>
                    </div>
                `;
                
                // Načíst servisní záznamy
                await loadServiceRecordsInline(vehicleId);
                
            } catch (error) {
                console.error('Error loading vehicle detail:', error);
                infoContainer.innerHTML = `<p class="alert alert-error">Chyba při načítání detailu vozidla: ${error.message}</p>`;
            }
        }

        // Zobrazení detailu vozidla v modal okně
        // Smazání vozidla
        async function deleteVehicle(vehicleId) {
            if (!vehicleId) {
                showAlert('Chyba: Vozidlo není vybráno', 'error');
                return;
            }
            
            // Potvrzení smazání
            const vehicle = await apiCall(`/api/v1/vehicles/${vehicleId}`, 'GET');
            const vehicleName = vehicle.nickname || vehicle.brand || 'Vozidlo';
            
            if (!confirm(`Opravdu chcete smazat vozidlo "${vehicleName}"?\n\nTato akce je nevratná a smaže také všechny servisní záznamy a připomínky spojené s tímto vozidlem.`)) {
                return;
            }
            
            try {
                showAlert('Mažu vozidlo...', 'info');
                await apiCall(`/api/v1/vehicles/${vehicleId}`, 'DELETE');
                showAlert('Vozidlo bylo úspěšně smazáno', 'success');
                
                // Zavřít detail vozidla
                const modal = document.getElementById('vehicleDetailModal');
                if (modal) {
                    modal.style.display = 'none';
                }
                const detail = document.getElementById('vehicleDetail');
                if (detail) {
                    detail.classList.remove('active');
                }
                currentVehicleId = null;
                
                // Načíst aktualizovaný seznam vozidel
                await loadVehicles();
                
                // Přepnout na záložku s vozidly
                switchTab('vehicles');
            } catch (error) {
                console.error('Error deleting vehicle:', error);
                showAlert('Nepodařilo se smazat vozidlo: ' + (error.message || 'Neznámá chyba'), 'error');
            }
        }

        async function showVehicleDetail(vehicleId) {
            currentVehicleId = vehicleId;
            
            const modal = document.getElementById('vehicleDetailModal');
            const modalBody = document.getElementById('vehicleModalBody');
            const modalTitle = document.getElementById('vehicleModalTitle');
            
            if (!modal || !modalBody) return;
            
            // Zobrazit modal
            modal.style.display = 'flex';
            // Zablokovat scroll pozadí - pro mobilní zařízení
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            document.body.style.height = '100%';
            
            // Zobrazit loading
            modalBody.innerHTML = '<div class="loading">Načítám...</div>';
            modalTitle.textContent = 'Detail vozidla';
            
            try {
                // Načíst data vozidla
                const vehicle = await apiCall(`/api/v1/vehicles/${vehicleId}`, 'GET');
                
                // Uložit aktuální vozidlo pro editaci
                window.currentVehicle = vehicle;
                
                // Aktualizovat název v hlavičce modalu
                modalTitle.textContent = vehicle.nickname || 'Detail vozidla';
                
                // Zobrazit data vozidla - minimalistický design s možností editace
                modalBody.innerHTML = `
                    <div class="vehicle-modal-content-grid">
                        <div class="vehicle-modal-section">
                            <h3>Data vozidla</h3>
                            <div class="vehicle-info-list">
                                <!-- Název - editovatelné -->
                                <div class="vehicle-info-row editable" data-field="nickname" data-vehicle-id="${vehicleId}">
                                    <span class="vehicle-info-label">Název</span>
                                    <div class="vehicle-info-edit" style="display: none;">
                                        <input type="text" id="edit-nickname-modal-${vehicleId}" value="${vehicle.nickname || ''}" placeholder="Název vozidla">
                                        <div class="vehicle-info-actions">
                                            <button class="vehicle-info-btn save" onclick="saveVehicleFieldModal('nickname', ${vehicleId})">Uložit</button>
                                            <button class="vehicle-info-btn cancel" onclick="cancelEditModal('nickname', ${vehicleId})">Zrušit</button>
                                        </div>
                                    </div>
                                    <div class="vehicle-info-display" style="display: flex; align-items: center; justify-content: space-between; flex: 1; gap: 12px; width: 100%;">
                                        <span class="vehicle-info-value ${!vehicle.nickname ? 'empty' : ''}" style="flex: 1; min-width: 0;">${vehicle.nickname || 'Nezadáno'}</span>
                                        <button class="vehicle-info-btn" onclick="startEditModal('nickname', ${vehicleId})" title="Upravit název" style="flex-shrink: 0;">✏️</button>
                                    </div>
                                </div>
                                
                                <!-- SPZ - editovatelné -->
                                <div class="vehicle-info-row editable" data-field="plate" data-vehicle-id="${vehicleId}">
                                    <span class="vehicle-info-label">SPZ</span>
                                    <div class="vehicle-info-edit" style="display: none;">
                                        <input type="text" id="edit-plate-modal-${vehicleId}" value="${vehicle.plate || ''}" placeholder="SPZ">
                                        <div class="vehicle-info-actions">
                                            <button class="vehicle-info-btn save" onclick="saveVehicleFieldModal('plate', ${vehicleId})">Uložit</button>
                                            <button class="vehicle-info-btn cancel" onclick="cancelEditModal('plate', ${vehicleId})">Zrušit</button>
                                        </div>
                                    </div>
                                    <div class="vehicle-info-display" style="display: flex; align-items: center; justify-content: space-between; flex: 1; gap: 12px; width: 100%;">
                                        <span class="vehicle-info-value ${!vehicle.plate ? 'empty' : ''}" style="flex: 1; min-width: 0;">${vehicle.plate || 'Nezadáno'}</span>
                                        <button class="vehicle-info-btn" onclick="startEditModal('plate', ${vehicleId})" title="Upravit SPZ" style="flex-shrink: 0;">✏️</button>
                                    </div>
                                </div>
                                
                                <!-- VIN - pouze zobrazení -->
                                <div class="vehicle-info-row">
                                    <span class="vehicle-info-label">VIN</span>
                                    <span class="vehicle-info-value ${!vehicle.vin ? 'empty' : ''}" style="font-family: monospace; font-size: 14px; text-align: right;">${vehicle.vin || 'Nezadáno'}</span>
                                </div>
                                
                                ${vehicle.brand ? `
                                <div class="vehicle-info-row">
                                    <span class="vehicle-info-label">Značka</span>
                                    <span class="vehicle-info-value" style="text-align: right;">${vehicle.brand}</span>
                                </div>
                                ` : ''}
                                
                                ${vehicle.model ? `
                                <div class="vehicle-info-row">
                                    <span class="vehicle-info-label">Model</span>
                                    <span class="vehicle-info-value" style="text-align: right;">${vehicle.model}</span>
                                </div>
                                ` : ''}
                                
                                ${vehicle.year ? `
                                <div class="vehicle-info-row">
                                    <span class="vehicle-info-label">Rok výroby</span>
                                    <span class="vehicle-info-value" style="text-align: right;">${vehicle.year}</span>
                                </div>
                                ` : ''}
                                
                                ${vehicle.engine ? `
                                <div class="vehicle-info-row">
                                    <span class="vehicle-info-label">Motor</span>
                                    <span class="vehicle-info-value" style="text-align: right;">${vehicle.engine}</span>
                                </div>
                                ` : ''}
                                
                                <!-- Poznámky - editovatelné -->
                                <div class="vehicle-info-row editable" data-field="notes" data-vehicle-id="${vehicleId}">
                                    <span class="vehicle-info-label">Poznámky</span>
                                    <div class="vehicle-info-edit" style="display: none; flex-direction: column; gap: 8px; flex: 1;">
                                        <textarea id="edit-notes-modal-${vehicleId}" placeholder="Poznámky k vozidlu" rows="4">${vehicle.notes || ''}</textarea>
                                        <div class="vehicle-info-actions">
                                            <button class="vehicle-info-btn save" onclick="saveVehicleFieldModal('notes', ${vehicleId})">Uložit</button>
                                            <button class="vehicle-info-btn cancel" onclick="cancelEditModal('notes', ${vehicleId})">Zrušit</button>
                                        </div>
                                    </div>
                                    <div class="vehicle-info-display" style="display: flex; align-items: flex-start; justify-content: space-between; flex: 1; gap: 12px; width: 100%;">
                                        <span class="vehicle-info-value ${!vehicle.notes ? 'empty' : ''}" style="white-space: pre-wrap; line-height: 1.6; text-align: left; flex: 1; min-width: 0;">${vehicle.notes || 'Nezadáno'}</span>
                                        <button class="vehicle-info-btn" onclick="startEditModal('notes', ${vehicleId})" style="flex-shrink: 0;" title="Upravit poznámky">✏️</button>
                                    </div>
                                </div>
                                
                                <div class="vehicle-info-row">
                                    <span class="vehicle-info-label">Přidáno</span>
                                    <span class="vehicle-info-value" style="text-align: right;">${new Date(vehicle.created_at).toLocaleDateString('cs-CZ')}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="vehicle-modal-section">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 10px;">
                                <h3 style="margin: 0;">Servisní úkony</h3>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="generateServiceRecordsPDF(${vehicleId}); return false;" class="btn" style="padding: 8px 16px; font-size: 14px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                        📄 PDF
                                    </button>
                                    <button onclick="openAddServiceRecordModal(${vehicleId})" class="btn" style="padding: 8px 16px; font-size: 14px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                        + Přidat záznam
                                    </button>
                                    <button onclick="deleteVehicle(${vehicleId})" class="btn" style="padding: 8px 16px; font-size: 14px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                        🗑️ Smazat
                                    </button>
                                </div>
                            </div>
                            
                            <!-- AI záznamy (vytvořené asistentem) - dlaždice -->
                            <div id="ai-service-records-modal-${vehicleId}" class="ai-service-records-list" style="margin-bottom: 20px;"></div>
                            <!-- Běžné servisní záznamy - dlaždice -->
                            <div id="service-records-modal-${vehicleId}" class="service-records-grid"></div>
                        </div>
                    </div>
                `;
                
                // Načíst servisní záznamy
                await loadServiceRecordsModal(vehicleId);
                
            } catch (error) {
                console.error('Error loading vehicle detail:', error);
                modalBody.innerHTML = `<p class="alert alert-error">Chyba při načítání detailu vozidla: ${error.message}</p>`;
            }
        }

        // Zavření modal okna
        function closeVehicleModal() {
            const modal = document.getElementById('vehicleDetailModal');
            if (modal) {
                modal.style.display = 'none';
                // Obnovit scroll pozadí
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
                document.body.style.height = '';
                currentVehicleId = null;
            }
        }

        // Zavření modalu pomocí ESC klávesy
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const vehicleModal = document.getElementById('vehicleDetailModal');
                const addServiceModal = document.getElementById('addServiceRecordModal');
                const detailServiceModal = document.getElementById('serviceRecordDetailModal');
                if (detailServiceModal && detailServiceModal.style.display === 'flex') {
                    closeServiceRecordDetailModal();
                } else if (addServiceModal && addServiceModal.style.display === 'flex') {
                    closeAddServiceRecordModal();
                } else if (vehicleModal && vehicleModal.style.display === 'flex') {
                    closeVehicleModal();
                }
            }
        });

        // Seznam dostupných kategorií servisních záznamů
        const SERVICE_CATEGORIES = [
            { value: 'OLEJ', label: 'Olej', icon: '🛢️' },
            { value: 'BRZDY', label: 'Brzdy', icon: '🛑' },
            { value: 'PNEU', label: 'Pneumatiky', icon: '⭕' },
            { value: 'STK', label: 'STK', icon: '✅' },
            { value: 'DIAGNOSTIKA', label: 'Diagnostika', icon: '🔧' },
            { value: 'FILTRY', label: 'Filtry', icon: '🔍' },
            { value: 'CHLADICI', label: 'Chladicí systém', icon: '❄️' },
            { value: 'VYFUK', label: 'Výfuk', icon: '💨' },
            { value: 'OSVETLENI', label: 'Osvětlení', icon: '💡' },
            { value: 'KAROSERIE', label: 'Karoserie', icon: '🚗' },
            { value: 'INTERIER', label: 'Interiér', icon: '🪑' },
            { value: 'ELEKTRIKA', label: 'Elektrika', icon: '⚡' },
            { value: 'KLIMATIZACE', label: 'Klimatizace', icon: '🌡️' },
            { value: 'PREVENTIVNI', label: 'Preventivní', icon: '🛡️' },
            { value: 'OPRAVA', label: 'Oprava', icon: '🔨' },
            { value: 'JINE', label: 'Jiné', icon: '📋' }
        ];

        // Otevření modalu pro přidání servisního záznamu
        function openAddServiceRecordModal(vehicleId) {
            const modal = document.getElementById('addServiceRecordModal');
            const modalBody = document.getElementById('addServiceRecordModalBody');
            
            if (!modal || !modalBody) return;
            
            // Resetovat modal (pokud byl použit pro editaci)
            resetAddServiceRecordModal();
            
            // Uložit vehicleId do modalu
            modal.setAttribute('data-vehicle-id', vehicleId);
            
            // Zobrazit modal
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            document.body.style.height = '100%';
            
            // Vytvořit formulář s výběrem kategorie
            modalBody.innerHTML = `
                <form onsubmit="handleAddServiceRecordSubmit(event, ${vehicleId})" style="display: flex; flex-direction: column; gap: 16px;">
                    <!-- Výběr kategorie -->
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px; font-weight: 500;">Kategorie *</label>
                            <div class="category-selector">
                                <button type="button" class="category-selector-button" id="category-selector-btn-add-${vehicleId}" onclick="toggleCategoryDropdown('add-${vehicleId}')">
                                    <span id="category-selected-text-add-${vehicleId}">Vyberte kategorii</span>
                                    <span style="font-size: 12px;">▼</span>
                                </button>
                                <div class="category-dropdown" id="category-dropdown-add-${vehicleId}">
                                    ${SERVICE_CATEGORIES.map(cat => `
                                        <div class="category-option" onclick="selectCategory('${cat.value}', '${cat.label}', '${cat.icon}', 'add-${vehicleId}')">
                                            <span style="margin-right: 8px;">${cat.icon}</span>
                                            ${cat.label}
                                        </div>
                                    `).join('')}
                                </div>
                                <input type="hidden" id="serviceCategory-add-${vehicleId}" required>
                            </div>
                    </div>
                    
                    <!-- Datum -->
                    <div class="form-group">
                        <label for="serviceDate-add-${vehicleId}" style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px; font-weight: 500;">Datum *</label>
                        <input type="datetime-local" id="serviceDate-add-${vehicleId}" required style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px; color: #f1f5f9; font-size: 14px;">
                    </div>
                    
                    <!-- Popis -->
                    <div class="form-group">
                        <label for="serviceDescription-add-${vehicleId}" style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px; font-weight: 500;">Popis úkonu *</label>
                        <textarea id="serviceDescription-add-${vehicleId}" rows="3" placeholder="Např. Výměna oleje, kontrola brzd..." required title="Vyplňte prosím popis úkonu" style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px; color: #f1f5f9; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                    </div>
                    
                    <!-- Nájezd a cena -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label for="serviceMileage-add-${vehicleId}" style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px; font-weight: 500;">Nájezd (km)</label>
                            <input type="number" id="serviceMileage-add-${vehicleId}" style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px; color: #f1f5f9; font-size: 14px;">
                        </div>
                        <div class="form-group">
                            <label for="servicePrice-add-${vehicleId}" style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px; font-weight: 500;">Cena (Kč)</label>
                            <input type="number" id="servicePrice-add-${vehicleId}" step="0.01" style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px; color: #f1f5f9; font-size: 14px;">
                        </div>
                    </div>
                    
                    <!-- Poznámka -->
                    <div class="form-group">
                        <label for="serviceNote-add-${vehicleId}" style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px; font-weight: 500;">Poznámka</label>
                        <input type="text" id="serviceNote-add-${vehicleId}" placeholder="Dodatečné informace..." style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px; color: #f1f5f9; font-size: 14px;">
                    </div>
                    
                    <!-- Tlačítka -->
                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                        <button type="submit" class="btn" style="flex: 1; padding: 12px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">Přidat záznam</button>
                        <button type="button" onclick="closeAddServiceRecordModal()" class="btn" style="padding: 12px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Zrušit</button>
                    </div>
                </form>
            `;
            
            // Nastavit aktuální datum a čas jako výchozí
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const dateTimeLocal = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById(`serviceDate-add-${vehicleId}`).value = dateTimeLocal;
        }

        // Zavření modalu pro přidání servisního záznamu
        function closeAddServiceRecordModal() {
            const modal = document.getElementById('addServiceRecordModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
                document.body.style.height = '';
                // Resetovat modal
                resetAddServiceRecordModal();
            }
        }

        // Rozbalení/sbalení dropdownu pro výběr kategorie
        function toggleCategoryDropdown(id) {
            const dropdown = document.getElementById(`category-dropdown-${id}`);
            const button = document.getElementById(`category-selector-btn-${id}`);
            
            if (!dropdown || !button) return;
            
            const isOpen = dropdown.classList.contains('open');
            
            // Zavřít všechny ostatní dropdowny
            document.querySelectorAll('.category-dropdown.open').forEach(dd => {
                if (dd.id !== `category-dropdown-${id}`) {
                    dd.classList.remove('open');
                    dd.previousElementSibling?.classList.remove('open');
                }
            });
            
            if (isOpen) {
                dropdown.classList.remove('open');
                button.classList.remove('open');
            } else {
                dropdown.classList.add('open');
                button.classList.add('open');
            }
        }

        // Výběr kategorie
        function selectCategory(value, label, icon, id) {
            const hiddenInput = document.getElementById(`serviceCategory-${id}`);
            const selectedText = document.getElementById(`category-selected-text-${id}`);
            const dropdown = document.getElementById(`category-dropdown-${id}`);
            const button = document.getElementById(`category-selector-btn-${id}`);
            
            if (hiddenInput) hiddenInput.value = value;
            if (selectedText) selectedText.textContent = `${icon} ${label}`;
            
            // Označit vybranou možnost
            dropdown.querySelectorAll('.category-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.textContent.includes(label)) {
                    opt.classList.add('selected');
                }
            });
            
            // Zavřít dropdown
            dropdown.classList.remove('open');
            button.classList.remove('open');
        }

        // Zavření dropdownu při kliknutí mimo
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.category-selector')) {
                document.querySelectorAll('.category-dropdown.open').forEach(dd => {
                    dd.classList.remove('open');
                    dd.previousElementSibling?.classList.remove('open');
                });
            }
        });

        // Odeslání formuláře pro přidání servisního záznamu
        async function handleAddServiceRecordSubmit(event, vehicleId) {
            event.preventDefault();
            
            const category = document.getElementById(`serviceCategory-add-${vehicleId}`).value;
            const dateInput = document.getElementById(`serviceDate-add-${vehicleId}`).value;
            const description = document.getElementById(`serviceDescription-add-${vehicleId}`).value;
            const mileage = document.getElementById(`serviceMileage-add-${vehicleId}`).value;
            const price = document.getElementById(`servicePrice-add-${vehicleId}`).value;
            const note = document.getElementById(`serviceNote-add-${vehicleId}`).value;
            
            if (!category) {
                showAlert('Vyberte prosím kategorii', 'error');
                return;
            }
            
            if (!dateInput || !description) {
                showAlert('Vyplňte prosím datum a popis úkonu', 'error');
                return;
            }
            
            try {
                const recordData = {
                    performed_at: new Date(dateInput).toISOString(),
                    mileage: mileage ? parseInt(mileage) : null,
                    description: description,
                    price: price ? parseFloat(price) : null,
                    note: note || null,
                    category: category
                };
                
                showAlert('Přidávám servisní úkon...', 'info');
                await apiCall(`/api/v1/vehicles/${vehicleId}/records`, 'POST', recordData);
                
                showAlert('Servisní úkon byl úspěšně přidán!', 'success');
                
                // Zavřít modal
                closeAddServiceRecordModal();
                
                // Načíst aktualizované servisní záznamy
                await loadServiceRecordsModal(vehicleId);
            } catch (error) {
                console.error('Error adding service record:', error);
                showAlert('Nepodařilo se přidat servisní úkon: ' + error.message, 'error');
            }
        }

        // Funkce pro editaci v modalu
        function startEditModal(field, vehicleId) {
            const row = document.querySelector(`.vehicle-info-row[data-field="${field}"][data-vehicle-id="${vehicleId}"]`);
            if (!row) return;
            
            const display = row.querySelector('.vehicle-info-display');
            const edit = row.querySelector('.vehicle-info-edit');
            
            if (display && edit) {
                display.style.display = 'none';
                edit.style.display = 'flex';
                
                // Focus na input
                const input = edit.querySelector('input, textarea');
                if (input) {
                    input.focus();
                    input.select();
                }
            }
        }

        function cancelEditModal(field, vehicleId) {
            const row = document.querySelector(`.vehicle-info-row[data-field="${field}"][data-vehicle-id="${vehicleId}"]`);
            if (!row) return;
            
            const display = row.querySelector('.vehicle-info-display');
            const edit = row.querySelector('.vehicle-info-edit');
            
            if (display && edit) {
                edit.style.display = 'none';
                display.style.display = 'flex';
                
                // Obnovit původní hodnotu
                const input = edit.querySelector('input, textarea');
                if (input && window.currentVehicle) {
                    input.value = window.currentVehicle[field] || '';
                }
            }
        }

        async function saveVehicleFieldModal(field, vehicleId) {
            if (!vehicleId || !window.currentVehicle) {
                showAlert('Chyba: Vozidlo není načteno', 'error');
                return;
            }
            
            const row = document.querySelector(`.vehicle-info-row[data-field="${field}"][data-vehicle-id="${vehicleId}"]`);
            if (!row) return;
            
            const input = row.querySelector('input, textarea');
            if (!input) return;
            
            const newValue = input.value.trim();
            
            // Validace
            if (field === 'plate' && !newValue) {
                showAlert('SPZ je povinné pole', 'error');
                return;
            }
            
            try {
                // Příprava dat pro aktualizaci
                const updateData = {};
                
                if (field === 'nickname') {
                    updateData.nickname = newValue || null;
                } else if (field === 'plate') {
                    updateData.plate = newValue;
                } else if (field === 'notes') {
                    updateData.notes = newValue || null;
                } else {
                    showAlert('Neznámé pole pro úpravu', 'error');
                    return;
                }
                
                showAlert('Ukládám změny...', 'info');
                
                // Volání API
                const updatedVehicle = await apiCall(`/api/v1/vehicles/${vehicleId}`, 'PUT', updateData);
                
                // Aktualizovat lokální data
                window.currentVehicle[field] = newValue;
                
                // Aktualizovat zobrazení
                const display = row.querySelector('.vehicle-info-display');
                const valueSpan = display.querySelector('.vehicle-info-value');
                if (valueSpan) {
                    valueSpan.textContent = newValue || 'Nezadáno';
                    valueSpan.classList.toggle('empty', !newValue);
                }
                
                // Skrýt editaci
                const edit = row.querySelector('.vehicle-info-edit');
                if (edit) edit.style.display = 'none';
                if (display) display.style.display = 'flex';
                
                showAlert('Změny byly úspěšně uloženy!', 'success');
                
                // Aktualizovat název v hlavičce modalu
                if (field === 'nickname') {
                    document.getElementById('vehicleModalTitle').textContent = newValue || 'Detail vozidla';
                }
                
                // Obnovit seznam vozidel, aby se aktualizoval název v kartě
                await loadVehicles();
                
            } catch (error) {
                console.error('Error updating vehicle:', error);
                showAlert('Nepodařilo se uložit změny: ' + (error.message || 'Neznámá chyba'), 'error');
            }
        }

        // Načtení servisních záznamů do modalu
        async function loadServiceRecordsModal(vehicleId) {
            const container = document.getElementById(`service-records-modal-${vehicleId}`);
            const aiContainer = document.getElementById(`ai-service-records-modal-${vehicleId}`);
            
            if (!container) return;
            
            if (aiContainer) aiContainer.innerHTML = '<div class="loading">Načítám AI záznamy...</div>';
            container.innerHTML = '<div class="loading">Načítám servisní záznamy...</div>';
            
            try {
                const records = await apiCall(`/api/v1/vehicles/${vehicleId}/records`, 'GET');
                
                if (!records || records.length === 0) {
                    if (aiContainer) aiContainer.innerHTML = '';
                    container.innerHTML = '<p style="color: #94a3b8; font-size: 14px;">Zatím nejsou žádné servisní záznamy. Klikněte na tlačítko "Přidat záznam" pro vytvoření prvního záznamu.</p>';
                    return;
                }
                
                // Rozdělit záznamy na AI a běžné
                const aiRecords = records.filter(r => r.created_by_ai === true);
                const normalRecords = records.filter(r => !r.created_by_ai || r.created_by_ai === false);
                
                // Zobrazit AI záznamy jako dlaždice v samostatné sekci
                if (aiContainer) {
                    if (aiRecords.length > 0) {
                        let aiHtml = '<h4 style="margin: 0 0 12px 0; color: #cbd5e1; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;"><span>🤖</span> Záznamy vytvořené AI asistentem</h4><div class="service-records-grid">';
                        aiRecords.forEach(record => {
                            const date = new Date(record.performed_at);
                            // Najít kategorii a její ikonu
                            const category = record.category || 'JINE';
                            const categoryInfo = SERVICE_CATEGORIES.find(c => c.value === category) || SERVICE_CATEGORIES.find(c => c.value === 'JINE');
                            const categoryIcon = categoryInfo ? categoryInfo.icon : '📋';
                            const categoryLabel = categoryInfo ? categoryInfo.label : category;
                            
                            aiHtml += `
                                <div class="service-record-tile ai-tile" onclick="showServiceRecordDetail(${record.id}, ${vehicleId})" title="Klikněte pro detail">
                                    <span class="tile-ai-badge">🤖</span>
                                    <div class="tile-category">${categoryIcon} ${categoryLabel}</div>
                                    <div class="tile-date">${date.toLocaleDateString('cs-CZ')}</div>
                                </div>
                            `;
                        });
                        aiHtml += '</div>';
                        aiContainer.innerHTML = aiHtml;
                    } else {
                        aiContainer.innerHTML = '';
                    }
                }
                
                // Zobrazit běžné záznamy jako dlaždice
                if (normalRecords.length > 0) {
                    let html = '';
                    normalRecords.forEach(record => {
                        const date = new Date(record.performed_at);
                        // Najít kategorii a její ikonu
                        const category = record.category || 'JINE';
                        const categoryInfo = SERVICE_CATEGORIES.find(c => c.value === category) || SERVICE_CATEGORIES.find(c => c.value === 'JINE');
                        const categoryIcon = categoryInfo ? categoryInfo.icon : '📋';
                        const categoryLabel = categoryInfo ? categoryInfo.label : category;
                        
                        html += `
                            <div class="service-record-tile" onclick="showServiceRecordDetail(${record.id}, ${vehicleId})" title="Klikněte pro detail">
                                <div class="tile-category">${categoryIcon} ${categoryLabel}</div>
                                <div class="tile-date">${date.toLocaleDateString('cs-CZ')}</div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    // Pokud jsou jen AI záznamy, zobrazit prázdnou zprávu
                    if (aiRecords.length > 0) {
                        container.innerHTML = '<p style="color: #94a3b8; font-size: 14px; grid-column: 1 / -1;">Zatím nejsou žádné běžné servisní záznamy.</p>';
                    } else {
                        container.innerHTML = '<p style="color: #94a3b8; font-size: 14px; grid-column: 1 / -1;">Zatím nejsou žádné servisní záznamy. Klikněte na tlačítko "Přidat záznam" pro vytvoření prvního záznamu.</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading service records:', error);
                if (aiContainer) aiContainer.innerHTML = '';
                container.innerHTML = `<p class="alert alert-error">Chyba při načítání servisních záznamů: ${error.message}</p>`;
            }
        }

        // Zobrazení/skrytí formuláře pro přidání servisního záznamu
        function toggleAddServiceForm(vehicleId) {
            const formContainer = document.getElementById(`add-service-form-container-${vehicleId}`);
            const btnText = document.getElementById(`add-service-btn-text-${vehicleId}`);
            
            if (!formContainer) return;
            
            if (formContainer.style.display === 'none' || !formContainer.style.display) {
                // Zobrazit formulář
                formContainer.style.display = 'block';
                if (btnText) btnText.textContent = '✕ Zrušit';
            } else {
                // Skrýt formulář
                formContainer.style.display = 'none';
                if (btnText) btnText.textContent = '+ Přidat záznam';
                
                // Vyčistit formulář
                const dateInput = document.getElementById(`serviceDate-modal-${vehicleId}`);
                const mileageInput = document.getElementById(`serviceMileage-modal-${vehicleId}`);
                const descriptionInput = document.getElementById(`serviceDescription-modal-${vehicleId}`);
                const priceInput = document.getElementById(`servicePrice-modal-${vehicleId}`);
                const noteInput = document.getElementById(`serviceNote-modal-${vehicleId}`);
                
                if (dateInput) dateInput.value = '';
                if (mileageInput) mileageInput.value = '';
                if (descriptionInput) descriptionInput.value = '';
                if (priceInput) priceInput.value = '';
                if (noteInput) noteInput.value = '';
            }
        }

        // Zobrazení detailu servisního záznamu
        async function showServiceRecordDetail(recordId, vehicleId) {
            try {
                const record = await apiCall(`/api/v1/vehicles/${vehicleId}/records/${recordId}`, 'GET');
                const date = new Date(record.performed_at);
                
                // Najít kategorii
                const category = record.category || 'JINE';
                const categoryInfo = SERVICE_CATEGORIES.find(c => c.value === category) || SERVICE_CATEGORIES.find(c => c.value === 'JINE');
                const categoryIcon = categoryInfo ? categoryInfo.icon : '📋';
                const categoryLabel = categoryInfo ? categoryInfo.label : category;
                
                let detailHtml = `
                    <div style="padding: 20px;">
                        <h3 style="margin: 0 0 20px 0; color: #e2e8f0; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                            ${categoryIcon} ${categoryLabel}
                        </h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div>
                                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 4px;">Popis</div>
                                <div style="color: #e2e8f0; font-size: 14px;">${record.description || 'Nezadáno'}</div>
                            </div>
                            <div>
                                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 4px;">Datum</div>
                                <div style="color: #e2e8f0; font-size: 14px;">${date.toLocaleDateString('cs-CZ')} ${date.toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'})}</div>
                            </div>
                            ${record.mileage ? `
                            <div>
                                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 4px;">Nájezd</div>
                                <div style="color: #e2e8f0; font-size: 14px;">${record.mileage.toLocaleString('cs-CZ')} km</div>
                            </div>
                            ` : ''}
                            ${record.price ? `
                            <div>
                                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 4px;">Cena</div>
                                <div style="color: #6366f1; font-size: 16px; font-weight: 600;">${record.price.toLocaleString('cs-CZ')} Kč</div>
                            </div>
                            ` : ''}
                            ${record.note ? `
                            <div>
                                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 4px;">Poznámka</div>
                                <div style="color: #e2e8f0; font-size: 14px;">${record.note}</div>
                            </div>
                            ` : ''}
                            ${record.created_by_ai ? `
                            <div style="margin-top: 12px; padding: 12px; background: rgba(99, 102, 241, 0.15); border-radius: 8px; border-left: 3px solid #6366f1;">
                                <div style="color: #94a3b8; font-size: 11px; font-style: italic;">🤖 Záznam vytvořený AI asistentem</div>
                            </div>
                            ` : ''}
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px; flex-direction: column;">
                            <button onclick="openEditServiceRecordModal(${recordId}, ${vehicleId})" class="btn" style="width: 100%; padding: 10px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">✏️ Upravit</button>
                            <button onclick="closeServiceRecordDetailModal()" class="btn" style="width: 100%; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Zavřít</button>
                        </div>
                    </div>
                `;
                
                // Zobrazit v modalu pro detail záznamu
                const modal = document.getElementById('serviceRecordDetailModal');
                const modalBody = document.getElementById('serviceRecordDetailModalBody');
                if (modal && modalBody) {
                    modal.setAttribute('data-vehicle-id', vehicleId);
                    modal.setAttribute('data-record-id', recordId);
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    document.body.style.position = 'fixed';
                    document.body.style.width = '100%';
                    document.body.style.height = '100%';
                    
                    modalBody.innerHTML = detailHtml;
                }
            } catch (error) {
                console.error('Error loading service record detail:', error);
                showAlert('Nepodařilo se načíst detail záznamu: ' + error.message, 'error');
            }
        }

        function closeServiceRecordDetailModal() {
            const modal = document.getElementById('serviceRecordDetailModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
                document.body.style.height = '';
            }
        }

        // Generování PDF s historií servisních záznamů - globální funkce
        window.generateServiceRecordsPDF = async function(vehicleId) {
            console.log('[PDF] ===== FUNKCE VOLÁNA =====');
            console.log('[PDF] Funkce volána s vehicleId:', vehicleId);
            console.log('[PDF] Typ vehicleId:', typeof vehicleId);
            console.log('[PDF] vehicleId hodnota:', vehicleId);
            
            if (!vehicleId || vehicleId === 'undefined' || vehicleId === 'null') {
                console.error('[PDF] Chybí nebo neplatné vehicleId!');
                showAlert('Chyba: Chybí ID vozidla', 'error');
                return;
            }
            
            // Převést na číslo, pokud je to string
            const vehicleIdNum = parseInt(vehicleId);
            if (isNaN(vehicleIdNum)) {
                console.error('[PDF] vehicleId není číslo:', vehicleId);
                showAlert('Chyba: Neplatné ID vozidla', 'error');
                return;
            }
            
            try {
                console.log('[PDF] Generuji PDF pro vozidlo:', vehicleIdNum);
                showAlert('Generuji PDF...', 'info');
                
                // Aktualizovat API_URL (stejně jako v apiCall)
                API_URL = getApiBaseUrl();
                
                if (!API_URL) {
                    throw new Error('API URL není nastavena. Kontaktujte administrátora.');
                }
                
                // Získat token pro autentizaci (stejně jako v apiCall)
                let token = accessToken;
                if (!token) {
                    token = localStorage.getItem('token');
                }
                if (!token) {
                    showAlert('Musíte být přihlášeni', 'error');
                    return;
                }
                
                const url = `${API_URL}/api/v1/vehicles/${vehicleIdNum}/pdf`;
                console.log('[PDF] Volám endpoint:', url);
                
                // Zavolat API endpoint pro generování PDF
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('[PDF] Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    // Zkusit získat chybovou zprávu
                    let errorMessage = `Chyba při generování PDF (HTTP ${response.status})`;
                    try {
                        const contentType = response.headers.get('content-type');
                        console.log('[PDF] Error response content-type:', contentType);
                        
                        // Zkusit získat text response (response lze přečíst jen jednou)
                        const responseText = await response.text();
                        console.log('[PDF] Error response text:', responseText);
                        
                        if (contentType && contentType.includes('application/json')) {
                            try {
                                const error = JSON.parse(responseText);
                                console.log('[PDF] Parsed error object:', error);
                                
                                // FastAPI vrací chyby v různých formátech
                                if (Array.isArray(error.detail)) {
                                    // Validation error - seznam chyb
                                    const errors = error.detail.map(e => {
                                        if (typeof e === 'object' && e.loc && e.msg) {
                                            return `${e.loc.join('.')}: ${e.msg}`;
                                        }
                                        return String(e);
                                    }).join(', ');
                                    errorMessage = `Validační chyba: ${errors}`;
                                } else if (error.detail) {
                                    errorMessage = String(error.detail);
                                } else if (error.message) {
                                    errorMessage = String(error.message);
                                } else {
                                    errorMessage = JSON.stringify(error);
                                }
                            } catch (parseError) {
                                console.error('[PDF] Chyba při parsování JSON:', parseError);
                                errorMessage = responseText || errorMessage;
                            }
                        } else {
                            if (responseText && responseText.length < 500) {
                                errorMessage = responseText;
                            }
                        }
                    } catch (e) {
                        console.error('[PDF] Chyba při parsování error response:', e);
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                // Zkontrolovat content-type
                const contentType = response.headers.get('content-type');
                console.log('[PDF] Content-Type:', contentType);
                
                if (!contentType || !contentType.includes('application/pdf')) {
                    console.warn('[PDF] Neočekávaný content-type:', contentType);
                }
                
                // Získat PDF jako blob
                const blob = await response.blob();
                console.log('[PDF] Blob velikost:', blob.size, 'bytes');
                
                if (blob.size === 0) {
                    throw new Error('PDF soubor je prázdný');
                }
                
                // Vytvořit URL pro stažení
                const blobUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = blobUrl;
                a.style.display = 'none';
                
                // Název souboru z response headers nebo default
                const contentDisposition = response.headers.get('content-disposition');
                let filename = 'servisni_zaznamy.pdf';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/i);
                    if (filenameMatch && filenameMatch[1]) {
                        filename = filenameMatch[1].replace(/['"]/g, '');
                    }
                }
                
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                
                // Vyčkat chvíli před odstraněním
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(blobUrl);
                }, 100);
                
                console.log('[PDF] PDF úspěšně staženo:', filename);
                showAlert('PDF bylo úspěšně vygenerováno a staženo!', 'success');
            } catch (error) {
                console.error('[PDF] Chyba při generování PDF:', error);
                console.error('[PDF] Error stack:', error.stack);
                showAlert('Nepodařilo se vygenerovat PDF: ' + (error.message || error), 'error');
            }
        };
        
        // Také jako normální funkce pro kompatibilitu
        function generateServiceRecordsPDF(vehicleId) {
            return window.generateServiceRecordsPDF(vehicleId);
        }

        // Funkce pro resetování modalu po zavření (aby se při dalším otevření zobrazil správný formulář)
        function resetAddServiceRecordModal() {
            const modal = document.getElementById('addServiceRecordModal');
            if (modal) {
                const modalHeader = modal.querySelector('.vehicle-modal-header h2');
                if (modalHeader) modalHeader.textContent = 'Přidat servisní záznam';
                modal.removeAttribute('data-record-id');
            }
        }

        // Otevření modalu pro editaci servisního záznamu
        async function openEditServiceRecordModal(recordId, vehicleId) {
            try {
                // Načíst záznam
                const record = await apiCall(`/api/v1/vehicles/${vehicleId}/records/${recordId}`, 'GET');
                
                // Zavřít detail modal
                closeServiceRecordDetailModal();
                
                // Otevřít modal pro editaci (použijeme stejný modal jako pro přidání)
                const modal = document.getElementById('addServiceRecordModal');
                const modalBody = document.getElementById('addServiceRecordModalBody');
                
                if (!modal || !modalBody) return;
                
                modal.setAttribute('data-vehicle-id', vehicleId);
                modal.setAttribute('data-record-id', recordId);
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';
                document.body.style.height = '100%';
                
                // Najít kategorii
                const category = record.category || 'JINE';
                const categoryInfo = SERVICE_CATEGORIES.find(c => c.value === category) || SERVICE_CATEGORIES.find(c => c.value === 'JINE');
                const categoryIcon = categoryInfo ? categoryInfo.icon : '📋';
                const categoryLabel = categoryInfo ? categoryInfo.label : category;
                
                // Formátovat datum pro datetime-local input
                const date = new Date(record.performed_at);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const dateTimeLocal = `${year}-${month}-${day}T${hours}:${minutes}`;
                
                // Vytvořit formulář pro editaci
                modalBody.innerHTML = `
                    <form onsubmit="handleEditServiceRecordSubmit(event, ${recordId}, ${vehicleId})" style="display: flex; flex-direction: column; gap: 16px;">
                        <!-- Výběr kategorie -->
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px; font-weight: 500;">Kategorie *</label>
                            <div class="category-selector">
                                <button type="button" class="category-selector-button" id="category-selector-btn-edit-${recordId}" onclick="toggleCategoryDropdown('edit-${recordId}')">
                                    <span id="category-selected-text-edit-${recordId}">${categoryIcon} ${categoryLabel}</span>
                                    <span style="font-size: 12px;">▼</span>
                                </button>
                                <div class="category-dropdown" id="category-dropdown-edit-${recordId}">
                                    ${SERVICE_CATEGORIES.map(cat => `
                                        <div class="category-option ${cat.value === category ? 'selected' : ''}" onclick="selectCategory('${cat.value}', '${cat.label}', '${cat.icon}', 'edit-${recordId}')">
                                            <span style="margin-right: 8px;">${cat.icon}</span>
                                            ${cat.label}
                                        </div>
                                    `).join('')}
                                </div>
                                <input type="hidden" id="serviceCategory-edit-${recordId}" value="${category}" required>
                            </div>
                        </div>
                        
                        <!-- Datum -->
                        <div class="form-group">
                            <label for="serviceDate-edit-${recordId}" style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px; font-weight: 500;">Datum *</label>
                            <input type="datetime-local" id="serviceDate-edit-${recordId}" value="${dateTimeLocal}" required style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px; color: #f1f5f9; font-size: 14px;">
                        </div>
                        
                        <!-- Popis -->
                        <div class="form-group">
                            <label for="serviceDescription-edit-${recordId}" style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px; font-weight: 500;">Popis úkonu *</label>
                            <textarea id="serviceDescription-edit-${recordId}" rows="3" placeholder="Např. Výměna oleje, kontrola brzd..." required title="Vyplňte prosím popis úkonu" style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px; color: #f1f5f9; font-size: 14px; font-family: inherit; resize: vertical;">${record.description || ''}</textarea>
                        </div>
                        
                        <!-- Nájezd a cena -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label for="serviceMileage-edit-${recordId}" style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px; font-weight: 500;">Nájezd (km)</label>
                                <input type="number" id="serviceMileage-edit-${recordId}" value="${record.mileage || ''}" style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px; color: #f1f5f9; font-size: 14px;">
                            </div>
                            <div class="form-group">
                                <label for="servicePrice-edit-${recordId}" style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px; font-weight: 500;">Cena (Kč)</label>
                                <input type="number" id="servicePrice-edit-${recordId}" value="${record.price || ''}" step="0.01" style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px; color: #f1f5f9; font-size: 14px;">
                            </div>
                        </div>
                        
                        <!-- Poznámka -->
                        <div class="form-group">
                            <label for="serviceNote-edit-${recordId}" style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px; font-weight: 500;">Poznámka</label>
                            <input type="text" id="serviceNote-edit-${recordId}" value="${record.note || ''}" placeholder="Dodatečné informace..." style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 6px; color: #f1f5f9; font-size: 14px;">
                        </div>
                        
                        <!-- Tlačítka -->
                        <div style="display: flex; gap: 10px; margin-top: 8px;">
                            <button type="submit" class="btn" style="flex: 1; padding: 12px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">Uložit změny</button>
                            <button type="button" onclick="closeAddServiceRecordModal()" class="btn" style="padding: 12px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Zrušit</button>
                        </div>
                    </form>
                `;
                
                // Aktualizovat header
                const modalHeader = modal.querySelector('.vehicle-modal-header h2');
                if (modalHeader) modalHeader.textContent = 'Upravit servisní záznam';
            } catch (error) {
                console.error('Error loading service record for edit:', error);
                showAlert('Nepodařilo se načíst záznam pro úpravu: ' + error.message, 'error');
            }
        }

        // Odeslání formuláře pro editaci servisního záznamu
        async function handleEditServiceRecordSubmit(event, recordId, vehicleId) {
            event.preventDefault();
            
            const category = document.getElementById(`serviceCategory-edit-${recordId}`).value;
            const dateInput = document.getElementById(`serviceDate-edit-${recordId}`).value;
            const description = document.getElementById(`serviceDescription-edit-${recordId}`).value;
            const mileage = document.getElementById(`serviceMileage-edit-${recordId}`).value;
            const price = document.getElementById(`servicePrice-edit-${recordId}`).value;
            const note = document.getElementById(`serviceNote-edit-${recordId}`).value;
            
            if (!category) {
                showAlert('Vyberte prosím kategorii', 'error');
                return;
            }
            
            if (!dateInput || !description) {
                showAlert('Vyplňte prosím datum a popis úkonu', 'error');
                return;
            }
            
            try {
                const updateData = {
                    performed_at: new Date(dateInput).toISOString(),
                    mileage: mileage ? parseInt(mileage) : null,
                    description: description,
                    price: price ? parseFloat(price) : null,
                    note: note || null,
                    category: category
                };
                
                showAlert('Ukládám změny...', 'info');
                await apiCall(`/api/v1/vehicles/${vehicleId}/records/${recordId}`, 'PUT', updateData);
                
                showAlert('Záznam byl úspěšně upraven!', 'success');
                
                // Zavřít modal
                closeAddServiceRecordModal();
                
                // Načíst aktualizované záznamy
                await loadServiceRecordsModal(vehicleId);
            } catch (error) {
                console.error('Error updating service record:', error);
                showAlert('Nepodařilo se upravit záznam: ' + error.message, 'error');
            }
        }

        // Přidání servisního úkonu z modalu
        async function handleAddServiceModal(event, vehicleId) {
            event.preventDefault();
            
            const dateInput = document.getElementById(`serviceDate-modal-${vehicleId}`).value;
            const mileage = document.getElementById(`serviceMileage-modal-${vehicleId}`).value;
            const description = document.getElementById(`serviceDescription-modal-${vehicleId}`).value;
            const price = document.getElementById(`servicePrice-modal-${vehicleId}`).value;
            const note = document.getElementById(`serviceNote-modal-${vehicleId}`).value;
            
            if (!dateInput || !description) {
                showAlert('Vyplňte prosím datum a popis úkonu', 'error');
                return;
            }
            
            try {
                const recordData = {
                    performed_at: new Date(dateInput).toISOString(),
                    mileage: mileage ? parseInt(mileage) : null,
                    description: description,
                    price: price ? parseFloat(price) : null,
                    note: note || null
                };
                
                showAlert('Přidávám servisní úkon...', 'info');
                await apiCall(`/api/v1/vehicles/${vehicleId}/records`, 'POST', recordData);
                
                showAlert('Servisní úkon byl úspěšně přidán!', 'success');
                
                // Vyčistit formulář
                document.getElementById(`serviceDate-modal-${vehicleId}`).value = '';
                document.getElementById(`serviceMileage-modal-${vehicleId}`).value = '';
                document.getElementById(`serviceDescription-modal-${vehicleId}`).value = '';
                document.getElementById(`servicePrice-modal-${vehicleId}`).value = '';
                document.getElementById(`serviceNote-modal-${vehicleId}`).value = '';
                
                // Skrýt formulář
                toggleAddServiceForm(vehicleId);
                
                // Načíst aktualizované servisní záznamy
                await loadServiceRecordsModal(vehicleId);
            } catch (error) {
                console.error('Error adding service record:', error);
                showAlert('Nepodařilo se přidat servisní úkon: ' + error.message, 'error');
            }
        }

        // Smazání servisního záznamu z modalu
        async function deleteServiceRecordModal(recordId, vehicleId) {
            if (!confirm('Opravdu chcete smazat tento servisní záznam?')) {
                return;
            }
            
            try {
                showAlert('Mažu servisní záznam...', 'info');
                await apiCall(`/api/v1/vehicles/${vehicleId}/records/${recordId}`, 'DELETE');
                showAlert('Servisní záznam byl úspěšně smazán!', 'success');
                
                // Načíst aktualizované servisní záznamy
                await loadServiceRecordsModal(vehicleId);
            } catch (error) {
                console.error('Error deleting service record:', error);
                showAlert('Nepodařilo se smazat servisní záznam: ' + error.message, 'error');
            }
        }

        // Funkce pro inline editaci vozidla v rozbalovacím panelu
        function startEditInline(field, vehicleId) {
            const row = document.querySelector(`.vehicle-info-row[data-field="${field}"][data-vehicle-id="${vehicleId}"]`);
            if (!row) return;
            
            const display = row.querySelector('.vehicle-info-display');
            const edit = row.querySelector('.vehicle-info-edit');
            
            if (display && edit) {
                display.style.display = 'none';
                edit.style.display = 'flex';
                
                // Focus na input
                const input = edit.querySelector('input, textarea');
                if (input) {
                    input.focus();
                    input.select();
                }
            }
        }

        function cancelEditInline(field, vehicleId) {
            const row = document.querySelector(`.vehicle-info-row[data-field="${field}"][data-vehicle-id="${vehicleId}"]`);
            if (!row) return;
            
            const display = row.querySelector('.vehicle-info-display');
            const edit = row.querySelector('.vehicle-info-edit');
            
            if (display && edit) {
                edit.style.display = 'none';
                display.style.display = 'flex';
                
                // Obnovit původní hodnotu
                const input = edit.querySelector('input, textarea');
                if (input && window.currentVehicle) {
                    input.value = window.currentVehicle[field] || '';
                }
            }
        }

        async function saveVehicleFieldInline(field, vehicleId) {
            if (!vehicleId || !window.currentVehicle) {
                showAlert('Chyba: Vozidlo není načteno', 'error');
                return;
            }
            
            const row = document.querySelector(`.vehicle-info-row[data-field="${field}"][data-vehicle-id="${vehicleId}"]`);
            if (!row) return;
            
            const input = row.querySelector('input, textarea');
            if (!input) return;
            
            const newValue = input.value.trim();
            
            // Validace
            if (field === 'plate' && !newValue) {
                showAlert('SPZ je povinné pole', 'error');
                return;
            }
            
            try {
                // Příprava dat pro aktualizaci - API očekává přesné názvy polí
                const updateData = {};
                
                if (field === 'nickname') {
                    updateData.nickname = newValue || null;
                } else if (field === 'plate') {
                    updateData.plate = newValue;
                } else if (field === 'notes') {
                    updateData.notes = newValue || null;
                } else {
                    showAlert('Neznámé pole pro úpravu', 'error');
                    return;
                }
                
                showAlert('Ukládám změny...', 'info');
                
                // Volání API
                const updatedVehicle = await apiCall(`/api/v1/vehicles/${vehicleId}`, 'PUT', updateData);
                
                // Aktualizovat lokální data
                window.currentVehicle[field] = newValue;
                
                // Aktualizovat zobrazení
                const display = row.querySelector('.vehicle-info-display');
                const valueSpan = display.querySelector('.vehicle-info-value');
                if (valueSpan) {
                    valueSpan.textContent = newValue || 'Nezadáno';
                    valueSpan.classList.toggle('empty', !newValue);
                }
                
                // Skrýt editaci
                const edit = row.querySelector('.vehicle-info-edit');
                if (edit) edit.style.display = 'none';
                if (display) display.style.display = 'flex';
                
                showAlert('Změny byly úspěšně uloženy!', 'success');
                
                // Aktualizovat název v hlavičce karty, pokud se změnil nickname
                if (field === 'nickname') {
                    const card = document.querySelector(`[data-vehicle-id="${vehicleId}"]`);
                    const title = card?.querySelector('.card-title');
                    if (title) {
                        title.textContent = newValue || 'Bez názvu';
                    }
                }
                
                // Obnovit seznam vozidel, aby se aktualizoval název v kartě
                await loadVehicles();
                
            } catch (error) {
                console.error('Error updating vehicle:', error);
                showAlert('Nepodařilo se uložit změny: ' + (error.message || 'Neznámá chyba'), 'error');
            }
        }

        // Načtení servisních záznamů do rozbalovacího panelu
        async function loadServiceRecordsInline(vehicleId) {
            const container = document.getElementById(`service-records-${vehicleId}`);
            if (!container) return;
            
            container.innerHTML = '<div class="loading">Načítám servisní záznamy...</div>';
            
            try {
                const records = await apiCall(`/api/v1/vehicles/${vehicleId}/records`, 'GET');
                
                if (!records || records.length === 0) {
                    container.innerHTML = '<p style="color: #94a3b8; font-size: 14px;">Zatím nejsou žádné servisní záznamy. Přidejte první pomocí formuláře níže.</p>';
                    return;
                }
                
                let html = '';
                records.forEach(record => {
                    const date = new Date(record.performed_at);
                    html += `
                        <div class="service-record-item" style="margin-bottom: 12px; padding: 12px; background: rgba(15, 23, 42, 0.4); border-radius: 8px; border-left: 3px solid #6366f1;">
                            <h5 style="margin: 0 0 8px 0; color: #e2e8f0; font-size: 15px;">${record.description}</h5>
                            <div style="color: #94a3b8; font-size: 13px; margin-bottom: 8px;">${date.toLocaleDateString('cs-CZ')} ${date.toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'})}</div>
                            <div style="color: #cbd5e1; font-size: 13px;">
                                ${record.mileage ? `<div><strong>Nájezd:</strong> ${record.mileage.toLocaleString('cs-CZ')} km</div>` : ''}
                                ${record.note ? `<div><strong>Kategorie:</strong> ${record.note}</div>` : ''}
                                ${record.price ? `<div style="margin-top: 8px; color: #6366f1; font-weight: 600;"><strong>Cena:</strong> ${record.price.toLocaleString('cs-CZ')} Kč</div>` : ''}
                            </div>
                            <button onclick="deleteServiceRecordInline(${record.id}, ${vehicleId})" style="margin-top: 10px; background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px;">Smazat</button>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading service records:', error);
                container.innerHTML = `<p class="alert alert-error">Chyba při načítání servisních záznamů: ${error.message}</p>`;
            }
        }

        // Přidání servisního úkonu z inline formuláře
        async function handleAddServiceInline(event, vehicleId) {
            event.preventDefault();
            
            const dateInput = document.getElementById(`serviceDate-${vehicleId}`).value;
            const mileage = document.getElementById(`serviceMileage-${vehicleId}`).value;
            const description = document.getElementById(`serviceDescription-${vehicleId}`).value;
            const price = document.getElementById(`servicePrice-${vehicleId}`).value;
            const note = document.getElementById(`serviceNote-${vehicleId}`).value;
            
            if (!dateInput || !description) {
                showAlert('Vyplňte prosím datum a popis úkonu', 'error');
                return;
            }
            
            try {
                const recordData = {
                    performed_at: new Date(dateInput).toISOString(),
                    mileage: mileage ? parseInt(mileage) : null,
                    description: description,
                    price: price ? parseFloat(price) : null,
                    note: note || null
                };
                
                showAlert('Přidávám servisní úkon...', 'info');
                await apiCall(`/api/v1/vehicles/${vehicleId}/records`, 'POST', recordData);
                
                showAlert('Servisní úkon byl úspěšně přidán!', 'success');
                
                // Vyčistit formulář
                document.getElementById(`serviceDate-${vehicleId}`).value = '';
                document.getElementById(`serviceMileage-${vehicleId}`).value = '';
                document.getElementById(`serviceDescription-${vehicleId}`).value = '';
                document.getElementById(`servicePrice-${vehicleId}`).value = '';
                document.getElementById(`serviceNote-${vehicleId}`).value = '';
                
                // Načíst aktualizované servisní záznamy
                await loadServiceRecordsInline(vehicleId);
            } catch (error) {
                console.error('Error adding service record:', error);
                showAlert('Nepodařilo se přidat servisní úkon: ' + error.message, 'error');
            }
        }

        // Smazání servisního záznamu z inline panelu
        async function deleteServiceRecordInline(recordId, vehicleId) {
            if (!confirm('Opravdu chcete smazat tento servisní záznam?')) {
                return;
            }
            
            try {
                showAlert('Mažu servisní záznam...', 'info');
                await apiCall(`/api/v1/vehicles/${vehicleId}/records/${recordId}`, 'DELETE');
                showAlert('Servisní záznam byl úspěšně smazán!', 'success');
                
                // Načíst aktualizované servisní záznamy
                await loadServiceRecordsInline(vehicleId);
            } catch (error) {
                console.error('Error deleting service record:', error);
                showAlert('Nepodařilo se smazat servisní záznam: ' + error.message, 'error');
            }
        }

        // Funkce pro editaci vozidla (zachováno pro zpětnou kompatibilitu)
        function startEdit(field) {
            if (currentVehicleId) {
                startEditInline(field, currentVehicleId);
            }
        }

        function cancelEdit(field) {
            if (currentVehicleId) {
                cancelEditInline(field, currentVehicleId);
            }
        }

        async function saveVehicleField(field) {
            if (currentVehicleId) {
                await saveVehicleFieldInline(field, currentVehicleId);
            }
        }

        // Zobrazení seznamu vozidel
        function showVehiclesList() {
            document.getElementById('vehiclesList').style.display = 'block';
            document.getElementById('vehicleDetail').classList.remove('active');
            currentVehicleId = null;
        }

        // Načtení servisních záznamů
        async function loadServiceRecords(vehicleId) {
            const container = document.getElementById('serviceRecordsList');
            container.innerHTML = '<div class="loading">Načítám servisní záznamy...</div>';
            
            try {
                const records = await apiCall(`/api/v1/vehicles/${vehicleId}/records`, 'GET');
                
                if (!records || records.length === 0) {
                    container.innerHTML = '<p>Zatím nejsou žádné servisní záznamy. Přidejte první pomocí formuláře níže.</p>';
                    return;
                }
                
                let html = '';
                records.forEach(record => {
                    const date = new Date(record.performed_at);
                    html += `
                        <div class="service-record-item">
                            <h4>${record.description}</h4>
                            <div class="record-date">${date.toLocaleDateString('cs-CZ')} ${date.toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'})}</div>
                            <div class="record-details">
                                ${record.mileage ? `<p><strong>Nájezd:</strong> ${record.mileage.toLocaleString('cs-CZ')} km</p>` : ''}
                                ${record.note ? `<p><strong>Kategorie:</strong> ${record.note}</p>` : ''}
                            </div>
                            ${record.price ? `<div class="record-price">Cena: ${record.price.toLocaleString('cs-CZ')} Kč</div>` : ''}
                            <button onclick="deleteServiceRecord(${record.id})" style="margin-top: 10px; background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Smazat</button>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading service records:', error);
                container.innerHTML = `<p class="alert alert-error">Chyba při načítání servisních záznamů: ${error.message}</p>`;
            }
        }

        // Přidání servisního úkonu
        async function handleAddService(event) {
            event.preventDefault();
            
            if (!currentVehicleId) {
                showAlert('Chyba: Vozidlo není vybráno', 'error');
                return;
            }
            
            const dateInput = document.getElementById('serviceDate').value;
            const mileage = document.getElementById('serviceMileage').value;
            const description = document.getElementById('serviceDescription').value;
            const price = document.getElementById('servicePrice').value;
            const note = document.getElementById('serviceNote').value;
            
            if (!dateInput || !description) {
                showAlert('Vyplňte prosím datum a popis úkonu', 'error');
                return;
            }
            
            try {
                const recordData = {
                    performed_at: new Date(dateInput).toISOString(),
                    mileage: mileage ? parseInt(mileage) : null,
                    description: description,
                    price: price ? parseFloat(price) : null,
                    note: note || null
                };
                
                showAlert('Přidávám servisní úkon...', 'info');
                await apiCall(`/api/v1/vehicles/${currentVehicleId}/records`, 'POST', recordData);
                
                showAlert('Servisní úkon byl úspěšně přidán!', 'success');
                
                // Vyčistit formulář
                document.getElementById('serviceDate').value = '';
                document.getElementById('serviceMileage').value = '';
                document.getElementById('serviceDescription').value = '';
                document.getElementById('servicePrice').value = '';
                document.getElementById('serviceNote').value = '';
                
                // Načíst aktualizované servisní záznamy
                await loadServiceRecords(currentVehicleId);
            } catch (error) {
                console.error('Error adding service record:', error);
                showAlert('Nepodařilo se přidat servisní úkon: ' + error.message, 'error');
            }
        }

        // Smazání servisního záznamu
        async function deleteServiceRecord(recordId) {
            if (!confirm('Opravdu chcete smazat tento servisní záznam?')) {
                return;
            }
            
            try {
                if (!currentVehicleId) {
                    showAlert('Chyba: Nelze smazat záznam - vozidlo není vybráno', 'error');
                    return;
                }
                await apiCall(`/api/v1/vehicles/${currentVehicleId}/records/${recordId}`, 'DELETE');
                showAlert('Servisní záznam byl smazán', 'success');
                
                // Načíst aktualizované servisní záznamy (inline i starý způsob)
                if (currentVehicleId) {
                    if (document.getElementById(`service-records-${currentVehicleId}`)) {
                        await loadServiceRecordsInline(currentVehicleId);
                    } else {
                        await loadServiceRecords(currentVehicleId);
                    }
                }
            } catch (error) {
                console.error('Error deleting service record:', error);
                showAlert('Nepodařilo se smazat servisní záznam: ' + error.message, 'error');
            }
        }

        // Přepínání tabů
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            // Najít a aktivovat správný tab button
            const tabButtons = document.querySelectorAll('.tab');
            let activeIndex = 0;
            
            if (tab === 'vehicles') {
                activeIndex = 0;
                document.getElementById('vehiclesTab').classList.add('active');
                // Načíst vozidla pouze pokud nemáme otevřený detail vozidla
                if (!currentVehicleId) {
                    loadVehicles();
                }
            } else if (tab === 'addVehicle') {
                activeIndex = 1;
                document.getElementById('addVehicleTab').classList.add('active');
            } else if (tab === 'reminders') {
                activeIndex = 2;
                document.getElementById('remindersTab').classList.add('active');
                loadReminders();
            } else if (tab === 'reservations') {
                activeIndex = 3;
                document.getElementById('reservationsTab').classList.add('active');
                loadReservations();
            } else if (tab === 'aiFeatures') {
                activeIndex = 4;
                document.getElementById('aiFeaturesTab').classList.add('active');
                if (typeof initAIFeaturesTab === 'function') {
                    initAIFeaturesTab();
                }
            } else if (tab === 'profile') {
                activeIndex = 5;
                document.getElementById('profileTab').classList.add('active');
                loadProfile();
            }
            
            if (tabButtons[activeIndex]) {
                tabButtons[activeIndex].classList.add('active');
            }
        }

        // Zobrazení registrace
        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            // Vyčistit chyby při přepnutí
            clearFormError('loginErrorContainer');
            clearFormError('registerErrorContainer');
        }

        // Zobrazení přihlášení
        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            // Vyčistit chyby při přepnutí
            clearFormError('loginErrorContainer');
            clearFormError('registerErrorContainer');
        }

        // Kontrola přihlášení při načtení stránky
        window.addEventListener('DOMContentLoaded', () => {
            // Inicializovat API_URL
            function initApiUrl() {
                try {
                    API_URL = getApiBaseUrl();
                    console.log('[APP] API URL:', API_URL);
                } catch (e) {
                    console.error('[APP] Chyba při inicializaci API_URL:', e);
                    API_URL = "http://127.0.0.1:8001"; // Fallback
                }
            }
            
            // Inicializovat API URL hned
            initApiUrl();
            
            // Nastavit DEV API URL panel (skrýt v produkci)
            setupDevApiUrlPanel();
            
            // Zobrazit tlačítko konfigurace jen v DEV režimu (ne v produkci)
            const isProduction = window.location.hostname === "hub.toozservis.cz";
            const location = getLocation();
            const urlParams = new URLSearchParams(location.search || '');
            const isAdmin = urlParams.get('admin') === '1';
            const configButton = document.getElementById('configButton');
            if (configButton) {
                // V produkci tlačítko skrýt, v DEV zobrazit jen pro admina
                if (isProduction) {
                    configButton.classList.add('hidden');
                } else if (isAdmin) {
                    configButton.classList.remove('hidden');
                } else {
                    configButton.classList.add('hidden');
                }
            }
            
            // V DEV režimu, pokud není nastavená API URL a je admin, zobrazit konfiguraci
            if (!isProduction && !API_URL && isAdmin) {
                showApiUrlConfig();
            }
            
            // Kontrola stavu serveru při načtení
            checkServerStatus();
            
            // Pravidelná kontrola stavu serveru každých 30 sekund
            serverStatusCheckInterval = setInterval(checkServerStatus, 30000);
            
            // Načíst verzi aplikace při startu
            loadVersionInfo();
            
            // Načíst uložený JWT token a uživatele
            const savedToken = localStorage.getItem('accessToken');
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedToken) {
                accessToken = savedToken;
                console.log('[AUTH] Loaded saved JWT token');
            }
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    console.log('[AUTH] Loaded saved user');
                } catch (e) {
                    console.error('[AUTH] Error parsing saved user:', e);
                }
            }
            
            // Pokud je uživatel přihlášen, zobrazit dashboard a bublinu
            if (savedToken && savedUser) {
                // Ověřit token a zobrazit dashboard
                showDashboard();
                // Zobrazit Command Bot bublinu
                updateCommandBotVisibility();
            }
            
            // ZAJISTIT, ŽE AUTH SECTION JE VIDITELNÁ PŘI NAČTENÍ
            const authSection = document.getElementById('authSection');
            const dashboard = document.getElementById('dashboard');
            
            if (authSection) {
                authSection.classList.remove('hidden');
                authSection.style.display = 'block';
                authSection.style.visibility = 'visible';
                authSection.style.opacity = '1';
                console.log('[APP] ✅ authSection je viditelná', {
                    hasHidden: authSection.classList.contains('hidden'),
                    display: authSection.style.display,
                    computed: window.getComputedStyle(authSection).display
                });
            } else {
                console.error('[APP] ❌ authSection NENÍ NALEZENA!');
            }
            
            // Zajistit, že dashboard je skrytý (pokud není aktivní)
            if (dashboard) {
                if (!dashboard.classList.contains('active')) {
                    dashboard.style.display = 'none';
                    console.log('[APP] Dashboard je skrytý (není aktivní)');
                } else {
                    console.log('[APP] Dashboard je aktivní');
                }
            } else {
                console.error('[APP] ❌ dashboard NENÍ NALEZEN!');
            }
            
            // TRVALÁ OCHRANA: Kontrolovat viditelnost každou sekundu
            // TRVALÁ OCHRANA: Kontrolovat viditelnost každou sekundu a zajistit, že aplikace zůstane viditelná
            const visibilityChecker = setInterval(() => {
                const authSection = document.getElementById('authSection');
                const dashboard = document.getElementById('dashboard');
                const content = document.querySelector('.content');
                const container = document.querySelector('.container');
                
                if (authSection) {
                    const computedDisplay = window.getComputedStyle(authSection).display;
                    const computedVisibility = window.getComputedStyle(authSection).visibility;
                    const computedOpacity = window.getComputedStyle(authSection).opacity;
                    
                    // Pokud je authSection skrytá a dashboard není aktivní, zobrazit authSection
                    const isDashboardActive = dashboard && dashboard.classList.contains('active');
                    
                    if (!isDashboardActive && (computedDisplay === 'none' || computedVisibility === 'hidden' || computedOpacity === '0')) {
                        console.warn('[APP] ⚠️ authSection je skrytá - opravuji...', {
                            display: computedDisplay,
                            visibility: computedVisibility,
                            opacity: computedOpacity
                        });
                        authSection.classList.remove('hidden');
                        authSection.style.display = 'block';
                        authSection.style.visibility = 'visible';
                        authSection.style.opacity = '1';
                        authSection.style.position = 'relative';
                    }
                }
                
                // Zajistit, že content a container jsou viditelné
                if (content) {
                    const contentDisplay = window.getComputedStyle(content).display;
                    if (contentDisplay === 'none') {
                        console.warn('[APP] ⚠️ content je skrytý - opravuji...');
                        content.style.display = 'block';
                    }
                }
                
                if (container) {
                    const containerDisplay = window.getComputedStyle(container).display;
                    if (containerDisplay === 'none') {
                        console.warn('[APP] ⚠️ container je skrytý - opravuji...');
                        container.style.display = 'block';
                    }
                }
            }, 1000); // Kontrolovat každou sekundu
            
            // Zastavit kontrolu, když se stránka zavře
            window.addEventListener('beforeunload', () => {
                clearInterval(visibilityChecker);
                stopInactivityTimer();
            });
            
            // Inicializovat sledování aktivity
            setupActivityTracking();
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    if (accessToken || currentUser.email) {
                        // Pokud je uživatel přihlášen, obnovit dashboard bez znovu načítání dat
                        // (aplikace zůstane ve stejném stavu při návratu na stránku)
                        const dashboard = document.getElementById('dashboard');
                        const authSection = document.getElementById('authSection');
                        
                        if (dashboard && authSection) {
                            // Zkontrolovat, zda byl uživatel přihlášen před opuštěním stránky
                            const wasLoggedIn = localStorage.getItem('wasLoggedIn') === 'true';
                            
                            if (wasLoggedIn && accessToken) {
                                console.log('[AUTH] Obnovení přihlášené relace - uživatel zůstává přihlášen');
                                // Obnovit dashboard bez znovu načítání (uživatel už je přihlášen)
                                authSection.classList.add('hidden');
                                authSection.style.display = 'none';
                                dashboard.classList.add('active');
                                dashboard.style.display = 'block';
                                
                                // Zobrazit navbar
                                const navbar = document.getElementById('mainNavbar');
                                const userBadge = document.getElementById('userBadge');
                                const logoutBtn = document.getElementById('logout-btn');
                                if (navbar) {
                                    navbar.classList.remove('hidden');
                                }
                                
                                // Nastavit email v hlavičce
                                const userEmailEl = document.getElementById('userEmail');
                                if (userEmailEl && currentUser) {
                                    userEmailEl.textContent = currentUser.email;
                                    if (userBadge) {
                                        userBadge.classList.remove('hidden');
                                    }
                                }
                                if (logoutBtn) {
                                    logoutBtn.classList.remove('hidden');
                                }
                                
                                // Resetovat timer aktivity
                                resetInactivityTimer();
                                
                                // Načíst data jen pokud není dashboard prázdný (aby se neznovu načítalo při návratu)
                                const vehiclesContainer = document.getElementById('vehiclesContainer');
                                if (!vehiclesContainer || vehiclesContainer.innerHTML.trim() === '') {
                                    loadVehicles();
                                }
                            } else {
                                console.log('[AUTH] Uložený token nalezen, ale vyžadujeme nové přihlášení pro bezpečnost');
                                localStorage.removeItem('wasLoggedIn');
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error parsing saved user:', e);
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('wasLoggedIn');
                }
            }
            
            // Automatické načtení ARES při zadání 8 číslic IČO
            const icoInput = document.getElementById('regIco');
            if (icoInput) {
                icoInput.addEventListener('input', (e) => {
                    const ico = e.target.value.trim();
                    if (ico.length === 8 && /^\d+$/.test(ico)) {
                        // Automaticky načíst po zadání 8 číslic
                        setTimeout(() => loadAresData(), 500);
                    }
                });
            }
            
            // Automatické dekódování VIN při zadání 17 znaků
            // Použijeme event delegation, protože formulář může být skrytý při načtení stránky
            document.addEventListener('input', (e) => {
                if (e.target && e.target.id === 'vehicleVin') {
                    const vin = e.target.value.trim().toUpperCase();
                    e.target.value = vin; // Automaticky převést na velká písmena
                    console.log('[VIN] Input event, VIN length:', vin.length);
                    
                    // Skrýt informační box při změně VIN (nebo pokud je VIN prázdný/kratší)
                    const sourceInfoBox = document.getElementById('vinSourceInfo');
                    if (sourceInfoBox && vin.length < 17) {
                        sourceInfoBox.style.display = 'none';
                    }
                    
                    if (vin.length === 17) {
                        // Automaticky načíst po zadání 17 znaků
                        console.log('[VIN] Auto-loading VIN data...');
                        setTimeout(() => loadVinData(), 500);
                    }
                }
            });
            
            // Také přidat event listener přímo na element, pokud existuje
            const vinInput = document.getElementById('vehicleVin');
            if (vinInput) {
                console.log('[VIN] Direct event listener added');
                vinInput.addEventListener('input', (e) => {
                    const vin = e.target.value.trim().toUpperCase();
                    e.target.value = vin;
                    if (vin.length === 17) {
                        console.log('[VIN] Auto-loading VIN data (direct listener)...');
                        setTimeout(() => loadVinData(), 500);
                    }
                });
            }
        });

        // Načítání připomínek (v1.0)
        async function loadReminders() {
            const container = document.getElementById('remindersContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">Načítám připomínky...</div>';
            
            try {
                const reminders = await apiCall('/api/v1/reminders', 'GET');
                
                let html = '';
                
                // Panel nastavení upozornění (collapsible)
                html += `
                    <div class="card" style="margin-bottom: 24px; border-left: 4px solid #6366f1;">
                        <div class="card-header" id="reminderSettingsHeader" style="cursor: pointer;">
                            <h3 class="card-title" style="margin: 0; color: #6366f1; font-size: 16px;">
                                ⚙️ Nastavení upozornění
                            </h3>
                            <span id="reminderSettingsToggle" style="font-size: 14px; color: #64748b;">▼</span>
                        </div>
                        <div id="reminderSettingsPanel" class="card-body" style="display: none;">
                            <form id="reminderSettingsForm">
                                <div class="form-group">
                                    <label for="notificationMethod" style="color: #334155; font-weight: 600; font-size: 14px; display: block; margin-bottom: 8px;">Způsob upozornění:</label>
                                    <select id="notificationMethod" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; background: white; color: #1e293b; font-size: 14px; font-family: inherit;">
                                        <option value="app">Pouze v aplikaci</option>
                                        <option value="email">E-mail</option>
                                        <option value="both">Obojí (aplikace + e-mail)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="notifyDaysBefore" style="color: #334155; font-weight: 600; font-size: 14px; display: block; margin-bottom: 8px;">Upozornit X dní předem:</label>
                                    <input type="number" id="notifyDaysBefore" min="0" max="365" value="7" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; background: white; color: #1e293b; font-size: 14px; font-family: inherit;">
                                    <small style="color: #64748b; font-size: 12px; display: block; margin-top: 4px;">Počet dní před termínem připomínky (0-365)</small>
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 20px;">
                                    <button type="button" id="saveReminderSettingsBtn" class="btn" style="flex: 1;">💾 Uložit nastavení</button>
                                    <button type="button" id="refreshReminderSettingsBtn" class="btn btn-secondary" style="flex: 1;">🔄 Obnovit</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                // Tlačítko pro přidání nové připomínky
                html += `
                    <div style="margin-bottom: 20px; text-align: center;">
                        <button class="btn" onclick="showCreateReminderForm()">➕ Přidat připomínku</button>
                    </div>
                `;
                
                if (!reminders || reminders.length === 0) {
                    html += '<p style="text-align: center; color: #9ca3af; padding: 40px;">Žádné připomínky. Všechno je v pořádku! ✅</p>';
                    container.innerHTML = html;
                    return;
                }
                
                html += '<div class="cards-grid">';
                
                reminders.forEach(reminder => {
                    const typeIcon = reminder.type === 'STK' ? '🚗' : reminder.type === 'OLEJ' ? '🛢️' : reminder.type === 'VLASTNI' ? '📝' : '🔧';
                    const typeColor = reminder.type === 'STK' ? '#ef4444' : reminder.type === 'OLEJ' ? '#f59e0b' : reminder.type === 'VLASTNI' ? '#8b5cf6' : '#6366f1';
                    const isManual = reminder.is_manual === true;
                    const isCompleted = reminder.is_completed === true;
                    
                    html += `
                        <div class="card" style="${isCompleted ? 'opacity: 0.7;' : ''} border-left: 4px solid ${typeColor};">
                            <div class="card-header">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 20px;">${typeIcon}</span>
                                    <h3 class="card-title" style="color: ${typeColor}; font-size: 16px; margin: 0;">${reminder.type}</h3>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    ${isManual ? '<span class="badge" style="background: #8b5cf6; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600;">RUČNÍ</span>' : '<span class="badge" style="background: #6366f1; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600;">AUTO</span>'}
                                    ${isCompleted ? '<span class="badge" style="background: #10b981; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600;">DOKONČENO</span>' : ''}
                                    ${isManual ? `
                                        <button class="btn" style="padding: 6px 10px; font-size: 12px; background: #475569; min-width: auto;" onclick="editReminder(${reminder.id})" title="Upravit">✏️</button>
                                        <button class="btn" style="padding: 6px 10px; font-size: 12px; background: #ef4444; min-width: auto;" onclick="deleteReminder(${reminder.id})" title="Smazat">🗑️</button>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="card-field">
                                    <span class="card-label">Vozidlo</span>
                                    <span class="card-value">${reminder.vehicle_name || 'Obecná připomínka'}</span>
                                </div>
                                <div class="card-field">
                                    <span class="card-label">Popis</span>
                                    <span class="card-value" style="${isCompleted ? 'text-decoration: line-through; opacity: 0.7;' : ''}">${reminder.text}</span>
                                </div>
                                ${reminder.due_date ? `
                                    <div class="card-field">
                                        <span class="card-label">Datum</span>
                                        <span class="card-value" style="font-weight: 600; color: ${typeColor};">${new Date(reminder.due_date).toLocaleDateString('cs-CZ')}</span>
                                    </div>
                                ` : ''}
                            </div>
                            ${reminder.vehicle_id ? `
                                <div class="card-actions">
                                    <button class="btn btn-secondary" style="flex: 1; font-size: 13px; padding: 8px 12px;" onclick="switchTab('vehicles'); showVehicleDetail(${reminder.vehicle_id})">
                                        Zobrazit vozidlo
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                // Nastavit event listenery pro tlačítka nastavení připomínek po vložení HTML
                setTimeout(() => {
                    setupReminderSettingsEventListeners();
                }, 100);
                
            } catch (error) {
                console.error('Error loading reminders:', error);
                container.innerHTML = `<p style="color: #ef4444;">Chyba při načítání připomínek: ${error.message}</p>`;
            }
        }

        // Zobrazení formuláře pro vytvoření připomínky
        async function showCreateReminderForm() {
            // Načíst vozidla uživatele
            let vehicles = [];
            try {
                vehicles = await apiCall('/api/v1/vehicles', 'GET');
            } catch (error) {
                console.error('Error loading vehicles:', error);
            }
            
            const formHtml = `
                <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; max-width: 600px; margin: 0 auto;">
                    <h2 style="color: #e5e7eb; margin-bottom: 20px; text-align: center;">Nová připomínka</h2>
                    
                    <div class="form-group">
                        <label for="reminderType" style="color: #9ca3af;">Typ připomínky *:</label>
                        <select id="reminderType" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                            <option value="VLASTNI">Vlastní</option>
                            <option value="STK">STK</option>
                            <option value="OLEJ">Olej</option>
                            <option value="SERVIS">Servis</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reminderVehicle" style="color: #9ca3af;">Vozidlo (volitelné):</label>
                        <select id="reminderVehicle" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                            <option value="">Obecná připomínka</option>
                            ${vehicles.map(v => `<option value="${v.id}">${v.nickname || v.plate || 'Bez názvu'} - ${v.plate || 'Bez SPZ'}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reminderText" style="color: #9ca3af;">Text připomínky *:</label>
                        <textarea id="reminderText" placeholder="Např. Zkontrolovat brzdy, Vyměnit filtr..." rows="3" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; font-family: inherit;" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="reminderDueDate" style="color: #9ca3af;">Datum (volitelné):</label>
                        <input type="date" id="reminderDueDate" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="handleCreateReminder()" style="flex: 1;">Vytvořit připomínku</button>
                        <button class="btn" style="background: #475569; flex: 1;" onclick="loadReminders()">Zrušit</button>
                    </div>
                </div>
            `;
            
            const container = document.getElementById('remindersContainer');
            if (container) {
                container.innerHTML = formHtml;
            }
        }
        
        // Vytvoření připomínky
        async function handleCreateReminder() {
            const type = document.getElementById('reminderType').value;
            const vehicleId = document.getElementById('reminderVehicle').value;
            const text = document.getElementById('reminderText').value;
            const dueDate = document.getElementById('reminderDueDate').value;
            
            if (!text || !text.trim()) {
                showAlert('Zadejte text připomínky', 'error');
                return;
            }
            
            const reminderData = {
                type: type,
                vehicle_id: vehicleId ? parseInt(vehicleId) : null,
                text: text.trim(),
                due_date: dueDate || null
            };
            
            try {
                showAlert('Vytvářím připomínku...', 'info');
                await apiCall('/api/v1/reminders', 'POST', reminderData);
                showAlert('Připomínka byla úspěšně vytvořena!', 'success');
                await loadReminders();
            } catch (error) {
                console.error('Error creating reminder:', error);
                showAlert('Nepodařilo se vytvořit připomínku: ' + (error.message || 'Neznámá chyba'), 'error');
            }
        }
        
        // ============= NASTAVENÍ EMAIL UPOZORNĚNÍ =============
        
        // Toggle panelu nastavení
        function toggleReminderSettings() {
            const panel = document.getElementById('reminderSettingsPanel');
            const toggle = document.getElementById('reminderSettingsToggle');
            if (panel && toggle) {
                if (panel.style.display === 'none') {
                    panel.style.display = 'block';
                    toggle.textContent = '▲';
                    loadReminderSettings(); // Načíst aktuální nastavení
                } else {
                    panel.style.display = 'none';
                    toggle.textContent = '▼';
                }
            }
        }
        
        // Načtení nastavení připomínek z API
        async function loadReminderSettings() {
            try {
                const settings = await apiCall('/api/v1/reminders/settings', 'GET');
                
                if (settings && settings.notification) {
                    const methodSelect = document.getElementById('notificationMethod');
                    const daysInput = document.getElementById('notifyDaysBefore');
                    
                    if (methodSelect) {
                        methodSelect.value = settings.notification.notification_method || 'email';
                    }
                    if (daysInput) {
                        daysInput.value = settings.notification.notify_days_before || 7;
                    }
                }
            } catch (error) {
                console.error('Error loading reminder settings:', error);
                // Použít výchozí hodnoty
                const methodSelect = document.getElementById('notificationMethod');
                const daysInput = document.getElementById('notifyDaysBefore');
                if (methodSelect) methodSelect.value = 'email';
                if (daysInput) daysInput.value = 7;
            }
        }
        
        // Uložení nastavení připomínek
        async function handleSaveReminderSettings(event) {
            event.preventDefault();
            
            const methodSelect = document.getElementById('notificationMethod');
            const daysInput = document.getElementById('notifyDaysBefore');
            
            if (!methodSelect || !daysInput) {
                showAlert('Chyba: Formulář není správně načten', 'error');
                return;
            }
            
            const notificationMethod = methodSelect.value;
            const notifyDaysBeforeValue = daysInput.value.trim();
            const notifyDaysBefore = notifyDaysBeforeValue === '' ? 7 : parseInt(notifyDaysBeforeValue);
            
            if (isNaN(notifyDaysBefore) || notifyDaysBefore < 0 || notifyDaysBefore > 365) {
                showAlert('Počet dní musí být mezi 0 a 365', 'error');
                return;
            }
            
            try {
                showAlert('Ukládám nastavení...', 'info');
                
                // Nejdřív načíst aktuální nastavení
                let currentSettings = {};
                try {
                    currentSettings = await apiCall('/api/v1/reminders/settings', 'GET');
                } catch (error) {
                    console.warn('Could not load current settings, using defaults:', error);
                }
                
                // Aktualizovat pouze notification část
                const settingsToUpdate = {
                    notification: {
                        notification_method: notificationMethod,
                        notify_days_before: notifyDaysBefore
                    }
                };
                
                // Pokud máme další nastavení, zachovat je
                if (currentSettings) {
                    settingsToUpdate.enabled = currentSettings.enabled !== undefined ? currentSettings.enabled : true;
                    if (currentSettings.stk) settingsToUpdate.stk = currentSettings.stk;
                    if (currentSettings.oil) settingsToUpdate.oil = currentSettings.oil;
                    if (currentSettings.general) settingsToUpdate.general = currentSettings.general;
                    if (currentSettings.service_categories) settingsToUpdate.service_categories = currentSettings.service_categories;
                }
                
                await apiCall('/api/v1/reminders/settings', 'PUT', settingsToUpdate);
                showAlert('Nastavení bylo úspěšně uloženo! ✅', 'success');
                
                // Počkat chvíli a znovu načíst nastavení pro ověření
                setTimeout(() => {
                    loadReminderSettings();
                }, 500);
                
            } catch (error) {
                console.error('Error saving reminder settings:', error);
                showAlert('Nepodařilo se uložit nastavení: ' + (error.message || 'Neznámá chyba'), 'error');
            }
        }
        
        // Nastavení event listenerů pro tlačítka nastavení připomínek (volá se po vložení HTML)
        function setupReminderSettingsEventListeners() {
            console.log('[REMINDER SETTINGS] Nastavuji event listenery...');
            
            // Tlačítko "Uložit nastavení"
            const saveBtn = document.getElementById('saveReminderSettingsBtn');
            if (saveBtn) {
                console.log('[REMINDER SETTINGS] Nalezeno tlačítko Uložit');
                // Odstranit všechny existující listenery klonováním
                const newSaveBtn = saveBtn.cloneNode(true);
                saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
                
                newSaveBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[REMINDER SETTINGS] Kliknutí na Uložit nastavení');
                    await handleSaveReminderSettings(e);
                });
            } else {
                console.warn('[REMINDER SETTINGS] Tlačítko Uložit nenalezeno!');
            }
            
            // Tlačítko "Obnovit"
            const refreshBtn = document.getElementById('refreshReminderSettingsBtn');
            if (refreshBtn) {
                console.log('[REMINDER SETTINGS] Nalezeno tlačítko Obnovit');
                // Odstranit všechny existující listenery klonováním
                const newRefreshBtn = refreshBtn.cloneNode(true);
                refreshBtn.parentNode.replaceChild(newRefreshBtn, refreshBtn);
                
                newRefreshBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[REMINDER SETTINGS] Kliknutí na Obnovit');
                    await loadReminderSettings();
                    showAlert('Nastavení obnoveno', 'success');
                });
            } else {
                console.warn('[REMINDER SETTINGS] Tlačítko Obnovit nenalezeno!');
            }
            
            // Formulář submit
            const form = document.getElementById('reminderSettingsForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[REMINDER SETTINGS] Submit formuláře');
                    await handleSaveReminderSettings(e);
                });
            }
            
            // Header pro toggle
            const header = document.getElementById('reminderSettingsHeader');
            if (header) {
                header.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log('[REMINDER SETTINGS] Kliknutí na header');
                    toggleReminderSettings();
                });
            } else {
                // Fallback - najít přes toggle element
                const toggle = document.getElementById('reminderSettingsToggle');
                if (toggle && toggle.parentElement) {
                    toggle.parentElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleReminderSettings();
                    });
                }
            }
        }
        
        // Editace připomínky
        async function editReminder(reminderId) {
            // Načíst aktuální připomínku
            try {
                const reminders = await apiCall('/api/v1/reminders', 'GET');
                const reminder = reminders.find(r => r.id === reminderId);
                
                if (!reminder) {
                    showAlert('Připomínka nenalezena', 'error');
                    return;
                }
                
                // Načíst vozidla
                let vehicles = [];
                try {
                    vehicles = await apiCall('/api/v1/vehicles', 'GET');
                } catch (error) {
                    console.error('Error loading vehicles:', error);
                }
                
                const formHtml = `
                    <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; max-width: 600px; margin: 0 auto;">
                        <h2 style="color: #e5e7eb; margin-bottom: 20px; text-align: center;">Upravit připomínku</h2>
                        
                        <div class="form-group">
                            <label for="editReminderType" style="color: #9ca3af;">Typ připomínky *:</label>
                            <select id="editReminderType" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                                <option value="VLASTNI" ${reminder.type === 'VLASTNI' ? 'selected' : ''}>Vlastní</option>
                                <option value="STK" ${reminder.type === 'STK' ? 'selected' : ''}>STK</option>
                                <option value="OLEJ" ${reminder.type === 'OLEJ' ? 'selected' : ''}>Olej</option>
                                <option value="SERVIS" ${reminder.type === 'SERVIS' ? 'selected' : ''}>Servis</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="editReminderVehicle" style="color: #9ca3af;">Vozidlo (volitelné):</label>
                            <select id="editReminderVehicle" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                                <option value="">Obecná připomínka</option>
                                ${vehicles.map(v => `<option value="${v.id}" ${reminder.vehicle_id === v.id ? 'selected' : ''}>${v.nickname || v.plate || 'Bez názvu'} - ${v.plate || 'Bez SPZ'}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="editReminderText" style="color: #9ca3af;">Text připomínky *:</label>
                            <textarea id="editReminderText" rows="3" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; font-family: inherit;" required>${reminder.text || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="editReminderDueDate" style="color: #9ca3af;">Datum (volitelné):</label>
                            <input type="date" id="editReminderDueDate" value="${dueDateValue}" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                        </div>
                        
                        <div class="form-group">
                            <label style="color: #9ca3af; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="editReminderCompleted" ${reminder.is_completed ? 'checked' : ''} style="width: 20px; height: 20px;">
                                Dokončeno
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn" onclick="handleUpdateReminder(${reminderId})" style="flex: 1;">Uložit změny</button>
                            <button class="btn" style="background: #475569; flex: 1;" onclick="loadReminders()">Zrušit</button>
                        </div>
                    </div>
                `;
                
                const container = document.getElementById('remindersContainer');
                if (container) {
                    container.innerHTML = formHtml;
                }
            } catch (error) {
                console.error('Error loading reminder:', error);
                showAlert('Nepodařilo se načíst připomínku: ' + error.message, 'error');
            }
        }
        
        // Aktualizace připomínky
        async function handleUpdateReminder(reminderId) {
            const type = document.getElementById('editReminderType').value;
            const vehicleId = document.getElementById('editReminderVehicle').value;
            const text = document.getElementById('editReminderText').value;
            const dueDate = document.getElementById('editReminderDueDate').value;
            const isCompleted = document.getElementById('editReminderCompleted').checked;
            
            if (!text || !text.trim()) {
                showAlert('Zadejte text připomínky', 'error');
                return;
            }
            
            const reminderData = {
                type: type,
                vehicle_id: vehicleId ? parseInt(vehicleId) : null,
                text: text.trim(),
                due_date: dueDate || null,
                is_completed: isCompleted
            };
            
            try {
                showAlert('Ukládám změny...', 'info');
                await apiCall(`/api/v1/reminders/${reminderId}`, 'PUT', reminderData);
                showAlert('Připomínka byla úspěšně aktualizována!', 'success');
                await loadReminders();
            } catch (error) {
                console.error('Error updating reminder:', error);
                showAlert('Nepodařilo se aktualizovat připomínku: ' + (error.message || 'Neznámá chyba'), 'error');
            }
        }
        
        // Smazání připomínky
        async function deleteReminder(reminderId) {
            if (!confirm('Opravdu chcete smazat tuto připomínku?')) {
                return;
            }
            
            try {
                await apiCall(`/api/v1/reminders/${reminderId}`, 'DELETE');
                showAlert('Připomínka byla smazána', 'success');
                await loadReminders();
            } catch (error) {
                console.error('Error deleting reminder:', error);
                showAlert('Nepodařilo se smazat připomínku: ' + error.message, 'error');
            }
        }

        // Načítání rezervací (v1.0)
        async function loadReservations() {
            const container = document.getElementById('reservationsContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">Načítám rezervace...</div>';
            
            try {
                const reservations = await apiCall('/api/v1/reservations/my', 'GET');
                
                if (!reservations || reservations.length === 0) {
                    container.innerHTML = `
                        <p style="text-align: center; color: #9ca3af; padding: 40px;">Nemáte žádné rezervace. Vytvořte novou pomocí tlačítka níže.</p>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn" onclick="showCreateReservationForm()">Vytvořit novou rezervaci</button>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
                
                reservations.forEach(reservation => {
                    const statusColors = {
                        'PENDING': '#f59e0b',
                        'CONFIRMED': '#10b981',
                        'CANCELLED': '#ef4444'
                    };
                    const statusLabels = {
                        'PENDING': 'Čeká na potvrzení',
                        'CONFIRMED': 'Potvrzeno',
                        'CANCELLED': 'Zrušeno'
                    };
                    const statusColor = statusColors[reservation.status] || '#9ca3af';
                    const statusLabel = statusLabels[reservation.status] || reservation.status;
                    
                    const startDate = new Date(reservation.start_datetime);
                    const endDate = reservation.end_datetime ? new Date(reservation.end_datetime) : null;
                    
                    html += `
                        <div style="background: rgba(30, 41, 59, 0.8); padding: 20px; border-radius: 12px; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <strong style="color: #e5e7eb; font-size: 16px;">${reservation.service_type || 'Servis'}</strong>
                                    <div style="color: #9ca3af; margin-top: 5px;">
                                        📅 ${startDate.toLocaleDateString('cs-CZ')} ${startDate.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' })}
                                        ${endDate ? ` - ${endDate.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' })}` : ''}
                                    </div>
                                </div>
                                <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    ${statusLabel}
                                </span>
                            </div>
                            ${reservation.note ? `
                                <div style="color: #9ca3af; margin-bottom: 10px;">
                                    ${reservation.note}
                                </div>
                            ` : ''}
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <button class="btn" style="padding: 6px 12px; font-size: 12px; width: auto; background: #475569;" onclick="switchTab('vehicles'); showVehicleDetail(${reservation.vehicle_id})">
                                    Zobrazit vozidlo
                                </button>
                                ${reservation.status === 'PENDING' ? `
                                    <button class="btn" style="padding: 6px 12px; font-size: 12px; width: auto; background: #ef4444;" onclick="cancelReservation(${reservation.id})">
                                        Zrušit rezervaci
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                // Přidat tlačítko pro vytvoření rezervace
                html += `
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn" onclick="showCreateReservationForm()">Vytvořit novou rezervaci</button>
                    </div>
                `;
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading reservations:', error);
                container.innerHTML = `
                    <p style="color: #ef4444;">Chyba při načítání rezervací: ${error.message}</p>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn" onclick="showCreateReservationForm()">Vytvořit novou rezervaci</button>
                    </div>
                `;
            }
        }

        // Zobrazení formuláře pro vytvoření rezervace
        async function showCreateReservationForm() {
            // Načíst vozidla uživatele
            let vehicles = [];
            try {
                vehicles = await apiCall('/api/v1/vehicles', 'GET');
            } catch (error) {
                console.error('Error loading vehicles:', error);
                showAlert('Nepodařilo se načíst vozidla: ' + error.message, 'error');
                return;
            }
            
            if (!vehicles || vehicles.length === 0) {
                showAlert('Nemáte žádná vozidla. Nejdříve přidejte vozidlo.', 'error');
                switchTab('addVehicle');
                return;
            }
            
            // Načíst seznam dostupných servisů
            let services = [];
            try {
                services = await apiCall('/api/v1/services', 'GET');
            } catch (error) {
                console.error('Error loading services:', error);
                showAlert('Nepodařilo se načíst seznam servisů: ' + error.message, 'error');
                return;
            }
            
            if (!services || services.length === 0) {
                showAlert('Není k dispozici žádný servis. Kontaktujte administrátora.', 'error');
                return;
            }
            
            // Vytvořit HTML formuláře
            const formHtml = `
                <div style="background: rgba(30, 41, 59, 0.8); padding: 30px; border-radius: 12px; max-width: 600px; margin: 0 auto;">
                    <h2 style="color: #e5e7eb; margin-bottom: 20px; text-align: center;">Nová rezervace</h2>
                    
                    <div class="form-group">
                        <label for="reservationVehicle" style="color: #9ca3af;">Vozidlo *:</label>
                        <select id="reservationVehicle" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                            <option value="">Vyberte vozidlo...</option>
                            ${vehicles.map(v => `<option value="${v.id}">${v.nickname || v.plate || 'Bez názvu'} - ${v.plate || 'Bez SPZ'}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationServiceId" style="color: #9ca3af;">Servis *:</label>
                        <select id="reservationServiceId" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                            <option value="">Vyberte servis...</option>
                            ${services.map(s => `<option value="${s.id}">${s.name || s.email}${s.city ? ' - ' + s.city : ''}${s.phone ? ' (' + s.phone + ')' : ''}</option>`).join('')}
                        </select>
                        <small style="color: #6b7280; font-size: 0.85em; display: block; margin-top: 5px;">Vyberte servis, který bude mít správu pro vaše vozidlo</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationServiceType" style="color: #9ca3af;">Typ servisu:</label>
                        <input type="text" id="reservationServiceType" placeholder="Např. Pravidelný servis, STK, Oprava..." style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationStartDate" style="color: #9ca3af;">Datum a čas začátku *:</label>
                        <input type="date" id="reservationStartDate" style="width: 48%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; margin-right: 4%;" required>
                        <input type="time" id="reservationStartTime" style="width: 48%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationEndDate" style="color: #9ca3af;">Datum a čas konce (volitelné):</label>
                        <input type="date" id="reservationEndDate" style="width: 48%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; margin-right: 4%;">
                        <input type="time" id="reservationEndTime" style="width: 48%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em;">
                    </div>
                    
                    <div class="form-group">
                        <label for="reservationNote" style="color: #9ca3af;">Poznámka:</label>
                        <textarea id="reservationNote" placeholder="Další informace o rezervaci..." rows="3" style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #020617; color: #f9fafb; font-size: 1em; font-family: inherit;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="handleCreateReservation()" style="flex: 1;">Vytvořit rezervaci</button>
                        <button class="btn" style="background: #475569; flex: 1;" onclick="closeReservationForm()">Zrušit</button>
                    </div>
                </div>
            `;
            
            // Zobrazit formulář v kontejneru rezervací
            const container = document.getElementById('reservationsContainer');
            if (container) {
                console.log('[RESERVATION] Zobrazuji formulář v kontejneru');
                container.innerHTML = formHtml;
                
                // Přidat event listener pro automatické předvyplnění servisu při výběru vozidla
                const vehicleSelect = document.getElementById('reservationVehicle');
                const serviceSelect = document.getElementById('reservationServiceId');
                
                if (vehicleSelect && serviceSelect) {
                    vehicleSelect.addEventListener('change', function() {
                        const selectedOption = vehicleSelect.options[vehicleSelect.selectedIndex];
                        const assignedServiceId = selectedOption.getAttribute('data-service-id');
                        
                        if (assignedServiceId && assignedServiceId !== '') {
                            // Automaticky předvyplnit servis podle přiřazeného servisu vozidla
                            serviceSelect.value = assignedServiceId;
                            console.log('[RESERVATION] Automaticky předvyplněn servis:', assignedServiceId);
                        }
                    });
                }
            } else {
                console.error('[RESERVATION] Chyba: Kontejner reservationsContainer nenalezen!');
                showAlert('Kontejner pro rezervace nenalezen', 'error');
            }
        }
        
        // Zavření formuláře
        function closeReservationForm() {
            loadReservations();
        }
        
        // Vytvoření rezervace
        async function handleCreateReservation() {
            const vehicleId = document.getElementById('reservationVehicle').value;
            const serviceId = document.getElementById('reservationServiceId').value;
            const serviceType = document.getElementById('reservationServiceType').value;
            const startDate = document.getElementById('reservationStartDate').value;
            const startTime = document.getElementById('reservationStartTime').value;
            const endDate = document.getElementById('reservationEndDate').value;
            const endTime = document.getElementById('reservationEndTime').value;
            const note = document.getElementById('reservationNote').value;
            
            // Validace
            if (!vehicleId) {
                showAlert('Vyberte vozidlo', 'error');
                return;
            }
            
            if (!serviceId) {
                showAlert('Zadejte ID servisu', 'error');
                return;
            }
            
            if (!startDate || !startTime) {
                showAlert('Zadejte datum a čas začátku', 'error');
                return;
            }
            
            // Vytvořit datetime string
            const startDatetime = new Date(`${startDate}T${startTime}:00`);
            let endDatetime = null;
            
            if (endDate && endTime) {
                endDatetime = new Date(`${endDate}T${endTime}:00`);
            }
            
            // Validace, že konec je po začátku
            if (endDatetime && endDatetime <= startDatetime) {
                showAlert('Datum a čas konce musí být po začátku', 'error');
                return;
            }
            
            // Připravit data
            const reservationData = {
                service_id: parseInt(serviceId),
                vehicle_id: parseInt(vehicleId),
                service_type: serviceType || null,
                note: note || null,
                start_datetime: startDatetime.toISOString(),
                end_datetime: endDatetime ? endDatetime.toISOString() : null
            };
            
            try {
                showAlert('Vytvářím rezervaci...', 'info');
                const response = await apiCall('/api/v1/reservations', 'POST', reservationData);
                showAlert('Rezervace byla úspěšně vytvořena!', 'success');
                
                // Načíst rezervace znovu
                await loadReservations();
            } catch (error) {
                console.error('Error creating reservation:', error);
                showAlert('Nepodařilo se vytvořit rezervaci: ' + (error.message || 'Neznámá chyba'), 'error');
            }
        }

        // Zrušení rezervace
        async function cancelReservation(reservationId) {
            if (!confirm('Opravdu chcete zrušit tuto rezervaci?')) {
                return;
            }
            
            try {
                await apiCall(`/api/v1/reservations/${reservationId}`, 'PUT', {
                    status: 'CANCELLED'
                });
                showAlert('Rezervace byla zrušena', 'success');
                await loadReservations();
            } catch (error) {
                console.error('Error cancelling reservation:', error);
                showAlert('Nepodařilo se zrušit rezervaci: ' + error.message, 'error');
            }
        }

        // ============= PROFIL =============
        
        // Načtení profilu
        async function loadProfile() {
            const container = document.getElementById('profileContainer');
            if (!container) {
                console.error('[PROFILE] Kontejner profileContainer nenalezen!');
                return;
            }
            
            try {
                container.innerHTML = '<div class="loading">Načítám profil...</div>';
                const profile = await apiCall('/user/me');
                
                // Načtení verze aplikace
                loadVersionInfo();
                
                container.innerHTML = `
                    <div class="profile-sections">
                        <!-- Základní údaje -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">📝 Základní údaje</h3>
                            </div>
                            <div class="card-body">
                                <form id="profileForm" onsubmit="handleSaveProfile(event); return false;">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="profileEmail">Email</label>
                                            <input type="email" id="profileEmail" value="${profile.email || ''}" disabled class="input-disabled">
                                            <small class="form-hint">Email nelze změnit</small>
                                        </div>
                                        <div class="form-group">
                                            <label for="profileName">Jméno / Název</label>
                                            <input type="text" id="profileName" value="${profile.name || ''}" placeholder="Vaše jméno nebo název firmy">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="profileIco">IČO</label>
                                            <input type="text" id="profileIco" value="${profile.ico || ''}" placeholder="8 číslic">
                                        </div>
                                        <div class="form-group">
                                            <label for="profileDic">DIČ</label>
                                            <input type="text" id="profileDic" value="${profile.dic || ''}" placeholder="Daňové identifikační číslo">
                                        </div>
                                    </div>
                                    
                                    <div id="profileErrorContainer" style="margin-top: 20px; min-height: 20px;"></div>
                                    
                                    <div class="form-actions">
                                        <button type="submit" class="btn-primary">💾 Uložit změny</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Kontaktní údaje -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">📍 Kontaktní údaje</h3>
                            </div>
                            <div class="card-body">
                                <form id="profileContactForm" onsubmit="handleSaveProfile(event); return false;">
                                    <div class="form-row">
                                        <div class="form-group" style="flex: 2;">
                                            <label for="profileStreet">Ulice</label>
                                            <input type="text" id="profileStreet" value="${profile.street || ''}" placeholder="Název ulice">
                                        </div>
                                        <div class="form-group" style="flex: 1;">
                                            <label for="profileStreetNumber">Číslo popisné</label>
                                            <input type="text" id="profileStreetNumber" value="${profile.street_number || ''}" placeholder="Č.p.">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="profileCity">Město</label>
                                            <input type="text" id="profileCity" value="${profile.city || ''}" placeholder="Město">
                                        </div>
                                        <div class="form-group">
                                            <label for="profileZip">PSČ</label>
                                            <input type="text" id="profileZip" value="${profile.zip || ''}" placeholder="123 45">
                                        </div>
                                        <div class="form-group">
                                            <label for="profilePhone">Telefon</label>
                                            <input type="text" id="profilePhone" value="${profile.phone || ''}" placeholder="+420 123 456 789">
                                        </div>
                                    </div>
                                    
                                    <div class="form-actions">
                                        <button type="submit" class="btn-primary">💾 Uložit změny</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Nastavení notifikací -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">🔔 Nastavení notifikací</h3>
                            </div>
                            <div class="card-body">
                                <form id="profileNotificationsForm" onsubmit="handleSaveProfile(event); return false;">
                                    <div class="notifications-list">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="profileNotifyEmail" ${profile.notify_email ? 'checked' : ''} class="checkbox-input">
                                            <span class="checkbox-text">Emailové notifikace</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="profileNotifySms" ${profile.notify_sms ? 'checked' : ''} class="checkbox-input">
                                            <span class="checkbox-text">SMS notifikace</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="profileNotifyStk" ${profile.notify_stk ? 'checked' : ''} class="checkbox-input">
                                            <span class="checkbox-text">Připomínky STK</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="profileNotifyOil" ${profile.notify_oil ? 'checked' : ''} class="checkbox-input">
                                            <span class="checkbox-text">Připomínky výměny oleje</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="profileNotifyGeneral" ${profile.notify_general ? 'checked' : ''} class="checkbox-input">
                                            <span class="checkbox-text">Obecné servisní připomínky</span>
                                        </label>
                                    </div>
                                    
                                    <div class="form-actions">
                                        <button type="submit" class="btn-primary">💾 Uložit změny</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Změna hesla -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">🔐 Zabezpečení</h3>
                            </div>
                            <div class="card-body">
                                <div id="changePasswordForm">
                                    <form id="changePasswordFormContent" onsubmit="handleChangePassword(event); return false;">
                                        <div class="form-group full-width">
                                            <label for="currentPassword">Současné heslo</label>
                                            <input type="password" id="currentPassword" required minlength="6">
                                        </div>
                                        <div class="form-group full-width">
                                            <label for="newPassword">Nové heslo</label>
                                            <input type="password" id="newPassword" required minlength="6" placeholder="Minimálně 6 znaků">
                                        </div>
                                        <div class="form-group full-width">
                                            <label for="confirmNewPassword">Potvrzení nového hesla</label>
                                            <input type="password" id="confirmNewPassword" required minlength="6">
                                        </div>
                                        <div class="form-actions">
                                            <button type="submit" class="btn-primary">Změnit heslo</button>
                                        </div>
                                        <div id="changePasswordErrorContainer" style="margin-top: 20px; min-height: 20px;"></div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Informace o verzi -->
                        <div class="card">
                            <div class="card-body">
                                <div id="versionInfo" style="text-align: center; padding: 20px 0;">
                                    <p style="color: var(--text-muted); font-size: 13px; margin: 0;">
                                        <span id="versionText">Načítám verzi...</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('[PROFILE] Chyba při načítání profilu:', error);
                container.innerHTML = `<div class="alert alert-error">Nepodařilo se načíst profil: ${error.message}</div>`;
            }
        }
        
        // Uložení profilu
        async function handleSaveProfile(event) {
            event.preventDefault();
            const errorContainer = document.getElementById('profileErrorContainer');
            
            try {
                const updateData = {
                    name: document.getElementById('profileName').value.trim() || null,
                    ico: document.getElementById('profileIco').value.trim() || null,
                    dic: document.getElementById('profileDic').value.trim() || null,
                    street: document.getElementById('profileStreet').value.trim() || null,
                    street_number: document.getElementById('profileStreetNumber').value.trim() || null,
                    city: document.getElementById('profileCity').value.trim() || null,
                    zip: document.getElementById('profileZip').value.trim() || null,
                    phone: document.getElementById('profilePhone').value.trim() || null,
                    notify_email: document.getElementById('profileNotifyEmail').checked,
                    notify_sms: document.getElementById('profileNotifySms').checked,
                    notify_stk: document.getElementById('profileNotifyStk').checked,
                    notify_oil: document.getElementById('profileNotifyOil').checked,
                    notify_general: document.getElementById('profileNotifyGeneral').checked
                };
                
                // Validace IČO (pokud je zadáno, musí být 8 číslic)
                if (updateData.ico && (!/^\d{8}$/.test(updateData.ico))) {
                    showFormError('profileErrorContainer', 'IČO musí obsahovat přesně 8 číslic');
                    return;
                }
                
                await apiCall('/user/me', 'PUT', updateData);
                showFormError('profileErrorContainer', '');
                showAlert('Profil byl úspěšně aktualizován', 'success');
                
                // Znovu načíst profil pro zobrazení aktualizovaných dat
                await loadProfile();
            } catch (error) {
                console.error('[PROFILE] Chyba při ukládání profilu:', error);
                showFormError('profileErrorContainer', 'Nepodařilo se uložit změny: ' + error.message);
            }
        }
        
        // ============================================
        // COMMAND BOT FUNCTIONS - PLOVOUCÍ BUBLINA
        // ============================================
        
        let commandBotChatOpen = false;
        
        function toggleCommandBotChat() {
            const chat = document.getElementById('commandBotChat');
            if (!chat) return;
            
            commandBotChatOpen = !commandBotChatOpen;
            
            if (commandBotChatOpen) {
                chat.style.display = 'flex';
                // Načíst historii při otevření
                loadCommandBotHistory();
                // Focus na input
                setTimeout(() => {
                    const input = document.getElementById('commandBotInput');
                    if (input) input.focus();
                }, 100);
            } else {
                chat.style.display = 'none';
            }
        }
        
        async function sendCommandBot() {
            const input = document.getElementById('commandBotInput');
            const message = input?.value.trim();
            
            if (!message) {
                showAlert('Zadejte prosím příkaz', 'error');
                return;
            }
            
            if (!currentUser || !currentUser.email) {
                showAlert('Musíte být přihlášeni', 'error');
                return;
            }
            
            // Disable input a tlačítko
            if (input) input.disabled = true;
            const sendBtn = document.querySelector('.command-bot-send');
            if (sendBtn) sendBtn.disabled = true;
            
            // Zobrazit zprávu uživatele
            addCommandBotMessage('user', message);
            if (input) input.value = '';
            
            try {
                // Získat aktuální vozidlo (pokud je otevřený detail)
                const vehicleId = currentVehicleId || null;
                
                // Zavolat API
                const response = await apiCall('/api/customer-commands', 'POST', {
                    source: 'web_chat',
                    customer_name: currentUser.name || null,
                    customer_email: currentUser.email,
                    vehicle_id: vehicleId,
                    message: message
                });
                
                // Pokud bot potřebuje výběr vozidla, zobrazit interaktivní výběr
                if (response.requires_vehicle_selection && response.available_vehicles && response.available_vehicles.length > 0) {
                    addCommandBotVehicleSelection(response.command_id, response.available_vehicles, message);
                } else {
                    // Zobrazit odpověď bota
                    const botMessage = response.result_summary || 
                        `Příkaz byl zpracován. Typ: ${response.intent_type}, Status: ${response.status}`;
                    const isError = response.status === 'FAILED';
                    addCommandBotMessage('bot', botMessage, response.intent_type, response.status, isError);
                }
                
                // Pokud byl vytvořen úkol nebo rezervace, načíst aktualizované seznamy
                if (response.intent_type === 'CREATE_BOOKING') {
                    // Načíst rezervace, pokud je otevřený tab
                    if (document.getElementById('reservationsTab')?.classList.contains('active')) {
                        loadReservations();
                    }
                } else if (response.intent_type === 'CREATE_TASK') {
                    // Načíst připomínky, pokud je otevřený tab
                    if (document.getElementById('remindersTab')?.classList.contains('active')) {
                        loadReminders();
                    }
                }
                
            } catch (error) {
                console.error('[COMMAND BOT] Chyba:', error);
                addCommandBotMessage('bot', `Chyba: ${error.message || 'Nepodařilo se zpracovat příkaz'}`, null, 'FAILED', true);
            } finally {
                // Re-enable input a tlačítko (jen pokud není výběr vozidla)
                const container = document.getElementById('commandBotMessages');
                const hasVehicleSelection = container && container.querySelector('[id^="vehicle-selection-"]');
                if (!hasVehicleSelection) {
                    if (input) input.disabled = false;
                    if (sendBtn) sendBtn.disabled = false;
                    if (input) input.focus();
                }
            }
        }
        
        function addCommandBotMessage(type, message, intentType = null, status = null, isError = false) {
            const container = document.getElementById('commandBotMessages');
            if (!container) return;
            
            // Odstranit welcome message
            const welcome = container.querySelector('.command-bot-welcome');
            if (welcome) welcome.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `command-bot-message ${type}${isError ? ' error' : ''}`;
            
            let statusBadge = '';
            if (status) {
                const statusColors = {
                    'EXECUTED': '#10b981',
                    'FAILED': '#ef4444',
                    'RECEIVED': '#f59e0b'
                };
                statusBadge = `<span class="command-bot-message-badge" style="background: ${statusColors[status] || '#94a3b8'}; color: white;">${status}</span>`;
            }
            
            let intentBadge = '';
            if (intentType) {
                const intentLabels = {
                    'CREATE_BOOKING': '📅 Rezervace',
                    'CREATE_TASK': '✅ Úkol',
                    'ADD_NOTE': '📝 Poznámka',
                    'QUESTION': '❓ Otázka',
                    'UNKNOWN': '❓ Neznámé'
                };
                intentBadge = `<span class="command-bot-message-badge" style="background: #6366f1; color: white;">${intentLabels[intentType] || intentType}</span>`;
            }
            
            messageDiv.innerHTML = `
                ${intentBadge}${statusBadge}
                <div style="margin-top: ${intentBadge || statusBadge ? '4px' : '0'};">
                    ${message.replace(/\n/g, '<br>')}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function addCommandBotVehicleSelection(commandId, vehicles, originalMessage) {
            const container = document.getElementById('commandBotMessages');
            if (!container) return;
            
            // Odstranit welcome message
            const welcome = container.querySelector('.command-bot-welcome');
            if (welcome) welcome.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'command-bot-message bot';
            messageDiv.id = `vehicle-selection-${commandId}`;
            
            let vehiclesHtml = vehicles.map(v => `
                <button 
                    onclick="selectVehicleForCommand(${commandId}, ${v.id}, '${v.display_name.replace(/'/g, "\\'")}', '${originalMessage.replace(/'/g, "\\'")}')"
                    style="
                        width: 100%;
                        padding: 12px;
                        margin: 8px 0;
                        background: white;
                        border: 2px solid #6366f1;
                        border-radius: 8px;
                        cursor: pointer;
                        text-align: left;
                        transition: all 0.2s;
                        font-size: 14px;
                    "
                    onmouseover="this.style.background='#f0f4ff'; this.style.borderColor='#4f46e5';"
                    onmouseout="this.style.background='white'; this.style.borderColor='#6366f1';"
                >
                    <strong>${v.display_name || 'Vozidlo'}</strong>
                    ${v.plate ? `<br><small style="color: #64748b;">SPZ: ${v.plate}</small>` : ''}
                </button>
            `).join('');
            
            messageDiv.innerHTML = `
                <div style="margin-bottom: 8px;">
                    <strong>Prosím vyberte vozidlo:</strong>
                </div>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${vehiclesHtml}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        async function selectVehicleForCommand(commandId, vehicleId, vehicleName, originalMessage) {
            // Zobrazit zprávu o výběru
            addCommandBotMessage('user', `Vybrané vozidlo: ${vehicleName}`);
            
            // Disable všechny tlačítka výběru
            const selectionDiv = document.getElementById(`vehicle-selection-${commandId}`);
            if (selectionDiv) {
                const buttons = selectionDiv.querySelectorAll('button');
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                });
            }
            
            // Zobrazit načítání
            addCommandBotMessage('bot', 'Zpracovávám příkaz s vybraným vozidlem...', null, 'RECEIVED');
            
            try {
                // Odeslat příkaz znovu s vehicle_id
                const response = await apiCall('/api/customer-commands', 'POST', {
                    source: 'web_chat',
                    customer_name: currentUser.name || null,
                    customer_email: currentUser.email,
                    vehicle_id: vehicleId,
                    message: originalMessage
                });
                
                // Odstranit zprávu o načítání
                const messages = document.getElementById('commandBotMessages');
                if (messages) {
                    const loadingMsg = Array.from(messages.children).find(child => 
                        child.textContent.includes('Zpracovávám příkaz')
                    );
                    if (loadingMsg) loadingMsg.remove();
                }
                
                // Zobrazit výsledek
                const botMessage = response.result_summary || 
                    `Příkaz byl zpracován. Typ: ${response.intent_type}, Status: ${response.status}`;
                const isError = response.status === 'FAILED';
                addCommandBotMessage('bot', botMessage, response.intent_type, response.status, isError);
                
                // Pokud byl vytvořen úkol nebo rezervace, načíst aktualizované seznamy
                if (response.intent_type === 'CREATE_BOOKING') {
                    if (document.getElementById('reservationsTab')?.classList.contains('active')) {
                        loadReservations();
                    }
                } else if (response.intent_type === 'CREATE_TASK') {
                    if (document.getElementById('remindersTab')?.classList.contains('active')) {
                        loadReminders();
                    }
                }
                
            } catch (error) {
                console.error('[COMMAND BOT] Chyba při zpracování s vozidlem:', error);
                addCommandBotMessage('bot', `Chyba: ${error.message || 'Nepodařilo se zpracovat příkaz'}`, null, 'FAILED', true);
            } finally {
                // Re-enable input a tlačítko po výběru vozidla
                const input = document.getElementById('commandBotInput');
                const sendBtn = document.querySelector('.command-bot-send');
                if (input) input.disabled = false;
                if (sendBtn) sendBtn.disabled = false;
                if (input) input.focus();
            }
        }
        
        async function loadCommandBotHistory() {
            const container = document.getElementById('commandBotMessages');
            if (!container) return;
            
            // Zobrazit welcome message, pokud není historie
            const welcome = container.querySelector('.command-bot-welcome');
            if (!welcome && container.children.length === 0) {
                const welcomeDiv = document.createElement('div');
                welcomeDiv.className = 'command-bot-welcome';
                welcomeDiv.innerHTML = `
                    <p>👋 Ahoj! Jsem Command Bot.</p>
                    <p>Napište mi příkaz v běžné češtině a já ho automaticky zpracuji.</p>
                    <p style="margin-top: 12px; font-size: 12px; color: #64748b;">
                        <strong>Příklady:</strong><br>
                        • "Chci se objednat na servis"<br>
                        • "Připomeň mi výměnu oleje"<br>
                        • "Zapiš si poznámku o brzdách"
                    </p>
                `;
                container.appendChild(welcomeDiv);
            }
            
            if (!currentUser || !currentUser.email) {
                return;
            }
            
            try {
                const data = await apiCall('/api/customer-commands?limit=20', 'GET');
                
                if (!data.commands || data.commands.length === 0) {
                    return;
                }
                
                // Zobrazit pouze příkazy aktuálního uživatele
                const userCommands = data.commands.filter(cmd => 
                    cmd.customer_email === currentUser.email
                );
                
                if (userCommands.length === 0) {
                    return;
                }
                
                // Odstranit welcome message
                const welcomeMsg = container.querySelector('.command-bot-welcome');
                if (welcomeMsg) welcomeMsg.remove();
                
                // Zobrazit historii (nejnovější první)
                userCommands.reverse().forEach(cmd => {
                    addCommandBotMessage('user', cmd.raw_text);
                    if (cmd.result_summary || cmd.error_message) {
                        const message = cmd.result_summary || cmd.error_message;
                        const isError = cmd.status === 'FAILED';
                        addCommandBotMessage('bot', message, cmd.intent_type, cmd.status, isError);
                    }
                });
                
            } catch (error) {
                console.error('[COMMAND BOT] Chyba při načítání historie:', error);
            }
        }
        
        // Zobrazení formuláře pro změnu hesla
        function showChangePasswordForm() {
            // Formulář je nyní vždy viditelný v kartě, takže tato funkce není potřeba
            // Ale můžeme scrollovat na formulář
            const form = document.getElementById('changePasswordForm');
            if (form) {
                form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        // Skrytí formuláře pro změnu hesla (reset formuláře)
        function hideChangePasswordForm() {
            const form = document.getElementById('changePasswordFormContent');
            if (form) {
                form.reset();
                const errorContainer = document.getElementById('changePasswordErrorContainer');
                if (errorContainer) {
                    errorContainer.innerHTML = '';
                }
            }
        }
        
        // Změna hesla
        async function handleChangePassword(event) {
            event.preventDefault();
            const errorContainer = document.getElementById('changePasswordErrorContainer');
            const button = event.target.querySelector('button[type="submit"]');
            const originalButtonText = button ? button.textContent : 'Změnit heslo';
            
            try {
                // Disable tlačítka
                if (button) {
                    button.disabled = true;
                    button.textContent = 'Měním heslo...';
                }
                
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmNewPassword').value;
                
                // Validace
                if (!currentPassword) {
                    showFormError('changePasswordErrorContainer', 'Zadejte současné heslo');
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalButtonText;
                    }
                    return;
                }
                
                if (!newPassword || newPassword.length < 6) {
                    showFormError('changePasswordErrorContainer', 'Nové heslo musí mít alespoň 6 znaků');
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalButtonText;
                    }
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showFormError('changePasswordErrorContainer', 'Hesla se neshodují');
                    if (button) {
                        button.disabled = false;
                        button.textContent = originalButtonText;
                    }
                    return;
                }
                
                const response = await apiCall('/user/change-password', 'PUT', {
                    current_password: currentPassword,
                    new_password: newPassword
                });
                
                // Zobrazit úspěšnou zprávu
                showFormError('changePasswordErrorContainer', '');
                
                let successMessage = 'Heslo bylo úspěšně změněno';
                if (response.email_sent) {
                    successMessage += ' a potvrzovací email byl odeslán na váš email';
                } else if (response.message && response.message.includes('email')) {
                    successMessage += '. ' + (response.message.includes('není nakonfigurován') ? 'Email není nakonfigurován.' : '');
                }
                
                showAlert(successMessage, 'success');
                
                // Vyčistit formulář a schovat ho po 2 sekundách
                document.getElementById('changePasswordFormContent').reset();
                setTimeout(() => {
                    hideChangePasswordForm();
                }, 2000);
                
            } catch (error) {
                console.error('[PROFILE] Chyba při změně hesla:', error);
                showFormError('changePasswordErrorContainer', 'Nepodařilo se změnit heslo: ' + error.message);
            } finally {
                // Re-enable tlačítka
                if (button) {
                    button.disabled = false;
                    button.textContent = originalButtonText;
                }
            }
        }

        // ============= VERZE APLIKACE =============
        
        // Načtení informací o verzi
        async function loadVersionInfo() {
            // Aktualizace verze v navbar-brand
            const navbarVersionElement = document.getElementById('navbarVersion');
            
            // Aktualizace verze v profilu (pokud existuje)
            const versionElement = document.getElementById('versionText');
            
            try {
                const versionInfo = await apiCall('/version');
                if (versionInfo && versionInfo.version) {
                    const versionText = `v${versionInfo.version}`;
                    
                    // Aktualizovat navbar verzi
                    if (navbarVersionElement) {
                        navbarVersionElement.textContent = versionText;
                    }
                    
                    // Aktualizovat verzi v profilu (pokud existuje)
                    if (versionElement) {
                        versionElement.textContent = `TooZ Hub 2 – verze ${versionInfo.version}`;
                    }
                } else {
                    // Fallback hodnoty
                    if (navbarVersionElement) {
                        navbarVersionElement.textContent = 'v2.2.0';
                    }
                    if (versionElement) {
                        versionElement.textContent = 'TooZ Hub 2';
                    }
                }
            } catch (error) {
                console.error('[VERSION] Chyba při načítání verze:', error);
                // Fallback hodnoty při chybě
                if (navbarVersionElement) {
                    navbarVersionElement.textContent = 'v2.2.0';
                }
                if (versionElement) {
                    versionElement.textContent = 'TooZ Hub 2';
                }
            }
        }
        
        // Zobrazit/skrýt Command Bot bublinu podle přihlášení
        function updateCommandBotVisibility() {
            const bubble = document.getElementById('commandBotBubble');
            if (!bubble) {
                console.warn('[COMMAND BOT] Bublina nenalezena!');
                return;
            }
            
            // Zkontrolovat, zda je uživatel přihlášen
            const hasUser = currentUser && accessToken;
            
            // Pokud nejsou proměnné nastavené, zkusit načíst z localStorage
            if (!hasUser) {
                try {
                    const storedUser = localStorage.getItem('currentUser');
                    const storedToken = localStorage.getItem('accessToken');
                    if (storedUser && storedToken) {
                        currentUser = JSON.parse(storedUser);
                        accessToken = storedToken;
                        console.log('[COMMAND BOT] Načten uživatel z localStorage');
                    }
                } catch (e) {
                    console.error('[COMMAND BOT] Chyba při načítání z localStorage:', e);
                }
            }
            
            const isLoggedIn = (currentUser && accessToken) || (localStorage.getItem('currentUser') && localStorage.getItem('accessToken'));
            
            if (isLoggedIn) {
                bubble.style.display = 'flex';
                bubble.classList.add('show');
                console.log('[COMMAND BOT] Bublina zobrazena', { isLoggedIn, hasUser: !!currentUser, hasToken: !!accessToken });
            } else {
                bubble.style.display = 'none';
                bubble.classList.remove('show');
                console.log('[COMMAND BOT] Bublina skryta (uživatel není přihlášen)', { isLoggedIn, hasUser: !!currentUser, hasToken: !!accessToken });
                // Zavřít chat, pokud je otevřený
                const chat = document.getElementById('commandBotChat');
                if (chat) chat.style.display = 'none';
                commandBotChatOpen = false;
            }
        }
        
        // Aktualizovat viditelnost bubliny při změně přihlášení
        const originalShowDashboard = window.showDashboard;
        if (originalShowDashboard) {
            window.showDashboard = function() {
                originalShowDashboard();
                updateCommandBotVisibility();
            };
        }
        
        // Vyčistit interval při opuštění stránky
        window.addEventListener('beforeunload', () => {
            if (serverStatusCheckInterval) {
                clearInterval(serverStatusCheckInterval);
            }
        });
        
        // Inicializace viditelnosti bubliny (voláno po načtení uživatele v DOMContentLoaded)
        // Funkce se volá automaticky po načtení uživatele z localStorage
    </script>
    
    <!-- AI Features JavaScript -->
    <script src="ai-features.js"></script>
</body>
</html>
